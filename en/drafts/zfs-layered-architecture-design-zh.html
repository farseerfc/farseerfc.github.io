<!DOCTYPE html>
<html lang="zh-Hant"
>
<head>
    <title>ZFS 分層架構設計 - Farseerfc's Nest</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <meta name="theme-color" content="#6b5594">
    <meta name="msapplication-navbutton-color" content="#6b5594">
    <meta name="apple-mobile-web-app-status-bar-style" content="#6b5594">
    <link rel="manifest" href="/manifest.json">


<link rel="apple-touch-icon" sizes="180x180" href="//farseerfc.me/en/images/apple-touch-icon.png">
<link rel="icon" type="image/png" href="//farseerfc.me/en/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="//farseerfc.me/en/images/favicon-16x16.png" sizes="16x16">
<link rel="mask-icon" href="//farseerfc.me/en/images/safari-pinned-tab.svg" color="#603cba">

<link rel="canonical" href="//farseerfc.me/en/../drafts/zfs-layered-architecture-design.html">

        <meta name="author" content="farseerfc" />
        <meta name="keywords" content="zfs,layered,architecture" />
        <meta name="description" content="ZFS 在設計之初源自於 Sun 內部多次重寫 UFS 的嘗試，背負了重構 Solaris 諸多內核子系統的重任，從而不同於 Linux 的文件系統只負責文件系統的功能而把其餘功能（比如內存髒頁管理， IO調度）交給內核更底層的子系統， ZFS 的整體設計更層次化並更獨立，很多部分可能和 Linux 內核已有的子系統有功能重疊。 這篇筆記試圖從 ZFS 的早期開發歷程開始，記錄一下 ZFS 分層架構中各個子系統之間的分工。 也有幾段 OpenZFS Summit 視頻佐以記錄那段歷史。 The Birth of ZFS by Jeff Bonwick Story Time (Q&amp;A) with Matt and Jeff ZFS First Mount by Mark …" />

        <meta property="og:site_name" content="Farseerfc's Nest" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="ZFS 分層架構設計"/>
        <meta property="og:url" content="//farseerfc.me/en/../drafts/zfs-layered-architecture-design.html"/>
        <meta property="og:description" content="ZFS 在設計之初源自於 Sun 內部多次重寫 UFS 的嘗試，背負了重構 Solaris 諸多內核子系統的重任，從而不同於 Linux 的文件系統只負責文件系統的功能而把其餘功能（比如內存髒頁管理， IO調度）交給內核更底層的子系統， ZFS 的整體設計更層次化並更獨立，很多部分可能和 Linux 內核已有的子系統有功能重疊。 這篇筆記試圖從 ZFS 的早期開發歷程開始，記錄一下 ZFS 分層架構中各個子系統之間的分工。 也有幾段 OpenZFS Summit 視頻佐以記錄那段歷史。 The Birth of ZFS by Jeff Bonwick Story Time (Q&amp;A) with Matt and Jeff ZFS First Mount by Mark …"/>
        <meta property="article:published_time" content="2020-01-30" />
            <meta property="article:section" content="tech" />
            <meta property="article:tag" content="zfs" />
            <meta property="article:tag" content="layered" />
            <meta property="article:tag" content="architecture" />
            <meta property="article:author" content="farseerfc" />
        <meta property="og:image"
                  content="//farseerfc.me/en/zfs-layered-architecture-design.png"/>



    <!-- Bootstrap -->
        <link href="//farseerfc.me/en/../theme/css/bootstrap.min.css" rel="stylesheet">

    <link href="//farseerfc.me/en/../theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="//farseerfc.me/en/../theme/css/pygments/monokai.css" rel="stylesheet">
    <link href="//farseerfc.me/en/../theme/tipuesearch/tipuesearch.css" rel="stylesheet">
        <link href="//farseerfc.me/en/../theme/css/html4css1.css" rel="stylesheet">
    <link rel="stylesheet" href="//farseerfc.me/en/../theme/css/style.css" type="text/css"/>

        <link href="//farseerfc.me/en/feeds/atom.xml" type="application/atom+xml" rel="alternate"
              title="Farseerfc's Nest ATOM Feed"/>

        <link href="//farseerfc.me/en/../theme/css/material.min.css" rel="stylesheet">
        <link href="//farseerfc.me/en/../theme/css/ripples.css" rel="stylesheet">
    <link href="//farseerfc.me/en/../theme/css/github-markdown.css" rel="stylesheet">
</head>
<body>
<div style="display:none" id="title">ZFS 分層架構設計 - Farseerfc's Nest</div>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
         <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="//farseerfc.me/en/" class="navbar-brand">
Farseerfc's Nest            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">

                    <li class="dropdown hidden-lg hidden-xl">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="javascript:void(0)">
                            <i class="mdi-action-translate"></i><span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a href="//farseerfc.me/">繁體</a></li>
                            <li><a href="//farseerfc.me/jp/">日本語</a></li>
                            <li class="active"><a href="//farseerfc.me/en/">English</a></li>
                            <li><a href="//farseerfc.me/zhs/">简体</a></li>
                        </ul>
                    </li>

                    <ul class="nav navbar-nav hidden-xs hidden-md hidden-sm">
                        <li><a href="//farseerfc.me/"><i class="mdi-action-translate"></i>繁體</a></li>
                        <li><a href="//farseerfc.me/jp/"><i class="mdi-action-translate"></i>日本語</a></li>
                        <li class="active"><a href="//farseerfc.me/en/"><i class="mdi-action-translate"></i>English</a></li>
                        <li><a href="//farseerfc.me/zhs/"><i class="mdi-action-translate"></i>简体</a></li>
                    </ul>

                    <li class="dropdown hidden-md hidden-lg hidden-xl">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="javascript:void(0)">
                            <i class="fa fa-user"></i><span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu">
                             <li class=""><a href="//farseerfc.me/en/pages/about.html"><i class="fa fa-user"></i>
                                 About
                              </a></li>
                        </ul>
                    </li>

                  <ul class="nav navbar-nav hidden-xs hidden-sm">
                     <li class=""><a href="//farseerfc.me/en/pages/about.html"><i class="fa fa-user"></i>
                         About
                      </a></li>
                  </ul>
            </ul>

                <ul class="nav navbar-nav hidden-md hidden-lg hidden-xl">
                    <li class="dropdown hidden-md hidden-lg hidden-xl">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="javascript:void(0)">
                            <i class="fa fa-folder-o"></i><span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li >
                                <a href="//farseerfc.me/en/category/import.html"><i class="fa fa-folder-o"></i> Import</a>
                            </li>
                            <li >
                                <a href="//farseerfc.me/en/category/life.html"><i class="fa fa-folder-o"></i> Life</a>
                            </li>
                            <li class="active">
                                <a href="//farseerfc.me/en/category/tech.html"><i class="fa fa-folder-o"></i> Tech</a>
                            </li>
                        </ul>
                    </li>
                </ul>

                    <ul class="nav navbar-nav hidden-xs hidden-sm">
                        <li >
                            <a href="//farseerfc.me/en/category/import.html"><i class="fa fa-folder-o"></i> Import</a>
                        </li>
                        <li >
                            <a href="//farseerfc.me/en/category/life.html"><i class="fa fa-folder-o"></i> Life</a>
                        </li>
                        <li class="active">
                            <a href="//farseerfc.me/en/category/tech.html"><i class="fa fa-folder-o"></i> Tech</a>
                        </li>
                    </ul>



            <ul class="nav navbar-nav navbar-right hidden-sm hidden-md hidden-lg hidden-xl">
                <li class="dropdown hidden-md hidden-lg hidden-xl">
                    <a class="dropdown-toggle" data-toggle="dropdown" href="javascript:void(0)">
                        <i class="fa fa-search"></i><span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu">
                      <li><span>
                        <form class="navbar-search" action="/search.html">
                          <input type="text" class="search-query form-control col-lg-16" placeholder="Search" name="q" id="tipue_search_input" required>
                        </form></span>
                      </li>
                    </ul>
                </li>
            </ul>

            <ul class="nav navbar-right navbar-form hidden-xs">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query form-control col-lg-16" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
            </ul>

            <ul class="nav navbar-nav navbar-right hidden-xs">
              <li><a href="//farseerfc.me/en/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">All</span></a></li>
              <li><a href="//farseerfc.me/en/feeds/atom.xml" title="Atom feeds for all articles"><i class="fa fa-rss"></i></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container" style="min-height: 100%;height: auto !important;height: 100%;">
    <div class="row" style="padding-bottom:80px;padding-top:80px;">
        <div class="col-xl-21 col-lg-20 col-md-18">
            <div id="loading-block">
            <ol class="breadcrumb">
                <li><a href="//farseerfc.me/en/" title="Farseerfc's Nest"><i class="fa fa-home fa-lg"></i></a></li>
                <li><a href="//farseerfc.me/en/category/tech.html" title="tech">tech</a></li>
                <li class="active">ZFS 分層架構設計</li>
            </ol>
    <section id="content" class="article-content">
        <article>
            <header class="page-header jumbotron jumbotron-primary panel-primary" id="article-header">
                <div class="panel-heading">
                    <h1>
                        ZFS 分層架構設計
                        <a href="//farseerfc.me/en/../drafts/zfs-layered-architecture-design.html"
                           rel="bookmark"
                           class="btn btn-primary btn-lg"
                           title="Permalink to ZFS 分層架構設計">
                           <i class="mdi-action-launch"></i>
                        </a>
                    </h1>
                </div>
                <div class="panel-body">
<div class="post-info">
    <span class="published">
        <time datetime="2020-01-30T13:45:00+09:00"><i class="fa fa-calendar"></i> 2020年01月30日(週四)</time>
    </span>



<div class="btn-group translations">
<a href="javascript:void(0)" class="btn btn-primary dropdown-toggle" data-toggle="dropdown"><i class="mdi-action-translate"></i><span class="caret"></a>
<ul class="dropdown-menu">
<li class="active"><a href="//farseerfc.me/en/../drafts/zfs-layered-architecture-design.html">繁體</a></li><li><a href="//farseerfc.me/en/zhs/drafts/zfs-layered-architecture-design.html" class="translate">简体</a></li></ul>
</div>

    <a onclick="$.get('//farseerfc.me/en/zfs-layered-architecture-design.rst.html', function(data){$('#source-code').html(data)});$('#article-content').toggle();$('#source-content').toggle();" class="btn btn-primary" title="Show source code of this page"><i class="fa fa-code"></i></a>
    <a href="//farseerfc.me/en/zfs-layered-architecture-design.pdf" class="btn btn-primary" title="Show pdf version of this page" target="_blank"><i class="fa fa-file-pdf-o"></i></a>
    <a href="//farseerfc.me/en/zfs-layered-architecture-design.png" class="btn btn-primary" title="Show captured png of this page" target="_blank""><i class="fa fa-file-photo-o"></i></a>

<small><span><a href="//farseerfc.me/en/../drafts/zfs-layered-architecture-design.html#disqus_thread" class="btn btn-primary" data-disqus-identifier="zfs-layered-architecture-design" data-disqus-url="http://farseerfc.me/en/../drafts/zfs-layered-architecture-design.html"><i class="fa fa-comments-o"></i></a></span></small><span class="btn-group">
	<a href="//farseerfc.me/en/tag/zfs.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> zfs</a>
	<a href="//farseerfc.me/en/tag/layered.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> layered</a>
	<a href="//farseerfc.me/en/tag/architecture.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> architecture</a>
</span>



</div><!-- /.post-info -->                </div>
            </header>

            <div class="entry-content jumbotron" id="article-content">
                    <div class="panel panel-default">
                        <div class="panel-heading">
Table of Contents                        </div>
                        <div class="panel-boy">
                        <div class="toc" id="">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#id1" id="id4">早期架構</a></li>
<li><a class="reference internal" href="#id2" id="id5">子系統整體架構</a></li>
<li><a class="reference internal" href="#spa" id="id6">SPA</a></li>
<li><a class="reference internal" href="#vdev" id="id7">VDEV</a></li>
<li><a class="reference internal" href="#zio" id="id8">ZIO</a></li>
<li><a class="reference internal" href="#arc" id="id9">ARC</a></li>
<li><a class="reference internal" href="#l2arc" id="id10">L2ARC</a></li>
<li><a class="reference internal" href="#tol" id="id11">TOL</a></li>
<li><a class="reference internal" href="#dmu" id="id12">DMU</a></li>
<li><a class="reference internal" href="#zap" id="id13">ZAP</a></li>
<li><a class="reference internal" href="#dsl" id="id14">DSL</a></li>
<li><a class="reference internal" href="#zil" id="id15">ZIL</a></li>
<li><a class="reference internal" href="#zvol" id="id16">ZVOL</a></li>
<li><a class="reference internal" href="#zpl" id="id17">ZPL</a></li>
</ul>
</div>
                        </div>
                    </div>
                
<p>ZFS 在設計之初源自於 Sun 內部多次重寫 UFS 的嘗試，背負了重構 Solaris
諸多內核子系統的重任，從而不同於 Linux 的文件系統只負責文件系統的功能而把其餘功能（比如內存髒頁管理，
IO調度）交給內核更底層的子系統， ZFS 的整體設計更層次化並更獨立，很多部分可能和 Linux
內核已有的子系統有功能重疊。</p>
<p>這篇筆記試圖從 ZFS 的早期開發歷程開始，記錄一下 ZFS 分層架構中各個子系統之間的分工。
也有幾段 OpenZFS Summit 視頻佐以記錄那段歷史。</p>
<div class="panel panel-default">
<div class="panel-heading">
The Birth of ZFS by Jeff Bonwick</div>
<div class="panel-body">
<div align="left" class="youtube embed-responsive embed-responsive-16by9"><iframe allow="fullscreen" class="embed-responsive-item" frameborder="0" src="https://www.youtube.com/embed/dcV2PaMTAJ4"></iframe></div></div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
Story Time (Q&amp;A) with Matt and Jeff</div>
<div class="panel-body">
<div align="left" class="youtube embed-responsive embed-responsive-16by9"><iframe allow="fullscreen" class="embed-responsive-item" frameborder="0" src="https://www.youtube.com/embed/yNKZQBsTX08"></iframe></div></div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
ZFS First Mount by Mark Shellenbaum</div>
<div class="panel-body">
<div align="left" class="youtube embed-responsive embed-responsive-16by9"><iframe allow="fullscreen" class="embed-responsive-item" frameborder="0" src="https://www.youtube.com/embed/xMH5rCL8S2k"></iframe></div></div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
ZFS past &amp; future by Mark Maybee</div>
<div class="panel-body">
<div align="left" class="youtube embed-responsive embed-responsive-16by9"><iframe allow="fullscreen" class="embed-responsive-item" frameborder="0" src="https://www.youtube.com/embed/c1ek1tFjhH8"></iframe></div></div>
</div>
<div class="section" id="id1">
<h2><a class="toc-backref" href="#id4">早期架構</a></h2>
<p>早期 ZFS 在開發時大體可以分爲上下三層，分別是 ZPL， DMU 和 SPA ，這三層分別由三組人負責。</p>
<p>最初在 Sun 內部帶領 ZFS 開發的是 <a class="reference external" href="https://blogs.oracle.com/bonwick/">Jeff Bonwick</a>
，他首先有了對 ZFS 整體架構的構思，然後遊說 Sun 高層，親自組建起了 ZFS
開發團隊，招募了當時剛從大學畢業的 <a class="reference external" href="http://open-zfs.org/wiki/User:Mahrens">Matt Ahrens</a>
。作爲和 Sun 高層談妥的條件， Jeff 也必須負責 Solaris 整體的 Storage &amp; Filesystem Team
，於是他也從 Solaris 的 Storage Team 抽調了 UFS 部分的負責人 Mark Shellenbaum 和
Mark Maybee 來開發 ZFS 。而如今 Jeff 成立了獨立公司繼續開拓服務器存儲領域， Matt
是 OpenZFS 項目的負責人，兩位 Mark 則留在了 Sun/Oracle 成爲了 Oracle ZFS 分支的維護者。</p>
<p>在開發早期，作爲分工， Jeff 負責 ZFS 設計中最底層的 SPA ，提供多個存儲設備組成的存儲池抽象；
Matt 負責 ZFS 設計中最至關重要的 DMU 引擎，在塊設備基礎上提供具有事務語義的對象存儲；
而兩位 Mark 負責 ZFS 設計中直接面向用戶的 ZPL ，在 DMU 基礎上提供完整 POSIX 文件系統語義。</p>
</div>
<div class="section" id="id2">
<h2><a class="toc-backref" href="#id5">子系統整體架構</a></h2>
<p>首先 ZFS 整體架構如下圖，其中圓圈是 ZFS 給內核層的外部接口，方框是 ZFS 內部子系統：</p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">

<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: ZFS_Layer_Architecture Pages: 1 -->
<svg class="svg-responsive" height="570pt" viewbox="0.00 0.00 761.50 570.00" width="762pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g class="graph" id="graph0" transform="scale(1 1) rotate(0) translate(4 566)">
<title>ZFS_Layer_Architecture</title>
<polygon fill="#ffffff" points="-4,4 -4,-566 757.5,-566 757.5,4 -4,4" stroke="transparent"></polygon>
<g class="cluster" id="clust4">
<title>clusterTOL</title>
<g id="a_clust4"><a xlink:href="#tol" xlink:title="TOL">
<polygon fill="none" points="199,-227 199,-374 413,-374 413,-227 199,-227" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="306" y="-358.8">TOL</text>
</a>
</g>
</g>
<g class="cluster" id="clust8">
<title>clusterSPA</title>
<g id="a_clust8"><a xlink:href="#spa" xlink:title="SPA">
<polygon fill="none" points="266,-8 266,-155 422,-155 422,-8 266,-8" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="344" y="-139.8">SPA</text>
</a>
</g>
</g>
<!-- Filesystem API -->
<g class="node" id="node1">
<title>Filesystem API</title>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="309" y="-540.3">Filesystem API</text>
</g>
<!-- VFS -->
<g class="node" id="node5">
<title>VFS</title>
<ellipse cx="331" cy="-472" fill="none" rx="30.5947" ry="18" stroke="#000000"></ellipse>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="331" y="-468.3">VFS</text>
</g>
<!-- Filesystem API&#45;&gt;VFS -->
<g class="edge" id="edge1">
<title>Filesystem API-&gt;VFS</title>
<path d="M314.5515,-525.8314C316.9669,-517.9266 319.8511,-508.4872 322.525,-499.7365" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="325.9514,-500.4997 325.5265,-489.9134 319.257,-498.4541 325.9514,-500.4997" stroke="#000000"></polygon>
</g>
<!-- Block device API -->
<g class="node" id="node2">
<title>Block device API</title>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="684" y="-540.3">Block device API</text>
</g>
<!-- /dev/zvol/... -->
<g class="node" id="node6">
<title>/dev/zvol/...</title>
<ellipse cx="658" cy="-472" fill="none" rx="63.8893" ry="18" stroke="#000000"></ellipse>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="658" y="-468.3">/dev/zvol/...</text>
</g>
<!-- Block device API&#45;&gt;/dev/zvol/... -->
<g class="edge" id="edge2">
<title>Block device API-&gt;/dev/zvol/...</title>
<path d="M677.4391,-525.8314C674.5536,-517.8406 671.1018,-508.2819 667.913,-499.4514" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="671.1572,-498.1302 664.4687,-489.9134 664.5733,-500.5077 671.1572,-498.1302" stroke="#000000"></polygon>
</g>
<!-- ZFS Management API (libzfs) -->
<g class="node" id="node3">
<title>ZFS Management API (libzfs)</title>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="114" y="-540.3">ZFS Management API (libzfs)</text>
</g>
<!-- /dev/zfs ioctl -->
<g class="node" id="node7">
<title>/dev/zfs ioctl</title>
<ellipse cx="179" cy="-472" fill="none" rx="69.5877" ry="18" stroke="#000000"></ellipse>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="179" y="-468.3">/dev/zfs ioctl</text>
</g>
<!-- ZFS Management API (libzfs)&#45;&gt;/dev/zfs ioctl -->
<g class="edge" id="edge3">
<title>ZFS Management API (libzfs)-&gt;/dev/zfs ioctl</title>
<path d="M130.4022,-525.8314C138.1591,-517.2392 147.5526,-506.834 156.0055,-497.4708" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="158.7251,-499.6815 162.8282,-489.9134 153.5292,-494.9907 158.7251,-499.6815" stroke="#000000"></polygon>
</g>
<!-- NFS/Samba API (libshare) -->
<g class="node" id="node4">
<title>NFS/Samba API (libshare)</title>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="493" y="-540.3">NFS/Samba API (libshare)</text>
</g>
<!-- NFS/CIFS -->
<g class="node" id="node8">
<title>NFS/CIFS</title>
<ellipse cx="471" cy="-472" fill="none" rx="58.4896" ry="18" stroke="#000000"></ellipse>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="471" y="-468.3">NFS/CIFS</text>
</g>
<!-- NFS/Samba API (libshare)&#45;&gt;NFS/CIFS -->
<g class="edge" id="edge4">
<title>NFS/Samba API (libshare)-&gt;NFS/CIFS</title>
<path d="M487.4485,-525.8314C485.0697,-518.0463 482.2362,-508.7729 479.5967,-500.1347" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="482.8958,-498.954 476.6263,-490.4133 476.2013,-500.9996 482.8958,-498.954" stroke="#000000"></polygon>
</g>
<!-- ZPL -->
<g class="node" id="node9">
<title>ZPL</title>
<g id="a_node9"><a xlink:href="#zpl" xlink:title="ZPL">
<polygon fill="none" points="405,-418 351,-418 351,-382 405,-382 405,-418" stroke="#0000ff"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="378" y="-396.3">ZPL</text>
</a>
</g>
</g>
<!-- VFS&#45;&gt;ZPL -->
<g class="edge" id="edge5">
<title>VFS-&gt;ZPL</title>
<path d="M342.1383,-454.937C347.6103,-446.5544 354.3323,-436.2569 360.4719,-426.8516" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="363.5846,-428.4862 366.12,-418.1992 357.7229,-424.6598 363.5846,-428.4862" stroke="#000000"></polygon>
</g>
<!-- ZVOL -->
<g class="node" id="node10">
<title>ZVOL</title>
<g id="a_node10"><a xlink:href="#zvol" xlink:title="ZVOL">
<polygon fill="none" points="622.5,-418 563.5,-418 563.5,-382 622.5,-382 622.5,-418" stroke="#0000ff"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="593" y="-396.3">ZVOL</text>
</a>
</g>
</g>
<!-- /dev/zvol/...&#45;&gt;ZVOL -->
<g class="edge" id="edge6">
<title>/dev/zvol/...-&gt;ZVOL</title>
<path d="M641.9326,-454.2022C634.1787,-445.6134 624.7314,-435.1486 616.2132,-425.7131" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="618.6331,-423.1705 609.3341,-418.0931 613.4372,-427.8612 618.6331,-423.1705" stroke="#000000"></polygon>
</g>
<!-- DSL -->
<g class="node" id="node13">
<title>DSL</title>
<g id="a_node13"><a xlink:href="#dsl" xlink:title="DSL">
<polygon fill="none" points="261,-343 207,-343 207,-307 261,-307 261,-343" stroke="#0000ff"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="234" y="-321.3">DSL</text>
</a>
</g>
</g>
<!-- /dev/zfs ioctl&#45;&gt;DSL -->
<g class="edge" id="edge11">
<title>/dev/zfs ioctl-&gt;DSL</title>
<path d="M185.7441,-453.9749C195.228,-428.6271 212.5859,-382.2341 223.6938,-352.5458" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="226.9745,-353.7649 227.2008,-343.1725 220.4184,-351.3119 226.9745,-353.7649" stroke="#000000"></polygon>
</g>
<!-- VDEV -->
<g class="node" id="node18">
<title>VDEV</title>
<g id="a_node18"><a xlink:href="#vdev" xlink:title="VDEV">
<polygon fill="none" points="333.5,-52 274.5,-52 274.5,-16 333.5,-16 333.5,-52" stroke="#0000ff"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="304" y="-30.3">VDEV</text>
</a>
</g>
</g>
<!-- /dev/zfs ioctl&#45;&gt;VDEV -->
<g class="edge" id="edge23">
<title>/dev/zfs ioctl-&gt;VDEV</title>
<path d="M179,-453.8955C179,-426.1512 179,-371.4479 179,-325 179,-325 179,-325 179,-181 179,-126.7258 229.0637,-82.2724 265.8246,-56.9468" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="268.0086,-59.6969 274.3767,-51.2295 264.1182,-53.8776 268.0086,-59.6969" stroke="#000000"></polygon>
</g>
<!-- NFS/CIFS&#45;&gt;ZPL -->
<g class="edge" id="edge7">
<title>NFS/CIFS-&gt;ZPL</title>
<path d="M448.9603,-454.937C437.2398,-445.8631 422.621,-434.5453 409.703,-424.5443" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="411.5571,-421.5534 401.5073,-418.1992 407.2719,-427.0885 411.5571,-421.5534" stroke="#000000"></polygon>
</g>
<!-- DMU -->
<g class="node" id="node14">
<title>DMU</title>
<g id="a_node14"><a xlink:href="#dmu" xlink:title="DMU">
<polygon fill="none" points="405,-271 351,-271 351,-235 405,-235 405,-271" stroke="#0000ff"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="378" y="-249.3">DMU</text>
</a>
</g>
</g>
<!-- NFS/CIFS&#45;&gt;DMU -->
<g class="edge" id="edge16">
<title>NFS/CIFS-&gt;DMU</title>
<path d="M469.9525,-453.9941C467.4413,-422.3669 459.0978,-355.5868 432,-307 426.0562,-296.3427 417.4063,-286.3685 408.7644,-277.9638" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="410.958,-275.2252 401.2403,-271.0042 406.2047,-280.364 410.958,-275.2252" stroke="#000000"></polygon>
</g>
<!-- ZAP -->
<g class="node" id="node11">
<title>ZAP</title>
<g id="a_node11"><a xlink:href="#zap" xlink:title="ZAP">
<polygon fill="none" points="405,-343 351,-343 351,-307 405,-307 405,-343" stroke="#0000ff"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="378" y="-321.3">ZAP</text>
</a>
</g>
</g>
<!-- ZPL&#45;&gt;ZAP -->
<g class="edge" id="edge8">
<title>ZPL-&gt;ZAP</title>
<path d="M378,-381.8446C378,-373.3401 378,-363.0076 378,-353.4964" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="381.5001,-353.2481 378,-343.2482 374.5001,-353.2482 381.5001,-353.2481" stroke="#000000"></polygon>
</g>
<!-- ZIL -->
<g class="node" id="node12">
<title>ZIL</title>
<g id="a_node12"><a xlink:href="#zil" xlink:title="ZIL">
<polygon fill="none" points="333,-343 279,-343 279,-307 333,-307 333,-343" stroke="#0000ff"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="306" y="-321.3">ZIL</text>
</a>
</g>
</g>
<!-- ZPL&#45;&gt;ZIL -->
<g class="edge" id="edge9">
<title>ZPL-&gt;ZIL</title>
<path d="M350.8999,-381.8614C347.7779,-379.3607 344.7368,-376.7146 342,-374 335.3204,-367.3746 328.9284,-359.4234 323.4333,-351.8725" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="326.0323,-349.482 317.4311,-343.2958 320.2972,-353.4956 326.0323,-349.482" stroke="#000000"></polygon>
</g>
<!-- ZPL&#45;&gt;DMU -->
<g class="edge" id="edge13">
<title>ZPL-&gt;DMU</title>
<path d="M405.2911,-384.8579C408.7978,-381.7348 411.8941,-378.1186 414,-374 427.5564,-347.487 422.6291,-335.5001 414,-307 411.0436,-297.2355 405.6748,-287.6229 399.97,-279.2762" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="402.7129,-277.0973 393.9905,-271.0831 397.0586,-281.2239 402.7129,-277.0973" stroke="#000000"></polygon>
</g>
<!-- ZVOL&#45;&gt;DMU -->
<g class="edge" id="edge14">
<title>ZVOL-&gt;DMU</title>
<path d="M574.6293,-381.7001C553.9977,-361.7621 518.9443,-329.6856 485,-307 462.7964,-292.1609 435.9621,-278.6282 414.7211,-268.8216" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="415.9445,-265.5333 405.392,-264.5868 413.051,-271.9073 415.9445,-265.5333" stroke="#000000"></polygon>
</g>
<!-- ZAP&#45;&gt;DMU -->
<g class="edge" id="edge12">
<title>ZAP-&gt;DMU</title>
<path d="M378,-306.8314C378,-299.131 378,-289.9743 378,-281.4166" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="381.5001,-281.4132 378,-271.4133 374.5001,-281.4133 381.5001,-281.4132" stroke="#000000"></polygon>
</g>
<!-- ZIO -->
<g class="node" id="node16">
<title>ZIO</title>
<g id="a_node16"><a xlink:href="#zio" xlink:title="ZIO">
<polygon fill="none" points="328,-124 274,-124 274,-88 328,-88 328,-124" stroke="#0000ff"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="301" y="-102.3">ZIO</text>
</a>
</g>
</g>
<!-- ZIL&#45;&gt;ZIO -->
<g class="edge" id="edge18">
<title>ZIL-&gt;ZIO</title>
<path d="M305.5823,-306.7049C304.7088,-268.4458 302.6841,-179.7623 301.6432,-134.1742" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="305.1404,-134.0065 301.413,-124.089 298.1423,-134.1664 305.1404,-134.0065" stroke="#000000"></polygon>
</g>
<!-- DSL&#45;&gt;ZAP -->
<g class="edge" id="edge10">
<title>DSL-&gt;ZAP</title>
<path d="M244.1055,-343.1461C250.4741,-353.2781 259.4741,-365.5281 270,-374 273.41,-376.7445 274.7181,-377.0913 279,-378 302.4772,-382.9822 309.5228,-382.9822 333,-378 347.0198,-375.0248 357.7149,-363.4083 365.1534,-351.8062" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="368.2242,-353.4877 370.2081,-343.0803 362.167,-349.979 368.2242,-353.4877" stroke="#000000"></polygon>
</g>
<!-- DSL&#45;&gt;DMU -->
<g class="edge" id="edge15">
<title>DSL-&gt;DMU</title>
<path d="M261.0853,-311.4574C283.7693,-300.1153 316.3567,-283.8217 341.3681,-271.316" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="343.1675,-274.3294 350.5466,-266.7267 340.037,-268.0684 343.1675,-274.3294" stroke="#000000"></polygon>
</g>
<!-- ARC -->
<g class="node" id="node15">
<title>ARC</title>
<g id="a_node15"><a xlink:href="#arc" xlink:title="ARC">
<polygon fill="none" points="405,-199 351,-199 351,-163 405,-163 405,-199" stroke="#0000ff"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="378" y="-177.3">ARC</text>
</a>
</g>
</g>
<!-- DMU&#45;&gt;ARC -->
<g class="edge" id="edge17">
<title>DMU-&gt;ARC</title>
<path d="M378,-234.8314C378,-227.131 378,-217.9743 378,-209.4166" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="381.5001,-209.4132 378,-199.4133 374.5001,-209.4133 381.5001,-209.4132" stroke="#000000"></polygon>
</g>
<!-- ARC&#45;&gt;ZIO -->
<g class="edge" id="edge19">
<title>ARC-&gt;ZIO</title>
<path d="M350.9193,-165.8576C346.0456,-162.5797 341.1891,-158.9116 337,-155 330.0127,-148.4756 323.4638,-140.4351 317.9176,-132.7678" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="320.4623,-130.2932 311.9011,-124.0516 314.7014,-134.2697 320.4623,-130.2932" stroke="#000000"></polygon>
</g>
<!-- L2ARC -->
<g class="node" id="node17">
<title>L2ARC</title>
<g id="a_node17"><a xlink:href="#l2arc" xlink:title="L2ARC">
<polygon fill="none" points="414,-124 346,-124 346,-88 414,-88 414,-124" stroke="#0000ff"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="380" y="-102.3">L2ARC</text>
</a>
</g>
</g>
<!-- ARC&#45;&gt;L2ARC -->
<g class="edge" id="edge20">
<title>ARC-&gt;L2ARC</title>
<path d="M378.4841,-162.8446C378.7109,-154.3401 378.9865,-144.0076 379.2401,-134.4964" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="382.7455,-134.3379 379.5134,-124.2482 375.748,-134.1513 382.7455,-134.3379" stroke="#000000"></polygon>
</g>
<!-- ZIO&#45;&gt;VDEV -->
<g class="edge" id="edge22">
<title>ZIO-&gt;VDEV</title>
<path d="M301.757,-87.8314C302.0779,-80.131 302.4594,-70.9743 302.816,-62.4166" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="306.3133,-62.5503 303.2328,-52.4133 299.3194,-62.2589 306.3133,-62.5503" stroke="#000000"></polygon>
</g>
<!-- L2ARC&#45;&gt;ZIO -->
<g class="edge" id="edge21">
<title>L2ARC-&gt;ZIO</title>
<path d="M345.9775,-106C343.3786,-106 340.7797,-106 338.1807,-106" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="338.1563,-102.5001 328.1563,-106 338.1562,-109.5001 338.1563,-102.5001" stroke="#000000"></polygon>
</g>
</g>
</svg>
<p>接下來從底層往上介紹一下各個子系統的全稱和職能。</p>
</div>
<div class="section" id="spa">
<h2><a class="toc-backref" href="#id6">SPA</a></h2>
<p>Storage Pool Allocator</p>
<p>從內核提供的多個塊設備中抽象出存儲池的子系統。 SPA 進一步分爲 ZIO 和 VDEV 兩大部分。</p>
<p>SPA 對 DMU 提供的接口不同於傳統的塊設備接口，完全利用了 CoW FS 對寫入位置不敏感的特點。
傳統的塊設備接口通常是寫入時指定一個寫入地址，把緩衝區寫到磁盤指定的位置上，而 DMU 可以讓 SPA
做兩種操作：</p>
<ol class="arabic simple">
<li><code class="code">
write</code>
 ， DMU 交給 SPA 一個數據塊的內存指針， SPA
負責找設備寫入這個數據塊，然後返回給 DMU 一個 block pointer 。</li>
<li><code class="code">
read</code>
 ，DMU 交給 SPA 一個 block pointer ，SPA 讀取設備並返回給 DMU
完整的數據塊。</li>
</ol>
</div>
<div class="section" id="vdev">
<h2><a class="toc-backref" href="#id7">VDEV</a></h2>
<p>Virtual DEVice</p>
<p>作用相當於 Linux 內核的 Device Mapper 層或者 FreeBSD GEOM 層，提供 Stripe/Mirror/RAIDZ
之類的多設備存儲池管理和抽象。 ZFS 中的 vdev 形成一個樹狀結構，在樹的底層是從內核提供的物理設備，
其上是虛擬的塊設備。每個虛擬塊設備對上對下都是塊設備接口，除了底層的物理設備之外，位於中間層的
vdev 需要負責地址映射、容量轉換等計算過程。</p>
</div>
<div class="section" id="zio">
<h2><a class="toc-backref" href="#id8">ZIO</a></h2>
<p>ZFS I/O</p>
<p>作用相當於內核的 IO scheduler 和 pagecache write back 機制。
ZIO 內部使用流水線和事件驅動機制，避免讓上層的 ZFS 線程阻塞等待在 IO 操作上。
ZIO 把一個上層的寫請求轉換成多個寫操作，負責把這些寫操作合併到
transaction group 提交事務組。 ZIO 也負責將讀寫請求按同步還是異步分成不同的讀寫優先級並實施優先級調度，
在 <a class="reference external" href="https://github.com/zfsonlinux/zfs/wiki/ZIO-Scheduler">OpenZFS 項目 wiki 頁有一篇描述 ZIO 調度</a>
的細節。</p>
<p>除了調度之外， ZIO 層還負責在讀寫流水線中拆解和拼裝數據塊。上層 DMU 交給 SPA 的數據塊有固定大小，
目前默認是 128KiB ，pool 整體的參數可以調整塊大小在 8KiB 到 8MiB 之間。ZIO
拿到整塊大小的數據塊之後，在流水線中可以對數據塊做如下操作：</p>
<ol class="arabic simple">
<li>用壓縮算法，壓縮/解壓數據塊。</li>
<li>查詢 dedup table ，對數據塊去重。</li>
<li>如果底層分配器不能分配完整的 128KiB （或別的大小），那麼嘗試分配多個小塊，多個用 512B
的指針間接塊連起多個小塊的
<a class="reference external" href="https://utcc.utoronto.ca/~cks/space/blog/solaris/ZFSGangBlocks">gang block</a>
拼成一個大塊。</li>
</ol>
<p>可見經過 ZIO 流水線之後，數據塊不再是統一大小，這使得 ZFS 用在 4K 對齊的磁盤或者 SSD
上有了一些新的挑戰。</p>
</div>
<div class="section" id="arc">
<h2><a class="toc-backref" href="#id9">ARC</a></h2>
<p>Adaptive Replacement Cache</p>
<p>作用相當於 Linux/Solaris/FreeBSD 中傳統的 page/buffer cache 。
和傳統 pagecache 使用 LRU (Least Recently Used) 之類的算法剔除緩存頁不同， ARC
算法試圖在 LRU 和 LFU(Least Frequently Used) 之間尋找平衡，從而複製大文件之類的線性大量
IO 操作不至於讓緩存失效率猛增。</p>
<p>不過 ZFS 採用它自有的 ARC 一個顯著缺點在於，不能和內核已有的 pagecache 機制相互配合，尤其在
系統內存壓力很大的情況下，內核與 ZFS 無關的其餘部分可能難以通知 ARC 釋放內存。所以 ARC
是 ZFS 消耗內存的大戶之一（另一個是可選的 dedup table），也是
<a class="reference external" href="http://open-zfs.org/wiki/Performance_tuning#Adaptive_Replacement_Cache">ZFS 性能調優</a>
的重中之重。</p>
<p>和很多傳言所說的不同， ARC 的內存壓力問題不僅在 Linux 內核會有，在 FreeBSD 和
Solaris/Illumos 上也是同樣，這個在
<a class="reference external" href="https://youtu.be/xMH5rCL8S2k?t=997">ZFS First Mount by Mark Shellenbaum 的問答環節 16:37 左右有提到</a>
。其中 Mark Shellenbaum 提到 Matt 覺得讓 ARC 併入現有 pagecache
子系統的工作量太大，難以實現。</p>
</div>
<div class="section" id="l2arc">
<h2><a class="toc-backref" href="#id10">L2ARC</a></h2>
<p>Level 2 Adaptive Replacement Cache</p>
<p>這是用 ARC 算法實現的二級緩存，存在於高速存儲設備上。通常 ZFS 可以配置一塊 SSD 作爲高速緩存，
減輕內存 ARC 的負擔並增加緩存命中率。</p>
</div>
<div class="section" id="tol">
<h2><a class="toc-backref" href="#id11">TOL</a></h2>
<p>Transactional Object Layer</p>
<p>這一部分子系統在數據塊的基礎上提供一個事務性的對象語義層。最主要的部分是 DMU 層。</p>
</div>
<div class="section" id="dmu">
<h2><a class="toc-backref" href="#id12">DMU</a></h2>
<p>Data Management Unit</p>
<p>在塊的基礎上提供「對象」的抽象。每個「對象」可以是一個文件，或者是別的 ZFS 內部需要記錄的東西。</p>
<p>DMU 這個名字最初是 Jeff 想類比於操作系統中內存管理的 MMU(Memory Management Unit)，
Jeff 希望 ZFS 中增加和刪除文件就像內存分配一樣簡單，增加和移除塊設備就像增加內存一樣簡單，
由 DMU 負責從存儲池中分配和釋放數據塊，對上提供事務性語義，管理員不需要管理文件存儲在什麼存儲設備上。
這裏事務性語義指對文件的修改要麼完全成功，要麼完全失敗，不會處於中間狀態，這靠 DMU 的 CoW
語義實現。</p>
<p>DMU 實現了對象級別的 CoW 語義，從而任何經過了 DMU 做讀寫的子系統都具有了 CoW 的特徵，
這不僅包括文件、文件夾這些 ZPL 層需要的東西，也包括文件系統內部用的 spacemap 之類的設施。
相反，不經過 DMU 的子系統則可能沒法保證事務語義。這裏一個特例是 ZIL ，一定程度上繞過了 DMU
直接寫日誌。說一定程度是因爲 ZIL 仍然靠 DMU 來擴展長度，當一個塊寫滿日誌之後需要等 DMU
分配一個新塊，在分配好的塊內寫日誌則不需要經過 DMU 。</p>
<p>上面提到 SPA 的時候也講了 DMU 和 SPA 之間不同於普通塊設備抽象的接口，這使得 DMU
按整塊的大小分配空間。當對象的大小超過一個固定的塊大小時（4K~8M，默認128K），DMU 採用了傳統
Unix 文件系統的間接塊（indirect block）的方案，不同於更現代的文件系統如
ext4/xfs/btrfs/ntfs/hfs+ 這些使用 extent 記錄連續的物理地址分配。
間接塊簡單來說就是寫滿了 block pointer 的塊組成的樹狀結構。 DMU 採用間接塊而不是 extent
，使得 ZFS 的空間分配更趨向碎片化。</p>
</div>
<div class="section" id="zap">
<h2><a class="toc-backref" href="#id13">ZAP</a></h2>
<p>ZFS Attribute Processor</p>
<p>在 DMU 提供的「對象」抽象基礎上提供緊湊的 name/value 映射存儲，
從而文件夾內容列表、文件擴展屬性之類的都是基於 ZAP 來存。 ZAP 在內部分爲兩種存儲表達：
microZAP 和 fatZAP 。</p>
<p>一個 microZAP 佔用一整塊數據塊，能存 name 長度小於 50 字符並且 value 是 uint64_t 的表項，
每個表項 64 字節。 fatZAP 則是個樹狀結構，能存更多更複雜的東西。可見 microZAP
非常適合表述一個普通大小的文件夾裏面包含到很多普通文件 inode （ZFS 是 dnode）的引用。</p>
<p>在 <a class="reference external" href="https://youtu.be/xMH5rCL8S2k?t=526">ZFS First Mount by Mark Shellenbaum</a>
中提到，最初 ZPL 中關於文件的所有屬性（包括訪問時間、權限、大小之類所有文件都有的）都是基於
ZAP 來存，然後文件夾內容列表有另一種數據結構 ZDS ，後來常見的文件屬性在 ZPL
有了專用的緊湊數據結構，而 ZDS 則漸漸融入了 ZAP 。</p>
</div>
<div class="section" id="dsl">
<h2><a class="toc-backref" href="#id14">DSL</a></h2>
<p>Dataset and Snapshot Layer</p>
<p>數據集和快照層。</p>
</div>
<div class="section" id="zil">
<h2><a class="toc-backref" href="#id15">ZIL</a></h2>
<p>ZFS Intent Log ，記錄兩次完整事務語義提交之間的 log ，用來加速實現 fsync 之類的保證。</p>
</div>
<div class="section" id="zvol">
<h2><a class="toc-backref" href="#id16">ZVOL</a></h2>
<p>ZFS VOLume</p>
<p>有點像 loopback block device ，暴露一個塊設備的接口，其上可以創建別的
FS 。對 ZFS 而言實現 ZVOL 的意義在於它是比文件更簡單的接口所以一開始先實現的它，而且
<a class="reference external" href="https://youtu.be/xMH5rCL8S2k?t=298">早期 Solaris 沒有 thin provisioning storage pool 的時候可以用它模擬很大的塊設備，測試 Solaris UFS 對 TB 級存儲的支持情況</a>。</p>
</div>
<div class="section" id="zpl">
<h2><a class="toc-backref" href="#id17">ZPL</a></h2>
<p>ZFS Posix Layer ，提供符合 POSIX 文件系統的語義，也就是包括文件、目錄這些抽象以及
inode 屬性、權限那些，對一個普通 FS 而言用戶直接接觸的部分。</p>
</div>

            </div>
            <div class="entry-content jumbotron" id="source-content" style="display: none">
                <!-- <pre><code id="source-code">
                </code></pre> -->
                <div id="source-code"></div>
            </div>
            <!-- /.entry-content -->

            <div class="row" id="prevnext">
                <div class="col-xs-12">
                </div>
                <div class="col-xs-12">
                </div>
            </div>

            <div class="panel panel-default" id="series">
                <div class="panel-heading">
                  <h4>
This is part <built-in method index of str object at 0x7fb0eea83e10> of the "" series:                  </h4>
                </div>
                <ul class="list-group">
                </ul>
            </div>

<section class="comments" id="comments">
    <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
      <div class="panel panel-primary">
        <div class="panel-heading" role="tab" id="disqus-heading">
          <h4 class="panel-title">
            <a data-toggle="collapse" data-parent="#accordion" href="#disqus-comments" aria-expanded="false" aria-controls="disqus-comments">
              <i class="fa fa-comments-o"></i> Disqus comments            </a>
          </h4>
        </div>
        <div id="disqus-comments" class="panel-collapse collapse" role="tabpanel" aria-labelledby="disqus-heading">
          <div class="panel-body">
            <div class="tab-pane fade active in" id="disqus-comments">
                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'farseerfcgithub'; // required: replace example with your forum shortname

                            var disqus_identifier = 'zfs-layered-architecture-design';
                        var disqus_url = 'http://farseerfc.me/en/../drafts/zfs-layered-architecture-design.html';

                    var disqus_config = function () {

                        this.language = "zh";
                    };

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function () {
                        var dsq = document.createElement('script');
                        dsq.type = 'text/javascript';
                        dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
                    Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
          </div>
        </div>
      </div>
    </div>
</section>        </article>
    </section>


            </div>
<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <a data-dismiss="modal" href="javascript:void(0);">
            <img id="mimg" src="" style="width:100%;height:auto">
          </a>
        </div>
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
        </div>
        <div class="col-xl-3 col-lg-4 col-md-6" id="sidebar">
            <aside>

<section>
    <div class="sidebar-container">
<div class="sidebar-item ">
<div class="panel panel-default">
	<div class="panel-heading">
        <h4>
<i class="fa fa-user fa-lg"></i>
<a href="//farseerfc.me/en/pages/about.html">
About farseerfc</a>
        </h4>
    </div>
<div class="panel-body" id="aboutme">
        <a href="//farseerfc.me/en/pages/about.html"><img width="100%" src="//farseerfc.me/en/../images/avatar.jpg"/></a>
    <h3 style="text-align:center">
<a href="https://sak.uy/"                  target="_blank">
<i class="fa fa-music" style="text-align:center"></i></a>
<a href="https://twitter.com/farseerfc"                  target="_blank">
<i class="fa fa-twitter" style="text-align:center"></i></a>
<a href="https://github.com/farseerfc"                   target="_blank">
<i class="fa fa-github" style="text-align:center"></i></a>
<a href="http://www.facebook.com/farseerfc"              target="_blank">
<i class="fa fa-facebook" style="text-align:center"></i></a>
<a href="https://plus.google.com/u/0/+JiachenYang/posts" target="_blank">
<i class="fa fa-google-plus" style="text-align:center"></i></a>
<a href="mailto:farseerfc@gmail.com" target="_blank">
<i class="mdi-communication-email" style="text-align:center"></i></a>
</h3>

</div>
</div>
</div>





<div class="sidebar-item hidden-xs">
<div class="panel panel-default">
	<div class="panel-heading">
        <h4>
<a href="//farseerfc.me/en/tags.html"><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></a>
        </h4>
    </div>
<div class="panel-body">
    <ul class="list-group list-inline tagcloud" id="tags">
            <li class="list-group-item tag-1">
                <a href="//farseerfc.me/en/tag/python.html">
                    python <sup> 3</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/pacvis.html">
                    pacvis <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/pacman.html">
                    pacman <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/arch.html">
                    arch <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-1">
                <a href="//farseerfc.me/en/tag/linux.html">
                    linux <sup> 3</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/pacgraph.html">
                    pacgraph <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/kde5.html">
                    kde5 <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/plasma.html">
                    plasma <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/gnome3.html">
                    gnome3 <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/will.html">
                    will <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/you.html">
                    you <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/marry.html">
                    marry <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/me.html">
                    me <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/msr.html">
                    msr <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/icse.html">
                    icse <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/mining.html">
                    mining <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/software.html">
                    software <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/repository.html">
                    repository <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/ruby.html">
                    ruby <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/template.html">
                    template <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/c.html">
                    C <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/pelican.html">
                    pelican <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-2">
                <a href="//farseerfc.me/en/tag/microsoft.html">
                    microsoft <sup> 2</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/acpi.html">
                    acpi <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/java.html">
                    java <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/music.html">
                    music <sup> 1</sup>
                </a>
            </li>
    </ul>
</div>
</div>
</div>

<div class="sidebar-item hidden-xs">
<div class="panel panel-default">
	<div class="panel-heading">
        <h4>
<i class="fa fa-github fa-lg"></i><span class="icon-label">GitHub Repos</span>
        </h4>
    </div>
    <div class="panel-body">
        <div id="gh_repos">
            <p class="list-group-item">Status updating...</p>
        </div>
            <a href="https://github.com/farseerfc">@farseerfc</a> on GitHub<br>
    </div>
</div>
</div>
<div class="sidebar-item hidden-xs">
<div class="panel panel-default">
	<div class="panel-heading">
        <h4>
<a href="https://sak.uy/">
<i class="fa fa-home fa-lg"></i><span class="icon-label">Sakuya的音樂盒</span>
</a>
        </h4>
    </div>
    <div class="panel-body">
        <div id="other_blog_posts">
            <p class="list-group-item">Status updating...</p>
        </div>
    </div>
</div>
</div>

    </div>
</section>
        <div class="panel panel-default hidden-xs hidden-sm" id="affix-toc">
            <div class="panel-heading"><h4>
Table of Contents</h4>
            </div>
            <div class="panel-boy">
            <div class="toc" id="">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#id1" id="id4">早期架構</a></li>
<li><a class="reference internal" href="#id2" id="id5">子系統整體架構</a></li>
<li><a class="reference internal" href="#spa" id="id6">SPA</a></li>
<li><a class="reference internal" href="#vdev" id="id7">VDEV</a></li>
<li><a class="reference internal" href="#zio" id="id8">ZIO</a></li>
<li><a class="reference internal" href="#arc" id="id9">ARC</a></li>
<li><a class="reference internal" href="#l2arc" id="id10">L2ARC</a></li>
<li><a class="reference internal" href="#tol" id="id11">TOL</a></li>
<li><a class="reference internal" href="#dmu" id="id12">DMU</a></li>
<li><a class="reference internal" href="#zap" id="id13">ZAP</a></li>
<li><a class="reference internal" href="#dsl" id="id14">DSL</a></li>
<li><a class="reference internal" href="#zil" id="id15">ZIL</a></li>
<li><a class="reference internal" href="#zvol" id="id16">ZVOL</a></li>
<li><a class="reference internal" href="#zpl" id="id17">ZPL</a></li>
</ul>
</div>
            </div>
        </div>
            </aside>
        </div>
    </div>
</div>


<footer id="fcfooter">
   <hr/>
   <div class="container">
      <div class="row">
         <div class="col-md-24">
         <p><small>
            &copy; 2016 farseerfc
            &middot; Powered by            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a> generator                <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a>
    <!-- Content -->
  <!-- licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution 4.0 International License</a>, except where indicated otherwise. -->

         </small></p>
         </div>
      </div>
   </div>
   <a href="#" class="btn btn-primary btn-fab btn-raised mdi-editor-vertical-align-top withripple" style="position:fixed;bottom:30px;right:30px;z-index:1000"></a>
</footer>
<script src="//farseerfc.me/en/../theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="//farseerfc.me/en/../theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="//farseerfc.me/en/../theme/js/respond.min.js"></script>

    <!-- GitHub JS -->
    <script type="text/javascript">
        $(document).ready(function () {
            if (!window.jXHR) {
                var jxhr = document.createElement('script');
                jxhr.type = 'text/javascript';
                jxhr.src = '//farseerfc.me/en/../theme/js/jXHR.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(jxhr, s);
            }

            github.showRepos({
                user: 'farseerfc',
                count: 5,
                skip_forks: false,
                target: '#gh_repos'
            });
        });
    </script>
    <script src="//farseerfc.me/en/../theme/js/github.js" type="text/javascript"></script>
    <!-- End GitHub JS Code -->
<!-- Other Blog JS -->
<script type="text/javascript">
    $(document).ready(function () {
        if (!window.jXHR) {
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '//farseerfc.me/en/../theme/js/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }
        other_blog.showRepos({
            url: 'https://sak.uy/',
            target: '#other_blog_posts'
        });
    });
</script>
<script src="//farseerfc.me/en/../theme/js/other_blog.js" type="text/javascript"></script>
<!-- End Other Blog JS Code -->
    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'farseerfcgithub'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-29540705-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->

<script src="//farseerfc.me/en/../theme/js/ripples.min.js"></script>
<script src="//farseerfc.me/en/../theme/js/material.min.js"></script>
<script src="//farseerfc.me/en/../theme/js/jquery.bootstrap-autohidingnavbar.min.js"></script>
<script>
    $(document).ready(function() {
        $.material.init();
        $("div.navbar").autoHidingNavbar();
        $(".img-responsive").css("cursor","pointer").on('click',function(){
            var sr=$(this).attr('src');
            $('#mimg').attr('src',sr);
            $('#myModal').modal('show');
        });
        $('#affix-toc').affix({
          offset: {
            top: function(){
                if($('#affix-toc').hasClass("affix"))
                    return $('#sidebar').height();
                return $('#sidebar').height() - $('#affix-toc').height();
            },
            bottom: function (){
                return $("#fcfooter").offset().top -
                    $("#article-content").offset().top -
                    $("#article-content").height() + 20;
            }
          }
        });
        $('#affix-toc').width($('#sidebar').width());
    });
    $(window).resize(function () {
       $('#affix-toc').width($('#sidebar').width());
    });
</script>

</body>
</html>