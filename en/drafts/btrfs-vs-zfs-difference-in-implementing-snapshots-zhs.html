<!DOCTYPE html>
<html lang="zh-Hans"
>
<head>
    <title>Btrfs vs ZFS 实现 snapshot 的差异 - Farseerfc's Nest</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <meta name="theme-color" content="#6b5594">
    <meta name="msapplication-navbutton-color" content="#6b5594">
    <meta name="apple-mobile-web-app-status-bar-style" content="#6b5594">
    <link rel="manifest" href="/manifest.json">


<link rel="apple-touch-icon" sizes="180x180" href="//farseerfc.me/en/images/apple-touch-icon.png">
<link rel="icon" type="image/png" href="//farseerfc.me/en/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="//farseerfc.me/en/images/favicon-16x16.png" sizes="16x16">
<link rel="mask-icon" href="//farseerfc.me/en/images/safari-pinned-tab.svg" color="#603cba">

<link rel="canonical" href="//farseerfc.me/en/zhs/drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html">

        <meta name="author" content="farseerfc" />
        <meta name="keywords" content="btrfs,zfs,cow,snapshot,clone,subvolume,dedup,reflink" />
        <meta name="description" content="Btrfs 和 ZFS 都是开源的写时拷贝（Copy on Write, CoW）文件系统，都提供了相似的子卷管理和 快照(snapshot）的功能。网上有不少文章都评价 ZFS 实现 CoW FS 的创新之处，进而想说「 Btrfs 只是 Linux/GPL 阵营对 ZFS 的拙劣抄袭」。或许（在存储领域人尽皆知而在领域外）鲜有人知，在 ZFS 之前就有 NetApp 的商业产品 WAFL(Write Anywhere File Layout) 实现了 CoW 语义的文件系统，并且集成了快照和卷管理之类的功能。描述 btrfs 原型设计的 论文 和 发表幻灯片 …" />

        <meta property="og:site_name" content="Farseerfc's Nest" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Btrfs vs ZFS 实现 snapshot 的差异"/>
        <meta property="og:url" content="//farseerfc.me/en/zhs/drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html"/>
        <meta property="og:description" content="Btrfs 和 ZFS 都是开源的写时拷贝（Copy on Write, CoW）文件系统，都提供了相似的子卷管理和 快照(snapshot）的功能。网上有不少文章都评价 ZFS 实现 CoW FS 的创新之处，进而想说「 Btrfs 只是 Linux/GPL 阵营对 ZFS 的拙劣抄袭」。或许（在存储领域人尽皆知而在领域外）鲜有人知，在 ZFS 之前就有 NetApp 的商业产品 WAFL(Write Anywhere File Layout) 实现了 CoW 语义的文件系统，并且集成了快照和卷管理之类的功能。描述 btrfs 原型设计的 论文 和 发表幻灯片 …"/>
        <meta property="article:published_time" content="2020-01-01" />
            <meta property="article:section" content="tech" />
            <meta property="article:tag" content="btrfs" />
            <meta property="article:tag" content="zfs" />
            <meta property="article:tag" content="cow" />
            <meta property="article:tag" content="snapshot" />
            <meta property="article:tag" content="clone" />
            <meta property="article:tag" content="subvolume" />
            <meta property="article:tag" content="dedup" />
            <meta property="article:tag" content="reflink" />
            <meta property="article:author" content="farseerfc" />
        <meta property="og:image"
                  content="//farseerfc.me/en/btrfs-vs-zfs-difference-in-implementing-snapshots.png"/>



    <!-- Bootstrap -->
        <link href="//farseerfc.me/en/../theme/css/bootstrap.min.css" rel="stylesheet">

    <link href="//farseerfc.me/en/../theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="//farseerfc.me/en/../theme/css/pygments/monokai.css" rel="stylesheet">
    <link href="//farseerfc.me/en/../theme/tipuesearch/tipuesearch.css" rel="stylesheet">
        <link href="//farseerfc.me/en/../theme/css/html4css1.css" rel="stylesheet">
    <link rel="stylesheet" href="//farseerfc.me/en/../theme/css/style.css" type="text/css"/>

        <link href="//farseerfc.me/en/feeds/atom.xml" type="application/atom+xml" rel="alternate"
              title="Farseerfc's Nest ATOM Feed"/>

        <link href="//farseerfc.me/en/../theme/css/material.min.css" rel="stylesheet">
        <link href="//farseerfc.me/en/../theme/css/ripples.css" rel="stylesheet">
    <link href="//farseerfc.me/en/../theme/css/github-markdown.css" rel="stylesheet">
</head>
<body>
<div style="display:none" id="title">Btrfs vs ZFS 实现 snapshot 的差异 - Farseerfc's Nest</div>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
         <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="//farseerfc.me/en/" class="navbar-brand">
Farseerfc's Nest            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">

                    <li class="dropdown hidden-lg hidden-xl">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="javascript:void(0)">
                            <i class="mdi-action-translate"></i><span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a href="//farseerfc.me/">繁體</a></li>
                            <li><a href="//farseerfc.me/jp/">日本語</a></li>
                            <li class="active"><a href="//farseerfc.me/en/">English</a></li>
                            <li><a href="//farseerfc.me/zhs/">简体</a></li>
                        </ul>
                    </li>

                    <ul class="nav navbar-nav hidden-xs hidden-md hidden-sm">
                        <li><a href="//farseerfc.me/"><i class="mdi-action-translate"></i>繁體</a></li>
                        <li><a href="//farseerfc.me/jp/"><i class="mdi-action-translate"></i>日本語</a></li>
                        <li class="active"><a href="//farseerfc.me/en/"><i class="mdi-action-translate"></i>English</a></li>
                        <li><a href="//farseerfc.me/zhs/"><i class="mdi-action-translate"></i>简体</a></li>
                    </ul>

                    <li class="dropdown hidden-md hidden-lg hidden-xl">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="javascript:void(0)">
                            <i class="fa fa-user"></i><span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu">
                             <li class=""><a href="//farseerfc.me/en/pages/about.html"><i class="fa fa-user"></i>
                                 About
                              </a></li>
                        </ul>
                    </li>

                  <ul class="nav navbar-nav hidden-xs hidden-sm">
                     <li class=""><a href="//farseerfc.me/en/pages/about.html"><i class="fa fa-user"></i>
                         About
                      </a></li>
                  </ul>
            </ul>

                <ul class="nav navbar-nav hidden-md hidden-lg hidden-xl">
                    <li class="dropdown hidden-md hidden-lg hidden-xl">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="javascript:void(0)">
                            <i class="fa fa-folder-o"></i><span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li >
                                <a href="//farseerfc.me/en/category/import.html"><i class="fa fa-folder-o"></i> Import</a>
                            </li>
                            <li >
                                <a href="//farseerfc.me/en/category/life.html"><i class="fa fa-folder-o"></i> Life</a>
                            </li>
                            <li class="active">
                                <a href="//farseerfc.me/en/category/tech.html"><i class="fa fa-folder-o"></i> Tech</a>
                            </li>
                        </ul>
                    </li>
                </ul>

                    <ul class="nav navbar-nav hidden-xs hidden-sm">
                        <li >
                            <a href="//farseerfc.me/en/category/import.html"><i class="fa fa-folder-o"></i> Import</a>
                        </li>
                        <li >
                            <a href="//farseerfc.me/en/category/life.html"><i class="fa fa-folder-o"></i> Life</a>
                        </li>
                        <li class="active">
                            <a href="//farseerfc.me/en/category/tech.html"><i class="fa fa-folder-o"></i> Tech</a>
                        </li>
                    </ul>



            <ul class="nav navbar-nav navbar-right hidden-sm hidden-md hidden-lg hidden-xl">
                <li class="dropdown hidden-md hidden-lg hidden-xl">
                    <a class="dropdown-toggle" data-toggle="dropdown" href="javascript:void(0)">
                        <i class="fa fa-search"></i><span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu">
                      <li><span>
                        <form class="navbar-search" action="/search.html">
                          <input type="text" class="search-query form-control col-lg-16" placeholder="Search" name="q" id="tipue_search_input" required>
                        </form></span>
                      </li>
                    </ul>
                </li>
            </ul>

            <ul class="nav navbar-right navbar-form hidden-xs">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query form-control col-lg-16" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
            </ul>

            <ul class="nav navbar-nav navbar-right hidden-xs">
              <li><a href="//farseerfc.me/en/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">All</span></a></li>
              <li><a href="//farseerfc.me/en/feeds/atom.xml" title="Atom feeds for all articles"><i class="fa fa-rss"></i></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container" style="min-height: 100%;height: auto !important;height: 100%;">
    <div class="row" style="padding-bottom:80px;padding-top:80px;">
        <div class="col-xl-21 col-lg-20 col-md-18">
            <div id="loading-block">
            <ol class="breadcrumb">
                <li><a href="//farseerfc.me/en/" title="Farseerfc's Nest"><i class="fa fa-home fa-lg"></i></a></li>
                <li><a href="//farseerfc.me/en/category/tech.html" title="tech">tech</a></li>
                <li class="active">Btrfs vs ZFS 实现 snapshot 的差异</li>
            </ol>
    <section id="content" class="article-content">
        <article>
            <header class="page-header jumbotron jumbotron-primary panel-primary" id="article-header">
                <div class="panel-heading">
                    <h1>
                        Btrfs vs ZFS 实现 snapshot 的差异
                        <a href="//farseerfc.me/en/zhs/drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html"
                           rel="bookmark"
                           class="btn btn-primary btn-lg"
                           title="Permalink to Btrfs vs ZFS 实现 snapshot 的差异">
                           <i class="mdi-action-launch"></i>
                        </a>
                    </h1>
                </div>
                <div class="panel-body">
<div class="post-info">
    <span class="published">
        <time datetime="2020-01-01T13:45:00+09:00"><i class="fa fa-calendar"></i> 2020年01月01日(周三)</time>
    </span>



<div class="btn-group translations">
<a href="javascript:void(0)" class="btn btn-primary dropdown-toggle" data-toggle="dropdown"><i class="mdi-action-translate"></i><span class="caret"></a>
<ul class="dropdown-menu">
<li class="active"><a href="//farseerfc.me/en/zhs/drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html">简体</a></li><li><a href="//farseerfc.me/en/../drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html" class="translate">繁體</a></li></ul>
</div>

    <a onclick="$.get('//farseerfc.me/en/btrfs-vs-zfs-difference-in-implementing-snapshots.rst.html', function(data){$('#source-code').html(data)});$('#article-content').toggle();$('#source-content').toggle();" class="btn btn-primary" title="Show source code of this page"><i class="fa fa-code"></i></a>
    <a href="//farseerfc.me/en/btrfs-vs-zfs-difference-in-implementing-snapshots.pdf" class="btn btn-primary" title="Show pdf version of this page" target="_blank"><i class="fa fa-file-pdf-o"></i></a>
    <a href="//farseerfc.me/en/btrfs-vs-zfs-difference-in-implementing-snapshots.png" class="btn btn-primary" title="Show captured png of this page" target="_blank""><i class="fa fa-file-photo-o"></i></a>

<small><span><a href="//farseerfc.me/en/zhs/drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html#disqus_thread" class="btn btn-primary" data-disqus-identifier="btrfs-vs-zfs-difference-in-implementing-snapshots" data-disqus-url="http://farseerfc.me/en/zhs/drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html"><i class="fa fa-comments-o"></i></a></span></small><span class="btn-group">
	<a href="//farseerfc.me/en/tag/btrfs.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> btrfs</a>
	<a href="//farseerfc.me/en/tag/zfs.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> zfs</a>
	<a href="//farseerfc.me/en/tag/cow.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> cow</a>
	<a href="//farseerfc.me/en/tag/snapshot.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> snapshot</a>
	<a href="//farseerfc.me/en/tag/clone.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> clone</a>
	<a href="//farseerfc.me/en/tag/subvolume.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> subvolume</a>
	<a href="//farseerfc.me/en/tag/dedup.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> dedup</a>
	<a href="//farseerfc.me/en/tag/reflink.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> reflink</a>
</span>



</div><!-- /.post-info -->                </div>
            </header>

            <div class="entry-content jumbotron" id="article-content">
                    <div class="panel panel-default">
                        <div class="panel-heading">
Table of Contents                        </div>
                        <div class="panel-boy">
                        <div class="toc" id="">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#btrfs-subvolume-snapshot" id="id11">Btrfs 的子卷（subvolume）和快照（snapshot）</a><ul>
<li><a class="reference internal" href="#subvolume-snapshot" id="id12">子卷（subvolume）和快照（snapshot）的术语</a></li>
<li><a class="reference internal" href="#id3" id="id13">于是子卷在存储介质中是如何记录的呢？</a></li>
<li><a class="reference internal" href="#id5" id="id14">那么快照又是如何记录的呢？</a></li>
</ul>
</li>
<li><a class="reference internal" href="#zfs-filesystem-snapshot-clone" id="id15">ZFS 的文件系统（filesystem）、快照（snapshot）、克隆（clone）及其它</a><ul>
<li><a class="reference internal" href="#zfs" id="id16">ZFS 设计中和快照相关的一些术语和概念</a><ul>
<li><a class="reference internal" href="#dataset" id="id17">数据集（dataset）</a></li>
<li><a class="reference internal" href="#filesystem" id="id18">文件系统（filesystem）</a></li>
<li><a class="reference internal" href="#snapshot" id="id19">快照（snapshot）</a></li>
<li><a class="reference internal" href="#clone" id="id20">克隆（clone）</a></li>
<li><a class="reference internal" href="#bookmark" id="id21">书签（bookmark）</a></li>
<li><a class="reference internal" href="#checkpoint" id="id22">检查点（checkpoint）</a></li>
</ul>
</li>
<li><a class="reference internal" href="#zfs-btrfs" id="id23">ZFS 的概念与 btrfs 概念的对比</a></li>
<li><a class="reference internal" href="#id6" id="id24">ZFS 中是如何存储这些数据集的呢</a><ul>
<li><a class="reference internal" href="#id7" id="id25">ZFS设计中的子系统层级</a></li>
<li><a class="reference internal" href="#id8" id="id26">ZFS 的存储格式概况</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
                        </div>
                    </div>
                
<p>Btrfs 和 ZFS 都是开源的写时拷贝（Copy on Write, CoW）文件系统，都提供了相似的子卷管理和
快照(snapshot）的功能。网上有不少文章都评价 ZFS 实现 CoW FS 的创新之处，进而想说「 Btrfs
只是 Linux/GPL 阵营对 ZFS 的拙劣抄袭」。或许（在存储领域人尽皆知而在领域外）鲜有人知，在
ZFS 之前就有 <a class="reference external" href="https://en.wikipedia.org/wiki/NetApp">NetApp</a> 的商业产品
<a class="reference external" href="https://en.wikipedia.org/wiki/Write_Anywhere_File_Layout">WAFL(Write Anywhere File Layout)</a>
实现了 CoW 语义的文件系统，并且集成了快照和卷管理之类的功能。描述 btrfs 原型设计的
<a class="reference external" href="https://btrfs.wiki.kernel.org/images-btrfs/6/68/Btree_TOS.pdf">论文</a>
和 <a class="reference external" href="https://btrfs.wiki.kernel.org/images-btrfs/6/63/LinuxFS_Workshop.pdf">发表幻灯片</a>
也明显提到 WAFL 比提到 ZFS 更多一些，应该说 WAFL 这样的企业级存储方案才是 ZFS 和 btrfs
共同的灵感来源，而无论是 ZFS 还是 btrfs 在其设计中都汲取了很多来自 WAFL 的经验教训。</p>
<p>我一开始也带着「 Btrfs 和 ZFS
都提供了类似的功能，因此两者必然有类似的设计」这样的先入观念，尝试去使用这两个文件系统，
却经常撞上两者细节上的差异，导致使用时需要不尽相同的工作流，
或者看似相似的用法有不太一样的性能表现，又或者一边有的功能（比如 ZFS 的 inband dedup ，
Btrfs 的 reflink ）在另一边没有的情况。后来看到了
<a class="reference external" href="https://lwn.net/Articles/342892/">LWN 的这篇 《A short history of btrfs》</a>
让我意识到 btrfs 和 ZFS 虽然表面功能上看起来类似，但是实现细节上完全不一样，
所以需要不一样的用法，适用于不一样的使用场景。</p>
<p>为了更好地理解这些差异，我四处搜罗这两个文件系统的实现细节，于是有了这篇笔记，
记录一下我查到的种种发现和自己的理解。<del>（或许会写成一个系列？还是先别乱挖坑不填。）</del>
只是自己的笔记，所有参阅的资料文档都是二手资料，没有深挖过源码，还参杂了自己的理解，
于是难免有和事实相违的地方，如有写错，还请留言纠正。</p>
<div class="section" id="btrfs-subvolume-snapshot">
<h2><a class="toc-backref" href="#id11">Btrfs 的子卷（subvolume）和快照（snapshot）</a></h2>
<p>先从两个文件系统中（表面上看起来）比较简单的 btrfs 的子卷（subvolume）和快照（snapshot）说起。
关于子卷和快照的常规用法、推荐布局之类的话题就不细说了，网上能找到很多不错的资料，比如
<a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/SysadminGuide#Subvolumes">btrfs wiki 的 SysadminGuide 页</a>
和 Arch wiki 上 <a class="reference external" href="https://wiki.archlinux.org/index.php/Btrfs#Subvolumes">Btrfs#Subvolumes</a> 页都有不错的参考价值。</p>
<p>关于写时拷贝（CoW）文件系统的优势，我们为什么要用 btrfs/zfs 这样的写时拷贝文件系统，
而不是传统的文件系统设计，或者写时拷贝文件系统在使用时有什么区别之类的，网上同样也能找到很多介绍
，这里不想再讨论。这里假设你用过 btrfs/zfs 至少一个的快照功能，知道它该怎么用，
并且想知道更多细节，判断怎么用那些功能才合理。</p>
<div class="section" id="subvolume-snapshot">
<h3><a class="toc-backref" href="#id12">子卷（subvolume）和快照（snapshot）的术语</a></h3>
<p>在 btrfs 中，存在于存储媒介中的只有「子卷」的概念，「快照」只是个创建「子卷」的方式，
换句话说在 btrfs 的术语里，子卷（subvolume）是个名词，而快照（snapshot）是个动词。
如果脱离了 btrfs 术语的上下文，或者不精确地称呼的时候，也经常有文档把 btrfs
的快照命令创建出的子卷叫做一个快照，所以当提到快照的时候，根据上下文判断这里是个动词还是名词，
把名词的快照当作用快照命令创建出的子卷就可以了。或者我们可以理解为，
<strong>互相共享一部分元数据（metadata）的子卷互为彼此的快照（名词）</strong> ，
那么按照这个定义的话，在 btrfs 中创建快照（名词）的方式其实有两种：</p>
<ol class="arabic simple">
<li>用 <code class="code">
btrfs subvolume snapshot</code>
 命令创建快照</li>
<li>用 <code class="code">
btrfs send</code>
 命令并使用 <code class="code">
-p</code>
 参数发送快照，并在管道另一端接收</li>
</ol>
<div class="panel panel-default">
<div class="panel-heading">
<code class="code">
btrfs send</code>
 命令的 <code class="code">
-p</code>
 与 <code class="code">
-c</code>
</div>
<div class="panel-body">
<p>这里也顺便提一下 <code class="code">
btrfs send</code>
 命令的 <code class="code">
-p</code>
 参数和 <code class="code">
-c</code>
 参数的差异。
只看 <a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/Manpage/btrfs-send#DESCRIPTION">btrfs-send(8)</a> 的描述的话：</p>
<blockquote>
<div class="line-block">
<div class="line">-p &lt;parent&gt;</div>
<div class="line-block">
<div class="line">send an incremental stream from parent to subvol</div>
<div class="line"><br/></div>
</div>
<div class="line">-c &lt;clone-src&gt;</div>
<div class="line-block">
<div class="line">use this snapshot as a clone source for an incremental send (multiple allowed)</div>
</div>
</div>
</blockquote>
<p>看起来这两个都可以用来生成两个快照之间的差分，只不过 -p 只能指定一个「parent」，
而 -c 能指定多个「clone source」。在
<a class="reference external" href="https://unix.stackexchange.com/a/490857">unix stackexchange 上有人写明了这两个的异同</a>
。使用 -p 的时候，产生的差分首先让接收端用 subvolume snapshot 命令对 parent 子卷创建一个快照，
然后发送指令将这个快照修改成目标子卷的样子，而使用 -c 的时候，首先在接收端用 subvolume create
创建一个空的子卷，随后发送指令在这个子卷中填充内容，其数据块尽量共享 clone source 已有的数据。
所以 <code class="code">
btrfs send -p</code>
 在接收端产生是有共享元数据的快照，而 <code class="code">
btrfs send -c</code>

在接收端产生的是仅仅共享数据而不共享元数据的子卷。</p>
</div>
</div>
<p>定义中「互相共享一部分 <strong>元数据</strong> 」比较重要，因为除了快照的方式之外， btrfs
的子卷间也可以通过 reflink 的形式共享数据块。我们可以对一整个子卷（甚至目录）执行
<code class="code">
cp -r --reflink=always</code>
 ，创建出一个副本，副本的文件内容通过 reflink
共享原本的数据，但不共享元数据，这样创建出的就不是快照。</p>
<p>说了这么多，其实关键的只是 btrfs 在传统 Unix 文件系统的「目录/文件/inode」
这些东西之外只增加了一个「子卷」的新概念，而子卷间可以共享元数据或者数据，
用快照命令创建出的子卷就是共享一部分元数据。</p>
</div>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id13">于是子卷在存储介质中是如何记录的呢？</a></h3>
<p>比如在 <a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/SysadminGuide#Flat">SysadminGuide 这页的 Flat 布局</a>
有个子卷布局的例子。</p>
<pre class="code literal-block">
toplevel         (volume root directory, not to be mounted by default)
    +-- root       (subvolume root directory, to be mounted at /)
    +-- home       (subvolume root directory, to be mounted at /home)
    +-- var        (directory)
    |   \-- www    (subvolume root directory, to be mounted at /var/www)
    \-- postgres   (subvolume root directory, to be mounted at /var/lib/postgresql)
</pre>
<p>用圆柱体表示子卷的话画成图大概是这个样子：</p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">

<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Flat_layout Pages: 1 -->
<svg class="svg-responsive" height="206pt" viewbox="0.00 0.00 287.00 206.00" width="287pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g class="graph" id="graph0" transform="scale(1 1) rotate(0) translate(4 202)">
<title>Flat_layout</title>
<polygon fill="#ffffff" points="-4,4 -4,-202 283,-202 283,4 -4,4" stroke="transparent"></polygon>
<!-- toplevel -->
<g class="node" id="node1">
<title>toplevel</title>
<path d="M74,-113.7273C74,-115.5331 57.416,-117 37,-117 16.584,-117 0,-115.5331 0,-113.7273 0,-113.7273 0,-84.2727 0,-84.2727 0,-82.4669 16.584,-81 37,-81 57.416,-81 74,-82.4669 74,-84.2727 74,-84.2727 74,-113.7273 74,-113.7273" fill="none" stroke="#000000"></path>
<path d="M74,-113.7273C74,-111.9214 57.416,-110.4545 37,-110.4545 16.584,-110.4545 0,-111.9214 0,-113.7273" fill="none" stroke="#000000"></path>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="37" y="-95.3">toplevel</text>
</g>
<!-- root -->
<g class="node" id="node2">
<title>root</title>
<path d="M176.5,-194.7273C176.5,-196.5331 164.3982,-198 149.5,-198 134.6018,-198 122.5,-196.5331 122.5,-194.7273 122.5,-194.7273 122.5,-165.2727 122.5,-165.2727 122.5,-163.4669 134.6018,-162 149.5,-162 164.3982,-162 176.5,-163.4669 176.5,-165.2727 176.5,-165.2727 176.5,-194.7273 176.5,-194.7273" fill="none" stroke="#000000"></path>
<path d="M176.5,-194.7273C176.5,-192.9214 164.3982,-191.4545 149.5,-191.4545 134.6018,-191.4545 122.5,-192.9214 122.5,-194.7273" fill="none" stroke="#000000"></path>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="149.5" y="-176.3">root</text>
</g>
<!-- toplevel&#45;&gt;root -->
<g class="edge" id="edge1">
<title>toplevel-&gt;root</title>
<path d="M60.5079,-116.7348C74.7361,-127.3823 93.2999,-141.1218 110,-153 111.8699,-154.33 113.7963,-155.6874 115.7451,-157.0508" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="114.115,-160.1795 124.3276,-163 118.1029,-154.4265 114.115,-160.1795" stroke="#000000"></polygon>
</g>
<!-- home -->
<g class="node" id="node3">
<title>home</title>
<path d="M177.5,-140.7273C177.5,-142.5331 164.95,-144 149.5,-144 134.05,-144 121.5,-142.5331 121.5,-140.7273 121.5,-140.7273 121.5,-111.2727 121.5,-111.2727 121.5,-109.4669 134.05,-108 149.5,-108 164.95,-108 177.5,-109.4669 177.5,-111.2727 177.5,-111.2727 177.5,-140.7273 177.5,-140.7273" fill="none" stroke="#000000"></path>
<path d="M177.5,-140.7273C177.5,-138.9214 164.95,-137.4545 149.5,-137.4545 134.05,-137.4545 121.5,-138.9214 121.5,-140.7273" fill="none" stroke="#000000"></path>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="149.5" y="-122.3">home</text>
</g>
<!-- toplevel&#45;&gt;home -->
<g class="edge" id="edge2">
<title>toplevel-&gt;home</title>
<path d="M74.1485,-107.9156C86.1488,-110.7957 99.4652,-113.9916 111.5245,-116.8859" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="110.7613,-120.302 121.302,-119.2325 112.395,-113.4953 110.7613,-120.302" stroke="#000000"></polygon>
</g>
<!-- var -->
<g class="node" id="node4">
<title>var</title>
<polygon fill="none" points="176.5,-90 173.5,-94 152.5,-94 149.5,-90 122.5,-90 122.5,-54 176.5,-54 176.5,-90" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="149.5" y="-68.3">var</text>
</g>
<!-- toplevel&#45;&gt;var -->
<g class="edge" id="edge3">
<title>toplevel-&gt;var</title>
<path d="M74.1485,-90.0844C86.4488,-87.1323 100.1319,-83.8484 112.4265,-80.8976" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="113.4596,-84.2492 122.3666,-78.512 111.8259,-77.4425 113.4596,-84.2492" stroke="#000000"></polygon>
</g>
<!-- postgres -->
<g class="node" id="node6">
<title>postgres</title>
<path d="M189,-32.7273C189,-34.5331 171.2955,-36 149.5,-36 127.7045,-36 110,-34.5331 110,-32.7273 110,-32.7273 110,-3.2727 110,-3.2727 110,-1.4669 127.7045,0 149.5,0 171.2955,0 189,-1.4669 189,-3.2727 189,-3.2727 189,-32.7273 189,-32.7273" fill="none" stroke="#000000"></path>
<path d="M189,-32.7273C189,-30.9214 171.2955,-29.4545 149.5,-29.4545 127.7045,-29.4545 110,-30.9214 110,-32.7273" fill="none" stroke="#000000"></path>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="149.5" y="-14.3">postgres</text>
</g>
<!-- toplevel&#45;&gt;postgres -->
<g class="edge" id="edge5">
<title>toplevel-&gt;postgres</title>
<path d="M60.5079,-81.2652C74.7361,-70.6177 93.2999,-56.8782 110,-45 111.5738,-43.8806 113.1875,-42.7418 114.821,-41.5965" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="116.8432,-44.4534 123.0588,-35.8733 112.8492,-38.7046 116.8432,-44.4534" stroke="#000000"></polygon>
</g>
<!-- www -->
<g class="node" id="node5">
<title>www</title>
<path d="M279,-86.7273C279,-88.5331 266.8982,-90 252,-90 237.1018,-90 225,-88.5331 225,-86.7273 225,-86.7273 225,-57.2727 225,-57.2727 225,-55.4669 237.1018,-54 252,-54 266.8982,-54 279,-55.4669 279,-57.2727 279,-57.2727 279,-86.7273 279,-86.7273" fill="none" stroke="#000000"></path>
<path d="M279,-86.7273C279,-84.9214 266.8982,-83.4545 252,-83.4545 237.1018,-83.4545 225,-84.9214 225,-86.7273" fill="none" stroke="#000000"></path>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="252" y="-68.3">www</text>
</g>
<!-- var&#45;&gt;www -->
<g class="edge" id="edge4">
<title>var-&gt;www</title>
<path d="M176.699,-72C188.2828,-72 201.9866,-72 214.5073,-72" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="214.6739,-75.5001 224.6739,-72 214.6739,-68.5001 214.6739,-75.5001" stroke="#000000"></polygon>
</g>
</g>
</svg>
<p>首先要说明， btrfs 中大部分长度可变的数据结构都是
<a class="reference external" href="https://www.usenix.org/legacy/events/lsf07/tech/rodeh.pdf">CoW B-tree</a>
，一种经过修改适合写时拷贝的B树结构，所以在
<a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/On-disk_Format">on-disk format</a>
中提到了很多个树。这里的树不是指文件系统中目录结构树，而是 CoW B-tree
，如果不关心B树细节的话可以把 btrfs 所说的一棵树理解为关系数据库中的一个表，
和数据库的表一样 btrfs 的树的长度可变，然后表项内容根据一个 key 排序。
有这样的背景之后，上图例子中的 Flat 布局在 btrfs 中大概是这样的数据结构：</p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">

<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Flat_layout_on_disk Pages: 1 -->
<svg class="svg-responsive" height="453pt" viewbox="0.00 0.00 1130.00 453.00" width="1130pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g class="graph" id="graph0" transform="scale(1 1) rotate(0) translate(4 449)">
<title>Flat_layout_on_disk</title>
<polygon fill="#ffffff" points="-4,4 -4,-449 1126,-449 1126,4 -4,4" stroke="transparent"></polygon>
<!-- superblock -->
<g class="node" id="node1">
<title>superblock</title>
<polygon fill="none" points="0,-315.5 0,-407.5 123,-407.5 123,-315.5 0,-315.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="61.5" y="-392.3">SUPERBLOCK</text>
<polyline fill="none" points="0,-384.5 123,-384.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="61.5" y="-369.3">...</text>
<polyline fill="none" points="0,-361.5 123,-361.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="61.5" y="-346.3">root_tree</text>
<polyline fill="none" points="0,-338.5 123,-338.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="61.5" y="-323.3">...</text>
</g>
<!-- roottree -->
<g class="node" id="node2">
<title>roottree</title>
<polygon fill="none" points="195,-62 195,-361 504,-361 504,-62 195,-62" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-345.8">ROOT_TREE</text>
<polyline fill="none" points="195,-338 504,-338 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-322.8">2: extent_tree</text>
<polyline fill="none" points="195,-315 504,-315 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-299.8">3: chunk_tree</text>
<polyline fill="none" points="195,-292 504,-292 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-276.8">4: dev_tree</text>
<polyline fill="none" points="195,-269 504,-269 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-253.8">5: fs_tree</text>
<polyline fill="none" points="195,-246 504,-246 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-230.8">6: root_dir "default" -&gt; ROOT_ITEM 256</text>
<polyline fill="none" points="195,-223 504,-223 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-207.8">10: free_space_tree</text>
<polyline fill="none" points="195,-200 504,-200 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-184.8">256: fs_tree "root"</text>
<polyline fill="none" points="195,-177 504,-177 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-161.8">257: fs_tree "home"</text>
<polyline fill="none" points="195,-154 504,-154 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-138.8">258: fs_tree "www"</text>
<polyline fill="none" points="195,-131 504,-131 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-115.8">259: fs_tree "postgres"</text>
<polyline fill="none" points="195,-108 504,-108 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-92.8">-7: tree_log_tree</text>
<polyline fill="none" points="195,-85 504,-85 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-69.8">-5: orphan_root</text>
</g>
<!-- superblock&#45;&gt;roottree -->
<g class="edge" id="edge1">
<title>superblock:sn_root-&gt;roottree:label</title>
<path d="M123,-349.5C151.375,-349.5 160.8795,-349.5 184.9792,-349.5" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="185,-353.0001 195,-349.5 185,-346.0001 185,-353.0001" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- roottree&#45;&gt;roottree -->
<g class="edge" id="edge8">
<title>roottree:e-&gt;roottree:e</title>
<path d="M504.5,-234.5C552,-243.5 648,-243.5 648,-211.5 648,-181.625 564.3267,-179.6411 514.5622,-186.8328" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="513.7934,-183.4124 504.5,-188.5 514.9376,-190.3183 513.7934,-183.4124" stroke="#000000"></polygon>
</g>
<!-- toplevel -->
<g class="node" id="node3">
<title>toplevel</title>
<polygon fill="none" points="576,-195.5 576,-379.5 923,-379.5 923,-195.5 576,-195.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-364.3">FS_TREE "toplevel"</text>
<polyline fill="none" points="576,-356.5 923,-356.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-341.3">256: inode_item DIR</text>
<polyline fill="none" points="576,-333.5 923,-333.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-318.3">256: dir_item: "root" -&gt; ROOT_ITEM 256</text>
<polyline fill="none" points="576,-310.5 923,-310.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-295.3">256: dir_item: "home" -&gt; ROOT_ITEM 257</text>
<polyline fill="none" points="576,-287.5 923,-287.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-272.3">256: dir_item: "var" -&gt; INODE_ITEM 257</text>
<polyline fill="none" points="576,-264.5 923,-264.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-249.3">256: dir_item: "postgres" -&gt; ROOT_ITEM 259</text>
<polyline fill="none" points="576,-241.5 923,-241.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-226.3">257: inode_item DIR</text>
<polyline fill="none" points="576,-218.5 923,-218.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-203.3">257: dir_item: "www" -&gt; ROOT_ITEM 258</text>
</g>
<!-- roottree&#45;&gt;toplevel -->
<g class="edge" id="edge7">
<title>roottree:root_fs-&gt;toplevel:label</title>
<path d="M504,-257.5C559.0128,-257.5 522.6423,-354.6525 565.8752,-367.1761" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="565.6306,-370.6738 576,-368.5 566.5382,-363.7329 565.6306,-370.6738" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- root -->
<g class="node" id="node4">
<title>root</title>
<polygon fill="none" points="667.5,-398.5 667.5,-444.5 831.5,-444.5 831.5,-398.5 667.5,-398.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-429.3">FS_TREE "root"</text>
<polyline fill="none" points="667.5,-421.5 831.5,-421.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-406.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;root -->
<g class="edge" id="edge9">
<title>roottree:root_sub_root-&gt;root:label</title>
<path d="M504,-188.5C598.4735,-188.5 513.0238,-318.0782 576,-388.5 603.8494,-419.642 619.5989,-431.6093 657.395,-433.2892" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="657.4291,-436.7905 667.5,-433.5 657.5752,-429.7921 657.4291,-436.7905" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- home -->
<g class="node" id="node5">
<title>home</title>
<polygon fill="none" points="667.5,-130.5 667.5,-176.5 831.5,-176.5 831.5,-130.5 667.5,-130.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-161.3">FS_TREE "home"</text>
<polyline fill="none" points="667.5,-153.5 831.5,-153.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-138.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;home -->
<g class="edge" id="edge10">
<title>roottree:root_sub_home-&gt;home:label</title>
<path d="M504,-165.5C573.1185,-165.5 592.9293,-165.5 657.2326,-165.5" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="657.5,-169.0001 667.5,-165.5 657.5,-162.0001 657.5,-169.0001" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- www -->
<g class="node" id="node6">
<title>www</title>
<polygon fill="none" points="667.5,-65.5 667.5,-111.5 831.5,-111.5 831.5,-65.5 667.5,-65.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-96.3">FS_TREE "www"</text>
<polyline fill="none" points="667.5,-88.5 831.5,-88.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-73.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;www -->
<g class="edge" id="edge11">
<title>roottree:root_sub_www-&gt;www:label</title>
<path d="M504,-142.5C537.4605,-142.5 543.6289,-128.9684 576,-120.5 612.8107,-110.8702 623.9964,-102.1347 657.4378,-100.7044" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="657.5732,-104.2024 667.5,-100.5 657.431,-97.2039 657.5732,-104.2024" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- postgres -->
<g class="node" id="node7">
<title>postgres</title>
<polygon fill="none" points="667,-.5 667,-46.5 832,-46.5 832,-.5 667,-.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-31.3">FS_TREE "postgres"</text>
<polyline fill="none" points="667,-23.5 832,-23.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-8.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;postgres -->
<g class="edge" id="edge12">
<title>roottree:root_sub_postgres-&gt;postgres:label</title>
<path d="M504,-119.5C546.8146,-119.5 537.8681,-74.9691 576,-55.5 609.5346,-38.3781 622.9605,-35.847 656.4796,-35.5384" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="656.5135,-39.0384 666.5,-35.5 656.4866,-32.0384 656.5135,-39.0384" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge2">
<title>toplevel:toplevel_dir_root-&gt;roottree:root_sub_root</title>
<path d="M576,-322.5C512.0892,-322.5 565.0851,-202.7555 513.961,-189.6584" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="514.3374,-186.1787 504,-188.5 513.5287,-193.1318 514.3374,-186.1787" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge3">
<title>toplevel:toplevel_dir_home-&gt;roottree:root_sub_home</title>
<path d="M576,-299.5C512.0892,-299.5 565.0851,-179.7555 513.961,-166.6584" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="514.3374,-163.1787 504,-165.5 513.5287,-170.1318 514.3374,-163.1787" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge5">
<title>toplevel:toplevel_dir_postgres-&gt;roottree:root_sub_postgres</title>
<path d="M576,-252.5C512.5902,-252.5 564.5603,-134.1397 514.2209,-120.7317" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="514.347,-117.2217 504,-119.5 513.5094,-124.1714 514.347,-117.2217" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge6">
<title>toplevel:toplevel_dir_www-&gt;roottree:root_sub_www</title>
<path d="M576,-206.5C537.0321,-206.5 544.8212,-153.4834 514.2549,-143.957" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="514.3929,-140.4415 504,-142.5 513.4082,-147.3719 514.3929,-140.4415" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;toplevel -->
<g class="edge" id="edge4">
<title>toplevel:e-&gt;toplevel:e</title>
<path d="M923.5,-275.5C989.3333,-284.5 1122,-284.5 1122,-252.5 1122,-222.0625 1001.9728,-220.5763 933.5984,-228.2487" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="932.9937,-224.7968 923.5,-229.5 933.8545,-231.7436 932.9937,-224.7968" stroke="#000000"></polygon>
</g>
</g>
</svg>
<p>上图中已经隐去了很多和本文无关的具体细节，所有这些细节都可以通过
<a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/Manpage/btrfs-inspect-internal">btrfs inspect-internal 的 dump-super 和 dump-tree</a>
查看到。btrfs 中的每棵树都可以看作是一个数据库中的表，可以包含很多表项，根据 KEY 排序，而 KEY
是 (object_id, item_type, item_extra) 这样的三元组。每个对象（object）在树中用一个或多个
表项（item）描述，同 object_id 的表项共同描述一个对象（object）。B树中的 key
只用来比较大小不必连续，从而 object_id 也不必连续，只是按大小排序。有一些预留的 object_id
不能用作别的用途，他们的编号范围是 -255ULL 到 255ULL，也就是表中前 255 和最后 255 个编号预留。</p>
<p>ROOT_TREE 中记录了到所有别的B树的指针，在一些文档中叫做 tree of tree roots 。「所有别的B树」
举例来说比如 2 号 extent_tree ，3 号 chunk_tree ， 4 号 dev_tree ，10 号 free_space_tree
，这些B树都是描述 btrfs 文件系统结构非常重要的组成部分，但是在本文关系不大，
今后有机会再讨论它们。在 ROOT_TREE 的 5 号对象有一个 fs_tree ，它描述了整个 btrfs pool
的顶级子卷，也就是图中叫 toplevel 的那个子卷（有些文档用定冠词称 the FS_TREE
的时候就是在说这个 5 号树，而不是别的子卷的 FS_TREE ）。除了顶级子卷之外，别的所有子卷的 object_id
在 256ULL 到 -256ULL 的范围之间，对子卷而言 ROOT_TREE 中的这些 object_id 也同时是它们的
子卷 id ，在内核挂载文件系统的时候可以用 subvolid 找到它们，别的一些对子卷的操作也可以直接用
subvolid 表示一个子卷。 ROOT_TREE 的 6 号对象描述的不是一棵树，而是一个名叫 default
的特殊目录，它指向 btrfs pool 的默认挂载子卷。最初 mkfs 的时候，这个目录指向 ROOT_ITEM 5
，也就是那个顶级子卷，之后可以通过命令 <code class="code">
btrfs subvolume set-default</code>

修改它指向别的子卷，这里它被改为指向 ROOT_ITEM 256 亦即那个名叫 "root" 的子卷。</p>
<p>每一个子卷都有一棵自己的 FS_TREE （有的文档中叫 file tree），一个 FS_TREE 相当于传统 Unix
文件系统中的一整个 inode table ，只不过它除了包含 inode 信息之外还包含所有文件夹内容。在
FS_TREE 中， object_id 同时也是它所描述对象的 inode 号，所以 btrfs
的 <strong>子卷有互相独立的 inode 编号</strong> ，不同子卷中的文件或目录可以拥有相同的 inode 。 FS_TREE
中一个目录用一个 inode_item 和多个 dir_item 描述， inode_item 是目录自己的 inode
，那些 dir_item 是目录的内容。 dir_item 可以指向别的 inode_item 来描述普通文件和子目录，
也可以指向 root_item 来描述这个目录指向一个子卷。有人或许疑惑，子卷就没有自己的 inode
么？其实如果看 <a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/Data_Structures#btrfs_root_item">数据结构定义</a>
的话 <code class="code">
struct btrfs_root_item</code>
 结构在最开头的地方包含了一个
<code class="code">
struct btrfs_inode_item</code>
 所以 root_item 也同时作为子卷的 inode
，不过用户通常看不到这个子卷的 inode ，因为子卷在被（手动或自动地）挂载到目录上之后，
用户会看到的是子卷的根目录的 inode 。</p>
<p>比如上图 FS_TREE toplevel 中，有两个对象，第一个 256 是（子卷的）根目录，第二个 257
是 "var" 目录，256 有4个子目录，其中 "root" "home" "postgres" 这三个指向了 ROOT_TREE
中的对应子卷，而 "var" 指向了 inode 257 。然后 257 有一个子目录叫 "www" 它指向了
ROOT_TREE 中 object_id 为 258 的子卷。</p>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id14">那么快照又是如何记录的呢？</a></h3>
<p>以上是子卷、目录、 inode 在 btrfs 中的记录方式，你可能想知道，如何记录一个快照呢？
特别是，如果对一个包含子卷的子卷创建了快照，会得到什么结果呢？如果我们在上面的布局基础上执行：</p>
<pre class="code bash literal-block">
btrfs subvolume snapshot toplevel toplevel/toplevel@s1
</pre>
<p>那么产生的数据结构大概如下所示：</p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">

<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Flat_layout_on_disk Pages: 1 -->
<svg class="svg-responsive" height="712pt" viewbox="0.00 0.00 1162.00 712.00" width="1162pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g class="graph" id="graph0" transform="scale(1 1) rotate(0) translate(4 708)">
<title>Flat_layout_on_disk</title>
<polygon fill="#ffffff" points="-4,4 -4,-708 1158,-708 1158,4 -4,4" stroke="transparent"></polygon>
<!-- superblock -->
<g class="node" id="node1">
<title>superblock</title>
<polygon fill="none" points="0,-611.5 0,-703.5 123,-703.5 123,-611.5 0,-611.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="61.5" y="-688.3">SUPERBLOCK</text>
<polyline fill="none" points="0,-680.5 123,-680.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="61.5" y="-665.3">...</text>
<polyline fill="none" points="0,-657.5 123,-657.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="61.5" y="-642.3">root_tree</text>
<polyline fill="none" points="0,-634.5 123,-634.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="61.5" y="-619.3">...</text>
</g>
<!-- roottree -->
<g class="node" id="node2">
<title>roottree</title>
<polygon fill="none" points="195,-334.5 195,-656.5 504,-656.5 504,-334.5 195,-334.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-641.3">ROOT_TREE</text>
<polyline fill="none" points="195,-633.5 504,-633.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-618.3">2: extent_tree</text>
<polyline fill="none" points="195,-610.5 504,-610.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-595.3">3: chunk_tree</text>
<polyline fill="none" points="195,-587.5 504,-587.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-572.3">4: dev_tree</text>
<polyline fill="none" points="195,-564.5 504,-564.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-549.3">5: fs_tree</text>
<polyline fill="none" points="195,-541.5 504,-541.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-526.3">6: root_dir "default" -&gt; ROOT_ITEM 256</text>
<polyline fill="none" points="195,-518.5 504,-518.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-503.3">10: free_space_tree</text>
<polyline fill="none" points="195,-495.5 504,-495.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-480.3">256: fs_tree "root"</text>
<polyline fill="none" points="195,-472.5 504,-472.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-457.3">257: fs_tree "home"</text>
<polyline fill="none" points="195,-449.5 504,-449.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-434.3">258: fs_tree "www"</text>
<polyline fill="none" points="195,-426.5 504,-426.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-411.3">259: fs_tree "postgres"</text>
<polyline fill="none" points="195,-403.5 504,-403.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-388.3">260: fs_tree "toplevel@s1"</text>
<polyline fill="none" points="195,-380.5 504,-380.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-365.3">-7: tree_log_tree</text>
<polyline fill="none" points="195,-357.5 504,-357.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-342.3">-5: orphan_root</text>
</g>
<!-- superblock&#45;&gt;roottree -->
<g class="edge" id="edge1">
<title>superblock:sn_root-&gt;roottree:label</title>
<path d="M123,-645.5C151.375,-645.5 160.8795,-645.5 184.9792,-645.5" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="185,-649.0001 195,-645.5 185,-642.0001 185,-649.0001" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- roottree&#45;&gt;roottree -->
<g class="edge" id="edge10">
<title>roottree:e-&gt;roottree:e</title>
<path d="M504.5,-530.5C552,-539.5 648,-539.5 648,-507 648,-476.6582 564.3267,-474.6433 514.5622,-481.833" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="513.7934,-478.4125 504.5,-483.5 514.9376,-485.3184 513.7934,-478.4125" stroke="#000000"></polygon>
</g>
<!-- toplevel -->
<g class="node" id="node3">
<title>toplevel</title>
<polygon fill="none" points="576,-334 576,-541 948,-541 948,-334 576,-334" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-525.8">FS_TREE "toplevel"</text>
<polyline fill="none" points="576,-518 948,-518 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-502.8">256: inode_item DIR</text>
<polyline fill="none" points="576,-495 948,-495 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-479.8">256: dir_item: "root" -&gt; ROOT_ITEM 256</text>
<polyline fill="none" points="576,-472 948,-472 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-456.8">256: dir_item: "home" -&gt; ROOT_ITEM 257</text>
<polyline fill="none" points="576,-449 948,-449 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-433.8">256: dir_item: "var" -&gt; INODE_ITEM 257</text>
<polyline fill="none" points="576,-426 948,-426 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-410.8">256: dir_item: "postgres" -&gt; ROOT_ITEM 259</text>
<polyline fill="none" points="576,-403 948,-403 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-387.8">256: dir_item: "toplevel@s1" -&gt; ROOT_ITEM 260</text>
<polyline fill="none" points="576,-380 948,-380 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-364.8">257: inode_item DIR</text>
<polyline fill="none" points="576,-357 948,-357 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-341.8">257: dir_item: "www" -&gt; ROOT_ITEM 258</text>
</g>
<!-- roottree&#45;&gt;toplevel -->
<g class="edge" id="edge8">
<title>roottree:root_fs-&gt;toplevel:label</title>
<path d="M504,-553.5C534.0416,-553.5 540.9271,-534.4629 565.9033,-530.2985" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="566.3071,-533.7776 576,-529.5 565.7552,-526.7994 566.3071,-533.7776" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- toplevels1 -->
<g class="node" id="node4">
<title>toplevels1</title>
<polygon fill="none" points="588.5,-.5 588.5,-184.5 935.5,-184.5 935.5,-.5 588.5,-.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-169.3">FS_TREE "toplevel@s1"</text>
<polyline fill="none" points="588.5,-161.5 935.5,-161.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-146.3">256: inode_item DIR</text>
<polyline fill="none" points="588.5,-138.5 935.5,-138.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-123.3">256: dir_item: "root" -&gt; ROOT_ITEM 256</text>
<polyline fill="none" points="588.5,-115.5 935.5,-115.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-100.3">256: dir_item: "home" -&gt; ROOT_ITEM 257</text>
<polyline fill="none" points="588.5,-92.5 935.5,-92.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-77.3">256: dir_item: "var" -&gt; INODE_ITEM 257</text>
<polyline fill="none" points="588.5,-69.5 935.5,-69.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-54.3">256: dir_item: "postgres" -&gt; ROOT_ITEM 259</text>
<polyline fill="none" points="588.5,-46.5 935.5,-46.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-31.3">257: inode_item DIR</text>
<polyline fill="none" points="588.5,-23.5 935.5,-23.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-8.3">257: dir_item: "www" -&gt; ROOT_ITEM 258</text>
</g>
<!-- roottree&#45;&gt;toplevels1 -->
<g class="edge" id="edge9">
<title>roottree:root_sub_s1-&gt;toplevels1:label</title>
<path d="M504,-391.5C604.1824,-391.5 492.5813,-188.5587 577.8727,-174.2894" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="578.3023,-177.7666 588,-173.5 577.7582,-170.7878 578.3023,-177.7666" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- root -->
<g class="node" id="node5">
<title>root</title>
<polygon fill="none" points="680,-625.5 680,-671.5 844,-671.5 844,-625.5 680,-625.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-656.3">FS_TREE "root"</text>
<polyline fill="none" points="680,-648.5 844,-648.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-633.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;root -->
<g class="edge" id="edge11">
<title>roottree:root_sub_root-&gt;root:label</title>
<path d="M504,-483.5C571.217,-483.5 526.246,-571.3042 576,-616.5 610.5377,-647.8735 627.3669,-658.9419 669.8918,-660.3433" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="669.9469,-663.8445 680,-660.5 670.0555,-656.8453 669.9469,-663.8445" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- home -->
<g class="node" id="node6">
<title>home</title>
<polygon fill="none" points="680,-560.5 680,-606.5 844,-606.5 844,-560.5 680,-560.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-591.3">FS_TREE "home"</text>
<polyline fill="none" points="680,-583.5 844,-583.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-568.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;home -->
<g class="edge" id="edge12">
<title>roottree:root_sub_home-&gt;home:label</title>
<path d="M504,-460.5C555.225,-460.5 535.2893,-519.4092 576,-550.5 613.2118,-578.9187 627.5918,-593.3907 669.8996,-595.2854" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="669.9279,-598.7867 680,-595.5 670.0767,-591.7882 669.9279,-598.7867" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- www -->
<g class="node" id="node7">
<title>www</title>
<polygon fill="none" points="680,-268.5 680,-314.5 844,-314.5 844,-268.5 680,-268.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-299.3">FS_TREE "www"</text>
<polyline fill="none" points="680,-291.5 844,-291.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-276.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;www -->
<g class="edge" id="edge13">
<title>roottree:root_sub_www-&gt;www:label</title>
<path d="M504,-437.5C563.5506,-437.5 526.8969,-358.1921 576,-324.5 611.9965,-299.801 630.0633,-302.8353 669.9625,-303.4217" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="669.973,-306.9218 680,-303.5 670.0276,-299.922 669.973,-306.9218" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- postgres -->
<g class="node" id="node8">
<title>postgres</title>
<polygon fill="none" points="679.5,-203.5 679.5,-249.5 844.5,-249.5 844.5,-203.5 679.5,-203.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-234.3">FS_TREE "postgres"</text>
<polyline fill="none" points="679.5,-226.5 844.5,-226.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-211.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;postgres -->
<g class="edge" id="edge14">
<title>roottree:root_sub_postgres-&gt;postgres:label</title>
<path d="M504,-414.5C580.3617,-414.5 515.9138,-305.625 576,-258.5 609.8986,-231.9137 629.2713,-237.3806 668.7935,-238.3677" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="668.9554,-241.87 679,-238.5 669.0462,-234.8706 668.9554,-241.87" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge2">
<title>toplevel:toplevel_dir_root-&gt;roottree:root_sub_root</title>
<path d="M576,-483.5C547.625,-483.5 538.1205,-483.5 514.0208,-483.5" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="514,-480.0001 504,-483.5 514,-487.0001 514,-480.0001" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge3">
<title>toplevel:toplevel_dir_home-&gt;roottree:root_sub_home</title>
<path d="M576,-460.5C547.625,-460.5 538.1205,-460.5 514.0208,-460.5" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="514,-457.0001 504,-460.5 514,-464.0001 514,-457.0001" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge5">
<title>toplevel:toplevel_dir_postgres-&gt;roottree:root_sub_postgres</title>
<path d="M576,-414.5C547.625,-414.5 538.1205,-414.5 514.0208,-414.5" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="514,-411.0001 504,-414.5 514,-418.0001 514,-411.0001" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge6">
<title>toplevel:toplevel_dir_toplevels1-&gt;roottree:root_sub_s1</title>
<path d="M576,-391.5C547.625,-391.5 538.1205,-391.5 514.0208,-391.5" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="514,-388.0001 504,-391.5 514,-395.0001 514,-388.0001" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge7">
<title>toplevel:toplevel_dir_www-&gt;roottree:root_sub_www</title>
<path d="M576,-345.5C527.9315,-345.5 551.6566,-424.3505 514.245,-436.0549" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="513.4131,-432.6375 504,-437.5 514.3909,-439.5689 513.4131,-432.6375" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;toplevel -->
<g class="edge" id="edge4">
<title>toplevel:e-&gt;toplevel:e</title>
<path d="M948,-437.5C1016.6667,-446.5 1154,-446.5 1154,-403 1154,-361.5391 1029.2399,-359.5956 958.0877,-367.2973" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="957.5153,-363.8406 948,-368.5 958.3441,-370.7914 957.5153,-363.8406" stroke="#000000"></polygon>
</g>
</g>
</svg>
<p>在 ROOT_TREE 中增加了 260 号子卷，其内容复制自 toplevel 子卷，然后 FS_TREE toplevel
的 256 号 inode 也就是根目录中增加一个 dir_item 名叫 <cite>toplevel@s1</cite> 它指向 ROOT_ITEM
的 260 号子卷。这里看似是完整复制了整个 FS_TREE 的内容，这是因为 CoW b-tree
当只有一个叶子节点时就复制整个叶子节点。如果子卷内容再多一些，除了叶子之外还有中间节点，
那么只有被修改的叶子和其上的中间节点需要复制。从而创建快照的开销基本上是
O( level of FS_TREE )，而B树的高度一般都能维持在很低的程度，所以快照创建速度近乎是常数开销。</p>
<p>从子卷和快照的这种实现方式，可以看出： <strong>虽然子卷可以嵌套子卷，但是对含有嵌套子卷的子卷做快照的语义有些特别</strong>
。上图中我没有画 <cite>toplevel@s1</cite> 下的各个子卷到对应 ROOT_ITEM 之间的虚线箭头，
是因为这时候如果你尝试直接跳过 <cite>toplevel</cite> 挂载 <cite>toplevel@s1</cite> 到挂载点，
会发现那些子卷没有被自动挂载，更奇怪的是那些子卷的目录项也不是个普通目录，
尝试往它们中放东西会得到无权访问的错误，对它们能做的唯一事情是手动将别的子卷挂载在上面。
推测原因在于这些子目录并不是真的目录，没有对应的目录的 inode ，试图查看它们的 inode
号会得到 2 号，而这是个保留号不应该出现在 btrfs 的 inode 号中。
每个子卷创建时会记录包含它的上级子卷，用 <code class="code">
btrfs subvolume list</code>
 可以看到每个子卷的
top level subvolid ，猜测当挂载 A 而 A 中嵌套的 B 子卷记录的上级子卷不是 A 的时候，
会出现上述奇怪行为。嵌套子卷的快照还有一些别的奇怪行为，大家可以自己探索探索。</p>
<div class="panel panel-default">
<div class="panel-heading">
建议用平坦的子卷布局</div>
<div class="panel-body">
<p>因为上述嵌套子卷在做快照时的特殊行为，
我个人建议是 <strong>保持平坦的子卷布局</strong> ，也就是说：</p>
<ol class="arabic simple">
<li>只让顶层子卷包含其它子卷，除了顶层子卷之外的子卷只做手工挂载，不放嵌套子卷</li>
<li>只在顶层子卷对其它子卷做快照，不快照顶层子卷</li>
<li>虽然可以在顶层子卷放子卷之外的东西（文件或目录），不过因为想避免对顶层子卷做快照，
所以避免在顶层子卷放普通文件。</li>
</ol>
</div>
</div>
<p>btrfs 的子卷可以设置「可写」或者「只读」，在创建一个快照的时候也可以通过 <code class="code">
-r</code>

参数创建出一个只读快照。通常只读快照可能比可写的快照更有用，因为 <code class="code">
btrfs send</code>

命令只接受只读快照作为参考点。子卷可以有两种方式切换它是否只读的属性，可以通过
<code class="code">
btrfs property set &lt;subvol&gt; ro</code>
 直接修改是否只读，也可以对只读子卷用
<code class="code">
btrfs subvolume snapshot</code>
 创建出可写子卷，或者反过来对可写子卷创建出只读子卷。</p>
<p>只读快照也有些特殊的限制，在 <a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/SysadminGuide#Special_Cases">SysadminGuide#Special_Cases</a>
就提到一例，你不能把只读快照用 mv 移出包含它的目录，虽然你能用 mv 给它改名或者移动包含它的目录
到别的地方。 btrfs wiki 上给出这个限制的原因是子卷中记录了它的上级，
所以要移动它到别的上级需要修改这个子卷，从而只读子卷没法移动到别的上级（
不过我还没搞清楚子卷在哪儿记录了它的上级，记录的是上级目录还是上级子卷）。不过这个限制可以通过
对只读快照在目标位置创建一个新的只读快照，然后删掉原位置的只读快照来解决。</p>
</div>
</div>
<div class="section" id="zfs-filesystem-snapshot-clone">
<h2><a class="toc-backref" href="#id15">ZFS 的文件系统（filesystem）、快照（snapshot）、克隆（clone）及其它</a></h2>
<p>Btrfs 给传统文件系统只增加了子卷的概念，相比之下 ZFS 中类似子卷的概念有好几个，据我所知有这些：</p>
<ul class="simple">
<li>数据集（dataset）</li>
<li>文件系统（filesystem）</li>
<li>快照（snapshot）</li>
<li>克隆（clone）</li>
<li>书签（bookmark）：从 ZFS on Linux v0.6.4 开始</li>
<li>检查点（checkpoint）：从 ZFS on Linux v0.8.0 开始</li>
</ul>
<p>梳理一下这些概念之间的关系也是最初想写下这篇笔记的初衷。先画个简图，随后逐一讲讲这些概念：</p>
<img alt="ditaa diagram" class="ditaa img-responsive" src="//farseerfc.me/uml/f0cd8a5f.png"/>
<p>上图中，假设我们有一个 pool ，其中有 3 个文件系统叫 fs1~fs3 和一个 zvol 叫 zv1
，然后文件系统 fs1 有两个快照 s1 和 s2 ，和两个书签 b1 和 b2。pool 整体有两个检查点 cp1 和
cp2 。这个简图将作为例子在后面介绍这些概念。</p>
<div class="section" id="zfs">
<h3><a class="toc-backref" href="#id16">ZFS 设计中和快照相关的一些术语和概念</a></h3>
<div class="section" id="dataset">
<h4><a class="toc-backref" href="#id17">数据集（dataset）</a></h4>
<p>ZFS 中把文件系统、快照、克隆、zvol 等概念统称为数据集（dataset）。
一些文档和介绍中把文件系统叫做数据集，大概因为在 ZFS 中，文件系统是最先创建并且最有用的数据集。</p>
<p>在 ZFS 的术语中，把底层管理和释放存储设备空间的叫做 ZFS 存储池（pool），
简称 zpool ，其上可以容纳多个数据集，这些数据集用类似文件夹路径的语法
<code class="code">
pool_name/​dataset_path@snapshot_name</code>
 这样来称呼。
存储池中的数据集一同共享可用的存储空间，每个数据集单独跟踪自己所消耗掉的存储空间。</p>
<p>数据集之间有类似文件夹的层级父子关系，这一点有用的地方在于可以在父级数据集上设定一些 ZFS 参数，
这些参数可以被子级数据集基础，从而通过层级关系可以方便地微调 ZFS 参数。在 btrfs
中目前还没有类似的属性继承的功能。</p>
<p>zvol 的概念和本文关系不大，这里简要介绍一下。 zvol 是在 ZFS 存储池中虚拟出的一个块设备，
可以在 zvol 上创建别的类型的文件系统，比如 ext4 或者 xfs 这种。很多对 ZFS 文件系统能做的操作，
比如快照或者 send 也都能对 zvol 做，从而用 zvol 能把 ZFS 当作一个传统的卷管理器，绕开 ZFS
的 ZPL（ZFS Posix filesystem Layer） 层。在 Btrfs 中可以用 loopback
块设备某种程度上模拟 zvol 的功能。</p>
</div>
<div class="section" id="filesystem">
<h4><a class="toc-backref" href="#id18">文件系统（filesystem）</a></h4>
<p>创建了 ZFS 存储池后，首先要在其中创建文件系统（filesystem），才能在文件系统中存储文件。
容易看出 ZFS 文件系统的概念直接对应 btrfs 中的子卷。文件系统（filesystem）这个术语，
从命名方式来看或许是想要和（像 Solaris 的 SVM 或者 Linux 的 LVM 这样的）传统的卷管理器
与其上创建的多个文件系统（Solaris UFS 或者 Linux ext）这样的上下层级做类比。
从 btrfs 的子卷在内部结构中叫作 FS_TREE 这一点可以看出，至少在 btrfs
早期设计中大概也是把子卷称为 filesystem 做过类似的类比的。
和传统的卷管理器与传统文件系统的上下层级不同的是， ZFS 和 btrfs 中由存储池跟踪和管理可用空间，
做统一的数据块分配和释放，没有分配的数据块算作整个存储池中所有 ZFS 文件系统或者 btrfs
子卷的可用空间。</p>
<p>与 btrfs 的子卷不同的是， ZFS 的文件系统之间是完全隔离的，（除了后文会讲的 dedup
方式之外）不可以共享任何数据或者元数据。一个文件系统还包含了隶属于其中的快照（snapshot）、
克隆（clone）和书签（bookmark）。在 btrfs 中一个子卷和对其创建的快照之间虽然有父子关系，
但是在 ROOT_TREE 的记录中属于平级的关系。</p>
<p>上面简图中 pool 里面包含 3 个文件系统，分别是 fs1~3 。</p>
</div>
<div class="section" id="snapshot">
<h4><a class="toc-backref" href="#id19">快照（snapshot）</a></h4>
<p>ZFS 的快照对应 btrfs 的只读快照，是标记数据集在某一历史时刻上的只读状态。
和 btrfs 的只读快照一样， ZFS 的快照也兼作 send/receive 时的参考点。
快照隶属于一个数据集，这说明 ZFS 的文件系统或者 zvol 都可以创建快照。</p>
<p>ZFS 中快照是排列在一个时间线上的，因为都是只读快照，它们是数据集在历史上的不同时间点。
这里说的时间不是系统时钟的时间，而是 ZFS 中事务组（TXG, transaction group）的一个序号。
整个 ZFS pool 的每次写入会被合并到一个事务组，对事务组分配一个严格递增的序列号，
提交一个事务组具有类似数据库中事务的语义：要么整个事务组都被完整提交，要么整个 pool
处于上一个事务组的状态，即使中间发生突然断电之类的意外也不会破坏事务语义。
因此 ZFS 快照就是数据集处于某一个事务组时的状态。</p>
<p>如果不满于对数据集进行的修改，想把整个数据集恢复到之前的状态，那么可以回滚（rollback
）数据集到一个快照。回滚操作会撤销掉对数据集的所有更改，并且默认参数下只能回滚到最近的一个快照。
如果想回滚到更早的快照，可以先删掉最近的几个，或者可以使用 <code class="code">
zfs rollback -r</code>

参数删除中间的快照并回滚。</p>
<p>除了回滚操作，还可以直接只读访问到快照中的文件。 ZFS 的文件系统中有个隐藏文件夹叫 ".zfs"
，所以如果只想回滚一部分文件，可以从 ".zfs/snapshots/SNAPSHOT-NAME" 中把需要的文件复制出来。</p>
<p>比如上面简图中 fs1 就有 <code class="code">
pool/​fs1@s1</code>
 和 <code class="code">
pool/​fs1@s2</code>
 这两个快照，
那么可以在 fs1 挂载点下 <code class="code">
.zfs/​snapshots/​s1</code>
 的路径直接访问到 s1 中的内容。</p>
</div>
<div class="section" id="clone">
<h4><a class="toc-backref" href="#id20">克隆（clone）</a></h4>
<p>ZFS 的克隆有点像 btrfs 的可写快照。因为 ZFS 的快照是只读的，如果想对快照做写入，那需要先用
<code class="code">
zfs clone</code>
 从快照中建出一个克隆，创建出的克隆和快照共享元数据和数据，
然后对克隆的写入不影响数据集原本的写入点。
创建了克隆之后，作为克隆参考点的快照会成为克隆的依赖，克隆存在期间无法删除掉作为其依赖的快照。</p>
<p>一个数据集可以有多个克隆，这些克隆都独立于数据集当前的写入点。使用 <code class="code">
zfs promote</code>

命令可以把一个克隆「升级」成为数据集的当前写入点，从而数据集原本的写入点会调转依赖关系，
成为这个新写入点的一个克隆，被升级的克隆原本依赖的快照和之前的快照会成为新数据集写入点的快照。</p>
<p>比如上面简图中 fs1 有 c1 的克隆，它依赖于 s2 这个快照，从而 c1 存在的时候就不能删除掉 s2 。</p>
</div>
<div class="section" id="bookmark">
<h4><a class="toc-backref" href="#id21">书签（bookmark）</a></h4>
<p>这是 ZFS 一个比较新的特性，ZFS on Linux 分支从 v0.6.4 开始支持创建书签的功能。</p>
<p>书签特性存在的理由是基于这样的事实：原本 ZFS 在 send 两个快照间的差异的时候，比如 send S1 和
S2 之间的差异，在发送端实际上只需要 S1 中记录的时间戳（TXG id），而不需要 S1 快照的数据，
就可以计算出 S1 到 S2 的差异。在接收端则需要 S1 的完整数据，在其上根据接收到的数据流创建 S2 。
因此在发送端，可以把快照 S1 转变成书签，只留下时间戳元数据而不保留任何目录结构或者文件内容。
书签只能作为增量 send 时的参考点，并且在接收端需要有对应的快照，这种方式可以在发送端节省很多存储。</p>
<p>通常的使用场景是，比如你有一个笔记本电脑，上面有 ZFS 存储的数据，然后使用一个服务器上 ZFS
作为接收端，定期对笔记本上的 ZFS 做快照然后 send 给服务器。在没有书签功能的时候，
笔记本上至少得保留一个和服务器上相同的快照，作为 send 的增量参考点，
而这个快照的内容已经在服务器上，所以笔记本中存有相同的快照只是在浪费存储空间。
有了书签功能之后，每次将定期的新快照发送到服务器之后，就可以把这个快照转化成书签，节省存储开销。</p>
</div>
<div class="section" id="checkpoint">
<h4><a class="toc-backref" href="#id22">检查点（checkpoint）</a></h4>
<p>这也是 ZFS 的新特性， ZFS on Linux 分支从 v0.8.0 开始支持创建检查点。</p>
<p>简而言之，检查点可以看作是整个存储池级别的快照，使用检查点能快速将整个存储池都恢复到上一个状态。
这边有篇文章介绍 <a class="reference external" href="https://sdimitro.github.io/post/zpool-checkpoint/">ZFS checkpoint 功能的背景、用法和限制</a>
，可以看出当存储池中有检查点的时候很多存储池的功能会受影响（比如不能删除 vdev 、不能处于
degraded 状态、不能 scrub 到当前存储池中已经释放而在检查点还在引用的数据块），
于是检查点功能设计上更多是给系统管理员准备的用于调整整个 ZFS pool 时的后悔药，
调整结束后日用状态下应该删除掉所有检查点。</p>
</div>
</div>
<div class="section" id="zfs-btrfs">
<h3><a class="toc-backref" href="#id23">ZFS 的概念与 btrfs 概念的对比</a></h3>
<p>先说书签和检查点，因为这是两个 btrfs 目前完全没有的功能。</p>
<p>书签功能完全围绕 ZFS send 的工作原理，而 ZFS send 位于 ZFS 设计中的
<a href="#id27"><span class="problematic" id="id28">DSL_</span></a> 层面，甚至不关心它 send
的快照的数据是来自文件系统还是 zvol 。在发送端它只是从目标快照递归取数据块，判断 TXG
是否老于参照点的快照，然后把新的数据块全部发往 send stream ；在接收端也只是完整地接收数据块，
不加以处理，。与之不同的是 btrfs 的 send 的工作原理是工作在文件系统的只读子卷层面，
发送端在内核代码中根据目标快照的 b 树和参照点快照的 generation 生成一个 diff
（可以通过 <code class="code">
btrfs subvolume find-new</code>
 直接拿到这个 diff ），然后在用户态代码中根据
diff 和参照点、目标快照的两个只读子卷的数据产生一连串修改文件系统的指令，
指令包括创建文件、删除文件、让文件引用数据块（保持 reflink ）等操作；在接收端则完全工作在用户态下，
根据接收到的指令重建目标快照。可见 btrfs send 需要在发送端读取参照点快照的数据（比如找到
reflink 引用），从而 btrfs 没法（或者很难）实现书签功能。</p>
<p>检查点也是 btrfs 目前没有的功能。 btrfs 目前不能对顶层子卷做递归的 snapshot ，btrfs
的子卷也没有类似 ZFS 数据集的层级关系和可继承属性，从而没法实现类似检查点的功能。</p>
<p>除了书签和检查点之外，剩下的概念可以在 ZFS 和 btrfs 之间有如下映射关系：</p>
<table border="0" class="docutils field-list table" frame="void" rules="none">
<col class="field-name"/>
<col class="field-body"/>
<tbody valign="top">
<tr class="field"><th class="field-name">ZFS 文件系统:</th><td class="field-body">btrfs 子卷</td>
</tr>
<tr class="field"><th class="field-name">ZFS 快照:</th><td class="field-body">btrfs 只读快照</td>
</tr>
<tr class="field"><th class="field-name">ZFS 克隆:</th><td class="field-body">btrfs 可写快照</td>
</tr>
</tbody>
</table>
<p>对 ZFS 数据集的操作，大部分也可以找到对应的对 btrfs 子卷的操作。</p>
<table border="0" class="docutils field-list table" frame="void" rules="none">
<col class="field-name"/>
<col class="field-body"/>
<tbody valign="top">
<tr class="field"><th class="field-name">zfs list:</th><td class="field-body"><code class="code">
btrfs subvolume list</code>
</td>
</tr>
<tr class="field"><th class="field-name">zfs create:</th><td class="field-body"><code class="code">
btrfs subvolume create</code>
</td>
</tr>
<tr class="field"><th class="field-name">zfs destroy:</th><td class="field-body"><code class="code">
btrfs subvolume delete</code>
</td>
</tr>
<tr class="field"><th class="field-name">zfs rename:</th><td class="field-body"><code class="code">
mv</code>
</td>
</tr>
<tr class="field"><th class="field-name">zfs snapshot:</th><td class="field-body"><code class="code">
btrfs subvolume snapshot -r</code>
</td>
</tr>
<tr class="field"><th class="field-name">zfs rollback:</th><td class="field-body">这个在 btrfs 需要对只读快照创建出可写的快照（用 snapshot 命令，或者直接修改读写属性），然后改名或者调整挂载点</td>
</tr>
<tr class="field"><th class="field-name">zfs diff:</th><td class="field-body"><code class="code">
btrfs subvolume find-new</code>
</td>
</tr>
<tr class="field"><th class="field-name">zfs clone:</th><td class="field-body"><code class="code">
btrfs subvolume snapshot</code>
</td>
</tr>
<tr class="field"><th class="field-name">zfs promote:</th><td class="field-body">和 rollback 类似，可以直接调整 btrfs 子卷的挂载点</td>
</tr>
</tbody>
</table>
<p>可见虽然功能上类似，但是至少从管理员管理的角度而言， zfs 对文件系统、快照、克隆的划分更为清晰，
对他们能做的操作也更为明确。这也是很多从 ZFS 迁移到 btrfs ，或者反过来从 btrfs 换用 zfs
时，一些人困惑的起源（甚至有人据此说 ZFS 比 btrfs 好在 cli 设计上）。</p>
<p>不过 btrfs 子卷的设计也使它在系统管理上有了更大的灵活性。比如在 btrfs
中删除一个子卷不会受制于别的子卷是否存在，而在 zfs 中要删除一个快照必须先保证先摧毁掉依赖它的克隆。
再比如 btrfs 的可写子卷没有主次之分，而 zfs 中一个文件系统和其克隆之间有明显的区别，所以需要
promote 命令调整差异。还有比如 ZFS 的文件系统只能回滚到最近一次的快照，
要回滚到更久之前的快照需要删掉中间的快照，并且回滚之后原本的文件系统数据和快照数据就被丢弃了；
而 btrfs 中因为回滚操作相当于调整子卷的挂载，所以不需要删掉快照，
并且回滚之后原本的子卷和快照还可以继续保留。</p>
<p>加上 btrfs 有 reflink ，这给了 btrfs 在使用中更大的灵活性，可以有一些 zfs 很难做到的用法。
比如想从快照中打捞出一些虚拟机镜像的历史副本，而不想回滚整个快照的时候，在
btrfs 中可以直接 <code class="code">
cp --reflink=always</code>
 将镜像从快照中复制出来，此时的复制将和快照共享数据块；
而在 zfs 中只能用普通 cp 复制，会浪费很多存储空间。</p>
</div>
<div class="section" id="id6">
<h3><a class="toc-backref" href="#id24">ZFS 中是如何存储这些数据集的呢</a></h3>
<p>要讲到存储细节，首先需要提一下 ZFS 的分层设计。不像 btrfs 基于现代 Linux
内核，有许多现有文件系统已经实现好的基础设施可以利用，并且大体上只用到一种核心数据结构（CoW的B树）；
ZFS 则脱胎于 Solaris 的野心勃勃，设计时就分成很多不同的子系统，逐步提升抽象层次，
并且每个子系统都发明了许多特定需求下的数据结构来描述存储的信息。</p>
<p>ZFS 在设计之初背负了重构 Solaris 诸多内核子系统的重任，从而不同于 Linux 的文件系统
只负责文件系统的功能而把其余功能（比如内存脏页管理，IO调度）交给内核更底层的子系统， ZFS
的整体设计更层次化并更独立，很多部分可能和 Linux 内核已有的子系统有功能重叠。
而本文想讲的只是 ZFS 中与快照相关的一些部分，于是先从 ZFS 的整体设计上说一下和快照相关的概念位于
ZFS 设计中的什么位置。</p>
<div class="section" id="id7">
<h4><a class="toc-backref" href="#id25">ZFS设计中的子系统层级</a></h4>
<p>首先 ZFS 整体架构如下图，其中圆圈是 ZFS 给内核层的外部接口，方框是 ZFS 内部子系统：</p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">

<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: ZFS_Layer_Architecture Pages: 1 -->
<svg class="svg-responsive" height="570pt" viewbox="0.00 0.00 483.00 570.00" width="483pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g class="graph" id="graph0" transform="scale(1 1) rotate(0) translate(4 566)">
<title>ZFS_Layer_Architecture</title>
<polygon fill="#ffffff" points="-4,4 -4,-566 479,-566 479,4 -4,4" stroke="transparent"></polygon>
<g class="cluster" id="clust4">
<title>clusterTOL</title>
<polygon fill="none" points="184.5,-227 184.5,-374 398.5,-374 398.5,-227 184.5,-227" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="291.5" y="-358.8">TOL</text>
</g>
<g class="cluster" id="clust8">
<title>clusterSPA</title>
<polygon fill="none" points="173.5,-8 173.5,-155 329.5,-155 329.5,-8 173.5,-8" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="251.5" y="-139.8">SPA</text>
</g>
<!-- Filesystem API -->
<g class="node" id="node1">
<title>Filesystem API</title>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="219.5" y="-540.3">Filesystem API</text>
</g>
<!-- VFS -->
<g class="node" id="node4">
<title>VFS</title>
<ellipse cx="219.5" cy="-472" fill="none" rx="30.5947" ry="18" stroke="#000000"></ellipse>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="219.5" y="-468.3">VFS</text>
</g>
<!-- Filesystem API&#45;&gt;VFS -->
<g class="edge" id="edge1">
<title>Filesystem API-&gt;VFS</title>
<path d="M219.5,-525.8314C219.5,-518.131 219.5,-508.9743 219.5,-500.4166" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="223.0001,-500.4132 219.5,-490.4133 216.0001,-500.4133 223.0001,-500.4132" stroke="#000000"></polygon>
</g>
<!-- Block device API -->
<g class="node" id="node2">
<title>Block device API</title>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="69.5" y="-540.3">Block device API</text>
</g>
<!-- /dev/zvol/... -->
<g class="node" id="node5">
<title>/dev/zvol/...</title>
<ellipse cx="76.5" cy="-472" fill="none" rx="63.8893" ry="18" stroke="#000000"></ellipse>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="76.5" y="-468.3">/dev/zvol/...</text>
</g>
<!-- Block device API&#45;&gt;/dev/zvol/... -->
<g class="edge" id="edge2">
<title>Block device API-&gt;/dev/zvol/...</title>
<path d="M71.2664,-525.8314C72.015,-518.131 72.9053,-508.9743 73.7373,-500.4166" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="77.2256,-500.7051 74.7098,-490.4133 70.2585,-500.0276 77.2256,-500.7051" stroke="#000000"></polygon>
</g>
<!-- ZFS Management API -->
<g class="node" id="node3">
<title>ZFS Management API</title>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="387.5" y="-540.3">ZFS Management API</text>
</g>
<!-- /dev/zfs ioctl -->
<g class="node" id="node6">
<title>/dev/zfs ioctl</title>
<ellipse cx="381.5" cy="-472" fill="none" rx="69.5877" ry="18" stroke="#000000"></ellipse>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="381.5" y="-468.3">/dev/zfs ioctl</text>
</g>
<!-- ZFS Management API&#45;&gt;/dev/zfs ioctl -->
<g class="edge" id="edge3">
<title>ZFS Management API-&gt;/dev/zfs ioctl</title>
<path d="M385.9859,-525.8314C385.3442,-518.131 384.5812,-508.9743 383.8681,-500.4166" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="387.3529,-500.088 383.0344,-490.4133 380.3771,-500.6694 387.3529,-500.088" stroke="#000000"></polygon>
</g>
<!-- ZPL -->
<g class="node" id="node7">
<title>ZPL</title>
<polygon fill="none" points="246.5,-418 192.5,-418 192.5,-382 246.5,-382 246.5,-418" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="219.5" y="-396.3">ZPL</text>
</g>
<!-- VFS&#45;&gt;ZPL -->
<g class="edge" id="edge4">
<title>VFS-&gt;ZPL</title>
<path d="M219.5,-453.8314C219.5,-446.131 219.5,-436.9743 219.5,-428.4166" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="223.0001,-428.4132 219.5,-418.4133 216.0001,-428.4133 223.0001,-428.4132" stroke="#000000"></polygon>
</g>
<!-- ZVOL -->
<g class="node" id="node8">
<title>ZVOL</title>
<polygon fill="none" points="120,-418 61,-418 61,-382 120,-382 120,-418" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="90.5" y="-396.3">ZVOL</text>
</g>
<!-- /dev/zvol/...&#45;&gt;ZVOL -->
<g class="edge" id="edge5">
<title>/dev/zvol/...-&gt;ZVOL</title>
<path d="M80.0328,-453.8314C81.5301,-446.131 83.3105,-436.9743 84.9745,-428.4166" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="88.4465,-428.8975 86.9196,-418.4133 81.5752,-427.5614 88.4465,-428.8975" stroke="#000000"></polygon>
</g>
<!-- DSL -->
<g class="node" id="node11">
<title>DSL</title>
<polygon fill="none" points="390.5,-343 336.5,-343 336.5,-307 390.5,-307 390.5,-343" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="363.5" y="-321.3">DSL</text>
</g>
<!-- /dev/zfs ioctl&#45;&gt;DSL -->
<g class="edge" id="edge9">
<title>/dev/zfs ioctl-&gt;DSL</title>
<path d="M379.2928,-453.9749C376.216,-428.8475 370.6069,-383.0393 366.9682,-353.324" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="370.4148,-352.673 365.7252,-343.1725 363.4667,-353.5238 370.4148,-352.673" stroke="#000000"></polygon>
</g>
<!-- ZAP -->
<g class="node" id="node9">
<title>ZAP</title>
<polygon fill="none" points="246.5,-343 192.5,-343 192.5,-307 246.5,-307 246.5,-343" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="219.5" y="-321.3">ZAP</text>
</g>
<!-- ZPL&#45;&gt;ZAP -->
<g class="edge" id="edge6">
<title>ZPL-&gt;ZAP</title>
<path d="M219.5,-381.8446C219.5,-373.3401 219.5,-363.0076 219.5,-353.4964" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="223.0001,-353.2481 219.5,-343.2482 216.0001,-353.2482 223.0001,-353.2481" stroke="#000000"></polygon>
</g>
<!-- ZIL -->
<g class="node" id="node10">
<title>ZIL</title>
<polygon fill="none" points="318.5,-343 264.5,-343 264.5,-307 318.5,-307 318.5,-343" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="291.5" y="-321.3">ZIL</text>
</g>
<!-- ZPL&#45;&gt;ZIL -->
<g class="edge" id="edge7">
<title>ZPL-&gt;ZIL</title>
<path d="M246.6001,-381.8614C249.7221,-379.3607 252.7632,-376.7146 255.5,-374 262.1796,-367.3746 268.5716,-359.4234 274.0667,-351.8725" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="277.2028,-353.4956 280.0689,-343.2958 271.4677,-349.482 277.2028,-353.4956" stroke="#000000"></polygon>
</g>
<!-- DMU -->
<g class="node" id="node12">
<title>DMU</title>
<polygon fill="none" points="246.5,-271 192.5,-271 192.5,-235 246.5,-235 246.5,-271" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="219.5" y="-249.3">DMU</text>
</g>
<!-- ZPL&#45;&gt;DMU -->
<g class="edge" id="edge11">
<title>ZPL-&gt;DMU</title>
<path d="M192.2089,-384.8579C188.7022,-381.7348 185.6059,-378.1186 183.5,-374 169.9436,-347.487 174.8709,-335.5001 183.5,-307 186.4564,-297.2355 191.8252,-287.6229 197.53,-279.2762" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="200.4414,-281.2239 203.5095,-271.0831 194.7871,-277.0973 200.4414,-281.2239" stroke="#000000"></polygon>
</g>
<!-- ZVOL&#45;&gt;DMU -->
<g class="edge" id="edge12">
<title>ZVOL-&gt;DMU</title>
<path d="M105.9944,-381.6999C122.0079,-362.8551 147.7965,-332.6963 170.5,-307 178.6685,-297.7547 187.7187,-287.723 195.7956,-278.8433" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="198.4446,-281.1328 202.5963,-271.3853 193.2721,-276.4163 198.4446,-281.1328" stroke="#000000"></polygon>
</g>
<!-- ZAP&#45;&gt;DMU -->
<g class="edge" id="edge10">
<title>ZAP-&gt;DMU</title>
<path d="M219.5,-306.8314C219.5,-299.131 219.5,-289.9743 219.5,-281.4166" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="223.0001,-281.4132 219.5,-271.4133 216.0001,-281.4133 223.0001,-281.4132" stroke="#000000"></polygon>
</g>
<!-- ZIO -->
<g class="node" id="node14">
<title>ZIO</title>
<polygon fill="none" points="321.5,-124 267.5,-124 267.5,-88 321.5,-88 321.5,-124" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="294.5" y="-102.3">ZIO</text>
</g>
<!-- ZIL&#45;&gt;ZIO -->
<g class="edge" id="edge15">
<title>ZIL-&gt;ZIO</title>
<path d="M291.7506,-306.7049C292.2747,-268.4458 293.4896,-179.7623 294.1141,-134.1742" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="297.6148,-134.1361 294.2522,-124.089 290.6155,-134.0401 297.6148,-134.1361" stroke="#000000"></polygon>
</g>
<!-- DSL&#45;&gt;ZAP -->
<g class="edge" id="edge8">
<title>DSL-&gt;ZAP</title>
<path d="M355.7081,-343.0803C348.4513,-356.9247 336.0935,-374.2664 318.5,-378 295.0228,-382.9822 287.9772,-382.9822 264.5,-378 260.2181,-377.0913 258.91,-376.7445 255.5,-374 247.77,-367.7785 240.863,-359.5194 235.2167,-351.5579" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="238.0665,-349.5228 229.6055,-343.1461 232.2432,-353.4074 238.0665,-349.5228" stroke="#000000"></polygon>
</g>
<!-- DSL&#45;&gt;DMU -->
<g class="edge" id="edge13">
<title>DSL-&gt;DMU</title>
<path d="M336.4147,-311.4574C313.7307,-300.1153 281.1433,-283.8217 256.1319,-271.316" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="257.463,-268.0684 246.9534,-266.7267 254.3325,-274.3294 257.463,-268.0684" stroke="#000000"></polygon>
</g>
<!-- ARC -->
<g class="node" id="node13">
<title>ARC</title>
<polygon fill="none" points="245.5,-199 191.5,-199 191.5,-163 245.5,-163 245.5,-199" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="218.5" y="-177.3">ARC</text>
</g>
<!-- DMU&#45;&gt;ARC -->
<g class="edge" id="edge14">
<title>DMU-&gt;ARC</title>
<path d="M219.2477,-234.8314C219.1407,-227.131 219.0135,-217.9743 218.8947,-209.4166" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="222.3944,-209.3637 218.7557,-199.4133 215.3951,-209.4609 222.3944,-209.3637" stroke="#000000"></polygon>
</g>
<!-- L2ARC -->
<g class="node" id="node15">
<title>L2ARC</title>
<polygon fill="none" points="249.5,-124 181.5,-124 181.5,-88 249.5,-88 249.5,-124" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="215.5" y="-102.3">L2ARC</text>
</g>
<!-- ARC&#45;&gt;L2ARC -->
<g class="edge" id="edge16">
<title>ARC-&gt;L2ARC</title>
<path d="M217.7738,-162.8446C217.4336,-154.3401 217.0203,-144.0076 216.6399,-134.4964" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="220.1269,-134.1003 216.2299,-124.2482 213.1325,-134.3801 220.1269,-134.1003" stroke="#000000"></polygon>
</g>
<!-- VDEV/RAIDZ -->
<g class="node" id="node16">
<title>VDEV/RAIDZ</title>
<polygon fill="none" points="307.5,-52 195.5,-52 195.5,-16 307.5,-16 307.5,-52" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="251.5" y="-30.3">VDEV/RAIDZ</text>
</g>
<!-- ZIO&#45;&gt;VDEV/RAIDZ -->
<g class="edge" id="edge19">
<title>ZIO-&gt;VDEV/RAIDZ</title>
<path d="M283.6493,-87.8314C278.7977,-79.7079 272.9783,-69.9637 267.632,-61.0118" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="270.6292,-59.2041 262.4968,-52.4133 264.6194,-62.7933 270.6292,-59.2041" stroke="#000000"></polygon>
</g>
<!-- L2ARC&#45;&gt;ZIO -->
<g class="edge" id="edge17">
<title>L2ARC-&gt;ZIO</title>
<path d="M249.7539,-106C252.2119,-106 254.6699,-106 257.1278,-106" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="257.2329,-109.5001 267.2328,-106 257.2328,-102.5001 257.2329,-109.5001" stroke="#000000"></polygon>
</g>
<!-- L2ARC&#45;&gt;VDEV/RAIDZ -->
<g class="edge" id="edge18">
<title>L2ARC-&gt;VDEV/RAIDZ</title>
<path d="M224.5843,-87.8314C228.5615,-79.8771 233.3155,-70.369 237.7139,-61.5723" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="240.9517,-62.9228 242.2934,-52.4133 234.6907,-59.7923 240.9517,-62.9228" stroke="#000000"></polygon>
</g>
</g>
</svg>
<p>一两句话介绍各个子系统的缩写：</p>
<table border="0" class="docutils field-list table" frame="void" rules="none">
<col class="field-name"/>
<col class="field-body"/>
<tbody valign="top">
<tr class="field"><th class="field-name"><a href="#id9"><span class="problematic" id="id10">|ZPL|</span></a>:</th><td class="field-body">ZFS Posix Layer ，提供符合 POSIX 文件系统的语义，也就是包括文件、目录这些抽象以及
inode 属性、权限那些，对一个普通 FS 而言用户直接接触的部分。</td>
</tr>
<tr class="field"><th class="field-name">ZVOL:</th><td class="field-body">ZFS VOLume ，有点像 loopback block device ，暴露一个块设备的接口，其上可以创建别的
FS 。对 ZFS 而言实现 ZVOL 的意义在于它是比文件更简单的接口所以一开始先实现的它，而且
<a class="reference external" href="https://youtu.be/xMH5rCL8S2k?t=298">早期 Solaris 没有 sparse 文件的时候可以用它模拟很大的块设备，测试 Solaris UFS 对 TB 级存储的支持情况</a>。</td>
</tr>
<tr class="field"><th class="field-name">TOL:</th><td class="field-body">Transactional Object Layer，在数据块的基础上提供一个事务性的对象语义层。
每个对象用多个数据块存储，每个数据块大概是 4K~128K 这样的数量级。</td>
</tr>
<tr class="field"><th class="field-name">ZAP:</th><td class="field-body">ZFS Attribute Processor ，在「对象」基础上提供紧凑的 name/value 映射，从而文件夹内容、文件属性之类的都是基于 ZAP 。</td>
</tr>
<tr class="field"><th class="field-name">ZIL:</th><td class="field-body">ZFS Intent Log ，记录两次完整事务语义提交之间的 log ，用来加速实现 fsync 之类的保证。</td>
</tr>
<tr class="field"><th class="field-name">DSL:</th><td class="field-body">Dataset &amp; Snapshot Layer ，数据集和快照层，这是本文的重点。</td>
</tr>
<tr class="field"><th class="field-name">DMU:</th><td class="field-body">Data Management Unit ，在块的基础上提供「对象」的抽象。每个「对象」可以是一个文件，或者是别的 ZFS 内部需要记录的东西。</td>
</tr>
<tr class="field"><th class="field-name">ARC:</th><td class="field-body">Adaptive Replacement Cache，作用相当于 pagecache 。</td>
</tr>
<tr class="field"><th class="field-name">SPA:</th><td class="field-body">Storage Pool Allocator ，从内核的多个块设备中抽象出存储池。</td>
</tr>
<tr class="field"><th class="field-name">ZIO:</th><td class="field-body">ZFS I/O，作用相当于 IO scheduler 。</td>
</tr>
<tr class="field"><th class="field-name">VDEV:</th><td class="field-body">Virtual DEVice ，作用相当于 Linux Device Mapper ，提供 Stripe/Mirror/RAIDZ
之类的多设备存储池管理和抽象。</td>
</tr>
</tbody>
</table>
<p>和本文内容密切相关的是 ZPL 、 DSL、 DMU 这些部分。</p>
</div>
<div class="section" id="id8">
<h4><a class="toc-backref" href="#id26">ZFS 的存储格式概况</a></h4>
<p>Sun 曾经写过一篇 <a class="reference external" href="http://www.giis.co.in/Zfs_ondiskformat.pdf">ZFS 的 On disk format</a>
对理解 ZFS 如何存储在磁盘</p>
</div>
</div>
</div>
<div class="system-messages section">
<h2>Docutils System Messages</h2>
<div class="system-message" id="id9">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">/home/travis/build/farseerfc/farseerfc/content/tech/btrfs-vs-zfs-difference-in-implementing-snapshots.zhs.rst</tt>, line 705); <em><a href="#id10">backlink</a></em></p>
Undefined substitution referenced: "ZPL".</div>
<div class="system-message" id="id27">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">/home/travis/build/farseerfc/farseerfc/content/tech/btrfs-vs-zfs-difference-in-implementing-snapshots.zhs.rst</tt>, line 553); <em><a href="#id28">backlink</a></em></p>
Unknown target name: "dsl".</div>
</div>

            </div>
            <div class="entry-content jumbotron" id="source-content" style="display: none">
                <!-- <pre><code id="source-code">
                </code></pre> -->
                <div id="source-code"></div>
            </div>
            <!-- /.entry-content -->

            <div class="row" id="prevnext">
                <div class="col-xs-12">
                </div>
                <div class="col-xs-12">
                </div>
            </div>

            <div class="panel panel-default" id="series">
                <div class="panel-heading">
                  <h4>
This is part <built-in method index of str object at 0x7fc48c775f90> of the "" series:                  </h4>
                </div>
                <ul class="list-group">
                </ul>
            </div>

<section class="comments" id="comments">
    <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
      <div class="panel panel-primary">
        <div class="panel-heading" role="tab" id="disqus-heading">
          <h4 class="panel-title">
            <a data-toggle="collapse" data-parent="#accordion" href="#disqus-comments" aria-expanded="false" aria-controls="disqus-comments">
              <i class="fa fa-comments-o"></i> Disqus comments            </a>
          </h4>
        </div>
        <div id="disqus-comments" class="panel-collapse collapse" role="tabpanel" aria-labelledby="disqus-heading">
          <div class="panel-body">
            <div class="tab-pane fade active in" id="disqus-comments">
                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'farseerfcgithub'; // required: replace example with your forum shortname

                            var disqus_identifier = 'btrfs-vs-zfs-difference-in-implementing-snapshots';
                        var disqus_url = 'http://farseerfc.me/en/zhs/drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html';

                    var disqus_config = function () {

                        this.language = "zh";
                    };

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function () {
                        var dsq = document.createElement('script');
                        dsq.type = 'text/javascript';
                        dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
                    Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
          </div>
        </div>
      </div>
    </div>
</section>        </article>
    </section>


            </div>
<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <a data-dismiss="modal" href="javascript:void(0);">
            <img id="mimg" src="" style="width:100%;height:auto">
          </a>
        </div>
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
        </div>
        <div class="col-xl-3 col-lg-4 col-md-6" id="sidebar">
            <aside>

<section>
    <div class="sidebar-container">
<div class="sidebar-item ">
<div class="panel panel-default">
	<div class="panel-heading">
        <h4>
<i class="fa fa-user fa-lg"></i>
<a href="//farseerfc.me/en/pages/about.html">
About farseerfc</a>
        </h4>
    </div>
<div class="panel-body" id="aboutme">
        <a href="//farseerfc.me/en/pages/about.html"><img width="100%" src="//farseerfc.me/en/../images/avatar.jpg"/></a>
    <h3 style="text-align:center">
<a href="https://sak.uy/"                  target="_blank">
<i class="fa fa-music" style="text-align:center"></i></a>
<a href="https://twitter.com/farseerfc"                  target="_blank">
<i class="fa fa-twitter" style="text-align:center"></i></a>
<a href="https://github.com/farseerfc"                   target="_blank">
<i class="fa fa-github" style="text-align:center"></i></a>
<a href="http://www.facebook.com/farseerfc"              target="_blank">
<i class="fa fa-facebook" style="text-align:center"></i></a>
<a href="https://plus.google.com/u/0/+JiachenYang/posts" target="_blank">
<i class="fa fa-google-plus" style="text-align:center"></i></a>
<a href="mailto:farseerfc@gmail.com" target="_blank">
<i class="mdi-communication-email" style="text-align:center"></i></a>
</h3>

</div>
</div>
</div>





<div class="sidebar-item hidden-xs">
<div class="panel panel-default">
	<div class="panel-heading">
        <h4>
<a href="//farseerfc.me/en/tags.html"><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></a>
        </h4>
    </div>
<div class="panel-body">
    <ul class="list-group list-inline tagcloud" id="tags">
            <li class="list-group-item tag-1">
                <a href="//farseerfc.me/en/tag/python.html">
                    python <sup> 3</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/pacvis.html">
                    pacvis <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/pacman.html">
                    pacman <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/arch.html">
                    arch <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-1">
                <a href="//farseerfc.me/en/tag/linux.html">
                    linux <sup> 3</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/pacgraph.html">
                    pacgraph <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/kde5.html">
                    kde5 <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/plasma.html">
                    plasma <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/gnome3.html">
                    gnome3 <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/will.html">
                    will <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/you.html">
                    you <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/marry.html">
                    marry <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/me.html">
                    me <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/msr.html">
                    msr <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/icse.html">
                    icse <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/mining.html">
                    mining <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/software.html">
                    software <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/repository.html">
                    repository <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/ruby.html">
                    ruby <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/template.html">
                    template <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/c.html">
                    C <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/pelican.html">
                    pelican <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-2">
                <a href="//farseerfc.me/en/tag/microsoft.html">
                    microsoft <sup> 2</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/acpi.html">
                    acpi <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/java.html">
                    java <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/music.html">
                    music <sup> 1</sup>
                </a>
            </li>
    </ul>
</div>
</div>
</div>

<div class="sidebar-item hidden-xs">
<div class="panel panel-default">
	<div class="panel-heading">
        <h4>
<i class="fa fa-github fa-lg"></i><span class="icon-label">GitHub Repos</span>
        </h4>
    </div>
    <div class="panel-body">
        <div id="gh_repos">
            <p class="list-group-item">Status updating...</p>
        </div>
            <a href="https://github.com/farseerfc">@farseerfc</a> on GitHub<br>
    </div>
</div>
</div>
<div class="sidebar-item hidden-xs">
<div class="panel panel-default">
	<div class="panel-heading">
        <h4>
<a href="https://sak.uy/">
<i class="fa fa-home fa-lg"></i><span class="icon-label">Sakuya的音樂盒</span>
</a>
        </h4>
    </div>
    <div class="panel-body">
        <div id="other_blog_posts">
            <p class="list-group-item">Status updating...</p>
        </div>
    </div>
</div>
</div>

    </div>
</section>
        <div class="panel panel-default hidden-xs hidden-sm" id="affix-toc">
            <div class="panel-heading"><h4>
Table of Contents</h4>
            </div>
            <div class="panel-boy">
            <div class="toc" id="">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#btrfs-subvolume-snapshot" id="id11">Btrfs 的子卷（subvolume）和快照（snapshot）</a><ul>
<li><a class="reference internal" href="#subvolume-snapshot" id="id12">子卷（subvolume）和快照（snapshot）的术语</a></li>
<li><a class="reference internal" href="#id3" id="id13">于是子卷在存储介质中是如何记录的呢？</a></li>
<li><a class="reference internal" href="#id5" id="id14">那么快照又是如何记录的呢？</a></li>
</ul>
</li>
<li><a class="reference internal" href="#zfs-filesystem-snapshot-clone" id="id15">ZFS 的文件系统（filesystem）、快照（snapshot）、克隆（clone）及其它</a><ul>
<li><a class="reference internal" href="#zfs" id="id16">ZFS 设计中和快照相关的一些术语和概念</a><ul>
<li><a class="reference internal" href="#dataset" id="id17">数据集（dataset）</a></li>
<li><a class="reference internal" href="#filesystem" id="id18">文件系统（filesystem）</a></li>
<li><a class="reference internal" href="#snapshot" id="id19">快照（snapshot）</a></li>
<li><a class="reference internal" href="#clone" id="id20">克隆（clone）</a></li>
<li><a class="reference internal" href="#bookmark" id="id21">书签（bookmark）</a></li>
<li><a class="reference internal" href="#checkpoint" id="id22">检查点（checkpoint）</a></li>
</ul>
</li>
<li><a class="reference internal" href="#zfs-btrfs" id="id23">ZFS 的概念与 btrfs 概念的对比</a></li>
<li><a class="reference internal" href="#id6" id="id24">ZFS 中是如何存储这些数据集的呢</a><ul>
<li><a class="reference internal" href="#id7" id="id25">ZFS设计中的子系统层级</a></li>
<li><a class="reference internal" href="#id8" id="id26">ZFS 的存储格式概况</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
            </div>
        </div>
            </aside>
        </div>
    </div>
</div>


<footer id="fcfooter">
   <hr/>
   <div class="container">
      <div class="row">
         <div class="col-md-24">
         <p><small>
            &copy; 2016 farseerfc
            &middot; Powered by            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a> generator                <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a>
    <!-- Content -->
  <!-- licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution 4.0 International License</a>, except where indicated otherwise. -->

         </small></p>
         </div>
      </div>
   </div>
   <a href="#" class="btn btn-primary btn-fab btn-raised mdi-editor-vertical-align-top withripple" style="position:fixed;bottom:30px;right:30px;z-index:1000"></a>
</footer>
<script src="//farseerfc.me/en/../theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="//farseerfc.me/en/../theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="//farseerfc.me/en/../theme/js/respond.min.js"></script>

    <!-- GitHub JS -->
    <script type="text/javascript">
        $(document).ready(function () {
            if (!window.jXHR) {
                var jxhr = document.createElement('script');
                jxhr.type = 'text/javascript';
                jxhr.src = '//farseerfc.me/en/../theme/js/jXHR.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(jxhr, s);
            }

            github.showRepos({
                user: 'farseerfc',
                count: 5,
                skip_forks: false,
                target: '#gh_repos'
            });
        });
    </script>
    <script src="//farseerfc.me/en/../theme/js/github.js" type="text/javascript"></script>
    <!-- End GitHub JS Code -->
<!-- Other Blog JS -->
<script type="text/javascript">
    $(document).ready(function () {
        if (!window.jXHR) {
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '//farseerfc.me/en/../theme/js/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }
        other_blog.showRepos({
            url: 'https://sak.uy/',
            target: '#other_blog_posts'
        });
    });
</script>
<script src="//farseerfc.me/en/../theme/js/other_blog.js" type="text/javascript"></script>
<!-- End Other Blog JS Code -->
    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'farseerfcgithub'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-29540705-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->

<script src="//farseerfc.me/en/../theme/js/ripples.min.js"></script>
<script src="//farseerfc.me/en/../theme/js/material.min.js"></script>
<script src="//farseerfc.me/en/../theme/js/jquery.bootstrap-autohidingnavbar.min.js"></script>
<script>
    $(document).ready(function() {
        $.material.init();
        $("div.navbar").autoHidingNavbar();
        $(".img-responsive").css("cursor","pointer").on('click',function(){
            var sr=$(this).attr('src');
            $('#mimg').attr('src',sr);
            $('#myModal').modal('show');
        });
        $('#affix-toc').affix({
          offset: {
            top: function(){
                if($('#affix-toc').hasClass("affix"))
                    return $('#sidebar').height();
                return $('#sidebar').height() - $('#affix-toc').height();
            },
            bottom: function (){
                return $("#fcfooter").offset().top -
                    $("#article-content").offset().top -
                    $("#article-content").height() + 20;
            }
          }
        });
        $('#affix-toc').width($('#sidebar').width());
    });
    $(window).resize(function () {
       $('#affix-toc').width($('#sidebar').width());
    });
</script>

</body>
</html>