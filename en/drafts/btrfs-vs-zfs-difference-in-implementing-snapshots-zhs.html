<!DOCTYPE html>
<html lang="zh-Hans"
>
<head>
    <title>Btrfs vs ZFS 实现 snapshot 的差异 - Farseerfc's Nest</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <meta name="theme-color" content="#6b5594">
    <meta name="msapplication-navbutton-color" content="#6b5594">
    <meta name="apple-mobile-web-app-status-bar-style" content="#6b5594">
    <link rel="manifest" href="/manifest.json">


<link rel="apple-touch-icon" sizes="180x180" href="//farseerfc.me/en/images/apple-touch-icon.png">
<link rel="icon" type="image/png" href="//farseerfc.me/en/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="//farseerfc.me/en/images/favicon-16x16.png" sizes="16x16">
<link rel="mask-icon" href="//farseerfc.me/en/images/safari-pinned-tab.svg" color="#603cba">

<link rel="canonical" href="//farseerfc.me/en/zhs/drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html">

        <meta name="author" content="farseerfc" />
        <meta name="keywords" content="btrfs,zfs,cow,snapshot,clone,subvolume,dedup,reflink" />
        <meta name="description" content="Btrfs 和 ZFS 都是开源的写时拷贝（Copy on Write, CoW）文件系统，都提供了相似的子卷管理和 快照(snapshot）的功能。网上有不少文章都评价 ZFS 实现 CoW FS 的创新之处，进而想说「 Btrfs 只是 Linux/GPL 阵营对 ZFS 的拙劣抄袭」，或许（在存储领域人尽皆知而领域外）鲜有人知在 ZFS 之前就有 NetApp 的商业产品 WAFL(Write Anywhere File Layout) 实现了 CoW 语义的文件系统，并且集成了快照和卷管理之类的功能。描述 btrfs 原型设计的 论文 和 发表幻灯片 也明显提到 …" />

        <meta property="og:site_name" content="Farseerfc's Nest" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Btrfs vs ZFS 实现 snapshot 的差异"/>
        <meta property="og:url" content="//farseerfc.me/en/zhs/drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html"/>
        <meta property="og:description" content="Btrfs 和 ZFS 都是开源的写时拷贝（Copy on Write, CoW）文件系统，都提供了相似的子卷管理和 快照(snapshot）的功能。网上有不少文章都评价 ZFS 实现 CoW FS 的创新之处，进而想说「 Btrfs 只是 Linux/GPL 阵营对 ZFS 的拙劣抄袭」，或许（在存储领域人尽皆知而领域外）鲜有人知在 ZFS 之前就有 NetApp 的商业产品 WAFL(Write Anywhere File Layout) 实现了 CoW 语义的文件系统，并且集成了快照和卷管理之类的功能。描述 btrfs 原型设计的 论文 和 发表幻灯片 也明显提到 …"/>
        <meta property="article:published_time" content="2020-01-01" />
            <meta property="article:section" content="tech" />
            <meta property="article:tag" content="btrfs" />
            <meta property="article:tag" content="zfs" />
            <meta property="article:tag" content="cow" />
            <meta property="article:tag" content="snapshot" />
            <meta property="article:tag" content="clone" />
            <meta property="article:tag" content="subvolume" />
            <meta property="article:tag" content="dedup" />
            <meta property="article:tag" content="reflink" />
            <meta property="article:author" content="farseerfc" />
        <meta property="og:image"
                  content="//farseerfc.me/en/btrfs-vs-zfs-difference-in-implementing-snapshots.png"/>



    <!-- Bootstrap -->
        <link href="//farseerfc.me/en/../theme/css/bootstrap.min.css" rel="stylesheet">

    <link href="//farseerfc.me/en/../theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="//farseerfc.me/en/../theme/css/pygments/monokai.css" rel="stylesheet">
    <link href="//farseerfc.me/en/../theme/tipuesearch/tipuesearch.css" rel="stylesheet">
        <link href="//farseerfc.me/en/../theme/css/html4css1.css" rel="stylesheet">
    <link rel="stylesheet" href="//farseerfc.me/en/../theme/css/style.css" type="text/css"/>

        <link href="//farseerfc.me/en/feeds/atom.xml" type="application/atom+xml" rel="alternate"
              title="Farseerfc's Nest ATOM Feed"/>

        <link href="//farseerfc.me/en/../theme/css/material.min.css" rel="stylesheet">
        <link href="//farseerfc.me/en/../theme/css/ripples.css" rel="stylesheet">
    <link href="//farseerfc.me/en/../theme/css/github-markdown.css" rel="stylesheet">
</head>
<body>
<div style="display:none" id="title">Btrfs vs ZFS 实现 snapshot 的差异 - Farseerfc's Nest</div>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
         <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="//farseerfc.me/en/" class="navbar-brand">
Farseerfc's Nest            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">

                    <li class="dropdown hidden-lg hidden-xl">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="javascript:void(0)">
                            <i class="mdi-action-translate"></i><span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a href="//farseerfc.me/">繁體</a></li>
                            <li><a href="//farseerfc.me/jp/">日本語</a></li>
                            <li class="active"><a href="//farseerfc.me/en/">English</a></li>
                            <li><a href="//farseerfc.me/zhs/">简体</a></li>
                        </ul>
                    </li>

                    <ul class="nav navbar-nav hidden-xs hidden-md hidden-sm">
                        <li><a href="//farseerfc.me/"><i class="mdi-action-translate"></i>繁體</a></li>
                        <li><a href="//farseerfc.me/jp/"><i class="mdi-action-translate"></i>日本語</a></li>
                        <li class="active"><a href="//farseerfc.me/en/"><i class="mdi-action-translate"></i>English</a></li>
                        <li><a href="//farseerfc.me/zhs/"><i class="mdi-action-translate"></i>简体</a></li>
                    </ul>

                    <li class="dropdown hidden-md hidden-lg hidden-xl">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="javascript:void(0)">
                            <i class="fa fa-user"></i><span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu">
                             <li class=""><a href="//farseerfc.me/en/pages/about.html"><i class="fa fa-user"></i>
                                 About
                              </a></li>
                        </ul>
                    </li>

                  <ul class="nav navbar-nav hidden-xs hidden-sm">
                     <li class=""><a href="//farseerfc.me/en/pages/about.html"><i class="fa fa-user"></i>
                         About
                      </a></li>
                  </ul>
            </ul>

                <ul class="nav navbar-nav hidden-md hidden-lg hidden-xl">
                    <li class="dropdown hidden-md hidden-lg hidden-xl">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="javascript:void(0)">
                            <i class="fa fa-folder-o"></i><span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li >
                                <a href="//farseerfc.me/en/category/import.html"><i class="fa fa-folder-o"></i> Import</a>
                            </li>
                            <li >
                                <a href="//farseerfc.me/en/category/life.html"><i class="fa fa-folder-o"></i> Life</a>
                            </li>
                            <li class="active">
                                <a href="//farseerfc.me/en/category/tech.html"><i class="fa fa-folder-o"></i> Tech</a>
                            </li>
                        </ul>
                    </li>
                </ul>

                    <ul class="nav navbar-nav hidden-xs hidden-sm">
                        <li >
                            <a href="//farseerfc.me/en/category/import.html"><i class="fa fa-folder-o"></i> Import</a>
                        </li>
                        <li >
                            <a href="//farseerfc.me/en/category/life.html"><i class="fa fa-folder-o"></i> Life</a>
                        </li>
                        <li class="active">
                            <a href="//farseerfc.me/en/category/tech.html"><i class="fa fa-folder-o"></i> Tech</a>
                        </li>
                    </ul>



            <ul class="nav navbar-nav navbar-right hidden-sm hidden-md hidden-lg hidden-xl">
                <li class="dropdown hidden-md hidden-lg hidden-xl">
                    <a class="dropdown-toggle" data-toggle="dropdown" href="javascript:void(0)">
                        <i class="fa fa-search"></i><span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu">
                      <li><span>
                        <form class="navbar-search" action="/search.html">
                          <input type="text" class="search-query form-control col-lg-16" placeholder="Search" name="q" id="tipue_search_input" required>
                        </form></span>
                      </li>
                    </ul>
                </li>
            </ul>

            <ul class="nav navbar-right navbar-form hidden-xs">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query form-control col-lg-16" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
            </ul>

            <ul class="nav navbar-nav navbar-right hidden-xs">
              <li><a href="//farseerfc.me/en/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">All</span></a></li>
              <li><a href="//farseerfc.me/en/feeds/atom.xml" title="Atom feeds for all articles"><i class="fa fa-rss"></i></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container" style="min-height: 100%;height: auto !important;height: 100%;">
    <div class="row" style="padding-bottom:80px;padding-top:80px;">
        <div class="col-xl-21 col-lg-20 col-md-18">
            <div id="loading-block">
            <ol class="breadcrumb">
                <li><a href="//farseerfc.me/en/" title="Farseerfc's Nest"><i class="fa fa-home fa-lg"></i></a></li>
                <li><a href="//farseerfc.me/en/category/tech.html" title="tech">tech</a></li>
                <li class="active">Btrfs vs ZFS 实现 snapshot 的差异</li>
            </ol>
    <section id="content" class="article-content">
        <article>
            <header class="page-header jumbotron jumbotron-primary panel-primary" id="article-header">
                <div class="panel-heading">
                    <h1>
                        Btrfs vs ZFS 实现 snapshot 的差异
                        <a href="//farseerfc.me/en/zhs/drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html"
                           rel="bookmark"
                           class="btn btn-primary btn-lg"
                           title="Permalink to Btrfs vs ZFS 实现 snapshot 的差异">
                           <i class="mdi-action-launch"></i>
                        </a>
                    </h1>
                </div>
                <div class="panel-body">
<div class="post-info">
    <span class="published">
        <time datetime="2020-01-01T13:45:00+09:00"><i class="fa fa-calendar"></i> 2020年01月01日(周三)</time>
    </span>



<div class="btn-group translations">
<a href="javascript:void(0)" class="btn btn-primary dropdown-toggle" data-toggle="dropdown"><i class="mdi-action-translate"></i><span class="caret"></a>
<ul class="dropdown-menu">
<li class="active"><a href="//farseerfc.me/en/zhs/drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html">简体</a></li><li><a href="//farseerfc.me/en/../drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html" class="translate">繁體</a></li></ul>
</div>

    <a onclick="$.get('//farseerfc.me/en/btrfs-vs-zfs-difference-in-implementing-snapshots.rst.html', function(data){$('#source-code').html(data)});$('#article-content').toggle();$('#source-content').toggle();" class="btn btn-primary" title="Show source code of this page"><i class="fa fa-code"></i></a>
    <a href="//farseerfc.me/en/btrfs-vs-zfs-difference-in-implementing-snapshots.pdf" class="btn btn-primary" title="Show pdf version of this page" target="_blank"><i class="fa fa-file-pdf-o"></i></a>
    <a href="//farseerfc.me/en/btrfs-vs-zfs-difference-in-implementing-snapshots.png" class="btn btn-primary" title="Show captured png of this page" target="_blank""><i class="fa fa-file-photo-o"></i></a>

<small><span><a href="//farseerfc.me/en/zhs/drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html#disqus_thread" class="btn btn-primary" data-disqus-identifier="btrfs-vs-zfs-difference-in-implementing-snapshots" data-disqus-url="http://farseerfc.me/en/zhs/drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html"><i class="fa fa-comments-o"></i></a></span></small><span class="btn-group">
	<a href="//farseerfc.me/en/tag/btrfs.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> btrfs</a>
	<a href="//farseerfc.me/en/tag/zfs.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> zfs</a>
	<a href="//farseerfc.me/en/tag/cow.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> cow</a>
	<a href="//farseerfc.me/en/tag/snapshot.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> snapshot</a>
	<a href="//farseerfc.me/en/tag/clone.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> clone</a>
	<a href="//farseerfc.me/en/tag/subvolume.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> subvolume</a>
	<a href="//farseerfc.me/en/tag/dedup.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> dedup</a>
	<a href="//farseerfc.me/en/tag/reflink.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> reflink</a>
</span>



</div><!-- /.post-info -->                </div>
            </header>

            <div class="entry-content jumbotron" id="article-content">
                    <div class="panel panel-default">
                        <div class="panel-heading">
Table of Contents                        </div>
                        <div class="panel-boy">
                        <div class="toc" id="">

<ul class="simple">
<li><a class="reference internal" href="#btrfs-subvolume-snapshot" id="id6">Btrfs 的子卷（subvolume）和快照（snapshot）</a><ul>
<li><a class="reference internal" href="#subvolume-snapshot" id="id7">子卷（subvolume）和快照（snapshot）的术语</a></li>
<li><a class="reference internal" href="#id3" id="id8">于是子卷在存储介质中是如何记录的呢？</a></li>
<li><a class="reference internal" href="#id5" id="id9">那么快照又是如何记录的呢？</a></li>
</ul>
</li>
<li><a class="reference internal" href="#zfs-dataset-snapshot-clone" id="id10">ZFS 的数据集（dataset）、快照（snapshot）、克隆（clone）及其它</a><ul>
<li><a class="reference internal" href="#dataset" id="id11">数据集（dataset）</a></li>
<li><a class="reference internal" href="#snapshot" id="id12">快照（snapshot）</a></li>
</ul>
</li>
</ul>
</div>
                        </div>
                    </div>
                
<p>Btrfs 和 ZFS 都是开源的写时拷贝（Copy on Write, CoW）文件系统，都提供了相似的子卷管理和
快照(snapshot）的功能。网上有不少文章都评价 ZFS 实现 CoW FS 的创新之处，进而想说「 Btrfs
只是 Linux/GPL 阵营对 ZFS 的拙劣抄袭」，或许（在存储领域人尽皆知而领域外）鲜有人知在 ZFS
之前就有 <a class="reference external" href="https://en.wikipedia.org/wiki/NetApp">NetApp</a> 的商业产品
<a class="reference external" href="https://en.wikipedia.org/wiki/Write_Anywhere_File_Layout">WAFL(Write Anywhere File Layout)</a>
实现了 CoW 语义的文件系统，并且集成了快照和卷管理之类的功能。描述 btrfs 原型设计的
<a class="reference external" href="https://btrfs.wiki.kernel.org/images-btrfs/6/68/Btree_TOS.pdf">论文</a>
和 <a class="reference external" href="https://btrfs.wiki.kernel.org/images-btrfs/6/63/LinuxFS_Workshop.pdf">发表幻灯片</a>
也明显提到 WAFL 比提到 ZFS 更多一些。
我一开始也带着「 Btrfs 和 ZFS
都提供了类似的功能，因此两者必然有类似的设计」这样的先入观念，尝试去使用这两个文件系统，
却经常撞上两者细节上的差异，导致使用时需要不尽相同的工作流，
或者看似相似的用法有不太一样的性能表现，又或者一边有的功能（比如 ZFS 的 inband dedup ，
Btrfs 的 reflink ）在另一边没有的情况。</p>
<p>为了更好地理解这些差异，我四处搜罗这两个文件系统的实现细节，于是有了这篇笔记，
记录一下我查到的种种发现和自己的理解。<del>（或许会写成一个系列？还是先别乱挖坑不填。）</del>
只是自己的笔记，所有参阅的资料文档都是二手资料，没有深挖过源码，还参杂了自己的理解，
于是难免有和事实相违的地方，如有写错，还请留言纠正。</p>
<div class="section" id="btrfs-subvolume-snapshot">
<h2><a class="toc-backref" href="#id6">Btrfs 的子卷（subvolume）和快照（snapshot）</a></h2>
<p>先从两个文件系统中（表面上看起来）比较简单的 btrfs 的子卷（subvolume）和快照（snapshot）说起。
关于子卷和快照的常规用法、推荐布局之类的话题就不细说了，网上能找到很多不错的资料，比如
<a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/SysadminGuide#Subvolumes">btrfs wiki 的 SysadminGuide 页</a>
和 Arch wiki 上 <a class="reference external" href="https://wiki.archlinux.org/index.php/Btrfs#Subvolumes">Btrfs#Subvolumes</a> 页都有不错的参考价值。</p>
<div class="section" id="subvolume-snapshot">
<h3><a class="toc-backref" href="#id7">子卷（subvolume）和快照（snapshot）的术语</a></h3>
<p>在 btrfs 中，存在于存储媒介中的只有「子卷」的概念，「快照」只是个创建「子卷」的方式，
换句话说在 btrfs 的术语里，子卷（subvolume）是个名词，而快照（snapshot）是个动词。
如果脱离了 btrfs 术语的上下文，或者不精确地随口说说的时候，也经常有人把 btrfs
的快照命令创建出的子卷叫做一个快照。或者我们可以理解为，
<strong>互相共享一部分元数据（metadata）的子卷互为彼此的快照（名词）</strong> ，
那么按照这个定义的话，在 btrfs 中创建快照（名词）的方式其实有两种：</p>
<ol class="arabic simple">
<li>用 <code class="code">
btrfs subvolume snapshot</code>
 命令创建快照</li>
<li>用 <code class="code">
btrfs send</code>
 命令并使用 <code class="code">
-p</code>
 参数发送快照，并在管道另一端接收</li>
</ol>
<div class="panel panel-default">
<div class="panel-heading">
<code class="code">
btrfs send</code>
 命令的 <code class="code">
-p</code>
 与 <code class="code">
-c</code>
</div>
<div class="panel-body">
<p>这里也顺便提一下 <code class="code">
btrfs send</code>
 命令的 <code class="code">
-p</code>
 参数和 <code class="code">
-c</code>
 参数的差异。
只看 <a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/Manpage/btrfs-send#DESCRIPTION">btrfs-send(8)</a> 的描述的话：</p>
<blockquote>
<div class="line-block">
<div class="line">-p &lt;parent&gt;</div>
<div class="line-block">
<div class="line">send an incremental stream from parent to subvol</div>
<div class="line"><br/></div>
</div>
<div class="line">-c &lt;clone-src&gt;</div>
<div class="line-block">
<div class="line">use this snapshot as a clone source for an incremental send (multiple allowed)</div>
</div>
</div>
</blockquote>
<p>看起来这两个都可以用来生成两个快照之间的差分，只不过 -p 只能指定一个「parent」，
而 -c 能指定多个「clone source」。在
<a class="reference external" href="https://unix.stackexchange.com/a/490857">unix stackexchange 上有人写明了这两个的异同</a>
。使用 -p 的时候，产生的差分首先让接收端用 subvolume snapshot 命令对 parent 子卷创建一个快照，
然后发送指令将这个快照修改成目标子卷的样子，而使用 -c 的时候，首先在接收端用 subvolume create
创建一个空的子卷，随后发送指令在这个子卷中填充内容，其数据块尽量共享 clone source 已有的数据。
所以 <code class="code">
btrfs send -p</code>
 在接收端产生是有共享元数据的快照，而 <code class="code">
btrfs send -c</code>

在接收端产生的是仅仅共享数据而不共享元数据的子卷。</p>
</div>
</div>
<p>定义中「互相共享一部分 <strong>元数据</strong> 」比较重要，因为除了快照的方式之外， btrfs
的子卷间也可以通过 reflink 的形式共享数据块。我们可以对一整个子卷（甚至目录）执行
<code class="code">
cp -r --reflink=always</code>
 ，创建出一个副本，副本的文件内容通过 reflink
共享原本的数据，但不共享元数据，这样创建出的就不是快照。</p>
<p>说了这么多，其实关键的只是 btrfs 在传统 Unix 文件系统的「目录/文件/inode」
这些东西之外只增加了一个「子卷」的新概念，而子卷间可以共享元数据或者数据，
用快照命令创建出的子卷就是共享一部分元数据。</p>
</div>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id8">于是子卷在存储介质中是如何记录的呢？</a></h3>
<p>比如在 <a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/SysadminGuide#Flat">SysadminGuide 这页的 Flat 布局</a>
有个子卷布局的例子。</p>
<pre class="code literal-block">
toplevel         (volume root directory, not to be mounted by default)
    +-- root       (subvolume root directory, to be mounted at /)
    +-- home       (subvolume root directory, to be mounted at /home)
    +-- var        (directory)
    |   \-- www    (subvolume root directory, to be mounted at /var/www)
    \-- postgres   (subvolume root directory, to be mounted at /var/lib/postgresql)
</pre>
<p>用圆柱体表示子卷的话画成图大概是这个样子：</p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">

<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: Flat_layout Pages: 1 -->
<svg class="svg-responsive" height="206pt" viewbox="0.00 0.00 287.00 206.00" width="287pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g class="graph" id="graph0" transform="scale(1 1) rotate(0) translate(4 202)">
<title>Flat_layout</title>
<polygon fill="white" points="-4,4 -4,-202 283,-202 283,4 -4,4" stroke="none"></polygon>
<!-- toplevel -->
<g class="node" id="node1"><title>toplevel</title>
<polygon fill="none" points="74,-117 0,-117 0,-81 74,-81 74,-117" stroke="black"></polygon>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="37" y="-95.3">toplevel</text>
</g>
<!-- root -->
<g class="node" id="node2"><title>root</title>
<polygon fill="none" points="176.5,-198 122.5,-198 122.5,-162 176.5,-162 176.5,-198" stroke="black"></polygon>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="149.5" y="-176.3">root</text>
</g>
<!-- toplevel&#45;&gt;root -->
<g class="edge" id="edge1"><title>toplevel-&gt;root</title>
<path d="M61.858,-117.193C75.8106,-127.757 93.8106,-141.257 110,-153 111.363,-153.989 112.756,-154.993 114.166,-156.005" fill="none" stroke="black"></path>
<polygon fill="black" points="112.149,-158.865 122.326,-161.812 116.208,-153.162 112.149,-158.865" stroke="black"></polygon>
</g>
<!-- home -->
<g class="node" id="node3"><title>home</title>
<polygon fill="none" points="177.5,-144 121.5,-144 121.5,-108 177.5,-108 177.5,-144" stroke="black"></polygon>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="149.5" y="-122.3">home</text>
</g>
<!-- toplevel&#45;&gt;home -->
<g class="edge" id="edge2"><title>toplevel-&gt;home</title>
<path d="M74.1818,-107.841C86.1802,-110.773 99.5461,-114.038 111.598,-116.983" fill="none" stroke="black"></path>
<polygon fill="black" points="110.809,-120.393 121.354,-119.367 112.47,-113.593 110.809,-120.393" stroke="black"></polygon>
</g>
<!-- var -->
<g class="node" id="node4"><title>var</title>
<polygon fill="none" points="176.5,-90 173.5,-94 152.5,-94 149.5,-90 122.5,-90 122.5,-54 176.5,-54 176.5,-90" stroke="black"></polygon>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="149.5" y="-68.3">var</text>
</g>
<!-- toplevel&#45;&gt;var -->
<g class="edge" id="edge3"><title>toplevel-&gt;var</title>
<path d="M74.1818,-90.1592C86.4753,-87.1554 100.204,-83.8008 112.485,-80.8001" fill="none" stroke="black"></path>
<polygon fill="black" points="113.513,-84.152 122.396,-78.3783 111.851,-77.352 113.513,-84.152" stroke="black"></polygon>
</g>
<!-- postgres -->
<g class="node" id="node6"><title>postgres</title>
<polygon fill="none" points="189,-36 110,-36 110,-0 189,-0 189,-36" stroke="black"></polygon>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="149.5" y="-14.3">postgres</text>
</g>
<!-- toplevel&#45;&gt;postgres -->
<g class="edge" id="edge5"><title>toplevel-&gt;postgres</title>
<path d="M61.858,-80.8074C75.8106,-70.2433 93.8106,-56.7433 110,-45 111.363,-44.0113 112.756,-43.0067 114.166,-41.9951" fill="none" stroke="black"></path>
<polygon fill="black" points="116.208,-44.8379 122.326,-36.188 112.149,-39.1347 116.208,-44.8379" stroke="black"></polygon>
</g>
<!-- www -->
<g class="node" id="node5"><title>www</title>
<polygon fill="none" points="279,-90 225,-90 225,-54 279,-54 279,-90" stroke="black"></polygon>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="252" y="-68.3">www</text>
</g>
<!-- var&#45;&gt;www -->
<g class="edge" id="edge4"><title>var-&gt;www</title>
<path d="M176.643,-72C188.275,-72 202.165,-72 214.775,-72" fill="none" stroke="black"></path>
<polygon fill="black" points="214.988,-75.5001 224.988,-72 214.988,-68.5001 214.988,-75.5001" stroke="black"></polygon>
</g>
</g>
</svg>
<p>首先要说明， btrfs 中大部分长度可变的数据结构都是
<a class="reference external" href="https://www.usenix.org/legacy/events/lsf07/tech/rodeh.pdf">CoW B-tree</a>
，一种经过修改适合写时拷贝的B树结构，所以在
<a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/On-disk_Format">on-disk format</a>
中提到了很多个树。这里的树不是指文件系统中目录结构树，而是 CoW B-tree
，如果不关心B树细节的话可以把 btrfs 所说的一棵树理解为关系数据库中的一个表，
和数据库的表一样 btrfs 的树的长度可变，然后表项内容根据一个 key 排序。
有这样的背景之后，上图例子中的 Flat 布局在 btrfs 中大概是这样的数据结构：</p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">

<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: Flat_layout_on_disk Pages: 1 -->
<svg class="svg-responsive" height="453pt" viewbox="0.00 0.00 1122.00 453.00" width="1122pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g class="graph" id="graph0" transform="scale(1 1) rotate(0) translate(4 449)">
<title>Flat_layout_on_disk</title>
<polygon fill="white" points="-4,4 -4,-449 1118,-449 1118,4 -4,4" stroke="none"></polygon>
<!-- superblock -->
<g class="node" id="node1"><title>superblock</title>
<polygon fill="none" points="0,-315.5 0,-407.5 121,-407.5 121,-315.5 0,-315.5" stroke="black"></polygon>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="60.5" y="-392.3">SUPERBLOCK</text>
<polyline fill="none" points="0,-384.5 121,-384.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="60.5" y="-369.3">...</text>
<polyline fill="none" points="0,-361.5 121,-361.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="60.5" y="-346.3">root_tree</text>
<polyline fill="none" points="0,-338.5 121,-338.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="60.5" y="-323.3">...</text>
</g>
<!-- roottree -->
<g class="node" id="node2"><title>roottree</title>
<polygon fill="none" points="193,-62 193,-361 500,-361 500,-62 193,-62" stroke="black"></polygon>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="346.5" y="-345.8">ROOT_TREE</text>
<polyline fill="none" points="193,-338 500,-338 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="346.5" y="-322.8">2: extent_tree</text>
<polyline fill="none" points="193,-315 500,-315 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="346.5" y="-299.8">3: chunk_tree</text>
<polyline fill="none" points="193,-292 500,-292 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="346.5" y="-276.8">4: dev_tree</text>
<polyline fill="none" points="193,-269 500,-269 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="346.5" y="-253.8">5: fs_tree</text>
<polyline fill="none" points="193,-246 500,-246 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="346.5" y="-230.8">6: root_dir "default" -&gt; ROOT_ITEM 256</text>
<polyline fill="none" points="193,-223 500,-223 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="346.5" y="-207.8">10: free_space_tree</text>
<polyline fill="none" points="193,-200 500,-200 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="346.5" y="-184.8">256: fs_tree "root"</text>
<polyline fill="none" points="193,-177 500,-177 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="346.5" y="-161.8">257: fs_tree "home"</text>
<polyline fill="none" points="193,-154 500,-154 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="346.5" y="-138.8">258: fs_tree "www"</text>
<polyline fill="none" points="193,-131 500,-131 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="346.5" y="-115.8">259: fs_tree "postgres"</text>
<polyline fill="none" points="193,-108 500,-108 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="346.5" y="-92.8">-7: tree_log_tree</text>
<polyline fill="none" points="193,-85 500,-85 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="346.5" y="-69.8">-5: orphan_root</text>
</g>
<!-- superblock&#45;&gt;roottree -->
<g class="edge" id="edge1"><title>superblock:sn_root-&gt;roottree:label</title>
<path d="M121,-349.5C149.375,-349.5 158.88,-349.5 182.979,-349.5" fill="none" stroke="black" stroke-width="2"></path>
<polygon fill="black" points="183,-353 193,-349.5 183,-346 183,-353" stroke="black" stroke-width="2"></polygon>
</g>
<!-- roottree&#45;&gt;roottree -->
<g class="edge" id="edge8"><title>roottree:root_dir:e-&gt;roottree:root_sub_root:e</title>
<path d="M500.5,-234.5C547.667,-243.5 643,-243.5 643,-211.5 643,-181.625 559.908,-179.641 510.492,-186.833" fill="none" stroke="black" stroke-dasharray="5,2"></path>
<polygon fill="none" points="509.788,-183.402 500.5,-188.5 510.94,-190.306 509.788,-183.402" stroke="black"></polygon>
</g>
<!-- toplevel -->
<g class="node" id="node3"><title>toplevel</title>
<polygon fill="none" points="572,-195.5 572,-379.5 916,-379.5 916,-195.5 572,-195.5" stroke="black"></polygon>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="744" y="-364.3">FS_TREE "toplevel"</text>
<polyline fill="none" points="572,-356.5 916,-356.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="744" y="-341.3">256: inode_item DIR</text>
<polyline fill="none" points="572,-333.5 916,-333.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="744" y="-318.3">256: dir_item: "root" -&gt; ROOT_ITEM 256</text>
<polyline fill="none" points="572,-310.5 916,-310.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="744" y="-295.3">256: dir_item: "home" -&gt; ROOT_ITEM 257</text>
<polyline fill="none" points="572,-287.5 916,-287.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="744" y="-272.3">256: dir_item: "var" -&gt; INODE_ITEM 257</text>
<polyline fill="none" points="572,-264.5 916,-264.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="744" y="-249.3">256: dir_item: "postgres" -&gt; ROOT_ITEM 259</text>
<polyline fill="none" points="572,-241.5 916,-241.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="744" y="-226.3">257: inode_item DIR</text>
<polyline fill="none" points="572,-218.5 916,-218.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="744" y="-203.3">257: dir_item: "www" -&gt; ROOT_ITEM 258</text>
</g>
<!-- roottree&#45;&gt;toplevel -->
<g class="edge" id="edge7"><title>roottree:root_fs-&gt;toplevel:label</title>
<path d="M500,-257.5C555.013,-257.5 518.642,-354.653 561.875,-367.176" fill="none" stroke="black" stroke-width="2"></path>
<polygon fill="black" points="561.631,-370.674 572,-368.5 562.538,-363.733 561.631,-370.674" stroke="black" stroke-width="2"></polygon>
</g>
<!-- root -->
<g class="node" id="node4"><title>root</title>
<polygon fill="none" points="662,-398.5 662,-444.5 826,-444.5 826,-398.5 662,-398.5" stroke="black"></polygon>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="744" y="-429.3">FS_TREE "root"</text>
<polyline fill="none" points="662,-421.5 826,-421.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="744" y="-406.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;root -->
<g class="edge" id="edge9"><title>roottree:root_sub_root-&gt;root:label</title>
<path d="M500,-188.5C594.473,-188.5 509.414,-317.731 572,-388.5 598.955,-418.979 614.069,-431.42 650.654,-433.257" fill="none" stroke="black" stroke-width="2"></path>
<polygon fill="black" points="650.92,-436.764 661,-433.5 651.085,-429.766 650.92,-436.764" stroke="black" stroke-width="2"></polygon>
</g>
<!-- home -->
<g class="node" id="node5"><title>home</title>
<polygon fill="none" points="662,-130.5 662,-176.5 826,-176.5 826,-130.5 662,-130.5" stroke="black"></polygon>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="744" y="-161.3">FS_TREE "home"</text>
<polyline fill="none" points="662,-153.5 826,-153.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="744" y="-138.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;home -->
<g class="edge" id="edge10"><title>roottree:root_sub_home-&gt;home:label</title>
<path d="M500,-165.5C568.062,-165.5 587.57,-165.5 650.89,-165.5" fill="none" stroke="black" stroke-width="2"></path>
<polygon fill="black" points="651,-169 661,-165.5 651,-162 651,-169" stroke="black" stroke-width="2"></polygon>
</g>
<!-- www -->
<g class="node" id="node6"><title>www</title>
<polygon fill="none" points="662,-65.5 662,-111.5 826,-111.5 826,-65.5 662,-65.5" stroke="black"></polygon>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="744" y="-96.3">FS_TREE "www"</text>
<polyline fill="none" points="662,-88.5 826,-88.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="744" y="-73.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;www -->
<g class="edge" id="edge11"><title>roottree:root_sub_www-&gt;www:label</title>
<path d="M500,-142.5C533.46,-142.5 539.654,-129.063 572,-120.5 607.671,-111.057 618.551,-102.235 650.786,-100.727" fill="none" stroke="black" stroke-width="2"></path>
<polygon fill="black" points="651.08,-104.221 661,-100.5 650.925,-97.2228 651.08,-104.221" stroke="black" stroke-width="2"></polygon>
</g>
<!-- postgres -->
<g class="node" id="node7"><title>postgres</title>
<polygon fill="none" points="662,-0.5 662,-46.5 826,-46.5 826,-0.5 662,-0.5" stroke="black"></polygon>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="744" y="-31.3">FS_TREE "postgres"</text>
<polyline fill="none" points="662,-23.5 826,-23.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="744" y="-8.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;postgres -->
<g class="edge" id="edge12"><title>roottree:root_sub_postgres-&gt;postgres:label</title>
<path d="M500,-119.5C542.815,-119.5 533.903,-75.0367 572,-55.5 604.834,-38.6623 618.042,-35.9068 650.717,-35.5476" fill="none" stroke="black" stroke-width="2"></path>
<polygon fill="black" points="651.016,-39.0463 661,-35.5 650.984,-32.0464 651.016,-39.0463" stroke="black" stroke-width="2"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge2"><title>toplevel:toplevel_dir_root-&gt;roottree:root_sub_root</title>
<path d="M572,-322.5C508.089,-322.5 561.085,-202.755 509.961,-189.658" fill="none" stroke="black" stroke-dasharray="5,2"></path>
<polygon fill="none" points="510.337,-186.179 500,-188.5 509.529,-193.132 510.337,-186.179" stroke="black"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge3"><title>toplevel:toplevel_dir_home-&gt;roottree:root_sub_home</title>
<path d="M572,-299.5C508.089,-299.5 561.085,-179.755 509.961,-166.658" fill="none" stroke="black" stroke-dasharray="5,2"></path>
<polygon fill="none" points="510.337,-163.179 500,-165.5 509.529,-170.132 510.337,-163.179" stroke="black"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge5"><title>toplevel:toplevel_dir_postgres-&gt;roottree:root_sub_postgres</title>
<path d="M572,-252.5C508.59,-252.5 560.56,-134.14 510.221,-120.732" fill="none" stroke="black" stroke-dasharray="5,2"></path>
<polygon fill="none" points="510.347,-117.222 500,-119.5 509.509,-124.171 510.347,-117.222" stroke="black"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge6"><title>toplevel:toplevel_dir_www-&gt;roottree:root_sub_www</title>
<path d="M572,-206.5C533.032,-206.5 540.821,-153.483 510.255,-143.957" fill="none" stroke="black" stroke-dasharray="5,2"></path>
<polygon fill="none" points="510.393,-140.442 500,-142.5 509.408,-147.372 510.393,-140.442" stroke="black"></polygon>
</g>
<!-- toplevel&#45;&gt;toplevel -->
<g class="edge" id="edge4"><title>toplevel:toplevel_dir_var:e-&gt;toplevel:toplevel_inode_var:e</title>
<path d="M916,-275.5C982,-284.5 1114,-284.5 1114,-252.5 1114,-222.062 994.576,-220.576 926.117,-228.249" fill="none" stroke="black" stroke-dasharray="5,2"></path>
<polygon fill="none" points="925.495,-224.799 916,-229.5 926.354,-231.746 925.495,-224.799" stroke="black"></polygon>
</g>
</g>
</svg>
<p>上图中已经隐去了很多和本文无关的具体细节，所有这些细节都可以通过
<a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/Manpage/btrfs-inspect-internal">btrfs inspect-internal 的 dump-super 和 dump-tree</a>
查看到。btrfs 中的每棵树都可以看作是一个数据库中的表，可以包含很多表项，根据 KEY 排序，而 KEY
是 (object_id, item_type, item_extra) 这样的三元组。每个对象（object）在树中用一个或多个
表项（item）描述，同 object_id 的表项共同描述一个对象（object）。B树中的 key
只用来比较大小不必连续，从而 object_id 也不必连续，只是按大小排序。有一些预留的 object_id
不能用作别的用途，他们的编号范围是 -255ULL 到 255ULL，也就是表中前 255 和最后 255 个编号预留。</p>
<p>ROOT_TREE 中记录了到所有别的B树的指针，在一些文档中叫做 tree of tree roots 。「所有别的B树」
举例来说比如 2 号 extent_tree ，3 号 chunk_tree ， 4 号 dev_tree ，10 号 free_space_tree
，这些B树都是描述 btrfs 文件系统结构非常重要的组成部分，但是在本文关系不大，
今后有机会再讨论它们。在 ROOT_TREE 的 5 号对象有一个 fs_tree ，它描述了整个 btrfs pool
的顶级子卷，也就是图中叫 toplevel 的那个子卷（有些文档用定冠词称 the FS_TREE
的时候就是在说这个 5 号树，而不是别的子卷的 FS_TREE ）。除了顶级子卷之外，别的所有子卷的 object_id
在 256ULL 到 -256ULL 的范围之间，对子卷而言 ROOT_TREE 中的这些 object_id 也同时是它们的
子卷 id ，在内核挂载文件系统的时候可以用 subvolid 找到它们，别的一些对子卷的操作也可以直接用
subvolid 表示一个子卷。 ROOT_TREE 的 6 号对象描述的不是一棵树，而是一个名叫 default
的特殊目录，它指向 btrfs pool 的默认挂载子卷。最初 mkfs 的时候，这个目录指向 ROOT_ITEM 5
，也就是那个顶级子卷，之后可以通过命令 <code class="code">
btrfs subvolume set-default</code>

修改它指向别的子卷，这里它被改为指向 ROOT_ITEM 256 亦即那个名叫 "root" 的子卷。</p>
<p>每一个子卷都有一棵自己的 FS_TREE （有的文档中叫 file tree），一个 FS_TREE 相当于传统 Unix
文件系统中的一整个 inode table ，只不过它除了包含 inode 信息之外还包含所有文件夹内容。在
FS_TREE 中， object_id 同时也是它所描述对象的 inode 号，所以 btrfs
的 <strong>子卷有互相独立的 inode 编号</strong> ，不同子卷中的文件或目录可以拥有相同的 inode 。 FS_TREE
中一个目录用一个 inode_item 和多个 dir_item 描述， inode_item 是目录自己的 inode
，那些 dir_item 是目录的内容。 dir_item 可以指向别的 inode_item 来描述普通文件和子目录，
也可以指向 root_item 来描述这个目录指向一个子卷。有人或许疑惑，子卷就没有自己的 inode
么？其实如果看 <a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/Data_Structures#btrfs_root_item">数据结构定义</a>
的话 <code class="code">
struct btrfs_root_item</code>
 结构在最开头的地方包含了一个
<code class="code">
struct btrfs_inode_item</code>
 所以 root_item 也同时作为子卷的 inode
，不过用户通常看不到这个子卷的 inode ，因为子卷在被（手动或自动地）挂载到目录上之后，
用户会看到的是子卷的根目录的 inode 。</p>
<p>比如上图 FS_TREE toplevel 中，有两个对象，第一个 256 是（子卷的）根目录，第二个 257
是 "var" 目录，256 有4个子目录，其中 "root" "home" "postgres" 这三个指向了 ROOT_TREE
中的对应子卷，而 "var" 指向了 inode 257 。然后 257 有一个子目录叫 "www" 它指向了
ROOT_TREE 中 object_id 为 258 的子卷。</p>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id9">那么快照又是如何记录的呢？</a></h3>
<p>以上是子卷、目录、 inode 在 btrfs 中的记录方式，你可能想知道，如何记录一个快照呢？
特别是，如果对一个包含子卷的子卷创建了快照，会得到什么结果呢？如果我们在上面的布局基础上执行：</p>
<pre class="code bash literal-block">
btrfs subvolume snapshot toplevel toplevel/toplevel@s1
</pre>
<p>那么产生的数据结构大概如下所示：</p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">

<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: Flat_layout_on_disk Pages: 1 -->
<svg class="svg-responsive" height="712pt" viewbox="0.00 0.00 1155.00 712.00" width="1155pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g class="graph" id="graph0" transform="scale(1 1) rotate(0) translate(4 708)">
<title>Flat_layout_on_disk</title>
<polygon fill="white" points="-4,4 -4,-708 1151,-708 1151,4 -4,4" stroke="none"></polygon>
<!-- superblock -->
<g class="node" id="node1"><title>superblock</title>
<polygon fill="none" points="0,-611.5 0,-703.5 121,-703.5 121,-611.5 0,-611.5" stroke="black"></polygon>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="60.5" y="-688.3">SUPERBLOCK</text>
<polyline fill="none" points="0,-680.5 121,-680.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="60.5" y="-665.3">...</text>
<polyline fill="none" points="0,-657.5 121,-657.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="60.5" y="-642.3">root_tree</text>
<polyline fill="none" points="0,-634.5 121,-634.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="60.5" y="-619.3">...</text>
</g>
<!-- roottree -->
<g class="node" id="node2"><title>roottree</title>
<polygon fill="none" points="193,-334.5 193,-656.5 500,-656.5 500,-334.5 193,-334.5" stroke="black"></polygon>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="346.5" y="-641.3">ROOT_TREE</text>
<polyline fill="none" points="193,-633.5 500,-633.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="346.5" y="-618.3">2: extent_tree</text>
<polyline fill="none" points="193,-610.5 500,-610.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="346.5" y="-595.3">3: chunk_tree</text>
<polyline fill="none" points="193,-587.5 500,-587.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="346.5" y="-572.3">4: dev_tree</text>
<polyline fill="none" points="193,-564.5 500,-564.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="346.5" y="-549.3">5: fs_tree</text>
<polyline fill="none" points="193,-541.5 500,-541.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="346.5" y="-526.3">6: root_dir "default" -&gt; ROOT_ITEM 256</text>
<polyline fill="none" points="193,-518.5 500,-518.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="346.5" y="-503.3">10: free_space_tree</text>
<polyline fill="none" points="193,-495.5 500,-495.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="346.5" y="-480.3">256: fs_tree "root"</text>
<polyline fill="none" points="193,-472.5 500,-472.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="346.5" y="-457.3">257: fs_tree "home"</text>
<polyline fill="none" points="193,-449.5 500,-449.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="346.5" y="-434.3">258: fs_tree "www"</text>
<polyline fill="none" points="193,-426.5 500,-426.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="346.5" y="-411.3">259: fs_tree "postgres"</text>
<polyline fill="none" points="193,-403.5 500,-403.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="346.5" y="-388.3">260: fs_tree "toplevel@s1"</text>
<polyline fill="none" points="193,-380.5 500,-380.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="346.5" y="-365.3">-7: tree_log_tree</text>
<polyline fill="none" points="193,-357.5 500,-357.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="346.5" y="-342.3">-5: orphan_root</text>
</g>
<!-- superblock&#45;&gt;roottree -->
<g class="edge" id="edge1"><title>superblock:sn_root-&gt;roottree:label</title>
<path d="M121,-645.5C149.375,-645.5 158.88,-645.5 182.979,-645.5" fill="none" stroke="black" stroke-width="2"></path>
<polygon fill="black" points="183,-649 193,-645.5 183,-642 183,-649" stroke="black" stroke-width="2"></polygon>
</g>
<!-- roottree&#45;&gt;roottree -->
<g class="edge" id="edge10"><title>roottree:root_dir:e-&gt;roottree:root_sub_root:e</title>
<path d="M500.5,-530.5C547.667,-539.5 643,-539.5 643,-507 643,-476.658 559.908,-474.643 510.492,-481.833" fill="none" stroke="black" stroke-dasharray="5,2"></path>
<polygon fill="none" points="509.788,-478.402 500.5,-483.5 510.94,-485.307 509.788,-478.402" stroke="black"></polygon>
</g>
<!-- toplevel -->
<g class="node" id="node3"><title>toplevel</title>
<polygon fill="none" points="572,-334 572,-541 942,-541 942,-334 572,-334" stroke="black"></polygon>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="757" y="-525.8">FS_TREE "toplevel"</text>
<polyline fill="none" points="572,-518 942,-518 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="757" y="-502.8">256: inode_item DIR</text>
<polyline fill="none" points="572,-495 942,-495 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="757" y="-479.8">256: dir_item: "root" -&gt; ROOT_ITEM 256</text>
<polyline fill="none" points="572,-472 942,-472 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="757" y="-456.8">256: dir_item: "home" -&gt; ROOT_ITEM 257</text>
<polyline fill="none" points="572,-449 942,-449 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="757" y="-433.8">256: dir_item: "var" -&gt; INODE_ITEM 257</text>
<polyline fill="none" points="572,-426 942,-426 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="757" y="-410.8">256: dir_item: "postgres" -&gt; ROOT_ITEM 259</text>
<polyline fill="none" points="572,-403 942,-403 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="757" y="-387.8">256: dir_item: "toplevel@s1" -&gt; ROOT_ITEM 260</text>
<polyline fill="none" points="572,-380 942,-380 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="757" y="-364.8">257: inode_item DIR</text>
<polyline fill="none" points="572,-357 942,-357 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="757" y="-341.8">257: dir_item: "www" -&gt; ROOT_ITEM 258</text>
</g>
<!-- roottree&#45;&gt;toplevel -->
<g class="edge" id="edge8"><title>roottree:root_fs-&gt;toplevel:label</title>
<path d="M500,-553.5C530.042,-553.5 536.927,-534.463 561.903,-530.299" fill="none" stroke="black" stroke-width="2"></path>
<polygon fill="black" points="562.307,-533.778 572,-529.5 561.755,-526.799 562.307,-533.778" stroke="black" stroke-width="2"></polygon>
</g>
<!-- toplevels1 -->
<g class="node" id="node4"><title>toplevels1</title>
<polygon fill="none" points="585,-0.5 585,-184.5 929,-184.5 929,-0.5 585,-0.5" stroke="black"></polygon>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="757" y="-169.3">FS_TREE "toplevel@s1"</text>
<polyline fill="none" points="585,-161.5 929,-161.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="757" y="-146.3">256: inode_item DIR</text>
<polyline fill="none" points="585,-138.5 929,-138.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="757" y="-123.3">256: dir_item: "root" -&gt; ROOT_ITEM 256</text>
<polyline fill="none" points="585,-115.5 929,-115.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="757" y="-100.3">256: dir_item: "home" -&gt; ROOT_ITEM 257</text>
<polyline fill="none" points="585,-92.5 929,-92.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="757" y="-77.3">256: dir_item: "var" -&gt; INODE_ITEM 257</text>
<polyline fill="none" points="585,-69.5 929,-69.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="757" y="-54.3">256: dir_item: "postgres" -&gt; ROOT_ITEM 259</text>
<polyline fill="none" points="585,-46.5 929,-46.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="757" y="-31.3">257: inode_item DIR</text>
<polyline fill="none" points="585,-23.5 929,-23.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="757" y="-8.3">257: dir_item: "www" -&gt; ROOT_ITEM 258</text>
</g>
<!-- roottree&#45;&gt;toplevels1 -->
<g class="edge" id="edge9"><title>roottree:root_sub_s1-&gt;toplevels1:label</title>
<path d="M500,-391.5C600.182,-391.5 488.581,-188.559 573.873,-174.289" fill="none" stroke="black" stroke-width="2"></path>
<polygon fill="black" points="574.302,-177.767 584,-173.5 573.758,-170.788 574.302,-177.767" stroke="black" stroke-width="2"></polygon>
</g>
<!-- root -->
<g class="node" id="node5"><title>root</title>
<polygon fill="none" points="675,-625.5 675,-671.5 839,-671.5 839,-625.5 675,-625.5" stroke="black"></polygon>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="757" y="-656.3">FS_TREE "root"</text>
<polyline fill="none" points="675,-648.5 839,-648.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="757" y="-633.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;root -->
<g class="edge" id="edge11"><title>roottree:root_sub_root-&gt;root:label</title>
<path d="M500,-483.5C567.217,-483.5 522.405,-571.13 572,-616.5 605.796,-647.416 622.182,-658.839 663.796,-660.328" fill="none" stroke="black" stroke-width="2"></path>
<polygon fill="black" points="663.942,-663.831 674,-660.5 664.06,-656.832 663.942,-663.831" stroke="black" stroke-width="2"></polygon>
</g>
<!-- home -->
<g class="node" id="node6"><title>home</title>
<polygon fill="none" points="675,-560.5 675,-606.5 839,-606.5 839,-560.5 675,-560.5" stroke="black"></polygon>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="757" y="-591.3">FS_TREE "home"</text>
<polyline fill="none" points="675,-583.5 839,-583.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="757" y="-568.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;home -->
<g class="edge" id="edge12"><title>roottree:root_sub_home-&gt;home:label</title>
<path d="M500,-460.5C551.225,-460.5 531.4,-519.264 572,-550.5 608.433,-578.53 622.41,-593.282 663.804,-595.268" fill="none" stroke="black" stroke-width="2"></path>
<polygon fill="black" points="663.923,-598.772 674,-595.5 664.082,-591.773 663.923,-598.772" stroke="black" stroke-width="2"></polygon>
</g>
<!-- www -->
<g class="node" id="node7"><title>www</title>
<polygon fill="none" points="675,-268.5 675,-314.5 839,-314.5 839,-268.5 675,-268.5" stroke="black"></polygon>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="757" y="-299.3">FS_TREE "www"</text>
<polyline fill="none" points="675,-291.5 839,-291.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="757" y="-276.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;www -->
<g class="edge" id="edge13"><title>roottree:root_sub_www-&gt;www:label</title>
<path d="M500,-437.5C559.551,-437.5 522.961,-358.285 572,-324.5 607.137,-300.293 624.84,-302.871 663.654,-303.421" fill="none" stroke="black" stroke-width="2"></path>
<polygon fill="black" points="663.974,-306.924 674,-303.5 664.027,-299.924 663.974,-306.924" stroke="black" stroke-width="2"></polygon>
</g>
<!-- postgres -->
<g class="node" id="node8"><title>postgres</title>
<polygon fill="none" points="675,-203.5 675,-249.5 839,-249.5 839,-203.5 675,-203.5" stroke="black"></polygon>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="757" y="-234.3">FS_TREE "postgres"</text>
<polyline fill="none" points="675,-226.5 839,-226.5 " stroke="black"></polyline>
<text font-family="Times,serif" font-size="14.00" text-anchor="middle" x="757" y="-211.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;postgres -->
<g class="edge" id="edge14"><title>roottree:root_sub_postgres-&gt;postgres:label</title>
<path d="M500,-414.5C576.362,-414.5 511.957,-305.68 572,-258.5 605.486,-232.187 624.657,-237.392 663.641,-238.365" fill="none" stroke="black" stroke-width="2"></path>
<polygon fill="black" points="663.955,-241.87 674,-238.5 664.046,-234.87 663.955,-241.87" stroke="black" stroke-width="2"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge2"><title>toplevel:toplevel_dir_root-&gt;roottree:root_sub_root</title>
<path d="M572,-483.5C543.625,-483.5 534.12,-483.5 510.021,-483.5" fill="none" stroke="black" stroke-dasharray="5,2"></path>
<polygon fill="none" points="510,-480 500,-483.5 510,-487 510,-480" stroke="black"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge3"><title>toplevel:toplevel_dir_home-&gt;roottree:root_sub_home</title>
<path d="M572,-460.5C543.625,-460.5 534.12,-460.5 510.021,-460.5" fill="none" stroke="black" stroke-dasharray="5,2"></path>
<polygon fill="none" points="510,-457 500,-460.5 510,-464 510,-457" stroke="black"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge5"><title>toplevel:toplevel_dir_postgres-&gt;roottree:root_sub_postgres</title>
<path d="M572,-414.5C543.625,-414.5 534.12,-414.5 510.021,-414.5" fill="none" stroke="black" stroke-dasharray="5,2"></path>
<polygon fill="none" points="510,-411 500,-414.5 510,-418 510,-411" stroke="black"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge6"><title>toplevel:toplevel_dir_toplevels1-&gt;roottree:root_sub_s1</title>
<path d="M572,-391.5C543.625,-391.5 534.12,-391.5 510.021,-391.5" fill="none" stroke="black" stroke-dasharray="5,2"></path>
<polygon fill="none" points="510,-388 500,-391.5 510,-395 510,-388" stroke="black"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge7"><title>toplevel:toplevel_dir_www-&gt;roottree:root_sub_www</title>
<path d="M572,-345.5C523.932,-345.5 547.657,-424.351 510.245,-436.055" fill="none" stroke="black" stroke-dasharray="5,2"></path>
<polygon fill="none" points="509.413,-432.638 500,-437.5 510.391,-439.569 509.413,-432.638" stroke="black"></polygon>
</g>
<!-- toplevel&#45;&gt;toplevel -->
<g class="edge" id="edge4"><title>toplevel:toplevel_dir_var:e-&gt;toplevel:toplevel_inode_var:e</title>
<path d="M942,-437.5C1010.33,-446.5 1147,-446.5 1147,-403 1147,-361.539 1022.85,-359.596 952.039,-367.297" fill="none" stroke="black" stroke-dasharray="5,2"></path>
<polygon fill="none" points="951.513,-363.835 942,-368.5 952.345,-370.785 951.513,-363.835" stroke="black"></polygon>
</g>
</g>
</svg>
<p>在 ROOT_TREE 中增加了 260 号子卷，其内容复制自 toplevel 子卷，然后 FS_TREE toplevel
的 256 号 inode 也就是根目录中增加一个 dir_item 名叫 "<a class="reference external" href="mailto:toplevel@s1">toplevel@s1</a>" 它指向 ROOT_ITEM
的 260 号子卷。这里看似是完整复制了整个 FS_TREE 的内容，这是因为 CoW b-tree
当只有一个叶子节点时就复制整个叶子节点。如果子卷内容再多一些，除了叶子之外还有中间节点，
那么只有被修改的叶子和其上的中间节点需要复制。从而创建快照的开销基本上是
O( level of FS_TREE )，而B树的高度一般都能维持在很低的程度，所以快照创建速度近乎是常数开销。</p>
<p>从子卷和快照的这种实现方式，可以看出： <strong>虽然子卷可以嵌套子卷，但是对含有嵌套子卷的子卷做快照的语义有些特别</strong>
。上图中我没有画 <a class="reference external" href="mailto:toplevel@s1">toplevel@s1</a> 下的各个子卷到对应 ROOT_ITEM 之间的虚线箭头，
是因为这时候如果你尝试直接跳过 toplevel 挂载 <a class="reference external" href="mailto:toplevel@s1">toplevel@s1</a> 到挂载点，
会发现那些子卷没有被自动挂载，更奇怪的是那些子卷的目录项也不是个普通目录，
尝试往它们中放东西会得到无权访问的错误，对它们能做的唯一事情是手动将别的子卷挂载在上面。
推测原因在于这些子目录并不是真的目录，没有对应的目录的 inode ，试图查看它们的 inode
号会得到 2 号，而这是个保留号不应该出现在 btrfs 的 inode 号中。
每个子卷创建时会记录包含它的上级子卷，用 <code class="code">
btrfs subvolume list</code>
 可以看到每个子卷的
top level subvolid ，猜测当挂载 A 而 A 中嵌套的 B 子卷记录的上级子卷不是 A 的时候，
会出现上述奇怪行为。嵌套子卷的快照还有一些别的奇怪行为，大家可以自己探索探索。</p>
<div class="panel panel-default">
<div class="panel-heading">
建议用平坦的子卷布局</div>
<div class="panel-body">
<p>因为上述嵌套子卷在做快照时的特殊行为，
我个人建议是 <strong>保持平坦的子卷布局</strong> ，也就是说：</p>
<ol class="arabic simple">
<li>只让顶层子卷包含其它子卷，除了顶层子卷之外的子卷只做手工挂载，不放嵌套子卷</li>
<li>只在顶层子卷对其它子卷做快照，不快照顶层子卷</li>
<li>虽然可以在顶层子卷放子卷之外的东西（文件或目录），不过因为想避免对顶层子卷做快照，
所以避免在顶层子卷放普通文件。</li>
</ol>
</div>
</div>
<p>btrfs 的子卷可以设置「可写」或者「只读」，在创建一个快照的时候也可以通过 <code class="code">
-r</code>

参数创建出一个只读快照。通常只读快照可能比可写的快照更有用，因为 <code class="code">
btrfs send</code>

命令只接受只读快照作为参考点。子卷可以有两种方式切换它是否只读的属性，可以通过
<code class="code">
btrfs property set &lt;subvol&gt; ro</code>
 直接修改是否只读，也可以对只读子卷用
<code class="code">
btrfs subvolume snapshot</code>
 创建出可写子卷，或者反过来对可写子卷创建出只读子卷。</p>
<p>只读快照也有些特殊的限制，在 <a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/SysadminGuide#Special_Cases">SysadminGuide#Special_Cases</a>
就提到一例，你不能把只读快照用 mv 移出包含它的目录，虽然你能用 mv 给它改名或者移动包含它的目录
到别的地方。 btrfs wiki 上给出这个限制的原因是子卷中记录了它的上级，
所以要移动它到别的上级需要修改这个子卷，从而只读子卷没法移动到别的上级（
不过我还没搞清楚子卷在哪儿记录了它的上级，记录的是上级目录还是上级子卷）。不过这个限制可以通过
对只读子卷在目标位置创建一个新的只读快照，然后删掉原位置的只读快照来解决。</p>
</div>
</div>
<div class="section" id="zfs-dataset-snapshot-clone">
<h2><a class="toc-backref" href="#id10">ZFS 的数据集（dataset）、快照（snapshot）、克隆（clone）及其它</a></h2>
<p>Btrfs 给传统文件系统只增加了子卷的概念，相比之下 ZFS 中类似子卷的概念有好几个，据我所知有这些：</p>
<ul class="simple">
<li>数据集（dataset）</li>
<li>快照（snapshot）</li>
<li>克隆（clone）</li>
<li>书签（bookmark）：从 ZFS on Linux v0.6.4 开始</li>
<li>检查点（checkpoint）：从 ZFS on Linux v0.8.0 开始</li>
</ul>
<p>梳理一下这些概念之间的关系也是最初想写下这篇笔记的初衷。先画个简图，随后逐一讲讲这些东西：</p>
<img alt="ditaa diagram" class="ditaa img-responsive" src="//farseerfc.me/uml/d0a8892b.png"/>
<div class="section" id="dataset">
<h3><a class="toc-backref" href="#id11">数据集（dataset）</a></h3>
<p>先从最简单的概念说起。在 ZFS 的术语中，把底层管理和释放存储设备空间的叫做 ZFS 存储池（pool），
简称 zpool ，其上可以创建多个数据集（dataset）。容易看出数据集的概念直接对应 btrfs
中的子卷。也有很多介绍 ZFS 的文档中把一个数据集（dataset）叫做一个文件系统（filesystem），
这或许是想要和（像 Solaris 的 SVM 或者 Linux 的 LVM 这样的）传统的卷管理器
与其上创建的多个文件系统（Solaris UFS 或者 Linux ext）这样的上下层级做类比。
从 btrfs 的子卷在内部结构中叫作 FS_TREE 这一点可以看出，至少在 btrfs
早期设计中大概也是把子卷称为 filesystem 做过类似的类比的。</p>
<p>与 btrfs 的子卷不同的是， ZFS 的数据集之间是完全隔离的，（除了后文会讲的 dedup
方式之外）不可以共享任何数据或者元数据。一个数据集还包含了隶属于其中的快照（snapshot）、
克隆（clone）和书签（bookmark）。</p>
</div>
<div class="section" id="snapshot">
<h3><a class="toc-backref" href="#id12">快照（snapshot）</a></h3>
<p>一个 ZFS 的快照有点像一个 btrfs 的只读快照，是标记数据集在某一历史时刻上的只读状态。</p>
</div>
</div>

            </div>
            <div class="entry-content jumbotron" id="source-content" style="display: none">
                <!-- <pre><code id="source-code">
                </code></pre> -->
                <div id="source-code"></div>
            </div>
            <!-- /.entry-content -->

            <div class="row" id="prevnext">
                <div class="col-xs-12">
                </div>
                <div class="col-xs-12">
                </div>
            </div>

            <div class="panel panel-default" id="series">
                <div class="panel-heading">
                  <h4>
This is part <built-in method index of str object at 0x7f0a8fbf22f0> of the "" series:                  </h4>
                </div>
                <ul class="list-group">
                </ul>
            </div>

<section class="comments" id="comments">
    <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
      <div class="panel panel-primary">
        <div class="panel-heading" role="tab" id="disqus-heading">
          <h4 class="panel-title">
            <a data-toggle="collapse" data-parent="#accordion" href="#disqus-comments" aria-expanded="false" aria-controls="disqus-comments">
              <i class="fa fa-comments-o"></i> Disqus comments            </a>
          </h4>
        </div>
        <div id="disqus-comments" class="panel-collapse collapse" role="tabpanel" aria-labelledby="disqus-heading">
          <div class="panel-body">
            <div class="tab-pane fade active in" id="disqus-comments">
                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'farseerfcgithub'; // required: replace example with your forum shortname

                            var disqus_identifier = 'btrfs-vs-zfs-difference-in-implementing-snapshots';
                        var disqus_url = 'http://farseerfc.me/en/zhs/drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html';

                    var disqus_config = function () {

                        this.language = "zh";
                    };

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function () {
                        var dsq = document.createElement('script');
                        dsq.type = 'text/javascript';
                        dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
                    Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
          </div>
        </div>
      </div>
    </div>
</section>        </article>
    </section>


            </div>
<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <a data-dismiss="modal" href="javascript:void(0);">
            <img id="mimg" src="" style="width:100%;height:auto">
          </a>
        </div>
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
        </div>
        <div class="col-xl-3 col-lg-4 col-md-6" id="sidebar">
            <aside>

<section>
    <div class="sidebar-container">
<div class="sidebar-item ">
<div class="panel panel-default">
	<div class="panel-heading">
        <h4>
<i class="fa fa-user fa-lg"></i>
<a href="//farseerfc.me/en/about.html">
About farseerfc</a>
        </h4>
    </div>
<div class="panel-body" id="aboutme">
        <a href="//farseerfc.me/en/about.html"><img width="100%" src="//farseerfc.me/en/../images/avatar.jpg"/></a>
    <h3 style="text-align:center">
<a href="https://sak.uy/"                  target="_blank">
<i class="fa fa-music" style="text-align:center"></i></a>
<a href="https://twitter.com/farseerfc"                  target="_blank">
<i class="fa fa-twitter" style="text-align:center"></i></a>
<a href="https://github.com/farseerfc"                   target="_blank">
<i class="fa fa-github" style="text-align:center"></i></a>
<a href="http://www.facebook.com/farseerfc"              target="_blank">
<i class="fa fa-facebook" style="text-align:center"></i></a>
<a href="https://plus.google.com/u/0/+JiachenYang/posts" target="_blank">
<i class="fa fa-google-plus" style="text-align:center"></i></a>
<a href="mailto:farseerfc@gmail.com" target="_blank">
<i class="mdi-communication-email" style="text-align:center"></i></a>
</h3>

</div>
</div>
</div>





<div class="sidebar-item hidden-xs">
<div class="panel panel-default">
	<div class="panel-heading">
        <h4>
<a href="//farseerfc.me/en/tags.html"><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></a>
        </h4>
    </div>
<div class="panel-body">
    <ul class="list-group list-inline tagcloud" id="tags">
            <li class="list-group-item tag-1">
                <a href="//farseerfc.me/en/tag/python.html">
                    python <sup> 3</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/pacvis.html">
                    pacvis <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/pacman.html">
                    pacman <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/arch.html">
                    arch <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-1">
                <a href="//farseerfc.me/en/tag/linux.html">
                    linux <sup> 3</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/pacgraph.html">
                    pacgraph <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/kde5.html">
                    kde5 <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/plasma.html">
                    plasma <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/gnome3.html">
                    gnome3 <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/will.html">
                    will <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/you.html">
                    you <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/marry.html">
                    marry <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/me.html">
                    me <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/msr.html">
                    msr <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/icse.html">
                    icse <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/mining.html">
                    mining <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/software.html">
                    software <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/repository.html">
                    repository <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/ruby.html">
                    ruby <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/template.html">
                    template <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/c.html">
                    C <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/pelican.html">
                    pelican <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-2">
                <a href="//farseerfc.me/en/tag/microsoft.html">
                    microsoft <sup> 2</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/acpi.html">
                    acpi <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/java.html">
                    java <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/en/tag/music.html">
                    music <sup> 1</sup>
                </a>
            </li>
    </ul>
</div>
</div>
</div>

<div class="sidebar-item hidden-xs">
<div class="panel panel-default">
	<div class="panel-heading">
        <h4>
<i class="fa fa-github fa-lg"></i><span class="icon-label">GitHub Repos</span>
        </h4>
    </div>
    <div class="panel-body">
        <div id="gh_repos">
            <p class="list-group-item">Status updating...</p>
        </div>
            <a href="https://github.com/farseerfc">@farseerfc</a> on GitHub<br>
    </div>
</div>
</div>
<div class="sidebar-item hidden-xs">
<div class="panel panel-default">
	<div class="panel-heading">
        <h4>
<a href="https://sak.uy/">
<i class="fa fa-home fa-lg"></i><span class="icon-label">Sakuya的音樂盒</span>
</a>
        </h4>
    </div>
    <div class="panel-body">
        <div id="other_blog_posts">
            <p class="list-group-item">Status updating...</p>
        </div>
    </div>
</div>
</div>

    </div>
</section>
        <div class="panel panel-default hidden-xs hidden-sm" id="affix-toc">
            <div class="panel-heading"><h4>
Table of Contents</h4>
            </div>
            <div class="panel-boy">
            <div class="toc" id="">

<ul class="simple">
<li><a class="reference internal" href="#btrfs-subvolume-snapshot" id="id6">Btrfs 的子卷（subvolume）和快照（snapshot）</a><ul>
<li><a class="reference internal" href="#subvolume-snapshot" id="id7">子卷（subvolume）和快照（snapshot）的术语</a></li>
<li><a class="reference internal" href="#id3" id="id8">于是子卷在存储介质中是如何记录的呢？</a></li>
<li><a class="reference internal" href="#id5" id="id9">那么快照又是如何记录的呢？</a></li>
</ul>
</li>
<li><a class="reference internal" href="#zfs-dataset-snapshot-clone" id="id10">ZFS 的数据集（dataset）、快照（snapshot）、克隆（clone）及其它</a><ul>
<li><a class="reference internal" href="#dataset" id="id11">数据集（dataset）</a></li>
<li><a class="reference internal" href="#snapshot" id="id12">快照（snapshot）</a></li>
</ul>
</li>
</ul>
</div>
            </div>
        </div>
            </aside>
        </div>
    </div>
</div>


<footer id="fcfooter">
   <hr/>
   <div class="container">
      <div class="row">
         <div class="col-md-24">
         <p><small>
            &copy; 2016 farseerfc
            &middot; Powered by            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a> generator                <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a>
    <!-- Content -->
  <!-- licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution 4.0 International License</a>, except where indicated otherwise. -->

         </small></p>
         </div>
      </div>
   </div>
   <a href="#" class="btn btn-primary btn-fab btn-raised mdi-editor-vertical-align-top withripple" style="position:fixed;bottom:30px;right:30px;z-index:1000"></a>
</footer>
<script src="//farseerfc.me/en/../theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="//farseerfc.me/en/../theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="//farseerfc.me/en/../theme/js/respond.min.js"></script>

    <!-- GitHub JS -->
    <script type="text/javascript">
        $(document).ready(function () {
            if (!window.jXHR) {
                var jxhr = document.createElement('script');
                jxhr.type = 'text/javascript';
                jxhr.src = '//farseerfc.me/en/../theme/js/jXHR.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(jxhr, s);
            }

            github.showRepos({
                user: 'farseerfc',
                count: 5,
                skip_forks: false,
                target: '#gh_repos'
            });
        });
    </script>
    <script src="//farseerfc.me/en/../theme/js/github.js" type="text/javascript"></script>
    <!-- End GitHub JS Code -->
<!-- Other Blog JS -->
<script type="text/javascript">
    $(document).ready(function () {
        if (!window.jXHR) {
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '//farseerfc.me/en/../theme/js/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }
        other_blog.showRepos({
            url: 'https://sak.uy/',
            target: '#other_blog_posts'
        });
    });
</script>
<script src="//farseerfc.me/en/../theme/js/other_blog.js" type="text/javascript"></script>
<!-- End Other Blog JS Code -->
    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'farseerfcgithub'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-29540705-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->

<script src="//farseerfc.me/en/../theme/js/ripples.min.js"></script>
<script src="//farseerfc.me/en/../theme/js/material.min.js"></script>
<script src="//farseerfc.me/en/../theme/js/jquery.bootstrap-autohidingnavbar.min.js"></script>
<script>
    $(document).ready(function() {
        $.material.init();
        $("div.navbar").autoHidingNavbar();
        $(".img-responsive").css("cursor","pointer").on('click',function(){
            var sr=$(this).attr('src');
            $('#mimg').attr('src',sr);
            $('#myModal').modal('show');
        });
        $('#affix-toc').affix({
          offset: {
            top: function(){
                if($('#affix-toc').hasClass("affix"))
                    return $('#sidebar').height();
                return $('#sidebar').height() - $('#affix-toc').height();
            },
            bottom: function (){
                return $("#fcfooter").offset().top -
                    $("#article-content").offset().top -
                    $("#article-content").height() + 20;
            }
          }
        });
        $('#affix-toc').width($('#sidebar').width());
    });
    $(window).resize(function () {
       $('#affix-toc').width($('#sidebar').width());
    });
</script>

</body>
</html>