<!DOCTYPE html>
<html lang="zh-Hant"
>
<head>
    <title>Btrfs vs ZFS 實現 snapshot 的差異 - Farseerfcの巣</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <meta name="theme-color" content="#6b5594">
    <meta name="msapplication-navbutton-color" content="#6b5594">
    <meta name="apple-mobile-web-app-status-bar-style" content="#6b5594">
    <link rel="manifest" href="/manifest.json">


<link rel="apple-touch-icon" sizes="180x180" href="//farseerfc.me/jp/images/apple-touch-icon.png">
<link rel="icon" type="image/png" href="//farseerfc.me/jp/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="//farseerfc.me/jp/images/favicon-16x16.png" sizes="16x16">
<link rel="mask-icon" href="//farseerfc.me/jp/images/safari-pinned-tab.svg" color="#603cba">

<link rel="canonical" href="//farseerfc.me/jp/../drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html">

        <meta name="author" content="farseerfc" />
        <meta name="keywords" content="btrfs,zfs,cow,snapshot,clone,subvolume,dedup,reflink" />
        <meta name="description" content="Btrfs 和 ZFS 都是開源的寫時拷貝（Copy on Write, CoW）文件系統，都提供了相似的子卷管理和 快照(snapshot）的功能。網上有不少文章都評價 ZFS 實現 CoW FS 的創新之處，進而想說「 Btrfs 只是 Linux/GPL 陣營對 ZFS 的拙劣抄襲」。或許（在存儲領域人盡皆知而在領域外）鮮有人知，在 ZFS 之前就有 NetApp 的商業產品 WAFL(Write Anywhere File Layout) 實現了 CoW 語義的文件系統，並且集成了快照和卷管理之類的功能。描述 btrfs 原型設計的 論文 和 發表幻燈片 …" />

        <meta property="og:site_name" content="Farseerfcの巣" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Btrfs vs ZFS 實現 snapshot 的差異"/>
        <meta property="og:url" content="//farseerfc.me/jp/../drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html"/>
        <meta property="og:description" content="Btrfs 和 ZFS 都是開源的寫時拷貝（Copy on Write, CoW）文件系統，都提供了相似的子卷管理和 快照(snapshot）的功能。網上有不少文章都評價 ZFS 實現 CoW FS 的創新之處，進而想說「 Btrfs 只是 Linux/GPL 陣營對 ZFS 的拙劣抄襲」。或許（在存儲領域人盡皆知而在領域外）鮮有人知，在 ZFS 之前就有 NetApp 的商業產品 WAFL(Write Anywhere File Layout) 實現了 CoW 語義的文件系統，並且集成了快照和卷管理之類的功能。描述 btrfs 原型設計的 論文 和 發表幻燈片 …"/>
        <meta property="article:published_time" content="2020-01-01" />
            <meta property="article:section" content="tech" />
            <meta property="article:tag" content="btrfs" />
            <meta property="article:tag" content="zfs" />
            <meta property="article:tag" content="cow" />
            <meta property="article:tag" content="snapshot" />
            <meta property="article:tag" content="clone" />
            <meta property="article:tag" content="subvolume" />
            <meta property="article:tag" content="dedup" />
            <meta property="article:tag" content="reflink" />
            <meta property="article:author" content="farseerfc" />
        <meta property="og:image"
                  content="//farseerfc.me/jp/btrfs-vs-zfs-difference-in-implementing-snapshots.png"/>



    <!-- Bootstrap -->
        <link href="//farseerfc.me/jp/../theme/css/bootstrap.min.css" rel="stylesheet">

    <link href="//farseerfc.me/jp/../theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="//farseerfc.me/jp/../theme/css/pygments/monokai.css" rel="stylesheet">
    <link href="//farseerfc.me/jp/../theme/tipuesearch/tipuesearch.css" rel="stylesheet">
        <link href="//farseerfc.me/jp/../theme/css/html4css1.css" rel="stylesheet">
    <link rel="stylesheet" href="//farseerfc.me/jp/../theme/css/style.css" type="text/css"/>

        <link href="//farseerfc.me/jp/feeds/atom.xml" type="application/atom+xml" rel="alternate"
              title="Farseerfcの巣 ATOM Feed"/>

        <link href="//farseerfc.me/jp/../theme/css/material.min.css" rel="stylesheet">
        <link href="//farseerfc.me/jp/../theme/css/ripples.css" rel="stylesheet">
    <link href="//farseerfc.me/jp/../theme/css/github-markdown.css" rel="stylesheet">
</head>
<body>
<div style="display:none" id="title">Btrfs vs ZFS 實現 snapshot 的差異 - Farseerfcの巣</div>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
         <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">ナビの切り替え</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="//farseerfc.me/jp/" class="navbar-brand">
Farseerfcの巣            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">

                    <li class="dropdown hidden-lg hidden-xl">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="javascript:void(0)">
                            <i class="mdi-action-translate"></i><span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a href="//farseerfc.me/">繁體</a></li>
                            <li class="active"><a href="//farseerfc.me/jp/">日本語</a></li>
                            <li><a href="//farseerfc.me/en/">English</a></li>
                            <li><a href="//farseerfc.me/zhs/">简体</a></li>
                        </ul>
                    </li>

                    <ul class="nav navbar-nav hidden-xs hidden-md hidden-sm">
                        <li><a href="//farseerfc.me/"><i class="mdi-action-translate"></i>繁體</a></li>
                        <li class="active"><a href="//farseerfc.me/jp/"><i class="mdi-action-translate"></i>日本語</a></li>
                        <li><a href="//farseerfc.me/en/"><i class="mdi-action-translate"></i>English</a></li>
                        <li><a href="//farseerfc.me/zhs/"><i class="mdi-action-translate"></i>简体</a></li>
                    </ul>

                    <li class="dropdown hidden-md hidden-lg hidden-xl">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="javascript:void(0)">
                            <i class="fa fa-user"></i><span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu">
                             <li class=""><a href="//farseerfc.me/jp/pages/about.html"><i class="fa fa-user"></i>
                                 連絡
                              </a></li>
                        </ul>
                    </li>

                  <ul class="nav navbar-nav hidden-xs hidden-sm">
                     <li class=""><a href="//farseerfc.me/jp/pages/about.html"><i class="fa fa-user"></i>
                         連絡
                      </a></li>
                  </ul>
            </ul>

                <ul class="nav navbar-nav hidden-md hidden-lg hidden-xl">
                    <li class="dropdown hidden-md hidden-lg hidden-xl">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="javascript:void(0)">
                            <i class="fa fa-folder-o"></i><span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li >
                                <a href="//farseerfc.me/jp/category/import.html"><i class="fa fa-folder-o"></i> Import</a>
                            </li>
                            <li >
                                <a href="//farseerfc.me/jp/category/life.html"><i class="fa fa-folder-o"></i> Life</a>
                            </li>
                            <li class="active">
                                <a href="//farseerfc.me/jp/category/tech.html"><i class="fa fa-folder-o"></i> Tech</a>
                            </li>
                        </ul>
                    </li>
                </ul>

                    <ul class="nav navbar-nav hidden-xs hidden-sm">
                        <li >
                            <a href="//farseerfc.me/jp/category/import.html"><i class="fa fa-folder-o"></i> Import</a>
                        </li>
                        <li >
                            <a href="//farseerfc.me/jp/category/life.html"><i class="fa fa-folder-o"></i> Life</a>
                        </li>
                        <li class="active">
                            <a href="//farseerfc.me/jp/category/tech.html"><i class="fa fa-folder-o"></i> Tech</a>
                        </li>
                    </ul>



            <ul class="nav navbar-nav navbar-right hidden-sm hidden-md hidden-lg hidden-xl">
                <li class="dropdown hidden-md hidden-lg hidden-xl">
                    <a class="dropdown-toggle" data-toggle="dropdown" href="javascript:void(0)">
                        <i class="fa fa-search"></i><span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu">
                      <li><span>
                        <form class="navbar-search" action="/search.html">
                          <input type="text" class="search-query form-control col-lg-16" placeholder="検索" name="q" id="tipue_search_input" required>
                        </form></span>
                      </li>
                    </ul>
                </li>
            </ul>

            <ul class="nav navbar-right navbar-form hidden-xs">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query form-control col-lg-16" placeholder="検索" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
            </ul>

            <ul class="nav navbar-nav navbar-right hidden-xs">
              <li><a href="//farseerfc.me/jp/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">一覧</span></a></li>
              <li><a href="//farseerfc.me/jp/feeds/atom.xml" title="Atom feeds for all articles"><i class="fa fa-rss"></i></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container" style="min-height: 100%;height: auto !important;height: 100%;">
    <div class="row" style="padding-bottom:80px;padding-top:80px;">
        <div class="col-xl-21 col-lg-20 col-md-18">
            <div id="loading-block">
            <ol class="breadcrumb">
                <li><a href="//farseerfc.me/jp/" title="Farseerfcの巣"><i class="fa fa-home fa-lg"></i></a></li>
                <li><a href="//farseerfc.me/jp/category/tech.html" title="tech">tech</a></li>
                <li class="active">Btrfs vs ZFS 實現 snapshot 的差異</li>
            </ol>
    <section id="content" class="article-content">
        <article>
            <header class="page-header jumbotron jumbotron-primary panel-primary" id="article-header">
                <div class="panel-heading">
                    <h1>
                        Btrfs vs ZFS 實現 snapshot 的差異
                        <a href="//farseerfc.me/jp/../drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html"
                           rel="bookmark"
                           class="btn btn-primary btn-lg"
                           title="Btrfs vs ZFS 實現 snapshot 的差異　へのパーマリンク">
                           <i class="mdi-action-launch"></i>
                        </a>
                    </h1>
                </div>
                <div class="panel-body">
<div class="post-info">
    <span class="published">
        <time datetime="2020-01-01T13:45:00+09:00"><i class="fa fa-calendar"></i> 2020年01月01日(週三)</time>
    </span>



<div class="btn-group translations">
<a href="javascript:void(0)" class="btn btn-primary dropdown-toggle" data-toggle="dropdown"><i class="mdi-action-translate"></i><span class="caret"></a>
<ul class="dropdown-menu">
<li class="active"><a href="//farseerfc.me/jp/../drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html">繁體</a></li><li><a href="//farseerfc.me/jp/zhs/drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html" class="translate">简体</a></li></ul>
</div>

    <a onclick="$.get('//farseerfc.me/jp/btrfs-vs-zfs-difference-in-implementing-snapshots.rst.html', function(data){$('#source-code').html(data)});$('#article-content').toggle();$('#source-content').toggle();" class="btn btn-primary" title="このページのソースコードを表示する"><i class="fa fa-code"></i></a>
    <a href="//farseerfc.me/jp/btrfs-vs-zfs-difference-in-implementing-snapshots.pdf" class="btn btn-primary" title="このページの印刷版PDFファイルを表示する" target="_blank"><i class="fa fa-file-pdf-o"></i></a>
    <a href="//farseerfc.me/jp/btrfs-vs-zfs-difference-in-implementing-snapshots.png" class="btn btn-primary" title="このページのスクリーンショットPNGファイルを表示する" target="_blank""><i class="fa fa-file-photo-o"></i></a>

<small><span><a href="//farseerfc.me/jp/../drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html#disqus_thread" class="btn btn-primary" data-disqus-identifier="btrfs-vs-zfs-difference-in-implementing-snapshots" data-disqus-url="http://farseerfc.me/jp/../drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html"><i class="fa fa-comments-o"></i></a></span></small><span class="btn-group">
	<a href="//farseerfc.me/jp/tag/btrfs.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> btrfs</a>
	<a href="//farseerfc.me/jp/tag/zfs.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> zfs</a>
	<a href="//farseerfc.me/jp/tag/cow.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> cow</a>
	<a href="//farseerfc.me/jp/tag/snapshot.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> snapshot</a>
	<a href="//farseerfc.me/jp/tag/clone.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> clone</a>
	<a href="//farseerfc.me/jp/tag/subvolume.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> subvolume</a>
	<a href="//farseerfc.me/jp/tag/dedup.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> dedup</a>
	<a href="//farseerfc.me/jp/tag/reflink.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> reflink</a>
</span>



</div><!-- /.post-info -->                </div>
            </header>

            <div class="entry-content jumbotron" id="article-content">
                    <div class="panel panel-default">
                        <div class="panel-heading">
目次                        </div>
                        <div class="panel-boy">
                        <div class="toc" id="">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#btrfs-subvolume-snapshot" id="id8">Btrfs 的子卷（subvolume）和快照（snapshot）</a><ul>
<li><a class="reference internal" href="#subvolume-snapshot" id="id9">子卷（subvolume）和快照（snapshot）的術語</a></li>
<li><a class="reference internal" href="#id3" id="id10">於是子卷在存儲介質中是如何記錄的呢？</a></li>
<li><a class="reference internal" href="#id5" id="id11">那麼快照又是如何記錄的呢？</a></li>
</ul>
</li>
<li><a class="reference internal" href="#zfs-filesystem-snapshot-clone" id="id12">ZFS 的文件系統（filesystem）、快照（snapshot）、克隆（clone）及其它</a><ul>
<li><a class="reference internal" href="#zfs" id="id13">ZFS 設計中和快照相關的一些術語和概念</a><ul>
<li><a class="reference internal" href="#dataset" id="id14">數據集（dataset）</a></li>
<li><a class="reference internal" href="#filesystem" id="id15">文件系統（filesystem）</a></li>
<li><a class="reference internal" href="#snapshot" id="id16">快照（snapshot）</a></li>
<li><a class="reference internal" href="#clone" id="id17">克隆（clone）</a></li>
<li><a class="reference internal" href="#bookmark" id="id18">書籤（bookmark）</a></li>
<li><a class="reference internal" href="#checkpoint" id="id19">檢查點（checkpoint）</a></li>
</ul>
</li>
<li><a class="reference internal" href="#zfs-btrfs" id="id20">ZFS 的概念與 btrfs 概念的對比</a></li>
<li><a class="reference internal" href="#id6" id="id21">ZFS 中是如何存儲這些數據集的呢</a><ul>
<li><a class="reference internal" href="#id7" id="id22">ZFS 的存儲格式概況</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
                        </div>
                    </div>
                
<p>Btrfs 和 ZFS 都是開源的寫時拷貝（Copy on Write, CoW）文件系統，都提供了相似的子卷管理和
快照(snapshot）的功能。網上有不少文章都評價 ZFS 實現 CoW FS 的創新之處，進而想說「 Btrfs
只是 Linux/GPL 陣營對 ZFS 的拙劣抄襲」。或許（在存儲領域人盡皆知而在領域外）鮮有人知，在
ZFS 之前就有 <a class="reference external" href="https://en.wikipedia.org/wiki/NetApp">NetApp</a> 的商業產品
<a class="reference external" href="https://en.wikipedia.org/wiki/Write_Anywhere_File_Layout">WAFL(Write Anywhere File Layout)</a>
實現了 CoW 語義的文件系統，並且集成了快照和卷管理之類的功能。描述 btrfs 原型設計的
<a class="reference external" href="https://btrfs.wiki.kernel.org/images-btrfs/6/68/Btree_TOS.pdf">論文</a>
和 <a class="reference external" href="https://btrfs.wiki.kernel.org/images-btrfs/6/63/LinuxFS_Workshop.pdf">發表幻燈片</a>
也明顯提到 WAFL 比提到 ZFS 更多一些，應該說 WAFL 這樣的企業級存儲方案纔是 ZFS 和 btrfs
共同的靈感來源，而無論是 ZFS 還是 btrfs 在其設計中都汲取了很多來自 WAFL 的經驗教訓。</p>
<p>我一開始也帶着「 Btrfs 和 ZFS
都提供了類似的功能，因此兩者必然有類似的設計」這樣的先入觀念，嘗試去使用這兩個文件系統，
卻經常撞上兩者細節上的差異，導致使用時需要不盡相同的工作流，
或者看似相似的用法有不太一樣的性能表現，又或者一邊有的功能（比如 ZFS 的 inband dedup ，
Btrfs 的 reflink ）在另一邊沒有的情況。後來看到了
<a class="reference external" href="https://lwn.net/Articles/342892/">LWN 的這篇 《A short history of btrfs》</a>
讓我意識到 btrfs 和 ZFS 雖然表面功能上看起來類似，但是實現細節上完全不一樣，
所以需要不一樣的用法，適用於不一樣的使用場景。</p>
<p>爲了更好地理解這些差異，我四處蒐羅這兩個文件系統的實現細節，於是有了這篇筆記，
記錄一下我查到的種種發現和自己的理解。<del>（或許會寫成一個系列？還是先別亂挖坑不填。）</del>
只是自己的筆記，所有參閱的資料文檔都是二手資料，沒有深挖過源碼，還參雜了自己的理解，
於是難免有和事實相違的地方，如有寫錯，還請留言糾正。</p>
<div class="section" id="btrfs-subvolume-snapshot">
<h2><a class="toc-backref" href="#id8">Btrfs 的子卷（subvolume）和快照（snapshot）</a></h2>
<p>先從兩個文件系統中（表面上看起來）比較簡單的 btrfs 的子卷（subvolume）和快照（snapshot）說起。
關於子卷和快照的常規用法、推薦佈局之類的話題就不細說了，網上能找到很多不錯的資料，比如
<a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/SysadminGuide#Subvolumes">btrfs wiki 的 SysadminGuide 頁</a>
和 Arch wiki 上 <a class="reference external" href="https://wiki.archlinux.org/index.php/Btrfs#Subvolumes">Btrfs#Subvolumes</a> 頁都有不錯的參考價值。</p>
<p>關於寫時拷貝（CoW）文件系統的優勢，我們爲什麼要用 btrfs/zfs 這樣的寫時拷貝文件系統，
而不是傳統的文件系統設計，或者寫時拷貝文件系統在使用時有什麼區別之類的，網上同樣也能找到很多介紹
，這裏不想再討論。這裏假設你用過 btrfs/zfs 至少一個的快照功能，知道它該怎麼用，
並且想知道更多細節，判斷怎麼用那些功能才合理。</p>
<div class="section" id="subvolume-snapshot">
<h3><a class="toc-backref" href="#id9">子卷（subvolume）和快照（snapshot）的術語</a></h3>
<p>在 btrfs 中，存在於存儲媒介中的只有「子卷」的概念，「快照」只是個創建「子卷」的方式，
換句話說在 btrfs 的術語裏，子卷（subvolume）是個名詞，而快照（snapshot）是個動詞。
如果脫離了 btrfs 術語的上下文，或者不精確地稱呼的時候，也經常有文檔把 btrfs
的快照命令創建出的子卷叫做一個快照，所以當提到快照的時候，根據上下文判斷這裏是個動詞還是名詞，
把名詞的快照當作用快照命令創建出的子卷就可以了。或者我們可以理解爲，
<strong>互相共享一部分元數據（metadata）的子卷互爲彼此的快照（名詞）</strong> ，
那麼按照這個定義的話，在 btrfs 中創建快照（名詞）的方式其實有兩種：</p>
<ol class="arabic simple">
<li>用 <code class="code">
btrfs subvolume snapshot</code>
 命令創建快照</li>
<li>用 <code class="code">
btrfs send</code>
 命令並使用 <code class="code">
-p</code>
 參數發送快照，並在管道另一端接收</li>
</ol>
<div class="panel panel-default">
<div class="panel-heading">
<code class="code">
btrfs send</code>
 命令的 <code class="code">
-p</code>
 與 <code class="code">
-c</code>
</div>
<div class="panel-body">
<p>這裏也順便提一下 <code class="code">
btrfs send</code>
 命令的 <code class="code">
-p</code>
 參數和 <code class="code">
-c</code>
 參數的差異。
只看 <a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/Manpage/btrfs-send#DESCRIPTION">btrfs-send(8)</a> 的描述的話：</p>
<blockquote>
<div class="line-block">
<div class="line">-p &lt;parent&gt;</div>
<div class="line-block">
<div class="line">send an incremental stream from parent to subvol</div>
<div class="line"><br/></div>
</div>
<div class="line">-c &lt;clone-src&gt;</div>
<div class="line-block">
<div class="line">use this snapshot as a clone source for an incremental send (multiple allowed)</div>
</div>
</div>
</blockquote>
<p>看起來這兩個都可以用來生成兩個快照之間的差分，只不過 -p 只能指定一個「parent」，
而 -c 能指定多個「clone source」。在
<a class="reference external" href="https://unix.stackexchange.com/a/490857">unix stackexchange 上有人寫明了這兩個的異同</a>
。使用 -p 的時候，產生的差分首先讓接收端用 subvolume snapshot 命令對 parent 子卷創建一個快照，
然後發送指令將這個快照修改成目標子卷的樣子，而使用 -c 的時候，首先在接收端用 subvolume create
創建一個空的子卷，隨後發送指令在這個子卷中填充內容，其數據塊儘量共享 clone source 已有的數據。
所以 <code class="code">
btrfs send -p</code>
 在接收端產生是有共享元數據的快照，而 <code class="code">
btrfs send -c</code>

在接收端產生的是僅僅共享數據而不共享元數據的子卷。</p>
</div>
</div>
<p>定義中「互相共享一部分 <strong>元數據</strong> 」比較重要，因爲除了快照的方式之外， btrfs
的子卷間也可以通過 reflink 的形式共享數據塊。我們可以對一整個子卷（甚至目錄）執行
<code class="code">
cp -r --reflink=always</code>
 ，創建出一個副本，副本的文件內容通過 reflink
共享原本的數據，但不共享元數據，這樣創建出的就不是快照。</p>
<p>說了這麼多，其實關鍵的只是 btrfs 在傳統 Unix 文件系統的「目錄/文件/inode」
這些東西之外只增加了一個「子卷」的新概念，而子卷間可以共享元數據或者數據，
用快照命令創建出的子卷就是共享一部分元數據。</p>
</div>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id10">於是子卷在存儲介質中是如何記錄的呢？</a></h3>
<p>比如在 <a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/SysadminGuide#Flat">SysadminGuide 這頁的 Flat 佈局</a>
有個子卷佈局的例子。</p>
<pre class="code literal-block">
toplevel         (volume root directory, not to be mounted by default)
    +-- root       (subvolume root directory, to be mounted at /)
    +-- home       (subvolume root directory, to be mounted at /home)
    +-- var        (directory)
    |   \-- www    (subvolume root directory, to be mounted at /var/www)
    \-- postgres   (subvolume root directory, to be mounted at /var/lib/postgresql)
</pre>
<p>用圓柱體表示子卷的話畫成圖大概是這個樣子：</p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">

<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Flat_layout Pages: 1 -->
<svg class="svg-responsive" height="206pt" viewbox="0.00 0.00 287.00 206.00" width="287pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g class="graph" id="graph0" transform="scale(1 1) rotate(0) translate(4 202)">
<title>Flat_layout</title>
<polygon fill="#ffffff" points="-4,4 -4,-202 283,-202 283,4 -4,4" stroke="transparent"></polygon>
<!-- toplevel -->
<g class="node" id="node1">
<title>toplevel</title>
<path d="M74,-113.7273C74,-115.5331 57.416,-117 37,-117 16.584,-117 0,-115.5331 0,-113.7273 0,-113.7273 0,-84.2727 0,-84.2727 0,-82.4669 16.584,-81 37,-81 57.416,-81 74,-82.4669 74,-84.2727 74,-84.2727 74,-113.7273 74,-113.7273" fill="none" stroke="#000000"></path>
<path d="M74,-113.7273C74,-111.9214 57.416,-110.4545 37,-110.4545 16.584,-110.4545 0,-111.9214 0,-113.7273" fill="none" stroke="#000000"></path>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="37" y="-95.3">toplevel</text>
</g>
<!-- root -->
<g class="node" id="node2">
<title>root</title>
<path d="M176.5,-194.7273C176.5,-196.5331 164.3982,-198 149.5,-198 134.6018,-198 122.5,-196.5331 122.5,-194.7273 122.5,-194.7273 122.5,-165.2727 122.5,-165.2727 122.5,-163.4669 134.6018,-162 149.5,-162 164.3982,-162 176.5,-163.4669 176.5,-165.2727 176.5,-165.2727 176.5,-194.7273 176.5,-194.7273" fill="none" stroke="#000000"></path>
<path d="M176.5,-194.7273C176.5,-192.9214 164.3982,-191.4545 149.5,-191.4545 134.6018,-191.4545 122.5,-192.9214 122.5,-194.7273" fill="none" stroke="#000000"></path>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="149.5" y="-176.3">root</text>
</g>
<!-- toplevel&#45;&gt;root -->
<g class="edge" id="edge1">
<title>toplevel-&gt;root</title>
<path d="M60.5079,-116.7348C74.7361,-127.3823 93.2999,-141.1218 110,-153 111.8699,-154.33 113.7963,-155.6874 115.7451,-157.0508" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="114.115,-160.1795 124.3276,-163 118.1029,-154.4265 114.115,-160.1795" stroke="#000000"></polygon>
</g>
<!-- home -->
<g class="node" id="node3">
<title>home</title>
<path d="M177.5,-140.7273C177.5,-142.5331 164.95,-144 149.5,-144 134.05,-144 121.5,-142.5331 121.5,-140.7273 121.5,-140.7273 121.5,-111.2727 121.5,-111.2727 121.5,-109.4669 134.05,-108 149.5,-108 164.95,-108 177.5,-109.4669 177.5,-111.2727 177.5,-111.2727 177.5,-140.7273 177.5,-140.7273" fill="none" stroke="#000000"></path>
<path d="M177.5,-140.7273C177.5,-138.9214 164.95,-137.4545 149.5,-137.4545 134.05,-137.4545 121.5,-138.9214 121.5,-140.7273" fill="none" stroke="#000000"></path>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="149.5" y="-122.3">home</text>
</g>
<!-- toplevel&#45;&gt;home -->
<g class="edge" id="edge2">
<title>toplevel-&gt;home</title>
<path d="M74.1485,-107.9156C86.1488,-110.7957 99.4652,-113.9916 111.5245,-116.8859" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="110.7613,-120.302 121.302,-119.2325 112.395,-113.4953 110.7613,-120.302" stroke="#000000"></polygon>
</g>
<!-- var -->
<g class="node" id="node4">
<title>var</title>
<polygon fill="none" points="176.5,-90 173.5,-94 152.5,-94 149.5,-90 122.5,-90 122.5,-54 176.5,-54 176.5,-90" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="149.5" y="-68.3">var</text>
</g>
<!-- toplevel&#45;&gt;var -->
<g class="edge" id="edge3">
<title>toplevel-&gt;var</title>
<path d="M74.1485,-90.0844C86.4488,-87.1323 100.1319,-83.8484 112.4265,-80.8976" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="113.4596,-84.2492 122.3666,-78.512 111.8259,-77.4425 113.4596,-84.2492" stroke="#000000"></polygon>
</g>
<!-- postgres -->
<g class="node" id="node6">
<title>postgres</title>
<path d="M189,-32.7273C189,-34.5331 171.2955,-36 149.5,-36 127.7045,-36 110,-34.5331 110,-32.7273 110,-32.7273 110,-3.2727 110,-3.2727 110,-1.4669 127.7045,0 149.5,0 171.2955,0 189,-1.4669 189,-3.2727 189,-3.2727 189,-32.7273 189,-32.7273" fill="none" stroke="#000000"></path>
<path d="M189,-32.7273C189,-30.9214 171.2955,-29.4545 149.5,-29.4545 127.7045,-29.4545 110,-30.9214 110,-32.7273" fill="none" stroke="#000000"></path>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="149.5" y="-14.3">postgres</text>
</g>
<!-- toplevel&#45;&gt;postgres -->
<g class="edge" id="edge5">
<title>toplevel-&gt;postgres</title>
<path d="M60.5079,-81.2652C74.7361,-70.6177 93.2999,-56.8782 110,-45 111.5738,-43.8806 113.1875,-42.7418 114.821,-41.5965" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="116.8432,-44.4534 123.0588,-35.8733 112.8492,-38.7046 116.8432,-44.4534" stroke="#000000"></polygon>
</g>
<!-- www -->
<g class="node" id="node5">
<title>www</title>
<path d="M279,-86.7273C279,-88.5331 266.8982,-90 252,-90 237.1018,-90 225,-88.5331 225,-86.7273 225,-86.7273 225,-57.2727 225,-57.2727 225,-55.4669 237.1018,-54 252,-54 266.8982,-54 279,-55.4669 279,-57.2727 279,-57.2727 279,-86.7273 279,-86.7273" fill="none" stroke="#000000"></path>
<path d="M279,-86.7273C279,-84.9214 266.8982,-83.4545 252,-83.4545 237.1018,-83.4545 225,-84.9214 225,-86.7273" fill="none" stroke="#000000"></path>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="252" y="-68.3">www</text>
</g>
<!-- var&#45;&gt;www -->
<g class="edge" id="edge4">
<title>var-&gt;www</title>
<path d="M176.699,-72C188.2828,-72 201.9866,-72 214.5073,-72" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="214.6739,-75.5001 224.6739,-72 214.6739,-68.5001 214.6739,-75.5001" stroke="#000000"></polygon>
</g>
</g>
</svg>
<p>首先要說明， btrfs 中大部分長度可變的數據結構都是
<a class="reference external" href="https://www.usenix.org/legacy/events/lsf07/tech/rodeh.pdf">CoW B-tree</a>
，一種經過修改適合寫時拷貝的B樹結構，所以在
<a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/On-disk_Format">on-disk format</a>
中提到了很多個樹。這裏的樹不是指文件系統中目錄結構樹，而是 CoW B-tree
，如果不關心B樹細節的話可以把 btrfs 所說的一棵樹理解爲關係數據庫中的一個表，
和數據庫的表一樣 btrfs 的樹的長度可變，然後表項內容根據一個 key 排序。
有這樣的背景之後，上圖例子中的 Flat 佈局在 btrfs 中大概是這樣的數據結構：</p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">

<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Flat_layout_on_disk Pages: 1 -->
<svg class="svg-responsive" height="453pt" viewbox="0.00 0.00 1130.00 453.00" width="1130pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g class="graph" id="graph0" transform="scale(1 1) rotate(0) translate(4 449)">
<title>Flat_layout_on_disk</title>
<polygon fill="#ffffff" points="-4,4 -4,-449 1126,-449 1126,4 -4,4" stroke="transparent"></polygon>
<!-- superblock -->
<g class="node" id="node1">
<title>superblock</title>
<polygon fill="none" points="0,-315.5 0,-407.5 123,-407.5 123,-315.5 0,-315.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="61.5" y="-392.3">SUPERBLOCK</text>
<polyline fill="none" points="0,-384.5 123,-384.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="61.5" y="-369.3">...</text>
<polyline fill="none" points="0,-361.5 123,-361.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="61.5" y="-346.3">root_tree</text>
<polyline fill="none" points="0,-338.5 123,-338.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="61.5" y="-323.3">...</text>
</g>
<!-- roottree -->
<g class="node" id="node2">
<title>roottree</title>
<polygon fill="none" points="195,-62 195,-361 504,-361 504,-62 195,-62" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-345.8">ROOT_TREE</text>
<polyline fill="none" points="195,-338 504,-338 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-322.8">2: extent_tree</text>
<polyline fill="none" points="195,-315 504,-315 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-299.8">3: chunk_tree</text>
<polyline fill="none" points="195,-292 504,-292 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-276.8">4: dev_tree</text>
<polyline fill="none" points="195,-269 504,-269 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-253.8">5: fs_tree</text>
<polyline fill="none" points="195,-246 504,-246 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-230.8">6: root_dir "default" -&gt; ROOT_ITEM 256</text>
<polyline fill="none" points="195,-223 504,-223 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-207.8">10: free_space_tree</text>
<polyline fill="none" points="195,-200 504,-200 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-184.8">256: fs_tree "root"</text>
<polyline fill="none" points="195,-177 504,-177 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-161.8">257: fs_tree "home"</text>
<polyline fill="none" points="195,-154 504,-154 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-138.8">258: fs_tree "www"</text>
<polyline fill="none" points="195,-131 504,-131 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-115.8">259: fs_tree "postgres"</text>
<polyline fill="none" points="195,-108 504,-108 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-92.8">-7: tree_log_tree</text>
<polyline fill="none" points="195,-85 504,-85 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-69.8">-5: orphan_root</text>
</g>
<!-- superblock&#45;&gt;roottree -->
<g class="edge" id="edge1">
<title>superblock:sn_root-&gt;roottree:label</title>
<path d="M123,-349.5C151.375,-349.5 160.8795,-349.5 184.9792,-349.5" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="185,-353.0001 195,-349.5 185,-346.0001 185,-353.0001" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- roottree&#45;&gt;roottree -->
<g class="edge" id="edge8">
<title>roottree:e-&gt;roottree:e</title>
<path d="M504.5,-234.5C552,-243.5 648,-243.5 648,-211.5 648,-181.625 564.3267,-179.6411 514.5622,-186.8328" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="513.7934,-183.4124 504.5,-188.5 514.9376,-190.3183 513.7934,-183.4124" stroke="#000000"></polygon>
</g>
<!-- toplevel -->
<g class="node" id="node3">
<title>toplevel</title>
<polygon fill="none" points="576,-195.5 576,-379.5 923,-379.5 923,-195.5 576,-195.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-364.3">FS_TREE "toplevel"</text>
<polyline fill="none" points="576,-356.5 923,-356.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-341.3">256: inode_item DIR</text>
<polyline fill="none" points="576,-333.5 923,-333.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-318.3">256: dir_item: "root" -&gt; ROOT_ITEM 256</text>
<polyline fill="none" points="576,-310.5 923,-310.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-295.3">256: dir_item: "home" -&gt; ROOT_ITEM 257</text>
<polyline fill="none" points="576,-287.5 923,-287.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-272.3">256: dir_item: "var" -&gt; INODE_ITEM 257</text>
<polyline fill="none" points="576,-264.5 923,-264.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-249.3">256: dir_item: "postgres" -&gt; ROOT_ITEM 259</text>
<polyline fill="none" points="576,-241.5 923,-241.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-226.3">257: inode_item DIR</text>
<polyline fill="none" points="576,-218.5 923,-218.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-203.3">257: dir_item: "www" -&gt; ROOT_ITEM 258</text>
</g>
<!-- roottree&#45;&gt;toplevel -->
<g class="edge" id="edge7">
<title>roottree:root_fs-&gt;toplevel:label</title>
<path d="M504,-257.5C559.0128,-257.5 522.6423,-354.6525 565.8752,-367.1761" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="565.6306,-370.6738 576,-368.5 566.5382,-363.7329 565.6306,-370.6738" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- root -->
<g class="node" id="node4">
<title>root</title>
<polygon fill="none" points="667.5,-398.5 667.5,-444.5 831.5,-444.5 831.5,-398.5 667.5,-398.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-429.3">FS_TREE "root"</text>
<polyline fill="none" points="667.5,-421.5 831.5,-421.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-406.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;root -->
<g class="edge" id="edge9">
<title>roottree:root_sub_root-&gt;root:label</title>
<path d="M504,-188.5C598.4735,-188.5 513.0238,-318.0782 576,-388.5 603.8494,-419.642 619.5989,-431.6093 657.395,-433.2892" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="657.4291,-436.7905 667.5,-433.5 657.5752,-429.7921 657.4291,-436.7905" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- home -->
<g class="node" id="node5">
<title>home</title>
<polygon fill="none" points="667.5,-130.5 667.5,-176.5 831.5,-176.5 831.5,-130.5 667.5,-130.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-161.3">FS_TREE "home"</text>
<polyline fill="none" points="667.5,-153.5 831.5,-153.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-138.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;home -->
<g class="edge" id="edge10">
<title>roottree:root_sub_home-&gt;home:label</title>
<path d="M504,-165.5C573.1185,-165.5 592.9293,-165.5 657.2326,-165.5" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="657.5,-169.0001 667.5,-165.5 657.5,-162.0001 657.5,-169.0001" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- www -->
<g class="node" id="node6">
<title>www</title>
<polygon fill="none" points="667.5,-65.5 667.5,-111.5 831.5,-111.5 831.5,-65.5 667.5,-65.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-96.3">FS_TREE "www"</text>
<polyline fill="none" points="667.5,-88.5 831.5,-88.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-73.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;www -->
<g class="edge" id="edge11">
<title>roottree:root_sub_www-&gt;www:label</title>
<path d="M504,-142.5C537.4605,-142.5 543.6289,-128.9684 576,-120.5 612.8107,-110.8702 623.9964,-102.1347 657.4378,-100.7044" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="657.5732,-104.2024 667.5,-100.5 657.431,-97.2039 657.5732,-104.2024" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- postgres -->
<g class="node" id="node7">
<title>postgres</title>
<polygon fill="none" points="667,-.5 667,-46.5 832,-46.5 832,-.5 667,-.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-31.3">FS_TREE "postgres"</text>
<polyline fill="none" points="667,-23.5 832,-23.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-8.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;postgres -->
<g class="edge" id="edge12">
<title>roottree:root_sub_postgres-&gt;postgres:label</title>
<path d="M504,-119.5C546.8146,-119.5 537.8681,-74.9691 576,-55.5 609.5346,-38.3781 622.9605,-35.847 656.4796,-35.5384" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="656.5135,-39.0384 666.5,-35.5 656.4866,-32.0384 656.5135,-39.0384" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge2">
<title>toplevel:toplevel_dir_root-&gt;roottree:root_sub_root</title>
<path d="M576,-322.5C512.0892,-322.5 565.0851,-202.7555 513.961,-189.6584" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="514.3374,-186.1787 504,-188.5 513.5287,-193.1318 514.3374,-186.1787" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge3">
<title>toplevel:toplevel_dir_home-&gt;roottree:root_sub_home</title>
<path d="M576,-299.5C512.0892,-299.5 565.0851,-179.7555 513.961,-166.6584" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="514.3374,-163.1787 504,-165.5 513.5287,-170.1318 514.3374,-163.1787" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge5">
<title>toplevel:toplevel_dir_postgres-&gt;roottree:root_sub_postgres</title>
<path d="M576,-252.5C512.5902,-252.5 564.5603,-134.1397 514.2209,-120.7317" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="514.347,-117.2217 504,-119.5 513.5094,-124.1714 514.347,-117.2217" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge6">
<title>toplevel:toplevel_dir_www-&gt;roottree:root_sub_www</title>
<path d="M576,-206.5C537.0321,-206.5 544.8212,-153.4834 514.2549,-143.957" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="514.3929,-140.4415 504,-142.5 513.4082,-147.3719 514.3929,-140.4415" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;toplevel -->
<g class="edge" id="edge4">
<title>toplevel:e-&gt;toplevel:e</title>
<path d="M923.5,-275.5C989.3333,-284.5 1122,-284.5 1122,-252.5 1122,-222.0625 1001.9728,-220.5763 933.5984,-228.2487" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="932.9937,-224.7968 923.5,-229.5 933.8545,-231.7436 932.9937,-224.7968" stroke="#000000"></polygon>
</g>
</g>
</svg>
<p>上圖中已經隱去了很多和本文無關的具體細節，所有這些細節都可以通過
<a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/Manpage/btrfs-inspect-internal">btrfs inspect-internal 的 dump-super 和 dump-tree</a>
查看到。btrfs 中的每棵樹都可以看作是一個數據庫中的表，可以包含很多表項，根據 KEY 排序，而 KEY
是 (object_id, item_type, item_extra) 這樣的三元組。每個對象（object）在樹中用一個或多個
表項（item）描述，同 object_id 的表項共同描述一個對象（object）。B樹中的 key
只用來比較大小不必連續，從而 object_id 也不必連續，只是按大小排序。有一些預留的 object_id
不能用作別的用途，他們的編號範圍是 -255ULL 到 255ULL，也就是表中前 255 和最後 255 個編號預留。</p>
<p>ROOT_TREE 中記錄了到所有別的B樹的指針，在一些文檔中叫做 tree of tree roots 。「所有別的B樹」
舉例來說比如 2 號 extent_tree ，3 號 chunk_tree ， 4 號 dev_tree ，10 號 free_space_tree
，這些B樹都是描述 btrfs 文件系統結構非常重要的組成部分，但是在本文關係不大，
今後有機會再討論它們。在 ROOT_TREE 的 5 號對象有一個 fs_tree ，它描述了整個 btrfs pool
的頂級子卷，也就是圖中叫 toplevel 的那個子卷（有些文檔用定冠詞稱 the FS_TREE
的時候就是在說這個 5 號樹，而不是別的子卷的 FS_TREE ）。除了頂級子卷之外，別的所有子卷的 object_id
在 256ULL 到 -256ULL 的範圍之間，對子卷而言 ROOT_TREE 中的這些 object_id 也同時是它們的
子卷 id ，在內核掛載文件系統的時候可以用 subvolid 找到它們，別的一些對子卷的操作也可以直接用
subvolid 表示一個子卷。 ROOT_TREE 的 6 號對象描述的不是一棵樹，而是一個名叫 default
的特殊目錄，它指向 btrfs pool 的默認掛載子卷。最初 mkfs 的時候，這個目錄指向 ROOT_ITEM 5
，也就是那個頂級子卷，之後可以通過命令 <code class="code">
btrfs subvolume set-default</code>

修改它指向別的子卷，這裏它被改爲指向 ROOT_ITEM 256 亦即那個名叫 "root" 的子卷。</p>
<p>每一個子卷都有一棵自己的 FS_TREE （有的文檔中叫 file tree），一個 FS_TREE 相當於傳統 Unix
文件系統中的一整個 inode table ，只不過它除了包含 inode 信息之外還包含所有文件夾內容。在
FS_TREE 中， object_id 同時也是它所描述對象的 inode 號，所以 btrfs
的 <strong>子卷有互相獨立的 inode 編號</strong> ，不同子卷中的文件或目錄可以擁有相同的 inode 。
或許有人不太清楚子卷間 inode 編號獨立意味着什麼，簡單地說，這意味着你不能跨子卷創建
hard link ，不能跨子卷 mv 移動文件而不產生複製操作。不過因爲 reflink 和 inode 無關，
可以跨子卷創建 reflink ，也可以用 reflink + rm 的方式快速移動文件。</p>
<p>FS_TREE 中一個目錄用一個 inode_item 和多個 dir_item 描述， inode_item 是目錄自己的 inode
，那些 dir_item 是目錄的內容。 dir_item 可以指向別的 inode_item 來描述普通文件和子目錄，
也可以指向 root_item 來描述這個目錄指向一個子卷。有人或許疑惑，子卷就沒有自己的 inode
麼？其實如果看 <a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/Data_Structures#btrfs_root_item">數據結構定義</a>
的話 <code class="code">
struct btrfs_root_item</code>
 結構在最開頭的地方包含了一個
<code class="code">
struct btrfs_inode_item</code>
 所以 root_item 也同時作爲子卷的 inode
，不過用戶通常看不到這個子卷的 inode ，因爲子卷在被（手動或自動地）掛載到目錄上之後，
用戶會看到的是子卷的根目錄的 inode 。</p>
<p>比如上圖 FS_TREE toplevel 中，有兩個對象，第一個 256 是（子卷的）根目錄，第二個 257
是 "var" 目錄，256 有4個子目錄，其中 "root" "home" "postgres" 這三個指向了 ROOT_TREE
中的對應子卷，而 "var" 指向了 inode 257 。然後 257 有一個子目錄叫 "www" 它指向了
ROOT_TREE 中 object_id 爲 258 的子卷。</p>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id11">那麼快照又是如何記錄的呢？</a></h3>
<p>以上是子卷、目錄、 inode 在 btrfs 中的記錄方式，你可能想知道，如何記錄一個快照呢？
特別是，如果對一個包含子卷的子卷創建了快照，會得到什麼結果呢？如果我們在上面的佈局基礎上執行：</p>
<pre class="code bash literal-block">
btrfs subvolume snapshot toplevel toplevel/toplevel@s1
</pre>
<p>那麼產生的數據結構大概如下所示：</p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">

<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Flat_layout_on_disk Pages: 1 -->
<svg class="svg-responsive" height="712pt" viewbox="0.00 0.00 1162.00 712.00" width="1162pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g class="graph" id="graph0" transform="scale(1 1) rotate(0) translate(4 708)">
<title>Flat_layout_on_disk</title>
<polygon fill="#ffffff" points="-4,4 -4,-708 1158,-708 1158,4 -4,4" stroke="transparent"></polygon>
<!-- superblock -->
<g class="node" id="node1">
<title>superblock</title>
<polygon fill="none" points="0,-611.5 0,-703.5 123,-703.5 123,-611.5 0,-611.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="61.5" y="-688.3">SUPERBLOCK</text>
<polyline fill="none" points="0,-680.5 123,-680.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="61.5" y="-665.3">...</text>
<polyline fill="none" points="0,-657.5 123,-657.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="61.5" y="-642.3">root_tree</text>
<polyline fill="none" points="0,-634.5 123,-634.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="61.5" y="-619.3">...</text>
</g>
<!-- roottree -->
<g class="node" id="node2">
<title>roottree</title>
<polygon fill="none" points="195,-334.5 195,-656.5 504,-656.5 504,-334.5 195,-334.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-641.3">ROOT_TREE</text>
<polyline fill="none" points="195,-633.5 504,-633.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-618.3">2: extent_tree</text>
<polyline fill="none" points="195,-610.5 504,-610.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-595.3">3: chunk_tree</text>
<polyline fill="none" points="195,-587.5 504,-587.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-572.3">4: dev_tree</text>
<polyline fill="none" points="195,-564.5 504,-564.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-549.3">5: fs_tree</text>
<polyline fill="none" points="195,-541.5 504,-541.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-526.3">6: root_dir "default" -&gt; ROOT_ITEM 256</text>
<polyline fill="none" points="195,-518.5 504,-518.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-503.3">10: free_space_tree</text>
<polyline fill="none" points="195,-495.5 504,-495.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-480.3">256: fs_tree "root"</text>
<polyline fill="none" points="195,-472.5 504,-472.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-457.3">257: fs_tree "home"</text>
<polyline fill="none" points="195,-449.5 504,-449.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-434.3">258: fs_tree "www"</text>
<polyline fill="none" points="195,-426.5 504,-426.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-411.3">259: fs_tree "postgres"</text>
<polyline fill="none" points="195,-403.5 504,-403.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-388.3">260: fs_tree "toplevel@s1"</text>
<polyline fill="none" points="195,-380.5 504,-380.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-365.3">-7: tree_log_tree</text>
<polyline fill="none" points="195,-357.5 504,-357.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-342.3">-5: orphan_root</text>
</g>
<!-- superblock&#45;&gt;roottree -->
<g class="edge" id="edge1">
<title>superblock:sn_root-&gt;roottree:label</title>
<path d="M123,-645.5C151.375,-645.5 160.8795,-645.5 184.9792,-645.5" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="185,-649.0001 195,-645.5 185,-642.0001 185,-649.0001" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- roottree&#45;&gt;roottree -->
<g class="edge" id="edge10">
<title>roottree:e-&gt;roottree:e</title>
<path d="M504.5,-530.5C552,-539.5 648,-539.5 648,-507 648,-476.6582 564.3267,-474.6433 514.5622,-481.833" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="513.7934,-478.4125 504.5,-483.5 514.9376,-485.3184 513.7934,-478.4125" stroke="#000000"></polygon>
</g>
<!-- toplevel -->
<g class="node" id="node3">
<title>toplevel</title>
<polygon fill="none" points="576,-334 576,-541 948,-541 948,-334 576,-334" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-525.8">FS_TREE "toplevel"</text>
<polyline fill="none" points="576,-518 948,-518 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-502.8">256: inode_item DIR</text>
<polyline fill="none" points="576,-495 948,-495 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-479.8">256: dir_item: "root" -&gt; ROOT_ITEM 256</text>
<polyline fill="none" points="576,-472 948,-472 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-456.8">256: dir_item: "home" -&gt; ROOT_ITEM 257</text>
<polyline fill="none" points="576,-449 948,-449 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-433.8">256: dir_item: "var" -&gt; INODE_ITEM 257</text>
<polyline fill="none" points="576,-426 948,-426 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-410.8">256: dir_item: "postgres" -&gt; ROOT_ITEM 259</text>
<polyline fill="none" points="576,-403 948,-403 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-387.8">256: dir_item: "toplevel@s1" -&gt; ROOT_ITEM 260</text>
<polyline fill="none" points="576,-380 948,-380 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-364.8">257: inode_item DIR</text>
<polyline fill="none" points="576,-357 948,-357 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-341.8">257: dir_item: "www" -&gt; ROOT_ITEM 258</text>
</g>
<!-- roottree&#45;&gt;toplevel -->
<g class="edge" id="edge8">
<title>roottree:root_fs-&gt;toplevel:label</title>
<path d="M504,-553.5C534.0416,-553.5 540.9271,-534.4629 565.9033,-530.2985" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="566.3071,-533.7776 576,-529.5 565.7552,-526.7994 566.3071,-533.7776" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- toplevels1 -->
<g class="node" id="node4">
<title>toplevels1</title>
<polygon fill="none" points="588.5,-.5 588.5,-184.5 935.5,-184.5 935.5,-.5 588.5,-.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-169.3">FS_TREE "toplevel@s1"</text>
<polyline fill="none" points="588.5,-161.5 935.5,-161.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-146.3">256: inode_item DIR</text>
<polyline fill="none" points="588.5,-138.5 935.5,-138.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-123.3">256: dir_item: "root" -&gt; ROOT_ITEM 256</text>
<polyline fill="none" points="588.5,-115.5 935.5,-115.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-100.3">256: dir_item: "home" -&gt; ROOT_ITEM 257</text>
<polyline fill="none" points="588.5,-92.5 935.5,-92.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-77.3">256: dir_item: "var" -&gt; INODE_ITEM 257</text>
<polyline fill="none" points="588.5,-69.5 935.5,-69.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-54.3">256: dir_item: "postgres" -&gt; ROOT_ITEM 259</text>
<polyline fill="none" points="588.5,-46.5 935.5,-46.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-31.3">257: inode_item DIR</text>
<polyline fill="none" points="588.5,-23.5 935.5,-23.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-8.3">257: dir_item: "www" -&gt; ROOT_ITEM 258</text>
</g>
<!-- roottree&#45;&gt;toplevels1 -->
<g class="edge" id="edge9">
<title>roottree:root_sub_s1-&gt;toplevels1:label</title>
<path d="M504,-391.5C604.1824,-391.5 492.5813,-188.5587 577.8727,-174.2894" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="578.3023,-177.7666 588,-173.5 577.7582,-170.7878 578.3023,-177.7666" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- root -->
<g class="node" id="node5">
<title>root</title>
<polygon fill="none" points="680,-625.5 680,-671.5 844,-671.5 844,-625.5 680,-625.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-656.3">FS_TREE "root"</text>
<polyline fill="none" points="680,-648.5 844,-648.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-633.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;root -->
<g class="edge" id="edge11">
<title>roottree:root_sub_root-&gt;root:label</title>
<path d="M504,-483.5C571.217,-483.5 526.246,-571.3042 576,-616.5 610.5377,-647.8735 627.3669,-658.9419 669.8918,-660.3433" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="669.9469,-663.8445 680,-660.5 670.0555,-656.8453 669.9469,-663.8445" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- home -->
<g class="node" id="node6">
<title>home</title>
<polygon fill="none" points="680,-560.5 680,-606.5 844,-606.5 844,-560.5 680,-560.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-591.3">FS_TREE "home"</text>
<polyline fill="none" points="680,-583.5 844,-583.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-568.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;home -->
<g class="edge" id="edge12">
<title>roottree:root_sub_home-&gt;home:label</title>
<path d="M504,-460.5C555.225,-460.5 535.2893,-519.4092 576,-550.5 613.2118,-578.9187 627.5918,-593.3907 669.8996,-595.2854" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="669.9279,-598.7867 680,-595.5 670.0767,-591.7882 669.9279,-598.7867" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- www -->
<g class="node" id="node7">
<title>www</title>
<polygon fill="none" points="680,-268.5 680,-314.5 844,-314.5 844,-268.5 680,-268.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-299.3">FS_TREE "www"</text>
<polyline fill="none" points="680,-291.5 844,-291.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-276.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;www -->
<g class="edge" id="edge13">
<title>roottree:root_sub_www-&gt;www:label</title>
<path d="M504,-437.5C563.5506,-437.5 526.8969,-358.1921 576,-324.5 611.9965,-299.801 630.0633,-302.8353 669.9625,-303.4217" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="669.973,-306.9218 680,-303.5 670.0276,-299.922 669.973,-306.9218" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- postgres -->
<g class="node" id="node8">
<title>postgres</title>
<polygon fill="none" points="679.5,-203.5 679.5,-249.5 844.5,-249.5 844.5,-203.5 679.5,-203.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-234.3">FS_TREE "postgres"</text>
<polyline fill="none" points="679.5,-226.5 844.5,-226.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-211.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;postgres -->
<g class="edge" id="edge14">
<title>roottree:root_sub_postgres-&gt;postgres:label</title>
<path d="M504,-414.5C580.3617,-414.5 515.9138,-305.625 576,-258.5 609.8986,-231.9137 629.2713,-237.3806 668.7935,-238.3677" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="668.9554,-241.87 679,-238.5 669.0462,-234.8706 668.9554,-241.87" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge2">
<title>toplevel:toplevel_dir_root-&gt;roottree:root_sub_root</title>
<path d="M576,-483.5C547.625,-483.5 538.1205,-483.5 514.0208,-483.5" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="514,-480.0001 504,-483.5 514,-487.0001 514,-480.0001" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge3">
<title>toplevel:toplevel_dir_home-&gt;roottree:root_sub_home</title>
<path d="M576,-460.5C547.625,-460.5 538.1205,-460.5 514.0208,-460.5" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="514,-457.0001 504,-460.5 514,-464.0001 514,-457.0001" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge5">
<title>toplevel:toplevel_dir_postgres-&gt;roottree:root_sub_postgres</title>
<path d="M576,-414.5C547.625,-414.5 538.1205,-414.5 514.0208,-414.5" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="514,-411.0001 504,-414.5 514,-418.0001 514,-411.0001" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge6">
<title>toplevel:toplevel_dir_toplevels1-&gt;roottree:root_sub_s1</title>
<path d="M576,-391.5C547.625,-391.5 538.1205,-391.5 514.0208,-391.5" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="514,-388.0001 504,-391.5 514,-395.0001 514,-388.0001" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge7">
<title>toplevel:toplevel_dir_www-&gt;roottree:root_sub_www</title>
<path d="M576,-345.5C527.9315,-345.5 551.6566,-424.3505 514.245,-436.0549" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="513.4131,-432.6375 504,-437.5 514.3909,-439.5689 513.4131,-432.6375" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;toplevel -->
<g class="edge" id="edge4">
<title>toplevel:e-&gt;toplevel:e</title>
<path d="M948,-437.5C1016.6667,-446.5 1154,-446.5 1154,-403 1154,-361.5391 1029.2399,-359.5956 958.0877,-367.2973" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="957.5153,-363.8406 948,-368.5 958.3441,-370.7914 957.5153,-363.8406" stroke="#000000"></polygon>
</g>
</g>
</svg>
<p>在 ROOT_TREE 中增加了 260 號子卷，其內容複製自 toplevel 子卷，然後 FS_TREE toplevel
的 256 號 inode 也就是根目錄中增加一個 dir_item 名叫 <cite>toplevel@s1</cite> 它指向 ROOT_ITEM
的 260 號子卷。這裏看似是完整複製了整個 FS_TREE 的內容，這是因爲 CoW b-tree
當只有一個葉子節點時就複製整個葉子節點。如果子卷內容再多一些，除了葉子之外還有中間節點，
那麼只有被修改的葉子和其上的中間節點需要複製。從而創建快照的開銷基本上是
O( level of FS_TREE )，而B樹的高度一般都能維持在很低的程度，所以快照創建速度近乎是常數開銷。</p>
<p>從子卷和快照的這種實現方式，可以看出： <strong>雖然子卷可以嵌套子卷，但是對含有嵌套子卷的子卷做快照的語義有些特別</strong>
。上圖中我沒有畫 <cite>toplevel@s1</cite> 下的各個子卷到對應 ROOT_ITEM 之間的虛線箭頭，
是因爲這時候如果你嘗試直接跳過 <cite>toplevel</cite> 掛載 <cite>toplevel@s1</cite> 到掛載點，
會發現那些子卷沒有被自動掛載，更奇怪的是那些子卷的目錄項也不是個普通目錄，
嘗試往它們中放東西會得到無權訪問的錯誤，對它們能做的唯一事情是手動將別的子卷掛載在上面。
推測原因在於這些子目錄並不是真的目錄，沒有對應的目錄的 inode ，試圖查看它們的 inode
號會得到 2 號，而這是個保留號不應該出現在 btrfs 的 inode 號中。
每個子卷創建時會記錄包含它的上級子卷，用 <code class="code">
btrfs subvolume list</code>
 可以看到每個子卷的
top level subvolid ，猜測當掛載 A 而 A 中嵌套的 B 子卷記錄的上級子卷不是 A 的時候，
會出現上述奇怪行爲。嵌套子卷的快照還有一些別的奇怪行爲，大家可以自己探索探索。</p>
<div class="panel panel-default">
<div class="panel-heading">
建議用平坦的子卷佈局</div>
<div class="panel-body">
<p>因爲上述嵌套子卷在做快照時的特殊行爲，
我個人建議是 <strong>保持平坦的子卷佈局</strong> ，也就是說：</p>
<ol class="arabic simple">
<li>只讓頂層子卷包含其它子卷，除了頂層子卷之外的子卷只做手工掛載，不放嵌套子卷</li>
<li>只在頂層子卷對其它子卷做快照，不快照頂層子卷</li>
<li>雖然可以在頂層子卷放子卷之外的東西（文件或目錄），不過因爲想避免對頂層子卷做快照，
所以避免在頂層子卷放普通文件。</li>
</ol>
</div>
</div>
<p>btrfs 的子卷可以設置「可寫」或者「只讀」，在創建一個快照的時候也可以通過 <code class="code">
-r</code>

參數創建出一個只讀快照。通常只讀快照可能比可寫的快照更有用，因爲 <code class="code">
btrfs send</code>

命令只接受只讀快照作爲參考點。子卷可以有兩種方式切換它是否只讀的屬性，可以通過
<code class="code">
btrfs property set &lt;subvol&gt; ro</code>
 直接修改是否只讀，也可以對只讀子卷用
<code class="code">
btrfs subvolume snapshot</code>
 創建出可寫子卷，或者反過來對可寫子卷創建出只讀子卷。</p>
<p>只讀快照也有些特殊的限制，在 <a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/SysadminGuide#Special_Cases">SysadminGuide#Special_Cases</a>
就提到一例，你不能把只讀快照用 mv 移出包含它的目錄，雖然你能用 mv 給它改名或者移動包含它的目錄
到別的地方。 btrfs wiki 上給出這個限制的原因是子卷中記錄了它的上級，
所以要移動它到別的上級需要修改這個子卷，從而只讀子卷沒法移動到別的上級（
不過我還沒搞清楚子卷在哪兒記錄了它的上級，記錄的是上級目錄還是上級子卷）。不過這個限制可以通過
對只讀快照在目標位置創建一個新的只讀快照，然後刪掉原位置的只讀快照來解決。</p>
</div>
</div>
<div class="section" id="zfs-filesystem-snapshot-clone">
<h2><a class="toc-backref" href="#id12">ZFS 的文件系統（filesystem）、快照（snapshot）、克隆（clone）及其它</a></h2>
<p>Btrfs 給傳統文件系統只增加了子卷的概念，相比之下 ZFS 中類似子卷的概念有好幾個，據我所知有這些：</p>
<ul class="simple">
<li>數據集（dataset）</li>
<li>文件系統（filesystem）</li>
<li>快照（snapshot）</li>
<li>克隆（clone）</li>
<li>書籤（bookmark）：從 ZFS on Linux v0.6.4 開始</li>
<li>檢查點（checkpoint）：從 ZFS on Linux v0.8.0 開始</li>
</ul>
<p>梳理一下這些概念之間的關係也是最初想寫下這篇筆記的初衷。先畫個簡圖，隨後逐一講講這些概念：</p>
<img alt="ditaa diagram" class="ditaa img-responsive" src="//farseerfc.me/uml/f0cd8a5f.png"/>
<p>上圖中，假設我們有一個 pool ，其中有 3 個文件系統叫 fs1~fs3 和一個 zvol 叫 zv1
，然後文件系統 fs1 有兩個快照 s1 和 s2 ，和兩個書籤 b1 和 b2。pool 整體有兩個檢查點 cp1 和
cp2 。這個簡圖將作爲例子在後面介紹這些概念。</p>
<div class="section" id="zfs">
<h3><a class="toc-backref" href="#id13">ZFS 設計中和快照相關的一些術語和概念</a></h3>
<div class="section" id="dataset">
<h4><a class="toc-backref" href="#id14">數據集（dataset）</a></h4>
<p>ZFS 中把文件系統、快照、克隆、zvol 等概念統稱爲數據集（dataset）。
一些文檔和介紹中把文件系統叫做數據集，大概因爲在 ZFS 中，文件系統是最先創建並且最有用的數據集。</p>
<p>在 ZFS 的術語中，把底層管理和釋放存儲設備空間的叫做 ZFS 存儲池（pool），
簡稱 zpool ，其上可以容納多個數據集，這些數據集用類似文件夾路徑的語法
<code class="code">
pool_name/​dataset_path@snapshot_name</code>
 這樣來稱呼。
存儲池中的數據集一同共享可用的存儲空間，每個數據集單獨跟蹤自己所消耗掉的存儲空間。</p>
<p>數據集之間有類似文件夾的層級父子關係，這一點有用的地方在於可以在父級數據集上設定一些 ZFS 參數，
這些參數可以被子級數據集基礎，從而通過層級關係可以方便地微調 ZFS 參數。在 btrfs
中目前還沒有類似的屬性繼承的功能。</p>
<p>zvol 的概念和本文關係不大，這裏簡要介紹一下。 zvol 是在 ZFS 存儲池中虛擬出的一個塊設備，
可以在 zvol 上創建別的類型的文件系統，比如 ext4 或者 xfs 這種。很多對 ZFS 文件系統能做的操作，
比如快照或者 send 也都能對 zvol 做，從而用 zvol 能把 ZFS 當作一個傳統的卷管理器，繞開 ZFS
的 ZPL（ZFS Posix filesystem Layer） 層。在 Btrfs 中可以用 loopback
塊設備某種程度上模擬 zvol 的功能。</p>
</div>
<div class="section" id="filesystem">
<h4><a class="toc-backref" href="#id15">文件系統（filesystem）</a></h4>
<p>創建了 ZFS 存儲池後，首先要在其中創建文件系統（filesystem），才能在文件系統中存儲文件。
容易看出 ZFS 文件系統的概念直接對應 btrfs 中的子卷。文件系統（filesystem）這個術語，
從命名方式來看或許是想要和（像 Solaris 的 SVM 或者 Linux 的 LVM 這樣的）傳統的卷管理器
與其上創建的多個文件系統（Solaris UFS 或者 Linux ext）這樣的上下層級做類比。
從 btrfs 的子卷在內部結構中叫作 FS_TREE 這一點可以看出，至少在 btrfs
早期設計中大概也是把子卷稱爲 filesystem 做過類似的類比的。
和傳統的卷管理器與傳統文件系統的上下層級不同的是， ZFS 和 btrfs 中由存儲池跟蹤和管理可用空間，
做統一的數據塊分配和釋放，沒有分配的數據塊算作整個存儲池中所有 ZFS 文件系統或者 btrfs
子卷的可用空間。</p>
<p>與 btrfs 的子卷不同的是， ZFS 的文件系統之間是完全隔離的，（除了後文會講的 dedup
方式之外）不可以共享任何數據或者元數據。一個文件系統還包含了隸屬於其中的快照（snapshot）、
克隆（clone）和書籤（bookmark）。在 btrfs 中一個子卷和對其創建的快照之間雖然有父子關係，
但是在 ROOT_TREE 的記錄中屬於平級的關係。</p>
<p>上面簡圖中 pool 裏面包含 3 個文件系統，分別是 fs1~3 。</p>
</div>
<div class="section" id="snapshot">
<h4><a class="toc-backref" href="#id16">快照（snapshot）</a></h4>
<p>ZFS 的快照對應 btrfs 的只讀快照，是標記數據集在某一歷史時刻上的只讀狀態。
和 btrfs 的只讀快照一樣， ZFS 的快照也兼作 send/receive 時的參考點。
快照隸屬於一個數據集，這說明 ZFS 的文件系統或者 zvol 都可以創建快照。</p>
<p>ZFS 中快照是排列在一個時間線上的，因爲都是只讀快照，它們是數據集在歷史上的不同時間點。
這裏說的時間不是系統時鐘的時間，而是 ZFS 中事務組（TXG, transaction group）的一個序號。
整個 ZFS pool 的每次寫入會被合併到一個事務組，對事務組分配一個嚴格遞增的序列號，
提交一個事務組具有類似數據庫中事務的語義：要麼整個事務組都被完整提交，要麼整個 pool
處於上一個事務組的狀態，即使中間發生突然斷電之類的意外也不會破壞事務語義。
因此 ZFS 快照就是數據集處於某一個事務組時的狀態。</p>
<p>如果不滿於對數據集進行的修改，想把整個數據集恢復到之前的狀態，那麼可以回滾（rollback
）數據集到一個快照。回滾操作會撤銷掉對數據集的所有更改，並且默認參數下只能回滾到最近的一個快照。
如果想回滾到更早的快照，可以先刪掉最近的幾個，或者可以使用 <code class="code">
zfs rollback -r</code>

參數刪除中間的快照並回滾。</p>
<p>除了回滾操作，還可以直接只讀訪問到快照中的文件。 ZFS 的文件系統中有個隱藏文件夾叫 ".zfs"
，所以如果只想回滾一部分文件，可以從 ".zfs/snapshots/SNAPSHOT-NAME" 中把需要的文件複製出來。</p>
<p>比如上面簡圖中 fs1 就有 <code class="code">
pool/​fs1@s1</code>
 和 <code class="code">
pool/​fs1@s2</code>
 這兩個快照，
那麼可以在 fs1 掛載點下 <code class="code">
.zfs/​snapshots/​s1</code>
 的路徑直接訪問到 s1 中的內容。</p>
</div>
<div class="section" id="clone">
<h4><a class="toc-backref" href="#id17">克隆（clone）</a></h4>
<p>ZFS 的克隆有點像 btrfs 的可寫快照。因爲 ZFS 的快照是只讀的，如果想對快照做寫入，那需要先用
<code class="code">
zfs clone</code>
 從快照中建出一個克隆，創建出的克隆和快照共享元數據和數據，
然後對克隆的寫入不影響數據集原本的寫入點。
創建了克隆之後，作爲克隆參考點的快照會成爲克隆的依賴，克隆存在期間無法刪除掉作爲其依賴的快照。</p>
<p>一個數據集可以有多個克隆，這些克隆都獨立於數據集當前的寫入點。使用 <code class="code">
zfs promote</code>

命令可以把一個克隆「升級」成爲數據集的當前寫入點，從而數據集原本的寫入點會調轉依賴關係，
成爲這個新寫入點的一個克隆，被升級的克隆原本依賴的快照和之前的快照會成爲新數據集寫入點的快照。</p>
<p>比如上面簡圖中 fs1 有 c1 的克隆，它依賴於 s2 這個快照，從而 c1 存在的時候就不能刪除掉 s2 。</p>
</div>
<div class="section" id="bookmark">
<h4><a class="toc-backref" href="#id18">書籤（bookmark）</a></h4>
<p>這是 ZFS 一個比較新的特性，ZFS on Linux 分支從 v0.6.4 開始支持創建書籤的功能。</p>
<p>書籤特性存在的理由是基於這樣的事實：原本 ZFS 在 send 兩個快照間的差異的時候，比如 send S1 和
S2 之間的差異，在發送端實際上只需要 S1 中記錄的時間戳（TXG id），而不需要 S1 快照的數據，
就可以計算出 S1 到 S2 的差異。在接收端則需要 S1 的完整數據，在其上根據接收到的數據流創建 S2 。
因此在發送端，可以把快照 S1 轉變成書籤，只留下時間戳元數據而不保留任何目錄結構或者文件內容。
書籤只能作爲增量 send 時的參考點，並且在接收端需要有對應的快照，這種方式可以在發送端節省很多存儲。</p>
<p>通常的使用場景是，比如你有一個筆記本電腦，上面有 ZFS 存儲的數據，然後使用一個服務器上 ZFS
作爲接收端，定期對筆記本上的 ZFS 做快照然後 send 給服務器。在沒有書籤功能的時候，
筆記本上至少得保留一個和服務器上相同的快照，作爲 send 的增量參考點，
而這個快照的內容已經在服務器上，所以筆記本中存有相同的快照只是在浪費存儲空間。
有了書籤功能之後，每次將定期的新快照發送到服務器之後，就可以把這個快照轉化成書籤，節省存儲開銷。</p>
</div>
<div class="section" id="checkpoint">
<h4><a class="toc-backref" href="#id19">檢查點（checkpoint）</a></h4>
<p>這也是 ZFS 的新特性， ZFS on Linux 分支從 v0.8.0 開始支持創建檢查點。</p>
<p>簡而言之，檢查點可以看作是整個存儲池級別的快照，使用檢查點能快速將整個存儲池都恢復到上一個狀態。
這邊有篇文章介紹 <a class="reference external" href="https://sdimitro.github.io/post/zpool-checkpoint/">ZFS checkpoint 功能的背景、用法和限制</a>
，可以看出當存儲池中有檢查點的時候很多存儲池的功能會受影響（比如不能刪除 vdev 、不能處於
degraded 狀態、不能 scrub 到當前存儲池中已經釋放而在檢查點還在引用的數據塊），
於是檢查點功能設計上更多是給系統管理員準備的用於調整整個 ZFS pool 時的後悔藥，
調整結束後日用狀態下應該刪除掉所有檢查點。</p>
</div>
</div>
<div class="section" id="zfs-btrfs">
<h3><a class="toc-backref" href="#id20">ZFS 的概念與 btrfs 概念的對比</a></h3>
<p>先說書籤和檢查點，因爲這是兩個 btrfs 目前完全沒有的功能。</p>
<p>書籤功能完全圍繞 ZFS send 的工作原理，而 ZFS send 位於 ZFS 設計中的
<a href="#id23"><span class="problematic" id="id24">DSL_</span></a> 層面，甚至不關心它 send
的快照的數據是來自文件系統還是 zvol 。在發送端它只是從目標快照遞歸取數據塊，判斷 TXG
是否老於參照點的快照，然後把新的數據塊全部發往 send stream ；在接收端也只是完整地接收數據塊，
不加以處理，。與之不同的是 btrfs 的 send 的工作原理是工作在文件系統的只讀子卷層面，
發送端在內核代碼中根據目標快照的 b 樹和參照點快照的 generation 生成一個 diff
（可以通過 <code class="code">
btrfs subvolume find-new</code>
 直接拿到這個 diff ），然後在用戶態代碼中根據
diff 和參照點、目標快照的兩個只讀子卷的數據產生一連串修改文件系統的指令，
指令包括創建文件、刪除文件、讓文件引用數據塊（保持 reflink ）等操作；在接收端則完全工作在用戶態下，
根據接收到的指令重建目標快照。可見 btrfs send 需要在發送端讀取參照點快照的數據（比如找到
reflink 引用），從而 btrfs 沒法（或者很難）實現書籤功能。</p>
<p>檢查點也是 btrfs 目前沒有的功能。 btrfs 目前不能對頂層子卷做遞歸的 snapshot ，btrfs
的子卷也沒有類似 ZFS 數據集的層級關係和可繼承屬性，從而沒法實現類似檢查點的功能。</p>
<p>除了書籤和檢查點之外，剩下的概念可以在 ZFS 和 btrfs 之間有如下映射關係：</p>
<table border="0" class="field-list docutils table" frame="void" rules="none">
<col class="field-name"/>
<col class="field-body"/>
<tbody valign="top">
<tr class="field"><th class="field-name">ZFS 文件系統:</th><td class="field-body">btrfs 子卷</td>
</tr>
<tr class="field"><th class="field-name">ZFS 快照:</th><td class="field-body">btrfs 只讀快照</td>
</tr>
<tr class="field"><th class="field-name">ZFS 克隆:</th><td class="field-body">btrfs 可寫快照</td>
</tr>
</tbody>
</table>
<p>對 ZFS 數據集的操作，大部分也可以找到對應的對 btrfs 子卷的操作。</p>
<table border="0" class="field-list docutils table" frame="void" rules="none">
<col class="field-name"/>
<col class="field-body"/>
<tbody valign="top">
<tr class="field"><th class="field-name">zfs list:</th><td class="field-body"><code class="code">
btrfs subvolume list</code>
</td>
</tr>
<tr class="field"><th class="field-name">zfs create:</th><td class="field-body"><code class="code">
btrfs subvolume create</code>
</td>
</tr>
<tr class="field"><th class="field-name">zfs destroy:</th><td class="field-body"><code class="code">
btrfs subvolume delete</code>
</td>
</tr>
<tr class="field"><th class="field-name">zfs rename:</th><td class="field-body"><code class="code">
mv</code>
</td>
</tr>
<tr class="field"><th class="field-name">zfs snapshot:</th><td class="field-body"><code class="code">
btrfs subvolume snapshot -r</code>
</td>
</tr>
<tr class="field"><th class="field-name">zfs rollback:</th><td class="field-body">這個在 btrfs 需要對只讀快照創建出可寫的快照（用 snapshot 命令，或者直接修改讀寫屬性），然後改名或者調整掛載點</td>
</tr>
<tr class="field"><th class="field-name">zfs diff:</th><td class="field-body"><code class="code">
btrfs subvolume find-new</code>
</td>
</tr>
<tr class="field"><th class="field-name">zfs clone:</th><td class="field-body"><code class="code">
btrfs subvolume snapshot</code>
</td>
</tr>
<tr class="field"><th class="field-name">zfs promote:</th><td class="field-body">和 rollback 類似，可以直接調整 btrfs 子卷的掛載點</td>
</tr>
</tbody>
</table>
<p>可見雖然功能上類似，但是至少從管理員管理的角度而言， zfs 對文件系統、快照、克隆的劃分更爲清晰，
對他們能做的操作也更爲明確。這也是很多從 ZFS 遷移到 btrfs ，或者反過來從 btrfs 換用 zfs
時，一些人困惑的起源（甚至有人據此說 ZFS 比 btrfs 好在 cli 設計上）。</p>
<p>不過 btrfs 子卷的設計也使它在系統管理上有了更大的靈活性。比如在 btrfs
中刪除一個子卷不會受制於別的子卷是否存在，而在 zfs 中要刪除一個快照必須先保證先摧毀掉依賴它的克隆。
再比如 btrfs 的可寫子卷沒有主次之分，而 zfs 中一個文件系統和其克隆之間有明顯的區別，所以需要
promote 命令調整差異。還有比如 ZFS 的文件系統只能回滾到最近一次的快照，
要回滾到更久之前的快照需要刪掉中間的快照，並且回滾之後原本的文件系統數據和快照數據就被丟棄了；
而 btrfs 中因爲回滾操作相當於調整子卷的掛載，所以不需要刪掉快照，
並且回滾之後原本的子卷和快照還可以繼續保留。</p>
<p>加上 btrfs 有 reflink ，這給了 btrfs 在使用中更大的靈活性，可以有一些 zfs 很難做到的用法。
比如想從快照中打撈出一些虛擬機鏡像的歷史副本，而不想回滾整個快照的時候，在
btrfs 中可以直接 <code class="code">
cp --reflink=always</code>
 將鏡像從快照中複製出來，此時的複製將和快照共享數據塊；
而在 zfs 中只能用普通 cp 複製，會浪費很多存儲空間。</p>
</div>
<div class="section" id="id6">
<h3><a class="toc-backref" href="#id21">ZFS 中是如何存儲這些數據集的呢</a></h3>
<p>要講到存儲細節，首先需要提一下 ZFS 的分層設計。不像 btrfs 基於現代 Linux
內核，有許多現有文件系統已經實現好的基礎設施可以利用，並且大體上只用到一種核心數據結構（CoW的B樹）；
ZFS 則脫胎於 Solaris 的野心勃勃，設計時就分成很多不同的子系統，逐步提升抽象層次，
並且每個子系統都發明了許多特定需求下的數據結構來描述存儲的信息。</p>
<p>ZFS 在設計之初背負了重構 Solaris 諸多內核子系統的重任，從而不同於 Linux 的文件系統
只負責文件系統的功能而把其餘功能（比如內存髒頁管理，IO調度）交給內核更底層的子系統， ZFS
的整體設計更層次化並更獨立，很多部分可能和 Linux 內核已有的子系統有功能重疊。
而本文想講的只是 ZFS 中與快照相關的一些部分，於是先從 ZFS 的整體設計上說一下和快照相關的概念位於
ZFS 設計中的什麼位置。</p>
<p>和本文內容密切相關的是 ZPL 、 DSL、 DMU 這些 ZFS 子系統。</p>
<div class="section" id="id7">
<h4><a class="toc-backref" href="#id22">ZFS 的存儲格式概況</a></h4>
<p>Sun 曾經寫過一篇 <a class="reference external" href="http://www.giis.co.in/Zfs_ondiskformat.pdf">ZFS 的 On disk format</a>
對理解 ZFS 如何存儲在磁盤</p>
</div>
</div>
</div>
<div class="system-messages section">
<h2>Docutils System Messages</h2>
<div class="system-message" id="id23">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">/home/travis/build/farseerfc/farseerfc/content/tech/btrfs-vs-zfs-difference-in-implementing-snapshots.zh.rst</tt>, line 557); <em><a href="#id24">backlink</a></em></p>
Unknown target name: "dsl".</div>
</div>

            </div>
            <div class="entry-content jumbotron" id="source-content" style="display: none">
                <!-- <pre><code id="source-code">
                </code></pre> -->
                <div id="source-code"></div>
            </div>
            <!-- /.entry-content -->

            <div class="row" id="prevnext">
                <div class="col-xs-12">
                </div>
                <div class="col-xs-12">
                </div>
            </div>

            <div class="panel panel-default" id="series">
                <div class="panel-heading">
                  <h4>
この文章は ""　シリーズの <built-in method index of str object at 0x7f2007a0a990> 番目の文章：                  </h4>
                </div>
                <ul class="list-group">
                </ul>
            </div>

<section class="comments" id="comments">
    <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
      <div class="panel panel-primary">
        <div class="panel-heading" role="tab" id="disqus-heading">
          <h4 class="panel-title">
            <a data-toggle="collapse" data-parent="#accordion" href="#disqus-comments" aria-expanded="false" aria-controls="disqus-comments">
              <i class="fa fa-comments-o"></i> Disqus コメント            </a>
          </h4>
        </div>
        <div id="disqus-comments" class="panel-collapse collapse" role="tabpanel" aria-labelledby="disqus-heading">
          <div class="panel-body">
            <div class="tab-pane fade active in" id="disqus-comments">
                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'farseerfcgithub'; // required: replace example with your forum shortname

                            var disqus_identifier = 'btrfs-vs-zfs-difference-in-implementing-snapshots';
                        var disqus_url = 'http://farseerfc.me/jp/../drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html';

                    var disqus_config = function () {

                        this.language = "zh";
                    };

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function () {
                        var dsq = document.createElement('script');
                        dsq.type = 'text/javascript';
                        dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
                    Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
          </div>
        </div>
      </div>
    </div>
</section>        </article>
    </section>


            </div>
<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <a data-dismiss="modal" href="javascript:void(0);">
            <img id="mimg" src="" style="width:100%;height:auto">
          </a>
        </div>
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
        </div>
        <div class="col-xl-3 col-lg-4 col-md-6" id="sidebar">
            <aside>

<section>
    <div class="sidebar-container">
<div class="sidebar-item ">
<div class="panel panel-default">
	<div class="panel-heading">
        <h4>
<i class="fa fa-user fa-lg"></i>
<a href="//farseerfc.me/jp/pages/about.html">
farseerfc に連絡</a>
        </h4>
    </div>
<div class="panel-body" id="aboutme">
        <a href="//farseerfc.me/jp/pages/about.html"><img width="100%" src="//farseerfc.me/jp/../images/avatar.jpg"/></a>
    <h3 style="text-align:center">
<a href="https://sak.uy/"                  target="_blank">
<i class="fa fa-music" style="text-align:center"></i></a>
<a href="https://twitter.com/farseerfc"                  target="_blank">
<i class="fa fa-twitter" style="text-align:center"></i></a>
<a href="https://github.com/farseerfc"                   target="_blank">
<i class="fa fa-github" style="text-align:center"></i></a>
<a href="http://www.facebook.com/farseerfc"              target="_blank">
<i class="fa fa-facebook" style="text-align:center"></i></a>
<a href="https://plus.google.com/u/0/+JiachenYang/posts" target="_blank">
<i class="fa fa-google-plus" style="text-align:center"></i></a>
<a href="mailto:farseerfc@gmail.com" target="_blank">
<i class="mdi-communication-email" style="text-align:center"></i></a>
</h3>

</div>
</div>
</div>





<div class="sidebar-item hidden-xs">
<div class="panel panel-default">
	<div class="panel-heading">
        <h4>
<a href="//farseerfc.me/jp/tags.html"><i class="fa fa-tags fa-lg"></i><span class="icon-label">タグ雲</span></a>
        </h4>
    </div>
<div class="panel-body">
    <ul class="list-group list-inline tagcloud" id="tags">
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/jp/tag/kde5.html">
                    kde5 <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/jp/tag/plasma.html">
                    plasma <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-1">
                <a href="//farseerfc.me/jp/tag/linux.html">
                    linux <sup> 2</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/jp/tag/gnome3.html">
                    gnome3 <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/jp/tag/will.html">
                    will <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/jp/tag/you.html">
                    you <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/jp/tag/marry.html">
                    marry <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/jp/tag/me.html">
                    me <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/jp/tag/msr.html">
                    msr <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/jp/tag/icse.html">
                    icse <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/jp/tag/mining.html">
                    mining <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/jp/tag/software.html">
                    software <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/jp/tag/repository.html">
                    repository <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-1">
                <a href="//farseerfc.me/jp/tag/python.html">
                    python <sup> 2</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/jp/tag/ruby.html">
                    ruby <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/jp/tag/pelican.html">
                    pelican <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/jp/tag/microsoft.html">
                    microsoft <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/jp/tag/acpi.html">
                    acpi <sup> 1</sup>
                </a>
            </li>
    </ul>
</div>
</div>
</div>

<div class="sidebar-item hidden-xs">
<div class="panel panel-default">
	<div class="panel-heading">
        <h4>
<i class="fa fa-github fa-lg"></i><span class="icon-label">GitHubのリポ</span>
        </h4>
    </div>
    <div class="panel-body">
        <div id="gh_repos">
            <p class="list-group-item">Status updating...</p>
        </div>
            <a href="https://github.com/farseerfc">@farseerfc</a> on GitHub<br>
    </div>
</div>
</div>
<div class="sidebar-item hidden-xs">
<div class="panel panel-default">
	<div class="panel-heading">
        <h4>
<a href="https://sak.uy/">
<i class="fa fa-home fa-lg"></i><span class="icon-label">Sakuya的音樂盒</span>
</a>
        </h4>
    </div>
    <div class="panel-body">
        <div id="other_blog_posts">
            <p class="list-group-item">Status updating...</p>
        </div>
    </div>
</div>
</div>

    </div>
</section>
        <div class="panel panel-default hidden-xs hidden-sm" id="affix-toc">
            <div class="panel-heading"><h4>
目次</h4>
            </div>
            <div class="panel-boy">
            <div class="toc" id="">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#btrfs-subvolume-snapshot" id="id8">Btrfs 的子卷（subvolume）和快照（snapshot）</a><ul>
<li><a class="reference internal" href="#subvolume-snapshot" id="id9">子卷（subvolume）和快照（snapshot）的術語</a></li>
<li><a class="reference internal" href="#id3" id="id10">於是子卷在存儲介質中是如何記錄的呢？</a></li>
<li><a class="reference internal" href="#id5" id="id11">那麼快照又是如何記錄的呢？</a></li>
</ul>
</li>
<li><a class="reference internal" href="#zfs-filesystem-snapshot-clone" id="id12">ZFS 的文件系統（filesystem）、快照（snapshot）、克隆（clone）及其它</a><ul>
<li><a class="reference internal" href="#zfs" id="id13">ZFS 設計中和快照相關的一些術語和概念</a><ul>
<li><a class="reference internal" href="#dataset" id="id14">數據集（dataset）</a></li>
<li><a class="reference internal" href="#filesystem" id="id15">文件系統（filesystem）</a></li>
<li><a class="reference internal" href="#snapshot" id="id16">快照（snapshot）</a></li>
<li><a class="reference internal" href="#clone" id="id17">克隆（clone）</a></li>
<li><a class="reference internal" href="#bookmark" id="id18">書籤（bookmark）</a></li>
<li><a class="reference internal" href="#checkpoint" id="id19">檢查點（checkpoint）</a></li>
</ul>
</li>
<li><a class="reference internal" href="#zfs-btrfs" id="id20">ZFS 的概念與 btrfs 概念的對比</a></li>
<li><a class="reference internal" href="#id6" id="id21">ZFS 中是如何存儲這些數據集的呢</a><ul>
<li><a class="reference internal" href="#id7" id="id22">ZFS 的存儲格式概況</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
            </div>
        </div>
            </aside>
        </div>
    </div>
</div>


<footer id="fcfooter">
   <hr/>
   <div class="container">
      <div class="row">
         <div class="col-md-24">
         <p><small>
            &copy; 2014 farseerfc
            &middot; ここは            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a> で生成する                <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a>
    <!-- Content -->
  <!-- licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution 4.0 International License</a>, except where indicated otherwise. -->

         </small></p>
         </div>
      </div>
   </div>
   <a href="#" class="btn btn-primary btn-fab btn-raised mdi-editor-vertical-align-top withripple" style="position:fixed;bottom:30px;right:30px;z-index:1000"></a>
</footer>
<script src="//farseerfc.me/jp/../theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="//farseerfc.me/jp/../theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="//farseerfc.me/jp/../theme/js/respond.min.js"></script>

    <!-- GitHub JS -->
    <script type="text/javascript">
        $(document).ready(function () {
            if (!window.jXHR) {
                var jxhr = document.createElement('script');
                jxhr.type = 'text/javascript';
                jxhr.src = '//farseerfc.me/jp/../theme/js/jXHR.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(jxhr, s);
            }

            github.showRepos({
                user: 'farseerfc',
                count: 5,
                skip_forks: false,
                target: '#gh_repos'
            });
        });
    </script>
    <script src="//farseerfc.me/jp/../theme/js/github.js" type="text/javascript"></script>
    <!-- End GitHub JS Code -->
<!-- Other Blog JS -->
<script type="text/javascript">
    $(document).ready(function () {
        if (!window.jXHR) {
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '//farseerfc.me/jp/../theme/js/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }
        other_blog.showRepos({
            url: 'https://sak.uy/',
            target: '#other_blog_posts'
        });
    });
</script>
<script src="//farseerfc.me/jp/../theme/js/other_blog.js" type="text/javascript"></script>
<!-- End Other Blog JS Code -->
    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'farseerfcgithub'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-29540705-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->

<script src="//farseerfc.me/jp/../theme/js/ripples.min.js"></script>
<script src="//farseerfc.me/jp/../theme/js/material.min.js"></script>
<script src="//farseerfc.me/jp/../theme/js/jquery.bootstrap-autohidingnavbar.min.js"></script>
<script>
    $(document).ready(function() {
        $.material.init();
        $("div.navbar").autoHidingNavbar();
        $(".img-responsive").css("cursor","pointer").on('click',function(){
            var sr=$(this).attr('src');
            $('#mimg').attr('src',sr);
            $('#myModal').modal('show');
        });
        $('#affix-toc').affix({
          offset: {
            top: function(){
                if($('#affix-toc').hasClass("affix"))
                    return $('#sidebar').height();
                return $('#sidebar').height() - $('#affix-toc').height();
            },
            bottom: function (){
                return $("#fcfooter").offset().top -
                    $("#article-content").offset().top -
                    $("#article-content").height() + 20;
            }
          }
        });
        $('#affix-toc').width($('#sidebar').width());
    });
    $(window).resize(function () {
       $('#affix-toc').width($('#sidebar').width());
    });
</script>

</body>
</html>