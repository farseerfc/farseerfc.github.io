<!DOCTYPE html>
<html lang="zh-Hans"
>
<head>
    <title>Btrfs vs ZFS 实现 snapshot 的差异 - Farseerfc的小窝</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <meta name="theme-color" content="#6b5594">
    <meta name="msapplication-navbutton-color" content="#6b5594">
    <meta name="apple-mobile-web-app-status-bar-style" content="#6b5594">
    <link rel="manifest" href="/manifest.json">


<link rel="apple-touch-icon" sizes="180x180" href="//farseerfc.me/zhs/images/apple-touch-icon.png">
<link rel="icon" type="image/png" href="//farseerfc.me/zhs/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="//farseerfc.me/zhs/images/favicon-16x16.png" sizes="16x16">
<link rel="mask-icon" href="//farseerfc.me/zhs/images/safari-pinned-tab.svg" color="#603cba">

<link rel="canonical" href="//farseerfc.me/zhs/drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html">

        <meta name="author" content="farseerfc" />
        <meta name="keywords" content="btrfs,zfs,cow,snapshot,clone,subvolume,dedup,reflink,SPA,DMU,DSL,ZPL" />
        <meta name="description" content="zfs 这个东西倒是名不符实。叫 z storage stack 明显更符合。 叫 fs 但不做 fs 自然确实会和 btrfs 有很大出入。 我反而以前还好奇为什么 btrfs 不弄 zvol ， 直到我意识到这东西真是一个 fs ，名符奇实。 —— 某不愿透露姓名的 Ext2FSD 开发者 Btrfs 和 ZFS 都是开源的写时拷贝（Copy on Write, CoW）文件系统，都提供了相似的子卷管理和 快照(snapshot）的功能。网上有不少文章都评价 ZFS 实现 CoW FS 的创新之处，进而想说「 Btrfs 只是 Linux/GPL 阵营对 ZFS …" />

        <meta property="og:site_name" content="Farseerfc的小窝" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Btrfs vs ZFS 实现 snapshot 的差异"/>
        <meta property="og:url" content="//farseerfc.me/zhs/drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html"/>
        <meta property="og:description" content="zfs 这个东西倒是名不符实。叫 z storage stack 明显更符合。 叫 fs 但不做 fs 自然确实会和 btrfs 有很大出入。 我反而以前还好奇为什么 btrfs 不弄 zvol ， 直到我意识到这东西真是一个 fs ，名符奇实。 —— 某不愿透露姓名的 Ext2FSD 开发者 Btrfs 和 ZFS 都是开源的写时拷贝（Copy on Write, CoW）文件系统，都提供了相似的子卷管理和 快照(snapshot）的功能。网上有不少文章都评价 ZFS 实现 CoW FS 的创新之处，进而想说「 Btrfs 只是 Linux/GPL 阵营对 ZFS …"/>
        <meta property="article:published_time" content="2020-01-01" />
            <meta property="article:section" content="tech" />
            <meta property="article:tag" content="btrfs" />
            <meta property="article:tag" content="zfs" />
            <meta property="article:tag" content="cow" />
            <meta property="article:tag" content="snapshot" />
            <meta property="article:tag" content="clone" />
            <meta property="article:tag" content="subvolume" />
            <meta property="article:tag" content="dedup" />
            <meta property="article:tag" content="reflink" />
            <meta property="article:tag" content="SPA" />
            <meta property="article:tag" content="DMU" />
            <meta property="article:tag" content="DSL" />
            <meta property="article:tag" content="ZPL" />
            <meta property="article:author" content="farseerfc" />
        <meta property="og:image"
                  content="//farseerfc.me/zhs/btrfs-vs-zfs-difference-in-implementing-snapshots.png"/>



    <!-- Bootstrap -->
        <link href="//farseerfc.me/zhs/../theme/css/bootstrap.min.css" rel="stylesheet">

    <link href="//farseerfc.me/zhs/../theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="//farseerfc.me/zhs/../theme/css/pygments/monokai.css" rel="stylesheet">
    <link href="//farseerfc.me/zhs/../theme/tipuesearch/tipuesearch.css" rel="stylesheet">
        <link href="//farseerfc.me/zhs/../theme/css/html4css1.css" rel="stylesheet">
    <link rel="stylesheet" href="//farseerfc.me/zhs/../theme/css/style.css" type="text/css"/>

        <link href="//farseerfc.me/zhs/feeds/atom.xml" type="application/atom+xml" rel="alternate"
              title="Farseerfc的小窝 ATOM Feed"/>

        <link href="//farseerfc.me/zhs/../theme/css/material.min.css" rel="stylesheet">
        <link href="//farseerfc.me/zhs/../theme/css/ripples.css" rel="stylesheet">
    <link href="//farseerfc.me/zhs/../theme/css/github-markdown.css" rel="stylesheet">
</head>
<body>
<div style="display:none" id="title">Btrfs vs ZFS 实现 snapshot 的差异 - Farseerfc的小窝</div>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
         <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">切换导航</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="//farseerfc.me/zhs/" class="navbar-brand">
Farseerfc的小窝            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">

                    <li class="dropdown hidden-lg hidden-xl">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="javascript:void(0)">
                            <i class="mdi-action-translate"></i><span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a href="//farseerfc.me/">繁體</a></li>
                            <li><a href="//farseerfc.me/jp/">日本語</a></li>
                            <li><a href="//farseerfc.me/en/">English</a></li>
                            <li class="active"><a href="//farseerfc.me/zhs/">简体</a></li>
                        </ul>
                    </li>

                    <ul class="nav navbar-nav hidden-xs hidden-md hidden-sm">
                        <li><a href="//farseerfc.me/"><i class="mdi-action-translate"></i>繁體</a></li>
                        <li><a href="//farseerfc.me/jp/"><i class="mdi-action-translate"></i>日本語</a></li>
                        <li><a href="//farseerfc.me/en/"><i class="mdi-action-translate"></i>English</a></li>
                        <li class="active"><a href="//farseerfc.me/zhs/"><i class="mdi-action-translate"></i>简体</a></li>
                    </ul>

                    <li class="dropdown hidden-md hidden-lg hidden-xl">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="javascript:void(0)">
                            <i class="fa fa-user"></i><span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu">
                             <li class=""><a href="//farseerfc.me/zhs/pages/about.html"><i class="fa fa-user"></i>
                                 关于
                              </a></li>
                             <li class=""><a href="//farseerfc.me/zhs/pages/links.html"><i class="fa fa-user"></i>
                                 友情链接
                              </a></li>
                        </ul>
                    </li>

                  <ul class="nav navbar-nav hidden-xs hidden-sm">
                     <li class=""><a href="//farseerfc.me/zhs/pages/about.html"><i class="fa fa-user"></i>
                         关于
                      </a></li>
                     <li class=""><a href="//farseerfc.me/zhs/pages/links.html"><i class="fa fa-user"></i>
                         友情链接
                      </a></li>
                  </ul>
            </ul>

                <ul class="nav navbar-nav hidden-md hidden-lg hidden-xl">
                    <li class="dropdown hidden-md hidden-lg hidden-xl">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="javascript:void(0)">
                            <i class="fa fa-folder-o"></i><span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li >
                                <a href="//farseerfc.me/zhs/category/import.html"><i class="fa fa-folder-o"></i> Import</a>
                            </li>
                            <li >
                                <a href="//farseerfc.me/zhs/category/life.html"><i class="fa fa-folder-o"></i> Life</a>
                            </li>
                            <li class="active">
                                <a href="//farseerfc.me/zhs/category/tech.html"><i class="fa fa-folder-o"></i> Tech</a>
                            </li>
                        </ul>
                    </li>
                </ul>

                    <ul class="nav navbar-nav hidden-xs hidden-sm">
                        <li >
                            <a href="//farseerfc.me/zhs/category/import.html"><i class="fa fa-folder-o"></i> Import</a>
                        </li>
                        <li >
                            <a href="//farseerfc.me/zhs/category/life.html"><i class="fa fa-folder-o"></i> Life</a>
                        </li>
                        <li class="active">
                            <a href="//farseerfc.me/zhs/category/tech.html"><i class="fa fa-folder-o"></i> Tech</a>
                        </li>
                    </ul>



            <ul class="nav navbar-nav navbar-right hidden-sm hidden-md hidden-lg hidden-xl">
                <li class="dropdown hidden-md hidden-lg hidden-xl">
                    <a class="dropdown-toggle" data-toggle="dropdown" href="javascript:void(0)">
                        <i class="fa fa-search"></i><span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu">
                      <li><span>
                        <form class="navbar-search" action="/search.html">
                          <input type="text" class="search-query form-control col-lg-16" placeholder="搜索" name="q" id="tipue_search_input" required>
                        </form></span>
                      </li>
                    </ul>
                </li>
            </ul>

            <ul class="nav navbar-right navbar-form hidden-xs">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query form-control col-lg-16" placeholder="搜索" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
            </ul>

            <ul class="nav navbar-nav navbar-right hidden-xs">
              <li><a href="//farseerfc.me/zhs/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">归档</span></a></li>
              <li><a href="//farseerfc.me/zhs/feeds/atom.xml" title="Atom feeds for all articles"><i class="fa fa-rss"></i></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container" style="min-height: 100%;height: auto !important;height: 100%;">
    <div class="row" style="padding-bottom:80px;padding-top:80px;">
        <div class="col-xl-21 col-lg-20 col-md-18">
            <div id="loading-block">
            <ol class="breadcrumb">
                <li><a href="//farseerfc.me/zhs/" title="Farseerfc的小窝"><i class="fa fa-home fa-lg"></i></a></li>
                <li><a href="//farseerfc.me/zhs/category/tech.html" title="tech">tech</a></li>
                <li class="active">Btrfs vs ZFS 实现 snapshot 的差异</li>
            </ol>
    <section id="content" class="article-content">
        <article>
            <header class="page-header jumbotron jumbotron-primary panel-primary" id="article-header">
                <div class="panel-heading">
                    <h1>
                        Btrfs vs ZFS 实现 snapshot 的差异
                        <a href="//farseerfc.me/zhs/drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html"
                           rel="bookmark"
                           class="btn btn-primary btn-lg"
                           title="到 Btrfs vs ZFS 实现 snapshot 的差异 的永久链接">
                           <i class="mdi-action-launch"></i>
                        </a>
                    </h1>
                </div>
                <div class="panel-body">
<div class="post-info">
    <span class="published">
        <time datetime="2020-01-01T13:45:00+09:00"><i class="fa fa-calendar"></i> 2020年01月01日(周三)</time>
    </span>



<div class="btn-group translations">
<a href="javascript:void(0)" class="btn btn-primary dropdown-toggle" data-toggle="dropdown"><i class="mdi-action-translate"></i><span class="caret"></a>
<ul class="dropdown-menu">
<li class="active"><a href="//farseerfc.me/zhs/drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html">简体</a></li><li><a href="//farseerfc.me/zhs/../drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html" class="translate">繁體</a></li></ul>
</div>

    <a onclick="$.get('//farseerfc.me/zhs/btrfs-vs-zfs-difference-in-implementing-snapshots.rst.html', function(data){$('#source-code').html(data)});$('#article-content').toggle();$('#source-content').toggle();" class="btn btn-primary" title="显示这篇文章的源文件"><i class="fa fa-code"></i></a>
    <a href="//farseerfc.me/zhs/btrfs-vs-zfs-difference-in-implementing-snapshots.pdf" class="btn btn-primary" title="显示这篇文章的印刷版PDF文件" target="_blank"><i class="fa fa-file-pdf-o"></i></a>
    <a href="//farseerfc.me/zhs/btrfs-vs-zfs-difference-in-implementing-snapshots.png" class="btn btn-primary" title="显示这篇文章的截图PNG文件" target="_blank""><i class="fa fa-file-photo-o"></i></a>

<small><span><a href="//farseerfc.me/zhs/drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html#disqus_thread" class="btn btn-primary" data-disqus-identifier="btrfs-vs-zfs-difference-in-implementing-snapshots" data-disqus-url="http://farseerfc.me/zhs/drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html"><i class="fa fa-comments-o"></i></a></span></small><span class="btn-group">
	<a href="//farseerfc.me/zhs/tag/btrfs.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> btrfs</a>
	<a href="//farseerfc.me/zhs/tag/zfs.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> zfs</a>
	<a href="//farseerfc.me/zhs/tag/cow.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> cow</a>
	<a href="//farseerfc.me/zhs/tag/snapshot.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> snapshot</a>
	<a href="//farseerfc.me/zhs/tag/clone.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> clone</a>
	<a href="//farseerfc.me/zhs/tag/subvolume.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> subvolume</a>
	<a href="//farseerfc.me/zhs/tag/dedup.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> dedup</a>
	<a href="//farseerfc.me/zhs/tag/reflink.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> reflink</a>
	<a href="//farseerfc.me/zhs/tag/spa.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> SPA</a>
	<a href="//farseerfc.me/zhs/tag/dmu.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> DMU</a>
	<a href="//farseerfc.me/zhs/tag/dsl.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> DSL</a>
	<a href="//farseerfc.me/zhs/tag/zpl.html" class="btn btn-primary btn-xs"><i class="fa fa-tag"></i> ZPL</a>
</span>



</div><!-- /.post-info -->                </div>
            </header>

            <div class="entry-content jumbotron" id="article-content">
                    <div class="panel panel-default">
                        <div class="panel-heading">
目录                        </div>
                        <div class="panel-boy">
                        <div class="toc" id="">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#btrfs" id="id30">Btrfs 的子卷和快照</a><ul>
<li><a class="reference internal" href="#id3" id="id31">子卷和快照的术语</a></li>
<li><a class="reference internal" href="#id4" id="id32">于是子卷在存储介质中是如何记录的呢？</a></li>
<li><a class="reference internal" href="#id6" id="id33">那么快照又是如何记录的呢？</a></li>
</ul>
</li>
<li><a class="reference internal" href="#zfs" id="id34">ZFS 的文件系统、快照、克隆及其它</a><ul>
<li><a class="reference internal" href="#id7" id="id35">ZFS 设计中和快照相关的一些术语和概念</a><ul>
<li><a class="reference internal" href="#id8" id="id36">数据集</a></li>
<li><a class="reference internal" href="#id9" id="id37">文件系统</a></li>
<li><a class="reference internal" href="#id10" id="id38">快照</a></li>
<li><a class="reference internal" href="#id11" id="id39">克隆</a></li>
<li><a class="reference internal" href="#id12" id="id40">书签</a></li>
<li><a class="reference internal" href="#id13" id="id41">检查点</a></li>
</ul>
</li>
<li><a class="reference internal" href="#zfs-btrfs" id="id42">ZFS 的概念与 btrfs 概念的对比</a></li>
<li><a class="reference internal" href="#id14" id="id43">ZFS 中是如何存储这些数据集的呢</a><ul>
<li><a class="reference internal" href="#id17" id="id44">ZFS 的块指针</a></li>
<li><a class="reference internal" href="#id18" id="id45">ZPL 的元对象集</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id19" id="id46">创建快照这么简单么？那么删除快照呢？</a><ul>
<li><a class="reference internal" href="#id20" id="id47">日志结构文件系统中用的垃圾回收算法</a></li>
<li><a class="reference internal" href="#wafl" id="id48">WAFL 早期使用的可用空间位图数组</a></li>
<li><a class="reference internal" href="#id23" id="id49">ZFS 中关于快照和克隆的空间跟踪算法</a><ul>
<li><a class="reference internal" href="#id25" id="id50">🐢乌龟算法：概念上 ZFS 如何删快照</a></li>
<li><a class="reference internal" href="#id26" id="id51">🐰兔子算法：死亡列表算法（ZFS早期）</a></li>
<li><a class="reference internal" href="#id27" id="id52">🐆豹子算法：死亡列表的子列表</a></li>
<li><a class="reference internal" href="#id28" id="id53">生存日志：ZFS 如何管理克隆的空间占用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id29" id="id54">btrfs 的空间跟踪算法：反向引用</a></li>
</ul>
</li>
</ul>
</div>
                        </div>
                    </div>
                
<!-- -->
<blockquote>
<div class="line-block">
<div class="line">zfs 这个东西倒是名不符实。叫 z storage stack 明显更符合。 叫 fs 但不做 fs 自然确实会和 btrfs 有很大出入。</div>
<div class="line">我反而以前还好奇为什么 btrfs 不弄 zvol ， 直到我意识到这东西真是一个 fs ，名符奇实。</div>
<div class="line">—— 某不愿透露姓名的 Ext2FSD 开发者</div>
</div>
</blockquote>
<p>Btrfs 和 ZFS 都是开源的写时拷贝（Copy on Write, CoW）文件系统，都提供了相似的子卷管理和
快照(snapshot）的功能。网上有不少文章都评价 ZFS 实现 CoW FS 的创新之处，进而想说「 Btrfs
只是 Linux/GPL 阵营对 ZFS 的拙劣抄袭」。或许（在存储领域人尽皆知而在领域外）鲜有人知，在
ZFS 之前就有 <a class="reference external" href="https://en.wikipedia.org/wiki/NetApp">NetApp</a> 的商业产品
<a class="reference external" href="https://en.wikipedia.org/wiki/Write_Anywhere_File_Layout">WAFL (Write Anywhere File Layout)</a>
实现了 CoW 语义的文件系统，并且集成了快照和卷管理之类的功能。描述 btrfs 原型设计的
<a class="reference external" href="https://btrfs.wiki.kernel.org/images-btrfs/6/68/Btree_TOS.pdf">论文</a>
和 <a class="reference external" href="https://btrfs.wiki.kernel.org/images-btrfs/6/63/LinuxFS_Workshop.pdf">发表幻灯片</a>
也明显提到 WAFL 比提到 ZFS 更多一些，应该说 WAFL 这样的企业级存储方案才是 ZFS 和 btrfs
共同的灵感来源，而无论是 ZFS 还是 btrfs 在其设计中都汲取了很多来自 WAFL 的经验教训。</p>
<p>我一开始也带着「 Btrfs 和 ZFS
都提供了类似的功能，因此两者必然有类似的设计」这样的先入观念，尝试去使用这两个文件系统，
却经常撞上两者细节上的差异，导致使用时需要不尽相同的工作流，
或者看似相似的用法有不太一样的性能表现，又或者一边有的功能（比如 ZFS 的 inband dedup ，
Btrfs 的 reflink ）在另一边没有的情况。后来看到了
<a class="reference external" href="https://lwn.net/Articles/342892/">LWN 的这篇 《A short history of btrfs》</a>
让我意识到 btrfs 和 ZFS 虽然表面功能上看起来类似，但是实现细节上完全不一样，
所以需要不一样的用法，适用于不一样的使用场景。</p>
<p>为了更好地理解这些差异，我四处搜罗这两个文件系统的实现细节，于是有了这篇笔记，
记录一下我查到的种种发现和自己的理解。<del>（或许会写成一个系列？还是先别乱挖坑不填。）</del>
只是自己的笔记，所有参阅的资料文档都是二手资料，没有深挖过源码，还参杂了自己的理解，
于是难免有和事实相违的地方，如有写错，还请留言纠正。</p>
<div class="section" id="btrfs">
<h2><a class="toc-backref" href="#id30">Btrfs 的子卷和快照</a></h2>
<p>先从两个文件系统中（表面上看起来）比较简单的 btrfs 的子卷（subvolume）和快照（snapshot）说起。
关于子卷和快照的常规用法、推荐布局之类的话题就不细说了，网上能找到很多不错的资料，比如
<a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/SysadminGuide#Subvolumes">btrfs wiki 的 SysadminGuide 页</a>
和 Arch wiki 上 <a class="reference external" href="https://wiki.archlinux.org/index.php/Btrfs#Subvolumes">Btrfs#Subvolumes</a> 页都有不错的参考价值。</p>
<p>关于写时拷贝（CoW）文件系统的优势，我们为什么要用 btrfs/zfs 这样的写时拷贝文件系统，
而不是传统的文件系统设计，或者写时拷贝文件系统在使用时有什么区别之类的，网上同样也能找到很多介绍
，这里不想再讨论。这里假设你用过 btrfs/zfs 至少一个的快照功能，知道它该怎么用，
并且想知道更多细节，判断怎么用那些功能才合理。</p>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id31">子卷和快照的术语</a></h3>
<p>在 btrfs 中，存在于存储媒介中的只有「子卷」的概念，「快照」只是个创建「子卷」的方式，
换句话说在 btrfs 的术语里，子卷（subvolume）是个名词，而快照（snapshot）是个动词。
如果脱离了 btrfs 术语的上下文，或者不精确地称呼的时候，也经常有文档把 btrfs
的快照命令创建出的子卷叫做一个快照，所以当提到快照的时候，根据上下文判断这里是个动词还是名词，
把名词的快照当作用快照命令创建出的子卷就可以了。或者我们可以理解为，
<strong>互相共享一部分元数据（metadata）的子卷互为彼此的快照（名词）</strong> ，
那么按照这个定义的话，在 btrfs 中创建快照（名词）的方式其实有两种：</p>
<ol class="arabic simple">
<li>用 <code class="code">
btrfs subvolume snapshot</code>
 命令创建快照</li>
<li>用 <code class="code">
btrfs send</code>
 命令并使用 <code class="code">
-p</code>
 参数发送快照，并在管道另一端接收</li>
</ol>
<div class="panel panel-default">
<div class="panel-heading">
<code class="code">
btrfs send</code>
 命令的 <code class="code">
-p</code>
 与 <code class="code">
-c</code>
</div>
<div class="panel-body">
<p>这里也顺便提一下 <code class="code">
btrfs send</code>
 命令的 <code class="code">
-p</code>
 参数和 <code class="code">
-c</code>
 参数的差异。
只看 <a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/Manpage/btrfs-send#DESCRIPTION">btrfs-send(8)</a> 的描述的话：</p>
<blockquote>
<div class="line-block">
<div class="line">-p &lt;parent&gt;</div>
<div class="line-block">
<div class="line">send an incremental stream from parent to subvol</div>
<div class="line"><br/></div>
</div>
<div class="line">-c &lt;clone-src&gt;</div>
<div class="line-block">
<div class="line">use this snapshot as a clone source for an incremental send (multiple allowed)</div>
</div>
</div>
</blockquote>
<p>看起来这两个都可以用来生成两个快照之间的差分，只不过 -p 只能指定一个「parent」，
而 -c 能指定多个「clone source」。在
<a class="reference external" href="https://unix.stackexchange.com/a/490857">unix stackexchange 上有人写明了这两个的异同</a>
。使用 -p 的时候，产生的差分首先让接收端用 subvolume snapshot 命令对 parent 子卷创建一个快照，
然后发送指令将这个快照修改成目标子卷的样子，而使用 -c 的时候，首先在接收端用 subvolume create
创建一个空的子卷，随后发送指令在这个子卷中填充内容，其数据块尽量共享 clone source 已有的数据。
所以 <code class="code">
btrfs send -p</code>
 在接收端产生是有共享元数据的快照，而 <code class="code">
btrfs send -c</code>

在接收端产生的是仅仅共享数据而不共享元数据的子卷。</p>
</div>
</div>
<p>定义中「互相共享一部分 <strong>元数据</strong> 」比较重要，因为除了快照的方式之外， btrfs
的子卷间也可以通过 reflink 的形式共享数据块。我们可以对一整个子卷（甚至目录）执行
<code class="code">
cp -r --reflink=always</code>
 ，创建出一个副本，副本的文件内容通过 reflink
共享原本的数据，但不共享元数据，这样创建出的就不是快照。</p>
<p>说了这么多，其实关键的只是 btrfs 在传统 Unix 文件系统的「目录/文件/inode」
这些东西之外只增加了一个「子卷」的新概念，而子卷间可以共享元数据或者数据，
用快照命令创建出的子卷就是共享一部分元数据。</p>
</div>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id32">于是子卷在存储介质中是如何记录的呢？</a></h3>
<p>比如在 <a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/SysadminGuide#Flat">SysadminGuide 这页的 Flat 布局</a>
有个子卷布局的例子。</p>
<pre class="code literal-block">
toplevel         (volume root directory, not to be mounted by default)
    +-- root       (subvolume root directory, to be mounted at /)
    +-- home       (subvolume root directory, to be mounted at /home)
    +-- var        (directory)
    |   \-- www    (subvolume root directory, to be mounted at /var/www)
    \-- postgres   (subvolume root directory, to be mounted at /var/lib/postgresql)
</pre>
<p>用圆柱体表示子卷的话画成图大概是这个样子：</p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">

<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Flat_layout Pages: 1 -->
<svg class="svg-responsive" height="206pt" viewbox="0.00 0.00 287.00 206.00" width="287pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g class="graph" id="graph0" transform="scale(1 1) rotate(0) translate(4 202)">
<title>Flat_layout</title>
<polygon fill="#ffffff" points="-4,4 -4,-202 283,-202 283,4 -4,4" stroke="transparent"></polygon>
<!-- toplevel -->
<g class="node" id="node1">
<title>toplevel</title>
<path d="M74,-113.7273C74,-115.5331 57.416,-117 37,-117 16.584,-117 0,-115.5331 0,-113.7273 0,-113.7273 0,-84.2727 0,-84.2727 0,-82.4669 16.584,-81 37,-81 57.416,-81 74,-82.4669 74,-84.2727 74,-84.2727 74,-113.7273 74,-113.7273" fill="none" stroke="#000000"></path>
<path d="M74,-113.7273C74,-111.9214 57.416,-110.4545 37,-110.4545 16.584,-110.4545 0,-111.9214 0,-113.7273" fill="none" stroke="#000000"></path>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="37" y="-95.3">toplevel</text>
</g>
<!-- root -->
<g class="node" id="node2">
<title>root</title>
<path d="M176.5,-194.7273C176.5,-196.5331 164.3982,-198 149.5,-198 134.6018,-198 122.5,-196.5331 122.5,-194.7273 122.5,-194.7273 122.5,-165.2727 122.5,-165.2727 122.5,-163.4669 134.6018,-162 149.5,-162 164.3982,-162 176.5,-163.4669 176.5,-165.2727 176.5,-165.2727 176.5,-194.7273 176.5,-194.7273" fill="none" stroke="#000000"></path>
<path d="M176.5,-194.7273C176.5,-192.9214 164.3982,-191.4545 149.5,-191.4545 134.6018,-191.4545 122.5,-192.9214 122.5,-194.7273" fill="none" stroke="#000000"></path>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="149.5" y="-176.3">root</text>
</g>
<!-- toplevel&#45;&gt;root -->
<g class="edge" id="edge1">
<title>toplevel-&gt;root</title>
<path d="M60.5079,-116.7348C74.7361,-127.3823 93.2999,-141.1218 110,-153 111.8699,-154.33 113.7963,-155.6874 115.7451,-157.0508" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="114.115,-160.1795 124.3276,-163 118.1029,-154.4265 114.115,-160.1795" stroke="#000000"></polygon>
</g>
<!-- home -->
<g class="node" id="node3">
<title>home</title>
<path d="M177.5,-140.7273C177.5,-142.5331 164.95,-144 149.5,-144 134.05,-144 121.5,-142.5331 121.5,-140.7273 121.5,-140.7273 121.5,-111.2727 121.5,-111.2727 121.5,-109.4669 134.05,-108 149.5,-108 164.95,-108 177.5,-109.4669 177.5,-111.2727 177.5,-111.2727 177.5,-140.7273 177.5,-140.7273" fill="none" stroke="#000000"></path>
<path d="M177.5,-140.7273C177.5,-138.9214 164.95,-137.4545 149.5,-137.4545 134.05,-137.4545 121.5,-138.9214 121.5,-140.7273" fill="none" stroke="#000000"></path>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="149.5" y="-122.3">home</text>
</g>
<!-- toplevel&#45;&gt;home -->
<g class="edge" id="edge2">
<title>toplevel-&gt;home</title>
<path d="M74.1485,-107.9156C86.1488,-110.7957 99.4652,-113.9916 111.5245,-116.8859" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="110.7613,-120.302 121.302,-119.2325 112.395,-113.4953 110.7613,-120.302" stroke="#000000"></polygon>
</g>
<!-- var -->
<g class="node" id="node4">
<title>var</title>
<polygon fill="none" points="176.5,-90 173.5,-94 152.5,-94 149.5,-90 122.5,-90 122.5,-54 176.5,-54 176.5,-90" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="149.5" y="-68.3">var</text>
</g>
<!-- toplevel&#45;&gt;var -->
<g class="edge" id="edge3">
<title>toplevel-&gt;var</title>
<path d="M74.1485,-90.0844C86.4488,-87.1323 100.1319,-83.8484 112.4265,-80.8976" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="113.4596,-84.2492 122.3666,-78.512 111.8259,-77.4425 113.4596,-84.2492" stroke="#000000"></polygon>
</g>
<!-- postgres -->
<g class="node" id="node6">
<title>postgres</title>
<path d="M189,-32.7273C189,-34.5331 171.2955,-36 149.5,-36 127.7045,-36 110,-34.5331 110,-32.7273 110,-32.7273 110,-3.2727 110,-3.2727 110,-1.4669 127.7045,0 149.5,0 171.2955,0 189,-1.4669 189,-3.2727 189,-3.2727 189,-32.7273 189,-32.7273" fill="none" stroke="#000000"></path>
<path d="M189,-32.7273C189,-30.9214 171.2955,-29.4545 149.5,-29.4545 127.7045,-29.4545 110,-30.9214 110,-32.7273" fill="none" stroke="#000000"></path>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="149.5" y="-14.3">postgres</text>
</g>
<!-- toplevel&#45;&gt;postgres -->
<g class="edge" id="edge5">
<title>toplevel-&gt;postgres</title>
<path d="M60.5079,-81.2652C74.7361,-70.6177 93.2999,-56.8782 110,-45 111.5738,-43.8806 113.1875,-42.7418 114.821,-41.5965" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="116.8432,-44.4534 123.0588,-35.8733 112.8492,-38.7046 116.8432,-44.4534" stroke="#000000"></polygon>
</g>
<!-- www -->
<g class="node" id="node5">
<title>www</title>
<path d="M279,-86.7273C279,-88.5331 266.8982,-90 252,-90 237.1018,-90 225,-88.5331 225,-86.7273 225,-86.7273 225,-57.2727 225,-57.2727 225,-55.4669 237.1018,-54 252,-54 266.8982,-54 279,-55.4669 279,-57.2727 279,-57.2727 279,-86.7273 279,-86.7273" fill="none" stroke="#000000"></path>
<path d="M279,-86.7273C279,-84.9214 266.8982,-83.4545 252,-83.4545 237.1018,-83.4545 225,-84.9214 225,-86.7273" fill="none" stroke="#000000"></path>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="252" y="-68.3">www</text>
</g>
<!-- var&#45;&gt;www -->
<g class="edge" id="edge4">
<title>var-&gt;www</title>
<path d="M176.699,-72C188.2828,-72 201.9866,-72 214.5073,-72" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="214.6739,-75.5001 224.6739,-72 214.6739,-68.5001 214.6739,-75.5001" stroke="#000000"></polygon>
</g>
</g>
</svg>
<p>首先要说明， btrfs 中大部分长度可变的数据结构都是
<a class="reference external" href="https://www.usenix.org/legacy/events/lsf07/tech/rodeh.pdf">CoW B-tree</a>
，一种经过修改适合写时拷贝的B树结构，所以在
<a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/On-disk_Format">on-disk format</a>
中提到了很多个树。这里的树不是指文件系统中目录结构树，而是 CoW B-tree
，如果不关心B树细节的话可以把 btrfs 所说的一棵树理解为关系数据库中的一个表，
和数据库的表一样 btrfs 的树的长度可变，然后表项内容根据一个 key 排序。
有这样的背景之后，上图例子中的 Flat 布局在 btrfs 中大概是这样的数据结构：</p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">

<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Flat_layout_on_disk Pages: 1 -->
<svg class="svg-responsive" height="499pt" viewbox="0.00 0.00 1130.00 499.00" width="1130pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g class="graph" id="graph0" transform="scale(1 1) rotate(0) translate(4 495)">
<title>Flat_layout_on_disk</title>
<polygon fill="#ffffff" points="-4,4 -4,-495 1126,-495 1126,4 -4,4" stroke="transparent"></polygon>
<!-- superblock -->
<g class="node" id="node1">
<title>superblock</title>
<polygon fill="none" points="0,-315.5 0,-407.5 123,-407.5 123,-315.5 0,-315.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="61.5" y="-392.3">SUPERBLOCK</text>
<polyline fill="none" points="0,-384.5 123,-384.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="61.5" y="-369.3">...</text>
<polyline fill="none" points="0,-361.5 123,-361.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="61.5" y="-346.3">root_tree</text>
<polyline fill="none" points="0,-338.5 123,-338.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="61.5" y="-323.3">...</text>
</g>
<!-- roottree -->
<g class="node" id="node2">
<title>roottree</title>
<polygon fill="none" points="195,-62 195,-361 504,-361 504,-62 195,-62" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-345.8">ROOT_TREE</text>
<polyline fill="none" points="195,-338 504,-338 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-322.8">2: extent_tree</text>
<polyline fill="none" points="195,-315 504,-315 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-299.8">3: chunk_tree</text>
<polyline fill="none" points="195,-292 504,-292 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-276.8">4: dev_tree</text>
<polyline fill="none" points="195,-269 504,-269 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-253.8">5: fs_tree</text>
<polyline fill="none" points="195,-246 504,-246 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-230.8">6: root_dir "default" -&gt; ROOT_ITEM 256</text>
<polyline fill="none" points="195,-223 504,-223 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-207.8">10: free_space_tree</text>
<polyline fill="none" points="195,-200 504,-200 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-184.8">256: fs_tree "root"</text>
<polyline fill="none" points="195,-177 504,-177 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-161.8">257: fs_tree "home"</text>
<polyline fill="none" points="195,-154 504,-154 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-138.8">258: fs_tree "www"</text>
<polyline fill="none" points="195,-131 504,-131 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-115.8">259: fs_tree "postgres"</text>
<polyline fill="none" points="195,-108 504,-108 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-92.8">-7: tree_log_tree</text>
<polyline fill="none" points="195,-85 504,-85 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-69.8">-5: orphan_root</text>
</g>
<!-- superblock&#45;&gt;roottree -->
<g class="edge" id="edge1">
<title>superblock:sn_root-&gt;roottree:label</title>
<path d="M123,-349.5C151.375,-349.5 160.8795,-349.5 184.9792,-349.5" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="185,-353.0001 195,-349.5 185,-346.0001 185,-353.0001" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- roottree&#45;&gt;roottree -->
<g class="edge" id="edge8">
<title>roottree:e-&gt;roottree:e</title>
<path d="M504.5,-234.5C552,-243.5 648,-243.5 648,-211.5 648,-181.625 564.3267,-179.6411 514.5622,-186.8328" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="513.7934,-183.4124 504.5,-188.5 514.9376,-190.3183 513.7934,-183.4124" stroke="#000000"></polygon>
</g>
<!-- toplevel -->
<g class="node" id="node3">
<title>toplevel</title>
<polygon fill="none" points="576,-195.5 576,-425.5 923,-425.5 923,-195.5 576,-195.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-410.3">FS_TREE "toplevel"</text>
<polyline fill="none" points="576,-402.5 923,-402.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-387.3"> </text>
<polyline fill="none" points="576,-379.5 923,-379.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-364.3">256: inode_item DIR</text>
<polyline fill="none" points="576,-356.5 923,-356.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-341.3">256: dir_item: "root" -&gt; ROOT_ITEM 256</text>
<polyline fill="none" points="576,-333.5 923,-333.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-318.3">256: dir_item: "home" -&gt; ROOT_ITEM 257</text>
<polyline fill="none" points="576,-310.5 923,-310.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-295.3">256: dir_item: "var" -&gt; INODE_ITEM 257</text>
<polyline fill="none" points="576,-287.5 923,-287.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-272.3">256: dir_item: "postgres" -&gt; ROOT_ITEM 259</text>
<polyline fill="none" points="576,-264.5 923,-264.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-249.3"> </text>
<polyline fill="none" points="576,-241.5 923,-241.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-226.3">257: inode_item DIR</text>
<polyline fill="none" points="576,-218.5 923,-218.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-203.3">257: dir_item: "www" -&gt; ROOT_ITEM 258</text>
</g>
<!-- roottree&#45;&gt;toplevel -->
<g class="edge" id="edge7">
<title>roottree:root_fs-&gt;toplevel:label</title>
<path d="M504,-257.5C577.0172,-257.5 506.8191,-399.5423 565.8504,-413.4136" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="565.6843,-416.9157 576,-414.5 566.4293,-409.9555 565.6843,-416.9157" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- root -->
<g class="node" id="node4">
<title>root</title>
<polygon fill="none" points="667.5,-444.5 667.5,-490.5 831.5,-490.5 831.5,-444.5 667.5,-444.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-475.3">FS_TREE "root"</text>
<polyline fill="none" points="667.5,-467.5 831.5,-467.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-452.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;root -->
<g class="edge" id="edge9">
<title>roottree:root_sub_root-&gt;root:label</title>
<path d="M504,-188.5C617.92,-188.5 502.6779,-347.3126 576,-434.5 602.8896,-466.4744 619.4489,-477.7394 657.3774,-479.3044" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="657.4342,-482.8061 667.5,-479.5 657.5695,-475.8074 657.4342,-482.8061" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- home -->
<g class="node" id="node5">
<title>home</title>
<polygon fill="none" points="667.5,-130.5 667.5,-176.5 831.5,-176.5 831.5,-130.5 667.5,-130.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-161.3">FS_TREE "home"</text>
<polyline fill="none" points="667.5,-153.5 831.5,-153.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-138.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;home -->
<g class="edge" id="edge10">
<title>roottree:root_sub_home-&gt;home:label</title>
<path d="M504,-165.5C573.1185,-165.5 592.9293,-165.5 657.2326,-165.5" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="657.5,-169.0001 667.5,-165.5 657.5,-162.0001 657.5,-169.0001" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- www -->
<g class="node" id="node6">
<title>www</title>
<polygon fill="none" points="667.5,-65.5 667.5,-111.5 831.5,-111.5 831.5,-65.5 667.5,-65.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-96.3">FS_TREE "www"</text>
<polyline fill="none" points="667.5,-88.5 831.5,-88.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-73.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;www -->
<g class="edge" id="edge11">
<title>roottree:root_sub_www-&gt;www:label</title>
<path d="M504,-142.5C537.4605,-142.5 543.6289,-128.9684 576,-120.5 612.8107,-110.8702 623.9964,-102.1347 657.4378,-100.7044" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="657.5732,-104.2024 667.5,-100.5 657.431,-97.2039 657.5732,-104.2024" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- postgres -->
<g class="node" id="node7">
<title>postgres</title>
<polygon fill="none" points="667,-.5 667,-46.5 832,-46.5 832,-.5 667,-.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-31.3">FS_TREE "postgres"</text>
<polyline fill="none" points="667,-23.5 832,-23.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-8.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;postgres -->
<g class="edge" id="edge12">
<title>roottree:root_sub_postgres-&gt;postgres:label</title>
<path d="M504,-119.5C546.8146,-119.5 537.8681,-74.9691 576,-55.5 609.5346,-38.3781 622.9605,-35.847 656.4796,-35.5384" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="656.5135,-39.0384 666.5,-35.5 656.4866,-32.0384 656.5135,-39.0384" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge2">
<title>toplevel:toplevel_dir_root-&gt;roottree:root_sub_root</title>
<path d="M576,-345.5C502.9828,-345.5 573.1809,-203.4577 514.1496,-189.5864" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="514.3157,-186.0843 504,-188.5 513.5707,-193.0445 514.3157,-186.0843" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge3">
<title>toplevel:toplevel_dir_home-&gt;roottree:root_sub_home</title>
<path d="M576,-322.5C502.9828,-322.5 573.1809,-180.4577 514.1496,-166.5864" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="514.3157,-163.0843 504,-165.5 513.5707,-170.0445 514.3157,-163.0843" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge5">
<title>toplevel:toplevel_dir_postgres-&gt;roottree:root_sub_postgres</title>
<path d="M576,-275.5C503.3669,-275.5 572.8531,-134.3624 514.0988,-120.5795" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="514.3154,-117.0828 504,-119.5 513.5713,-124.0431 514.3154,-117.0828" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge6">
<title>toplevel:toplevel_dir_www-&gt;roottree:root_sub_www</title>
<path d="M576,-206.5C537.0321,-206.5 544.8212,-153.4834 514.2549,-143.957" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="514.3929,-140.4415 504,-142.5 513.4082,-147.3719 514.3929,-140.4415" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;toplevel -->
<g class="edge" id="edge4">
<title>toplevel:e-&gt;toplevel:e</title>
<path d="M923.5,-298.5C989.3333,-307.5 1122,-307.5 1122,-264 1122,-222.624 1001.9728,-220.6037 933.5984,-228.25" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="932.9943,-224.798 923.5,-229.5 933.8542,-231.745 932.9943,-224.798" stroke="#000000"></polygon>
</g>
</g>
</svg>
<p>上图中已经隐去了很多和本文无关的具体细节，所有这些细节都可以通过
<a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/Manpage/btrfs-inspect-internal">btrfs inspect-internal 的 dump-super 和 dump-tree</a>
查看到。btrfs 中的每棵树都可以看作是一个数据库中的表，可以包含很多表项，根据 KEY 排序，而 KEY
是 (object_id, item_type, item_extra) 这样的三元组。每个对象（object）在树中用一个或多个
表项（item）描述，同 object_id 的表项共同描述一个对象（object）。B树中的 key
只用来比较大小不必连续，从而 object_id 也不必连续，只是按大小排序。有一些预留的 object_id
不能用作别的用途，他们的编号范围是 -255ULL 到 255ULL，也就是表中前 255 和最后 255 个编号预留。</p>
<p>ROOT_TREE 中记录了到所有别的B树的指针，在一些文档中叫做 tree of tree roots 。「所有别的B树」
举例来说比如 2 号 extent_tree ，3 号 chunk_tree ， 4 号 dev_tree ，10 号 free_space_tree
，这些B树都是描述 btrfs 文件系统结构非常重要的组成部分，但是在本文关系不大，
今后有机会再讨论它们。在 ROOT_TREE 的 5 号对象有一个 fs_tree ，它描述了整个 btrfs pool
的顶级子卷，也就是图中叫 toplevel 的那个子卷（有些文档用定冠词称 the FS_TREE
的时候就是在说这个 5 号树，而不是别的子卷的 FS_TREE ）。除了顶级子卷之外，别的所有子卷的 object_id
在 256ULL 到 -256ULL 的范围之间，对子卷而言 ROOT_TREE 中的这些 object_id 也同时是它们的
子卷 id ，在内核挂载文件系统的时候可以用 subvolid 找到它们，别的一些对子卷的操作也可以直接用
subvolid 表示一个子卷。 ROOT_TREE 的 6 号对象描述的不是一棵树，而是一个名叫 default
的特殊目录，它指向 btrfs pool 的默认挂载子卷。最初 mkfs 的时候，这个目录指向 ROOT_ITEM 5
，也就是那个顶级子卷，之后可以通过命令 <code class="code">
btrfs subvolume set-default</code>

修改它指向别的子卷，这里它被改为指向 ROOT_ITEM 256 亦即那个名叫 "root" 的子卷。</p>
<p>每一个子卷都有一棵自己的 FS_TREE （有的文档中叫 file tree），一个 FS_TREE 相当于传统 Unix
文件系统中的一整个 inode table ，只不过它除了包含 inode 信息之外还包含所有文件夹内容。在
FS_TREE 中， object_id 同时也是它所描述对象的 inode 号，所以 btrfs
的 <strong>子卷有互相独立的 inode 编号</strong> ，不同子卷中的文件或目录可以拥有相同的 inode 。
或许有人不太清楚子卷间 inode 编号独立意味着什么，简单地说，这意味着你不能跨子卷创建
hard link ，不能跨子卷 mv 移动文件而不产生复制操作。不过因为 reflink 和 inode 无关，
可以跨子卷创建 reflink ，也可以用 reflink + rm 的方式快速移动文件。</p>
<p>FS_TREE 中一个目录用一个 inode_item 和多个 dir_item 描述， inode_item 是目录自己的 inode
，那些 dir_item 是目录的内容。 dir_item 可以指向别的 inode_item 来描述普通文件和子目录，
也可以指向 root_item 来描述这个目录指向一个子卷。有人或许疑惑，子卷就没有自己的 inode
么？其实如果看 <a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/Data_Structures#btrfs_root_item">数据结构定义</a>
的话 <code class="code">
struct btrfs_root_item</code>
 结构在最开头的地方包含了一个
<code class="code">
struct btrfs_inode_item</code>
 所以 root_item 也同时作为子卷的 inode
，不过用户通常看不到这个子卷的 inode ，因为子卷在被（手动或自动地）挂载到目录上之后，
用户会看到的是子卷的根目录的 inode 。</p>
<p>比如上图 FS_TREE toplevel 中，有两个对象，第一个 256 是（子卷的）根目录，第二个 257
是 "var" 目录，256 有4个子目录，其中 "root" "home" "postgres" 这三个指向了 ROOT_TREE
中的对应子卷，而 "var" 指向了 inode 257 。然后 257 有一个子目录叫 "www" 它指向了
ROOT_TREE 中 object_id 为 258 的子卷。</p>
</div>
<div class="section" id="id6">
<h3><a class="toc-backref" href="#id33">那么快照又是如何记录的呢？</a></h3>
<p>以上是子卷、目录、 inode 在 btrfs 中的记录方式，你可能想知道，如何记录一个快照呢？
特别是，如果对一个包含子卷的子卷创建了快照，会得到什么结果呢？如果我们在上面的布局基础上执行：</p>
<div class="highlight"><pre><span class="code-line"><span></span>btrfs subvolume snapshot toplevel toplevel/toplevel@s1</span>
</pre></div>
<p>那么产生的数据结构大概如下所示：</p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">

<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Flat_layout_on_disk Pages: 1 -->
<svg class="svg-responsive" height="781pt" viewbox="0.00 0.00 1162.00 781.00" width="1162pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g class="graph" id="graph0" transform="scale(1 1) rotate(0) translate(4 777)">
<title>Flat_layout_on_disk</title>
<polygon fill="#ffffff" points="-4,4 -4,-777 1158,-777 1158,4 -4,4" stroke="transparent"></polygon>
<!-- superblock -->
<g class="node" id="node1">
<title>superblock</title>
<polygon fill="none" points="0,-680.5 0,-772.5 123,-772.5 123,-680.5 0,-680.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="61.5" y="-757.3">SUPERBLOCK</text>
<polyline fill="none" points="0,-749.5 123,-749.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="61.5" y="-734.3">...</text>
<polyline fill="none" points="0,-726.5 123,-726.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="61.5" y="-711.3">root_tree</text>
<polyline fill="none" points="0,-703.5 123,-703.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="61.5" y="-688.3">...</text>
</g>
<!-- roottree -->
<g class="node" id="node2">
<title>roottree</title>
<polygon fill="none" points="195,-403.5 195,-725.5 504,-725.5 504,-403.5 195,-403.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-710.3">ROOT_TREE</text>
<polyline fill="none" points="195,-702.5 504,-702.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-687.3">2: extent_tree</text>
<polyline fill="none" points="195,-679.5 504,-679.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-664.3">3: chunk_tree</text>
<polyline fill="none" points="195,-656.5 504,-656.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-641.3">4: dev_tree</text>
<polyline fill="none" points="195,-633.5 504,-633.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-618.3">5: fs_tree</text>
<polyline fill="none" points="195,-610.5 504,-610.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-595.3">6: root_dir "default" -&gt; ROOT_ITEM 256</text>
<polyline fill="none" points="195,-587.5 504,-587.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-572.3">10: free_space_tree</text>
<polyline fill="none" points="195,-564.5 504,-564.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-549.3">256: fs_tree "root"</text>
<polyline fill="none" points="195,-541.5 504,-541.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-526.3">257: fs_tree "home"</text>
<polyline fill="none" points="195,-518.5 504,-518.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-503.3">258: fs_tree "www"</text>
<polyline fill="none" points="195,-495.5 504,-495.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-480.3">259: fs_tree "postgres"</text>
<polyline fill="none" points="195,-472.5 504,-472.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-457.3">260: fs_tree "toplevel@s1"</text>
<polyline fill="none" points="195,-449.5 504,-449.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-434.3">-7: tree_log_tree</text>
<polyline fill="none" points="195,-426.5 504,-426.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-411.3">-5: orphan_root</text>
</g>
<!-- superblock&#45;&gt;roottree -->
<g class="edge" id="edge1">
<title>superblock:sn_root-&gt;roottree:label</title>
<path d="M123,-714.5C151.375,-714.5 160.8795,-714.5 184.9792,-714.5" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="185,-718.0001 195,-714.5 185,-711.0001 185,-718.0001" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- roottree&#45;&gt;roottree -->
<g class="edge" id="edge10">
<title>roottree:e-&gt;roottree:e</title>
<path d="M504.5,-599.5C552,-608.5 648,-608.5 648,-576 648,-545.6582 564.3267,-543.6433 514.5622,-550.833" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="513.7934,-547.4125 504.5,-552.5 514.9376,-554.3184 513.7934,-547.4125" stroke="#000000"></polygon>
</g>
<!-- toplevel -->
<g class="node" id="node3">
<title>toplevel</title>
<polygon fill="none" points="576,-380 576,-633 948,-633 948,-380 576,-380" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-617.8">FS_TREE "toplevel"</text>
<polyline fill="none" points="576,-610 948,-610 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-594.8"> </text>
<polyline fill="none" points="576,-587 948,-587 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-571.8">256: inode_item DIR</text>
<polyline fill="none" points="576,-564 948,-564 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-548.8">256: dir_item: "root" -&gt; ROOT_ITEM 256</text>
<polyline fill="none" points="576,-541 948,-541 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-525.8">256: dir_item: "home" -&gt; ROOT_ITEM 257</text>
<polyline fill="none" points="576,-518 948,-518 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-502.8">256: dir_item: "var" -&gt; INODE_ITEM 257</text>
<polyline fill="none" points="576,-495 948,-495 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-479.8">256: dir_item: "postgres" -&gt; ROOT_ITEM 259</text>
<polyline fill="none" points="576,-472 948,-472 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-456.8">256: dir_item: "toplevel@s1" -&gt; ROOT_ITEM 260</text>
<polyline fill="none" points="576,-449 948,-449 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-433.8"> </text>
<polyline fill="none" points="576,-426 948,-426 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-410.8">257: inode_item DIR</text>
<polyline fill="none" points="576,-403 948,-403 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-387.8">257: dir_item: "www" -&gt; ROOT_ITEM 258</text>
</g>
<!-- roottree&#45;&gt;toplevel -->
<g class="edge" id="edge8">
<title>roottree:root_fs-&gt;toplevel:label</title>
<path d="M504,-622.5C532.3777,-622.5 541.8777,-621.7137 565.9785,-621.5356" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="566.0125,-625.0356 576,-621.5 565.9876,-618.0356 566.0125,-625.0356" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- toplevels1 -->
<g class="node" id="node4">
<title>toplevels1</title>
<polygon fill="none" points="588.5,-.5 588.5,-230.5 935.5,-230.5 935.5,-.5 588.5,-.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-215.3">FS_TREE "toplevel@s1"</text>
<polyline fill="none" points="588.5,-207.5 935.5,-207.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-192.3"> </text>
<polyline fill="none" points="588.5,-184.5 935.5,-184.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-169.3">256: inode_item DIR</text>
<polyline fill="none" points="588.5,-161.5 935.5,-161.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-146.3">256: dir_item: "root" -&gt; ROOT_ITEM 256</text>
<polyline fill="none" points="588.5,-138.5 935.5,-138.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-123.3">256: dir_item: "home" -&gt; ROOT_ITEM 257</text>
<polyline fill="none" points="588.5,-115.5 935.5,-115.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-100.3">256: dir_item: "var" -&gt; INODE_ITEM 257</text>
<polyline fill="none" points="588.5,-92.5 935.5,-92.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-77.3">256: dir_item: "postgres" -&gt; ROOT_ITEM 259</text>
<polyline fill="none" points="588.5,-69.5 935.5,-69.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-54.3"> </text>
<polyline fill="none" points="588.5,-46.5 935.5,-46.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-31.3">257: inode_item DIR</text>
<polyline fill="none" points="588.5,-23.5 935.5,-23.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-8.3">257: dir_item: "www" -&gt; ROOT_ITEM 258</text>
</g>
<!-- roottree&#45;&gt;toplevels1 -->
<g class="edge" id="edge9">
<title>roottree:root_sub_s1-&gt;toplevels1:label</title>
<path d="M504,-460.5C613.7754,-460.5 483.5108,-234.7829 577.8149,-220.2347" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="578.2778,-223.7105 588,-219.5 577.7741,-216.7287 578.2778,-223.7105" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- root -->
<g class="node" id="node5">
<title>root</title>
<polygon fill="none" points="680,-717.5 680,-763.5 844,-763.5 844,-717.5 680,-717.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-748.3">FS_TREE "root"</text>
<polyline fill="none" points="680,-740.5 844,-740.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-725.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;root -->
<g class="edge" id="edge11">
<title>roottree:root_sub_root-&gt;root:label</title>
<path d="M504,-552.5C580.3617,-552.5 521.1427,-655.3795 576,-708.5 609.5199,-740.9586 627.2238,-751.0945 669.8767,-752.3594" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="669.9523,-755.8607 680,-752.5 670.0496,-748.8614 669.9523,-755.8607" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- home -->
<g class="node" id="node6">
<title>home</title>
<polygon fill="none" points="680,-652.5 680,-698.5 844,-698.5 844,-652.5 680,-652.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-683.3">FS_TREE "home"</text>
<polyline fill="none" points="680,-675.5 844,-675.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-660.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;home -->
<g class="edge" id="edge12">
<title>roottree:root_sub_home-&gt;home:label</title>
<path d="M504,-529.5C563.5506,-529.5 530.6816,-603.867 576,-642.5 611.6322,-672.8757 627.3697,-685.6659 669.8761,-687.3144" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="669.9375,-690.816 680,-687.5 670.0659,-683.8172 669.9375,-690.816" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- www -->
<g class="node" id="node7">
<title>www</title>
<polygon fill="none" points="680,-314.5 680,-360.5 844,-360.5 844,-314.5 680,-314.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-345.3">FS_TREE "www"</text>
<polyline fill="none" points="680,-337.5 844,-337.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-322.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;www -->
<g class="edge" id="edge13">
<title>roottree:root_sub_www-&gt;www:label</title>
<path d="M504,-506.5C572.3925,-506.5 521.2069,-411.4298 576,-370.5 610.9748,-344.3743 629.9117,-348.6235 669.9457,-349.3981" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="669.965,-352.8984 680,-349.5 670.036,-345.8988 669.965,-352.8984" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- postgres -->
<g class="node" id="node8">
<title>postgres</title>
<polygon fill="none" points="679.5,-249.5 679.5,-295.5 844.5,-295.5 844.5,-249.5 679.5,-249.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-280.3">FS_TREE "postgres"</text>
<polyline fill="none" points="679.5,-272.5 844.5,-272.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="762" y="-257.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;postgres -->
<g class="edge" id="edge14">
<title>roottree:root_sub_postgres-&gt;postgres:label</title>
<path d="M504,-483.5C589.7501,-483.5 509.8697,-359.0882 576,-304.5 609.2237,-277.075 629.1685,-283.2528 668.7818,-284.3531" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="668.9507,-287.8558 679,-284.5 669.0514,-280.8565 668.9507,-287.8558" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge2">
<title>toplevel:toplevel_dir_root-&gt;roottree:root_sub_root</title>
<path d="M576,-552.5C547.625,-552.5 538.1205,-552.5 514.0208,-552.5" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="514,-549.0001 504,-552.5 514,-556.0001 514,-549.0001" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge3">
<title>toplevel:toplevel_dir_home-&gt;roottree:root_sub_home</title>
<path d="M576,-529.5C547.625,-529.5 538.1205,-529.5 514.0208,-529.5" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="514,-526.0001 504,-529.5 514,-533.0001 514,-526.0001" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge5">
<title>toplevel:toplevel_dir_postgres-&gt;roottree:root_sub_postgres</title>
<path d="M576,-483.5C547.625,-483.5 538.1205,-483.5 514.0208,-483.5" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="514,-480.0001 504,-483.5 514,-487.0001 514,-480.0001" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge6">
<title>toplevel:toplevel_dir_toplevels1-&gt;roottree:root_sub_s1</title>
<path d="M576,-460.5C547.625,-460.5 538.1205,-460.5 514.0208,-460.5" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="514,-457.0001 504,-460.5 514,-464.0001 514,-457.0001" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge7">
<title>toplevel:toplevel_dir_www-&gt;roottree:root_sub_www</title>
<path d="M576,-391.5C519.4668,-391.5 558.652,-492.5742 514.0836,-505.2085" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="513.4743,-501.7579 504,-506.5 514.3637,-508.7011 513.4743,-501.7579" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;toplevel -->
<g class="edge" id="edge4">
<title>toplevel:e-&gt;toplevel:e</title>
<path d="M948,-506.5C1016.6667,-515.5 1154,-515.5 1154,-460.5 1154,-408.0781 1029.2399,-405.6208 958.0877,-413.2984" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="957.5158,-409.8417 948,-414.5 958.3438,-416.7926 957.5158,-409.8417" stroke="#000000"></polygon>
</g>
</g>
</svg>
<p>在 ROOT_TREE 中增加了 260 号子卷，其内容复制自 toplevel 子卷，然后 FS_TREE toplevel
的 256 号 inode 也就是根目录中增加一个 dir_item 名叫 <cite>toplevel@s1</cite> 它指向 ROOT_ITEM
的 260 号子卷。这里看似是完整复制了整个 FS_TREE 的内容，这是因为 CoW b-tree
当只有一个叶子节点时就复制整个叶子节点。如果子卷内容再多一些，除了叶子之外还有中间节点，
那么只有被修改的叶子和其上的中间节点需要复制。从而创建快照的开销基本上是
O( level of FS_TREE )，而B树的高度一般都能维持在很低的程度，所以快照创建速度近乎是常数开销。</p>
<p>从子卷和快照的这种实现方式，可以看出： <strong>虽然子卷可以嵌套子卷，但是对含有嵌套子卷的子卷做快照的语义有些特别</strong>
。上图中我没有画 <cite>toplevel@s1</cite> 下的各个子卷到对应 ROOT_ITEM 之间的虚线箭头，
是因为这时候如果你尝试直接跳过 <cite>toplevel</cite> 挂载 <cite>toplevel@s1</cite> 到挂载点，
会发现那些子卷没有被自动挂载，更奇怪的是那些子卷的目录项也不是个普通目录，
尝试往它们中放东西会得到无权访问的错误，对它们能做的唯一事情是手动将别的子卷挂载在上面。
推测原因在于这些子目录并不是真的目录，没有对应的目录的 inode ，试图查看它们的 inode
号会得到 2 号，而这是个保留号不应该出现在 btrfs 的 inode 号中。
每个子卷创建时会记录包含它的上级子卷，用 <code class="code">
btrfs subvolume list</code>
 可以看到每个子卷的
top level subvolid ，猜测当挂载 A 而 A 中嵌套的 B 子卷记录的上级子卷不是 A 的时候，
会出现上述奇怪行为。嵌套子卷的快照还有一些别的奇怪行为，大家可以自己探索探索。</p>
<div class="panel panel-default">
<div class="panel-heading">
建议用平坦的子卷布局</div>
<div class="panel-body">
<p>因为上述嵌套子卷在做快照时的特殊行为，
我个人建议是 <strong>保持平坦的子卷布局</strong> ，也就是说：</p>
<ol class="arabic simple">
<li>只让顶层子卷包含其它子卷，除了顶层子卷之外的子卷只做手工挂载，不放嵌套子卷</li>
<li>只在顶层子卷对其它子卷做快照，不快照顶层子卷</li>
<li>虽然可以在顶层子卷放子卷之外的东西（文件或目录），不过因为想避免对顶层子卷做快照，
所以避免在顶层子卷放普通文件。</li>
</ol>
</div>
</div>
<p>btrfs 的子卷可以设置「可写」或者「只读」，在创建一个快照的时候也可以通过 <code class="code">
-r</code>

参数创建出一个只读快照。通常只读快照可能比可写的快照更有用，因为 <code class="code">
btrfs send</code>

命令只接受只读快照作为参考点。子卷可以有两种方式切换它是否只读的属性，可以通过
<code class="code">
btrfs property set &lt;subvol&gt; ro</code>
 直接修改是否只读，也可以对只读子卷用
<code class="code">
btrfs subvolume snapshot</code>
 创建出可写子卷，或者反过来对可写子卷创建出只读子卷。</p>
<p>只读快照也有些特殊的限制，在 <a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/SysadminGuide#Special_Cases">SysadminGuide#Special_Cases</a>
就提到一例，你不能把只读快照用 mv 移出包含它的目录，虽然你能用 mv 给它改名或者移动包含它的目录
到别的地方。 btrfs wiki 上给出这个限制的原因是子卷中记录了它的上级，
所以要移动它到别的上级需要修改这个子卷，从而只读子卷没法移动到别的上级（
不过我还没搞清楚子卷在哪儿记录了它的上级，记录的是上级目录还是上级子卷）。不过这个限制可以通过
对只读快照在目标位置创建一个新的只读快照，然后删掉原位置的只读快照来解决。</p>
</div>
</div>
<div class="section" id="zfs">
<h2><a class="toc-backref" href="#id34">ZFS 的文件系统、快照、克隆及其它</a></h2>
<p>Btrfs 给传统文件系统只增加了子卷的概念，相比之下 ZFS 中类似子卷的概念有好几个，据我所知有这些：</p>
<ul class="simple">
<li>数据集（dataset）</li>
<li>文件系统（filesystem）</li>
<li>快照（snapshot）</li>
<li>克隆（clone）</li>
<li>书签（bookmark）：从 ZFS on Linux v0.6.4 开始</li>
<li>检查点（checkpoint）：从 ZFS on Linux v0.8.0 开始</li>
</ul>
<p>梳理一下这些概念之间的关系也是最初想写下这篇笔记的初衷。先画个简图，随后逐一讲讲这些概念：</p>
<img alt="ditaa diagram" class="img-responsive ditaa" src="//farseerfc.me/uml/f0cd8a5f.png"/>
<p>上图中，假设我们有一个 pool ，其中有 3 个文件系统叫 fs1~fs3 和一个 zvol 叫 zv1
，然后文件系统 fs1 有两个快照 s1 和 s2 ，和两个书签 b1 和 b2。pool 整体有两个检查点 cp1 和
cp2 。这个简图将作为例子在后面介绍这些概念。</p>
<div class="section" id="id7">
<h3><a class="toc-backref" href="#id35">ZFS 设计中和快照相关的一些术语和概念</a></h3>
<div class="section" id="id8">
<h4><a class="toc-backref" href="#id36">数据集</a></h4>
<p>ZFS 中把文件系统、快照、克隆、zvol 等概念统称为数据集（dataset）。
一些文档和介绍中把文件系统叫做数据集，大概因为在 ZFS 中，文件系统是最先创建并且最有用的数据集。</p>
<p>在 ZFS 的术语中，把底层管理和释放存储设备空间的叫做 ZFS 存储池（pool），
简称 zpool ，其上可以容纳多个数据集，这些数据集用类似文件夹路径的语法
<code class="code">
pool_name/​dataset_path@snapshot_name</code>
 这样来称呼。
存储池中的数据集一同共享可用的存储空间，每个数据集单独跟踪自己所消耗掉的存储空间。</p>
<p>数据集之间有类似文件夹的层级父子关系，这一点有用的地方在于可以在父级数据集上设定一些 ZFS 参数，
这些参数可以被子级数据集基础，从而通过层级关系可以方便地微调 ZFS 参数。在 btrfs
中目前还没有类似的属性继承的功能。</p>
<p>zvol 的概念和本文关系不大，可以参考我上一篇 <a class="reference external" href="//farseerfc.me/zhs/zfs-layered-architecture-design.html#ZVOL">ZFS 子系统笔记中 ZVOL 的说明</a>
。用 zvol 能把 ZFS 当作一个传统的卷管理器，绕开 ZFS
的 <a class="reference external" href="//farseerfc.me/zhs/zfs-layered-architecture-design.html#ZPL">ZPL（ZFS Posix filesystem Layer）</a>
层。在 Btrfs 中可以用 loopback 块设备某种程度上模拟 zvol 的功能。</p>
</div>
<div class="section" id="id9">
<h4><a class="toc-backref" href="#id37">文件系统</a></h4>
<p>创建了 ZFS 存储池后，首先要在其中创建文件系统（filesystem），才能在文件系统中存储文件。
容易看出 ZFS 文件系统的概念直接对应 btrfs 中的子卷。文件系统（filesystem）这个术语，
从命名方式来看或许是想要和（像 Solaris 的 SVM 或者 Linux 的 LVM 这样的）传统的卷管理器
与其上创建的多个文件系统（Solaris UFS 或者 Linux ext）这样的上下层级做类比。
从 btrfs 的子卷在内部结构中叫作 FS_TREE 这一点可以看出，至少在 btrfs
早期设计中大概也是把子卷称为 filesystem 做过类似的类比的。
和传统的卷管理器与传统文件系统的上下层级不同的是， ZFS 和 btrfs 中由存储池跟踪和管理可用空间，
做统一的数据块分配和释放，没有分配的数据块算作整个存储池中所有 ZFS 文件系统或者 btrfs
子卷的可用空间。</p>
<p>与 btrfs 的子卷不同的是， ZFS 的文件系统之间是完全隔离的，（除了后文会讲的 dedup
方式之外）不可以共享任何数据或者元数据。一个文件系统还包含了隶属于其中的快照（snapshot）、
克隆（clone）和书签（bookmark）。在 btrfs 中一个子卷和对其创建的快照之间虽然有父子关系，
但是在 ROOT_TREE 的记录中属于平级的关系。</p>
<p>上面简图中 pool 里面包含 3 个文件系统，分别是 fs1~3 。</p>
</div>
<div class="section" id="id10">
<h4><a class="toc-backref" href="#id38">快照</a></h4>
<p>ZFS 的快照对应 btrfs 的只读快照，是标记数据集在某一历史时刻上的只读状态。
和 btrfs 的只读快照一样， ZFS 的快照也兼作 send/receive 时的参考点。
快照隶属于一个数据集，这说明 ZFS 的文件系统或者 zvol 都可以创建快照。</p>
<p>ZFS 中快照是排列在一个时间线上的，因为都是只读快照，它们是数据集在历史上的不同时间点。
这里说的时间不是系统时钟的时间，而是 ZFS 中事务组（TXG, transaction group）的一个序号。
整个 ZFS pool 的每次写入会被合并到一个事务组，对事务组分配一个严格递增的序列号，
提交一个事务组具有类似数据库中事务的语义：要么整个事务组都被完整提交，要么整个 pool
处于上一个事务组的状态，即使中间发生突然断电之类的意外也不会破坏事务语义。
因此 ZFS 快照就是数据集处于某一个事务组时的状态。</p>
<p>如果不满于对数据集进行的修改，想把整个数据集恢复到之前的状态，那么可以回滚（rollback
）数据集到一个快照。回滚操作会撤销掉对数据集的所有更改，并且默认参数下只能回滚到最近的一个快照。
如果想回滚到更早的快照，可以先删掉最近的几个，或者可以使用 <code class="code">
zfs rollback -r</code>

参数删除中间的快照并回滚。</p>
<p>除了回滚操作，还可以直接只读访问到快照中的文件。 ZFS 的文件系统中有个隐藏文件夹叫 ".zfs"
，所以如果只想回滚一部分文件，可以从 ".zfs/snapshots/SNAPSHOT-NAME" 中把需要的文件复制出来。</p>
<p>比如上面简图中 fs1 就有 <code class="code">
pool/​fs1@s1</code>
 和 <code class="code">
pool/​fs1@s2</code>
 这两个快照，
那么可以在 fs1 挂载点下 <code class="code">
.zfs/​snapshots/​s1</code>
 的路径直接访问到 s1 中的内容。</p>
</div>
<div class="section" id="id11">
<h4><a class="toc-backref" href="#id39">克隆</a></h4>
<p>ZFS 的克隆（clone）有点像 btrfs 的可写快照。因为 ZFS 的快照是只读的，如果想对快照做写入，那需要先用
<code class="code">
zfs clone</code>
 从快照中建出一个克隆，创建出的克隆和快照共享元数据和数据，
然后对克隆的写入不影响数据集原本的写入点。
创建了克隆之后，作为克隆参考点的快照会成为克隆的依赖，克隆存在期间无法删除掉作为其依赖的快照。</p>
<p>一个数据集可以有多个克隆，这些克隆都独立于数据集当前的写入点。使用 <code class="code">
zfs promote</code>

命令可以把一个克隆「升级」成为数据集的当前写入点，从而数据集原本的写入点会调转依赖关系，
成为这个新写入点的一个克隆，被升级的克隆原本依赖的快照和之前的快照会成为新数据集写入点的快照。</p>
<p>比如上面简图中 fs1 有 c1 的克隆，它依赖于 s2 这个快照，从而 c1 存在的时候就不能删除掉 s2 。</p>
</div>
<div class="section" id="id12">
<h4><a class="toc-backref" href="#id40">书签</a></h4>
<p>这是 ZFS 一个比较新的特性，ZFS on Linux 分支从 v0.6.4 开始支持创建书签的功能。</p>
<p>书签（bookmark）特性存在的理由是基于这样的事实：原本 ZFS 在 send 两个快照间的差异的时候，比如 send S1 和
S2 之间的差异，在发送端实际上只需要 S1 中记录的时间戳（TXG id），而不需要 S1 快照的数据，
就可以计算出 S1 到 S2 的差异。在接收端则需要 S1 的完整数据，在其上根据接收到的数据流创建 S2 。
因此在发送端，可以把快照 S1 转变成书签，只留下时间戳元数据而不保留任何目录结构或者文件内容。
书签只能作为增量 send 时的参考点，并且在接收端需要有对应的快照，这种方式可以在发送端节省很多存储。</p>
<p>通常的使用场景是，比如你有一个笔记本电脑，上面有 ZFS 存储的数据，然后使用一个服务器上 ZFS
作为接收端，定期对笔记本上的 ZFS 做快照然后 send 给服务器。在没有书签功能的时候，
笔记本上至少得保留一个和服务器上相同的快照，作为 send 的增量参考点，
而这个快照的内容已经在服务器上，所以笔记本中存有相同的快照只是在浪费存储空间。
有了书签功能之后，每次将定期的新快照发送到服务器之后，就可以把这个快照转化成书签，节省存储开销。</p>
</div>
<div class="section" id="id13">
<h4><a class="toc-backref" href="#id41">检查点</a></h4>
<p>这也是 ZFS 的新特性， ZFS on Linux 分支从 v0.8.0 开始支持创建检查点。</p>
<p>简而言之，检查点（checkpoint）可以看作是整个存储池级别的快照，使用检查点能快速将整个存储池都恢复到上一个状态。
这边有篇文章介绍 <a class="reference external" href="https://sdimitro.github.io/post/zpool-checkpoint/">ZFS checkpoint 功能的背景、用法和限制</a>
，可以看出当存储池中有检查点的时候很多存储池的功能会受影响（比如不能删除 vdev 、不能处于
degraded 状态、不能 scrub 到当前存储池中已经释放而在检查点还在引用的数据块），
于是检查点功能设计上更多是给系统管理员准备的用于调整整个 ZFS pool 时的后悔药，
调整结束后日用状态下应该删除掉所有检查点。</p>
</div>
</div>
<div class="section" id="zfs-btrfs">
<h3><a class="toc-backref" href="#id42">ZFS 的概念与 btrfs 概念的对比</a></h3>
<p>先说书签和检查点，因为这是两个 btrfs 目前完全没有的功能。</p>
<p>书签功能完全围绕 ZFS send 的工作原理，而 ZFS send 位于
<a class="reference external" href="//farseerfc.me/zhs/zfs-layered-architecture-design.html#DSL">ZFS 设计中的 DSL</a>
层面，甚至不关心它 send 的快照的数据是来自文件系统还是 zvol
。在发送端它只是从目标快照递归取数据块，判断 TXG
是否老于参照点的快照，然后把新的数据块全部发往 send stream ；在接收端也只是完整地接收数据块，
不加以处理，。与之不同的是 btrfs 的 send 的工作原理是工作在文件系统的只读子卷层面，
发送端在内核代码中根据目标快照的 b 树和参照点快照的 generation 生成一个 diff
（可以通过 <code class="code">
btrfs subvolume find-new</code>
 直接拿到这个 diff ），然后在用户态代码中根据
diff 和参照点、目标快照的两个只读子卷的数据产生一连串修改文件系统的指令，
指令包括创建文件、删除文件、让文件引用数据块（保持 reflink ）等操作；在接收端则完全工作在用户态下，
根据接收到的指令重建目标快照。可见 btrfs send 需要在发送端读取参照点快照的数据（比如找到
reflink 引用），从而 btrfs 没法（或者很难）实现书签功能。</p>
<p>检查点也是 btrfs 目前没有的功能。 btrfs 目前不能对顶层子卷做递归的 snapshot ，btrfs
的子卷也没有类似 ZFS 数据集的层级关系和可继承属性，从而没法实现类似检查点的功能。</p>
<p>除了书签和检查点之外，剩下的概念可以在 ZFS 和 btrfs 之间有如下映射关系：</p>
<table border="0" class="table docutils field-list" frame="void" rules="none">
<col class="field-name"/>
<col class="field-body"/>
<tbody valign="top">
<tr class="field"><th class="field-name">ZFS 文件系统:</th><td class="field-body">btrfs 子卷</td>
</tr>
<tr class="field"><th class="field-name">ZFS 快照:</th><td class="field-body">btrfs 只读快照</td>
</tr>
<tr class="field"><th class="field-name">ZFS 克隆:</th><td class="field-body">btrfs 可写快照</td>
</tr>
</tbody>
</table>
<p>对 ZFS 数据集的操作，大部分也可以找到对应的对 btrfs 子卷的操作。</p>
<table border="0" class="table docutils field-list" frame="void" rules="none">
<col class="field-name"/>
<col class="field-body"/>
<tbody valign="top">
<tr class="field"><th class="field-name">zfs list:</th><td class="field-body"><code class="code">
btrfs subvolume list</code>
</td>
</tr>
<tr class="field"><th class="field-name">zfs create:</th><td class="field-body"><code class="code">
btrfs subvolume create</code>
</td>
</tr>
<tr class="field"><th class="field-name">zfs destroy:</th><td class="field-body"><code class="code">
btrfs subvolume delete</code>
</td>
</tr>
<tr class="field"><th class="field-name">zfs rename:</th><td class="field-body"><code class="code">
mv</code>
</td>
</tr>
<tr class="field"><th class="field-name">zfs snapshot:</th><td class="field-body"><code class="code">
btrfs subvolume snapshot -r</code>
</td>
</tr>
<tr class="field"><th class="field-name">zfs rollback:</th><td class="field-body">这个在 btrfs 需要对只读快照创建出可写的快照（用 snapshot 命令，或者直接修改读写属性），然后改名或者调整挂载点</td>
</tr>
<tr class="field"><th class="field-name">zfs diff:</th><td class="field-body"><code class="code">
btrfs subvolume find-new</code>
</td>
</tr>
<tr class="field"><th class="field-name">zfs clone:</th><td class="field-body"><code class="code">
btrfs subvolume snapshot</code>
</td>
</tr>
<tr class="field"><th class="field-name">zfs promote:</th><td class="field-body">和 rollback 类似，可以直接调整 btrfs 子卷的挂载点</td>
</tr>
</tbody>
</table>
<p>可见虽然功能上类似，但是至少从管理员管理的角度而言， zfs 对文件系统、快照、克隆的划分更为清晰，
对他们能做的操作也更为明确。这也是很多从 ZFS 迁移到 btrfs ，或者反过来从 btrfs 换用 zfs
时，一些人困惑的起源（甚至有人据此说 ZFS 比 btrfs 好在 cli 设计上）。</p>
<p>不过 btrfs 子卷的设计也使它在系统管理上有了更大的灵活性。比如在 btrfs
中删除一个子卷不会受制于别的子卷是否存在，而在 zfs 中要删除一个快照必须先保证先摧毁掉依赖它的克隆。
再比如 btrfs 的可写子卷没有主次之分，而 zfs 中一个文件系统和其克隆之间有明显的区别，所以需要
promote 命令调整差异。还有比如 ZFS 的文件系统只能回滚到最近一次的快照，
要回滚到更久之前的快照需要删掉中间的快照，并且回滚之后原本的文件系统数据和快照数据就被丢弃了；
而 btrfs 中因为回滚操作相当于调整子卷的挂载，所以不需要删掉快照，
并且回滚之后原本的子卷和快照还可以继续保留。</p>
<p>加上 btrfs 有 reflink ，这给了 btrfs 在使用中更大的灵活性，可以有一些 zfs 很难做到的用法。
比如想从快照中打捞出一些虚拟机镜像的历史副本，而不想回滚整个快照的时候，在
btrfs 中可以直接 <code class="code">
cp --reflink=always</code>
 将镜像从快照中复制出来，此时的复制将和快照共享数据块；
而在 zfs 中只能用普通 cp 复制，会浪费很多存储空间。</p>
</div>
<div class="section" id="id14">
<h3><a class="toc-backref" href="#id43">ZFS 中是如何存储这些数据集的呢</a></h3>
<p>要讲到存储细节，首先需要 了解一下 <a class="reference external" href="//farseerfc.me/zhs/zfs-layered-architecture-design.html">ZFS 的分层设计</a>
。不像 btrfs 基于现代 Linux 内核，有许多现有文件系统已经实现好的基础设施可以利用，
并且大体上只用到一种核心数据结构（CoW的B树）； ZFS 则脱胎于 Solaris 的野心勃勃，
设计时就分成很多不同的子系统，逐步提升抽象层次，
并且每个子系统都发明了许多特定需求下的数据结构来描述存储的信息。 在这里和本文内容密切相关的是
<a class="reference external" href="//farseerfc.me/zhs/zfs-layered-architecture-design.html#zpl">ZPL</a> 、 <a class="reference external" href="//farseerfc.me/zhs/zfs-layered-architecture-design.html#DSL">DSL</a> 、 <a class="reference external" href="//farseerfc.me/zhs/zfs-layered-architecture-design.html#dmu">DMU</a> 这些 ZFS 子系统。</p>
<p>Sun 曾经写过一篇 ZFS 的 <a class="reference external" href="http://www.giis.co.in/Zfs_ondiskformat.pdf">On disk format</a>
对理解 ZFS 如何存储在磁盘上很有帮助，虽然这篇文档是针对 Sun 还在的时候 Solaris 的 ZFS
，现在 ZFS 的内部已经变化挺大，不过对于理解本文想讲的快照的实现方式还具有参考意义。这里借助这篇
ZFS On Disk Format 中的一些图示来解释 ZFS 在磁盘上的存储方式。</p>
<div class="section" id="id17">
<h4><a class="toc-backref" href="#id44">ZFS 的块指针</a></h4>
<div class="panel panel-default">
<div class="panel-heading">
<a class="reference external" href="//farseerfc.me/zhs/images/zfs-block-pointer.svg">ZFS 中用的 128 字节块指针</a></div>
<div class="panel-body">
<object class="embed-responsive-item" data="//farseerfc.me/zhs/images/zfs-block-pointer.svg" type="image/svg+xml">
zfs-block-pointer.svg</object>
</div>
</div>
<p>要理解 ZFS 的磁盘结构首先想介绍一下 ZFS 中的块指针（block pointer, <code class="code">
blkptr_t</code>

），结构如右图所示。 ZFS 的块指针用在 ZFS 的许多数据结构之中，当需要从一个地方指向任意另一个地址的时候都会
插入这样的一个块指针结构。大多数文件系统中也有类似的指针结构，比如 btrfs
中有个8字节大小的逻辑地址（logical address），一般也就是个 4字节 到 16字节
大小的整数写着扇区号、块号或者字节偏移，在 ZFS 中的块指针则是一个巨大的128字节（不是
128bit !）的结构体。</p>
<p>128字节块指针的开头是3个数据虚拟地址（DVA, Data Virtual Address），每个 DVA 是 128bit
，其中记录这块数据在什么设备（vdev）的什么偏移（offset）上占用多大（asize)，有 3个
DVA 槽是用来存储最多3个不同位置的副本。然后块指针还记录了这个块用什么校验算法（ cksum
）和什么压缩算法（comp），压缩前后的大小（PSIZE/LSIZE），以及256bit的校验和（checksum）。</p>
<p>当需要间接块（indirect block）时，块指针中记录了间接块的层数（lvl），和下层块指针的数量（fill）。
一个间接块就是一个数据块中包含一个块指针的数组，当引用的对象很大需要很多块时，间接块构成一棵树状结构。</p>
<p>块指针中还有和本文关系很大的一个值 birth txg ，记录这个块指针诞生时的整个 pool 的 TXG id
。一次 TXG 提交中写入的数据块都会有相同的 birth txg ，这个相当于 btrfs 中 generation 的概念。
实际上现在的 ZFS 块指针似乎记录了两个 birth txg ，分别在图中的9行和a行的位置，
<a class="reference external" href="https://utcc.utoronto.ca/~cks/space/blog/solaris/ZFSBlockPointers">一个 physical 一个 logical ，用于 dedup 和 device removal</a>
。值得注意的是块指针里只有 birth txg ，没有引用计数或者别的机制做引用，这对后面要讲的东西很关键。</p>
</div>
<div class="section" id="id18">
<h4><a class="toc-backref" href="#id45">ZPL 的元对象集</a></h4>
<p>理解块指针和 ZFS 的子系统层级之后，就可以来看看 ZFS 存储在磁盘上的具体结构了。
因为涉及的数据结构种类比较多，所以先来画一张逻辑上的简图，其中箭头只是某种引用关系不代表块指针，
方框也不是结构体细节：</p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">

<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: zfs_layout_simple Pages: 1 -->
<svg class="svg-responsive" height="262pt" viewbox="0.00 0.00 1128.00 262.00" width="1128pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g class="graph" id="graph0" transform="scale(1 1) rotate(0) translate(4 258)">
<title>zfs_layout_simple</title>
<polygon fill="#ffffff" points="-4,4 -4,-258 1124,-258 1124,4 -4,4" stroke="transparent"></polygon>
<!-- uberblock -->
<g class="node" id="node1">
<title>uberblock</title>
<polygon fill="none" points="0,-184.5 0,-253.5 114,-253.5 114,-184.5 0,-184.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="57" y="-238.3">UBERBLOCK</text>
<polyline fill="none" points="0,-230.5 114,-230.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="57" y="-215.3">...</text>
<polyline fill="none" points="0,-207.5 114,-207.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="57" y="-192.3">mos_blkptr</text>
</g>
<!-- mos -->
<g class="node" id="node2">
<title>mos</title>
<polygon fill="none" points="186,-115 186,-207 320,-207 320,-115 186,-115" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="253" y="-191.8">Meta Object Set</text>
<polyline fill="none" points="186,-184 320,-184 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="253" y="-168.8">root dataset</text>
<polyline fill="none" points="186,-161 320,-161 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="253" y="-145.8">config</text>
<polyline fill="none" points="186,-138 320,-138 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="253" y="-122.8">...</text>
</g>
<!-- uberblock&#45;&gt;mos -->
<g class="edge" id="edge1">
<title>uberblock:ub_rootbp-&gt;mos:mos_label</title>
<path d="M114,-196C142.375,-196 151.8795,-196 175.9792,-196" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="176,-199.5001 186,-196 176,-192.5001 176,-199.5001" stroke="#000000"></polygon>
</g>
<!-- root_dataset -->
<g class="node" id="node3">
<title>root_dataset</title>
<polygon fill="none" points="392,-92 392,-184 541,-184 541,-92 392,-92" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="466.5" y="-168.8">ROOT dataset</text>
<polyline fill="none" points="392,-161 541,-161 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="466.5" y="-145.8">dataset1 directory</text>
<polyline fill="none" points="392,-138 541,-138 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="466.5" y="-122.8">dataset2 directory</text>
<polyline fill="none" points="392,-115 541,-115 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="466.5" y="-99.8">...</text>
</g>
<!-- mos&#45;&gt;root_dataset -->
<g class="edge" id="edge2">
<title>mos:mos_root_dataset-&gt;root_dataset:rd_label</title>
<path d="M320,-173C348.375,-173 357.8795,-173 381.9792,-173" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="382,-176.5001 392,-173 382,-169.5001 382,-176.5001" stroke="#000000"></polygon>
</g>
<!-- ds1_directory -->
<g class="node" id="node4">
<title>ds1_directory</title>
<polygon fill="none" points="613,-.5 613,-161.5 805,-161.5 805,-.5 613,-.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="709" y="-146.3">DSL Directory</text>
<polyline fill="none" points="613,-138.5 805,-138.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="709" y="-123.3">ds1 property ZAP object</text>
<polyline fill="none" points="613,-115.5 805,-115.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="709" y="-100.3">ds1 child ZAP object</text>
<polyline fill="none" points="613,-92.5 805,-92.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="709" y="-77.3">ds1 dataset (active)</text>
<polyline fill="none" points="613,-69.5 805,-69.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="709" y="-54.3">ds1 snapshot1</text>
<polyline fill="none" points="613,-46.5 805,-46.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="709" y="-31.3">ds1 snapshot2</text>
<polyline fill="none" points="613,-23.5 805,-23.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="709" y="-8.3">...</text>
</g>
<!-- root_dataset&#45;&gt;ds1_directory -->
<g class="edge" id="edge3">
<title>root_dataset:rd_ds1-&gt;ds1_directory:ds1_label</title>
<path d="M541,-150C569.375,-150 578.8795,-150 602.9792,-150" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="603,-153.5001 613,-150 603,-146.5001 603,-153.5001" stroke="#000000"></polygon>
</g>
<!-- ds1_dataset -->
<g class="node" id="node5">
<title>ds1_dataset</title>
<polygon fill="none" points="916,-67 916,-113 1081,-113 1081,-67 916,-67" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="998.5" y="-97.8">ds1 DMU Object Set</text>
<polyline fill="none" points="916,-90 1081,-90 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="998.5" y="-74.8">...</text>
</g>
<!-- ds1_directory&#45;&gt;ds1_dataset -->
<g class="edge" id="edge4">
<title>ds1_directory:ds1_dataset-&gt;ds1_dataset:ds1_ds_label</title>
<path d="M805,-81C851.3776,-81 863.7833,-99.0745 905.2509,-101.6868" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="905.3977,-105.1929 915.5,-102 905.6116,-98.1961 905.3977,-105.1929" stroke="#000000"></polygon>
</g>
<!-- ds1_snapshot1 -->
<g class="node" id="node6">
<title>ds1_snapshot1</title>
<polygon fill="none" points="877,-2 877,-48 1120,-48 1120,-2 877,-2" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="998.5" y="-32.8">ds1 snapshot1 DMU Object Set</text>
<polyline fill="none" points="877,-25 1120,-25 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="998.5" y="-9.8">...</text>
</g>
<!-- ds1_directory&#45;&gt;ds1_snapshot1 -->
<g class="edge" id="edge5">
<title>ds1_directory:ds1_s1-&gt;ds1_snapshot1:ds1_s1_label</title>
<path d="M805,-58C834.6875,-58 842.165,-41.3425 866.9941,-37.6987" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="867.2681,-41.1882 877,-37 866.7804,-34.2052 867.2681,-41.1882" stroke="#000000"></polygon>
</g>
</g>
</svg>
<p>如上简图所示，首先 ZFS pool 级别有个 uberblock ，具体每个 vdev 如何存储和找到这个 uberblock
今后有空再聊，这里认为整个 zpool 有唯一的一个 uberblock 。从 uberblock 有个指针指向元对象集（MOS, Meta Object Set）
，它是个 DMU 的对象集，它包含整个 pool 的一些配置信息，和根数据集（root dataset）。
根数据集再包含整个 pool 中保存的所有顶层数据集，每个数据集有一个 DSL Directory 结构。
然后从每个数据集的 DSL Directory 可以找到一系列子数据集和一系列快照等结构。最后每个数据集有个 active
的 DMU 对象集，这是整个文件系统的当前写入点，每个快照也指向一个各自的 DMU 对象集。</p>
<p>DSL 层的每个数据集的逻辑结构也可以用下面的图表达（来自 ZFS On Disk Format ）：</p>
<div class="figure">
<object class="embed-responsive-item" data="//farseerfc.me/zhs/images/zfs-dsl-infrastructure.svg" type="image/svg+xml">
zfs-dsl-infrastructure.svg</object>
<p class="caption">ZFS On Disk Format 中 4.1 节的 DSL infrastructure</p>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<a class="reference external" href="//farseerfc.me/zhs/images/zfs-metaobjectset.svg">ZFS On Disk Format 中 4.2 节的 Meta Object Set</a></div>
<div class="panel-body">
<object class="embed-responsive-item" data="//farseerfc.me/zhs/images/zfs-metaobjectset.svg" type="image/svg+xml">
zfs-metaobjectset.svg</object>
</div>
</div>
<p>需要记得 ZFS 中没有类似 btrfs 的 CoW b-tree 这样的统一数据结构，所以上面的这些设施是用各种不同的数据结构表达的。
尤其每个 Directory 的结构可以包含一个 ZAP 的键值对存储，和一个 DMU 对象。
可以理解为， DSL 用 DMU 对象集（Objectset）表示一个整数（uinit64_t 的 dnode）到 DMU 对象的映射，
然后用 ZAP 对象表示一个名字到整数的映射，然后又有很多额外的存储于 DMU 对象中的 DSL 结构体。
如果我们画出不同的指针和不同的结构体，那么会得到一个稍显复杂的图，见右边「ZFS
On Disk Format 中 4.2 节的 Meta Object Set」，图中还只画到了 root_dataset 为止。</p>
<p>看到这里，大概可以理解在 ZFS 中创建一个 ZFS 快照的操作其实很简单：找到数据集的 DSL Directory
中当前 active 的 DMU 对象集指针，创建一个表示 snapshot 的 DSL dataset 结构，指向那个
DMU 对象集，然后快照就建好了。因为今后对 active 的写入会写时复制对应的 DMU 对象集，所以
snapshot 指向的 DMU 对象集不会变化。</p>
</div>
</div>
</div>
<div class="section" id="id19">
<h2><a class="toc-backref" href="#id46">创建快照这么简单么？那么删除快照呢？</a></h2>
<p>按上面的存储格式细节来看， btrfs 和 zfs 中创建快照似乎都挺简单的，利用写时拷贝，创建快照本身没什么复杂操作。</p>
<p>如果你也听到过别人介绍 CoW 文件系统时这么讲，是不是会觉得似乎哪儿少了点什么。创建快照是挺简单的，
<strong>直到你开始考虑如何删除快照</strong> ……</p>
<p>或者不局限在删除单个快照上， CoW 文件系统因为写时拷贝，每修改一个文件内容或者修改一个文件系统结构，
都是分配新数据块，然后考虑是否要删除这个数据替换的老数据块，此时如何决定老数据块能不能删呢？
删除快照的时候也是同样，快照是和别的文件系统有共享一部分数据和元数据的，
所以显然不能把快照引用到的数据块都直接删掉，要考察快照引用的数据块是否还在别的地方被引用着，
只能删除那些没有被引用的数据。</p>
<p>深究「如何删快照」这个问题，就能看出 WAFL 、 btrfs 、 ZFS 甚至别的 log-structured
文件系统间的关键区别，从而也能看到另一个问题的答案：
<strong>为什么 btrfs 只需要子卷的抽象，而 zfs 搞出了这么多抽象概念？</strong>
带着这两个疑问，我们来研究一下这些文件系统的块删除算法。</p>
<div class="section" id="id20">
<h3><a class="toc-backref" href="#id47">日志结构文件系统中用的垃圾回收算法</a></h3>
<p>讲 btrfs 和 zfs 用到的删除算法之前，先讲一下日志结构（log-structured）文件系统中的垃圾回收（
GC, Garbage Collection）算法。对熟悉编程的人来说，讲到空间释放算法，大概首先会想到 GC
，因为这里要解决的问题乍看起来很像编程语言的内存管理中 GC
想要解决的问题：有很多指针相互指向很多数据结构，找其中没有被引用的垃圾然后释放掉。</p>
<p>首先要澄清一下 <a class="reference external" href="https://en.wikipedia.org/wiki/Log-structured_file_system">日志结构文件系统（log-structured file system）</a>
的定义，因为有很多文件系统用日志，而用了日志的不一定是日志结构文件系统。
在维基百科上有个页面介绍 <a class="reference external" href="https://en.wikipedia.org/wiki/Log-structured_file_system">日志结构文件系统</a>
，还有个 <a class="reference external" href="https://en.wikipedia.org/wiki/List_of_log-structured_file_systems">列表列出了一些日志结构文件系统</a>
。通常说，整个文件系统的存储结构都组织成一个大日志的样子，就说这个文件系统是日志结构的，
这包括很多早期学术研究的文件系统，以及目前 <a class="reference external" href="https://en.wikipedia.org/wiki/Log-structured_File_System_(BSD)">NetBSD 的 LFS</a>
、Linux 的 <a class="reference external" href="https://en.wikipedia.org/wiki/NILFS">NILFS</a>
，用在光盘介质上的 <a class="reference external" href="https://en.wikipedia.org/wiki/Universal_Disk_Format">UDF</a>
，还有一些专门为闪存优化的 <a class="reference external" href="https://en.wikipedia.org/wiki/JFFS">JFFS</a> 、
<a class="reference external" href="https://en.wikipedia.org/wiki/YAFFS">YAFFS</a> 以及
<a class="reference external" href="https://en.wikipedia.org/wiki/F2FS">F2FS</a>
。日志结构文件系统不包括那些用额外日志保证文件系统一致性，但文件系统结构不在日志中的 ext4 、 xfs
、 ntfs 、 hfs+ 。</p>
<p>简单来说，日志结构文件系统就是把存储设备当作一个大日志，每次写入数据时都添加在日志末尾，
然后用写时复制重新写入元数据，最后提交整个文件系统结构。因为这里用了写时复制，原本的数据块都还留着，
所以可以很容易实现快照之类的功能。从这个特征上来说，写时拷贝文件系统（CoW
FS）像 btrfs/zfs 这些在一些人眼中也符合日志结构文件系统的特征，
所以也有人说写时拷贝文件系统算是日志结构文件系统的一个子类。不过日志结构文件系统的另一大特征是利用
GC 回收空间，这里是本文要讲的区别，所以在我看来不用 GC 的 btrfs 和 zfs 不算是日志结构文件系统。</p>
<p>举个例子，比如下图是一个日志结构文件系统的磁盘占用，其中绿色是数据，蓝色是元数据（比如目录结构和
inode），红色是文件系统级关键数据（比如最后的日志提交点），一开始可能是这样，有9个数据块，
2个元数据块，1个系统块：</p>
<img alt="ditaa diagram" class="img-responsive ditaa" src="//farseerfc.me/uml/c8f452c3.png"/>
<p>现在要覆盖 2 和 3 的内容，新写入 n2 和 n3 ，再删除 4 号的内容 ，然后修改 10 里面的 inode 变成 n10
引用这些新数据，然后写入一个新提交 n12 ，用黄色表示不再被引用的垃圾，提交完大概是这样：</p>
<img alt="ditaa diagram" class="img-responsive ditaa" src="//farseerfc.me/uml/a0eb592f.png"/>
<p>日志结构文件系统需要 GC 比较容易理解，写日志嘛，总得有一个「添加到末尾」的写入点，比如上面图中的
n12 就是当前的写入点。空盘上连续往后写而不 GC 总会遇到空间末尾，这时候就要覆盖写空间开头，
就很难判断「末尾」在什么地方，而下一次写入需要在哪里了。
这时文件系统也不知道需要回收哪些块（图中的 o2 o3 o4 o10 和 o12），因为这些块可能被别的地方还继续
引用着，需要等到 GC 时扫描元数据来判断。</p>
<p>和内存管理时的 GC 不同的一点在于，文件系统的 GC 肯定不能停下整个世界跑 GC
，也不能把整个地址空间对半分然后 Mark-and-Sweep
，这些在内存中还尚可的简单策略直接放到文件系统中绝对是性能灾难。所以文件系统的 GC
需要并行的后台 GC ，并且需要更细粒度的分块机制能在 Mark-and-Sweep
的时候保持别的地方可以继续写入数据而维持文件系统的正常职能。</p>
<p>通常文件系统的 GC 是这样，先把整个盘分成几个段（segment）或者区域(zone)，术语不同不过表达的概念类似，
然后 GC 时挑一个老段，扫描文件系统元数据找出要释放的段中还被引用的数据块，搬运到日志末尾，最后整个释放一段。
搬运数据块时，也要调整文件系统别的地方对被搬运的数据块的引用。</p>
<p>物理磁盘上一般有扇区的概念，通常是 512B 或者 4KiB 的大小，在文件系统中一般把连续几个物理块作为一个数据块，
大概是 4KiB 到 1MiB 的数量级，然后日志结构文件系统中一个段(segment)通常是连续的很多块，数量级来看大约是
4MiB 到 64MiB 这样的数量级。相比之下 ufs/ext4/btrfs/zfs 的分配器通常还有 block group 的概念，
大概是 128MiB 到 1GiB 的大小。可见日志结构文件系统的段，是位于数据块和其它文件系统 block group
中间的一个单位。段大小太小的话，会显著增加空间管理需要的额外时间空间开销，而段大小太大的话，
又不利于利用整个可用空间，这里的抉择有个平衡点。</p>
<p>继续上面的例子，假设上面文件系统的图示中每一列的4块是一个段，想要回收最开头那个段，
那么需要搬运还在用的 1 到空闲空间，顺带修改引用它的 n10 ，最后提交 n12 ：</p>
<img alt="ditaa diagram" class="img-responsive ditaa" src="//farseerfc.me/uml/ba5b5955.png"/>
<p>要扫描并释放一整段，需要扫描整个文件系统中别的元数据（图中的 n12 和 n10 和
11）来确定有没有引用到目标段中的地址，可见释放一个段是一个 <span class="math">\(O(N)\)</span> 的操作，其中 N
是元数据段的数量，按文件系统的大小增长，
于是删除快照之类可能要连续释放很多段的操作在日志文件系统中是个 <span class="math">\(O(N^2)\)</span> 甚至更昂贵的操作。
在文件系统相对比较小而系统内存相对比较大的时候，比如手机上或者PC读写SD卡，大部分元数据块（
其中包含块指针）都能放入内存缓存起来的话，这个扫描操作的开销还是可以接受的。
但是对大型存储系统显然扫描并释放空间就不合适了。</p>
<p>段的抽象用在闪存类存储设备上的一点优势在于，闪存通常也有擦除块的概念，比写入块的大小要大，
是连续的多个写入块构成，从而日志结构的文件系统中一个段可以直接对应到闪存的一个擦除块上。
所以闪存设备诸如U盘或者 SSD 通常在底层固件中用日志结构文件系统模拟一个块设备，来做写入平衡。
大家所说的 SSD 上固件做的 GC ，大概也就是这样一种操作。</p>
<p>基于段的 GC 还有一个显著缺陷，需要扫描元数据，复制搬运仍然被引用到的块，这不光会增加设备写入，
还需要调整现有数据结构中的指针，调整指针需要更多写入，同时又释放更多数据块，
F2FS 等一些文件系统设计中把这个问题叫 Wandering Tree Problem ，在 F2FS
设计中是通过近乎「作弊」的 <a class="reference external" href="WanderingTreeProblem">NAT 转换表</a>
放在存储设备期待的 FAT 所在位置，不仅能让需要扫描的元数据更集中，还能减少这种指针调整导致的写入。</p>
<p>不过基于段的 GC 也有一些好处，它不需要复杂的文件系统设计，不需要特殊构造的指针，
就能很方便地支持大量快照。一些日志结构文件系统比如 NILFS 用这一点支持了「连续快照（continuous
snapshots）」，每次文件系统提交都是自动创建一个快照，用户可以手动标记需要保留哪些快照，
GC 算法则排除掉用户手动标记的快照之后，根据快照创建的时间，先从最老的未标记快照开始回收。
即便如此， GC 的开销（CPU时间和磁盘读写带宽）仍然是 NILFS
最为被人诟病的地方，是它难以被广泛采用的原因。 为了加快 NILFS 这类日志文件系统的 GC
性能让他们能更适合于普通使用场景，也有许多学术研究致力于探索和优化 GC
，使用更先进的数据结构和算法跟踪数据块来调整 GC 策略，比如这里有一篇
<a class="reference external" href="https://www.complang.tuwien.ac.at/Diplomarbeiten/rohner18.pdf">State-of-the-art Garbage Collection Policies for NILFS2</a>
。</p>
</div>
<div class="section" id="wafl">
<h3><a class="toc-backref" href="#id48">WAFL 早期使用的可用空间位图数组</a></h3>
<p>从日志结构文件系统使用 GC 的困境中可以看出，文件系统级别实际更合适的，
可能不是在运行期依赖扫描元数据来计算空间利用率的 GC
，而是在创建快照时或者写入数据时就预先记录下快照的空间利用情况，
从而可以细粒度地跟踪空间和回收空间，这也是 WAFL 早期实现快照的设计思路。</p>
<p>WAFL 早期记录快照占用数据块的思路从表面上来看也很「暴力」，传统文件系统一般有个叫做「位图（bitmap
）」的数据结构，用一个二进制位记录一个数据块是否占用，靠扫描位图来寻找可用空间和已用空间。 WAFL
的设计早期中考虑既然需要支持快照，那就把记录数据块占用情况的位图，变成快照的数组。
于是整个文件系统有个 256 大小的快照利用率数组，数组中每个快照记录自己占用的数据块位图，
文件系统中最多能容纳 255 个快照。</p>
<img alt="ditaa diagram" class="img-responsive ditaa" src="//farseerfc.me/uml/08c1b975.png"/>
<p>上面每个单元格都是一个二进制位，表示某个快照有没有引用某个数据块。有这样一个位图的数组之后，
就可以直接扫描位图判断出某个数据块是否已经占用，可以找出尚未被占用的数据块用作空间分配，
也可以方便地计算每个快照引用的空间大小或者独占的空间大小，估算删除快照后可以释放的空间。</p>
<p>需要注意的是，文件系统中可以有非常多的块，从而位图数组比位图需要更多的元数据来表达。
比如估算一下传统文件系统中一块可以是 4KiB 大小，那么跟踪空间利用的位图需要 1bit/4KiB
， 1TiB 的盘就需要 32MiB 的元数据来存放位图；
而 WAFL 这种位图数组即便限制了快照数量只能有255个，仍需要 256bit/4KiB 的空间开销，
1TiB 的盘需要的元数据开销陡增到 8GiB ，这些还只是单纯记录空间利用率的位图数组，不包括别的元数据。</p>
<p>使用这么多元数据表示快照之后，创建快照的开销也相应地增加了，需要复制整个位图来创建一个新的快照，
按上面的估算 1TiB 的盘可能需要复制 256MiB 的位图，这不再是一瞬能完成的事情，
期间可能需要停下所有对文件系统的写入等待复制完成。
位图数组在存储设备上的记录方式也很有讲究，当删除快照时希望能快速读写上图中的一整行位图，
于是可能希望每一行位图的存储方式在磁盘上都尽量连续，
而在普通的写入操作需要分配新块时，想要按列的方式扫描位图数组，找到没有被快照占用的块，
从而上图中按列的存储表达也希望在磁盘上尽量连续。
WAFL 的设计工程师们在位图数组的思路下，实现了高效的数据结构让上述两种维度的操作都能快速完成，
但是这绝不是一件容易的事情。</p>
<p>位图数组的表达方式也有其好处，比如除了快照之外，也可以非常容易地表达类似 ZFS
的克隆和独立的文件系统这样的概念，这些东西和快照一样，占用仅有的 256 个快照数量限制。
这样表达的克隆可以有数据块和别的文件系统共享，文件系统之间也可以有类似
reflink 的机制共享数据块，在位图数组的相应位置将位置1即可。</p>
<p>使用位图数组的做法，也只是 WAFL 早期可能采用的方式，由于 WAFL 本身是闭源产品，
难以获知它具体的工作原理。哈佛大学和 NetApp 的职员曾经在 FAST10
(USENIX Conference on File and Storage Technologies) 上发表过一篇讲解高效跟踪和使用
back reference 的论文，叫
<a class="reference external" href="https://www.usenix.org/legacy/event/fast10/tech/full_papers/macko.pdf">Tracking Back References in a Write-Anywhere File System</a>
，可以推测在新一代 WAFL 的设计中可能使用了类似 btrfs backref 的实现方式，接下来会详细介绍。</p>
</div>
<div class="section" id="id23">
<h3><a class="toc-backref" href="#id49">ZFS 中关于快照和克隆的空间跟踪算法</a></h3>
<div class="panel panel-default">
<div class="panel-heading">
How ZFS snapshots really work And why they perform well (usually)</div>
<div class="panel-body">
<div align="left" class="youtube embed-responsive embed-responsive-16by9"><iframe allow="fullscreen" class="embed-responsive-item" frameborder="0" src="https://www.youtube.com/embed/NXg86uBDSqI"></iframe></div><p><a class="reference external" href="https://www.bsdcan.org/2019/schedule/attachments/500_How%20ZFS%20Snapshots%20Really%20Work.pdf">幻灯片可以从这里下载</a></p>
<p><embed class="embed-responsive-item" src="//farseerfc.me/zhs/images/500_How_ZFS_Snapshots_Really_Work.pdf" style="width:90%;height:480px"/></p>
</div>
</div>
<p>OpenZFS 的项目领导者，同时也是最初设计 ZFS 中 DMU 子系统的作者 Matt Ahrens 在 DMU 和 DSL
中设计并实现了 ZFS 独特的快照的空间跟踪算法。他也在很多地方发表演讲，讲过这个算法的思路和细节，
比如右侧就是他在 BSDCan 2019 做的演讲
<a class="reference external" href="https://youtu.be/NXg86uBDSqI">How ZFS snapshots really work And why they perform well (usually)</a>
的 YouTube 视频。</p>
<p>其中 Matt 讲到了三个删除快照的算法，分别可以叫做「🐢乌龟算法」、「🐰兔子算法」、「🐆豹子算法」，
接下来简单讲讲这些算法背后的思想和实现方式。</p>
<div class="section" id="id25">
<h4><a class="toc-backref" href="#id50">🐢乌龟算法：概念上 ZFS 如何删快照</a></h4>
<p>乌龟算法没有实现在 ZFS 中，不过方便理解 ZFS 在概念上如何考虑快照删除这个问题，从而帮助理解
后面的🐰兔子算法和🐆豹子算法。</p>
<p>要删除一个快照， ZFS 需要找出这个快照引用到的「独占」数据块，也就是那些不和别的数据集或者快照共享的
数据块。 ZFS 删除快照基于这几点条件：</p>
<ol class="arabic simple">
<li>ZFS 快照是只读的。创建快照之后无法修改其内容。</li>
<li>ZFS 的快照是严格按时间顺序排列的，这里的时间指 TXG id ，即记录文件系统提交所属事务组的严格递增序号。</li>
<li>ZFS 不存在 reflink 之类的机制，���是某个时间点中删除掉的数据块，不可能在比它更后面的快照中「复活」。</li>
</ol>
<p>第三点关于 reflink 造成的数据复活现象可能需要解释一下，比如在（支持 reflink 的） btrfs 中有如下操作：</p>
<div class="highlight"><pre><span class="code-line"><span></span>btrfs subvolume snapshot -r fs s1</span>
<span class="code-line">rm fs/somefile</span>
<span class="code-line">btrfs subvolume snapshot -r fs s2</span>
<span class="code-line">cp --reflink<span class="o">=</span>always s1/somefile fs/somefile</span>
<span class="code-line">btrfs subvolume snapshot -r fs s3</span>
</pre></div>
<p>我们对 fs 创建了 s1 快照，删除了 fs 中某个文件，创建了 s2 快照，然后用 reflink
把刚刚删除的文件从 s1 中复制出来，再创建 s3 。如此操作之后，按时间顺序有 s1、s2、s3 三个快照：</p>
<img alt="ditaa diagram" class="img-responsive ditaa" src="//farseerfc.me/uml/fe4409ee.png"/>
<p>其中只有 s2 不存在 somefile ，而 s1 、 s3 和当前的 fs 都有，并且都引用到了同一个数据块。
于是从时间线来看， somefile 的数据块在 s2 中「死」了，又在 s3 中「复活」了。</p>
<p>而 ZFS (目前还）不支持 reflink ，所以没法像这样让数据块复活。一旦某个数据块在某个快照中「死」了，
就意味着它在随后的所有快照中都不再被引用到了。</p>
<p>ZFS 的快照具有的上述三点条件，使得 ZFS 的快照删除算法可以基于 birth time
。回顾上面 <a class="reference internal" href="#id17">ZFS 的块指针</a> 中讲到， ZFS 的每个块指针都有一个 birth txg
属性，记录这个块诞生时 pool 所在的 txg 。于是可以根据这个 birth txg
找到快照所引用的「独占」数据块然后释放掉它们。</p>
<p>具体来说，🐢乌龟算法可以这样删除一个快照：</p>
<ol class="arabic simple">
<li>在 DSL 层找出要删除的快照（我们叫他 s ），它的前一个快照（叫它 ps ），后一个快照（叫它 ns
），分别有各自的 birth txg 叫 s.birth, ps.birth, ns.birth 。</li>
<li>遍历 s 的 DMU 对象集指针所引出的所有块指针。
这里所有块指针在逻辑上构成一个由块指针组成的树状结构，可以有间接块组成的指针树，可以有对象集的
dnode 保存的块指针，这些都可以看作是树状结构的中间节点。<ol class="arabic">
<li>每个树节点的指针 bp，考察如果 bp.birth &lt;= ps.birth
，那么这个指针和其下所有指针都还被前一个快照引用着，需要保留这个 bp 引出的整个子树。</li>
<li>按定义 bp.birth 不可能 &gt; s.birth 。</li>
<li>对所有满足 ps.birth &lt; bp.birtu &lt;= s.birth 的 bp ，需要去遍历 ns
的相应块指针（同样文件的同样偏移位置），看是否还在引用 bp 。<ul>
<li>如果存在，继续递归往下考察树状结构中 bp 的所有子节点指针。因为可能共享了这个 bp 但
CoW 了新的子节点。</li>
<li>如果不存在，说明下一个快照中已经删了 bp 。这时可以确定地说 bp 是 s 的「独占」数据块。</li>
</ul>
</li>
</ol>
</li>
<li>释放掉所有找到的 s 所「独占」的数据块。</li>
</ol>
<p>上述算法的一些边角情况可以自然地处理，比如没有后一个快照时使用当前数据集的写入点，
没有前一个快照时那么不被后一个快照引用的数据块都是当前要删除快照的独占数据块。</p>
<p>分析一下乌龟算法的复杂度的话，算法需要分两次，读 s 和 ns 中引用到的所有 ps
之后创建的数据块的指针，重要的是这些读都是在整个文件系统范围内的随机读操作，所以速度非常慢……</p>
</div>
<div class="section" id="id26">
<h4><a class="toc-backref" href="#id51">🐰兔子算法：死亡列表算法（ZFS早期）</a></h4>
<p>可以粗略地认为🐢乌龟算法算是用 birth txg 优化代码路径的 GC 算法，利用了一部分元数据中的 birth txg
信息来避免扫描所有元数据，但是概念上仍然是在扫描元数据找出快照的独占数据块，
而非记录和跟踪快照的数据块，在最坏的情况下仍然可能需要扫描几乎所有元数据。</p>
<p>🐰兔子算法基于🐢乌龟算法的基本原理，在它基础上跟踪快照所引用数据块的一些信息，
从而很大程度上避免了扫描元数据的开销。ZFS 在早期使用这个算法跟踪数据集和快照引用数据块的情况。</p>
<p>🐰兔子算法为每个数据集（文件系统或快照）增加了一个数据结构，叫死亡列表（dead list），
记录 <strong>前一个快照中还活着，而当前数据集中死掉了的数据块指针</strong>
，换句话说就是在本数据集中「杀掉」的数据块。举例画图大概是这样</p>
<img alt="ditaa diagram" class="img-responsive ditaa" src="//farseerfc.me/uml/ab76244a.png"/>
<p>上图中有三个快照和一个文件系统，共 4 个数据集。每个数据集维护自己的死亡列表，
死亡列表中是那些在该数据集中被删掉的数据块。于是🐰兔子算法把🐢乌龟算法所做的操作分成了两部分，
一部分在文件系统删除数据时记录死亡列表，另一部分在删除快照时根据死亡列表释放需要释放的块。</p>
<p>在当前文件系统删除数据块（不再被当前文件系统引用）时，负责比对 birth txg
维护当前文件系统的死亡列表。每删除一个数据块，指针为 bp 时，判断 bp.birth
和文件系统最新的快照（上图为 s3）的 birth：</p>
<ul class="simple">
<li>bp.birth &lt;= s3.birth： 说明 bp 被 s3 引用，于是将 bp 加入 fs1 的 deadlist</li>
<li>bp.birth &gt; s3.birth：说明 bp 指向的数据块诞生于 s3 之后，可以直接释放 bp 指向的块。</li>
</ul>
<p>创建新快照时，将当前文件系统（图中 fs1）的死亡列表交给快照，文件系统可以初始化一个空列表。</p>
<p>删除快照时，被删除的快照 s 和前一个快照 ps 、后一个快照 ns ，需要读入后一个快照 ns 的死亡列表：</p>
<ol class="arabic simple">
<li>对 s.deadlist 中的每个指针 bp<ul>
<li>复制 bp 到 ns.deadlist</li>
</ul>
</li>
<li>对 ns.deadlist 中的每个指针 bp<ul>
<li>如果 bp.birth &gt; ps.birth ，释放 bp 的空间</li>
<li>否则保留 bp</li>
</ul>
</li>
</ol>
<p>换个说法的话， <strong>死亡列表记录的是每个数据集需要负责删除，但因为之前的快照还引用着所以不能删除的数据块列表</strong>
。从当前文件系统中删除一个数据块时，这个职责最初落在当前文件系统身上，随后跟着创建新快照职责被转移到新快照上。
每个负责的数据集根据数据块的出生时间是否早于之前一个快照来判断现在是否能立刻释放该块，
删除一个快照时则重新评估自己负责的和下一个快照负责的数据块的出生时间。</p>
<p>从所做的事情来看，🐰兔子算法并没有比🐢乌龟算法少做很多事情。🐢乌龟算法删除一个快照，
需要遍历当前快照和后一个快照两组数据块指针中，新写入的部分；
🐰兔子算法则需要遍历当前快照和后一个快照两个死亡数组中，新删除的块指针。
但是实际🐰兔子算法能比🐢乌龟算法快不少，因为维护死亡列表的操作只在文件系统删除数据时和删除快照时，
顺序写入，并且删除快照时也只需要顺序读取死亡列表。在磁盘这种块设备上，顺序访问能比随机访问有数量级的差异。</p>
<p>不过记录死亡列表也有一定存储开销。最差情况下，比如把文件系统写满之后，创建一个快照，
再把所有数据都删掉，此时文件系统引用的所有数据块的块指针都要保存在文件系统的死亡列表中。
按 ZFS 默认的 128KiB 数据块大小，每块需要 128 字节的块指针，存储这些死亡列表所需开销可能要
整个文件系统大小的 1/1024 。如果用 4KiB 的数据块大小，所需开销则是 1/32 ， 1TiB
的盘会有 32GiB 拿来存放这些块指针，将高于用位图数组所需的存储量。</p>
</div>
<div class="section" id="id27">
<h4><a class="toc-backref" href="#id52">🐆豹子算法：死亡列表的子列表</a></h4>
<p>🐆豹子算法是 ZFS 后来在 2009 年左右实现的算法。在🐰兔子算法中就可以看到，每次删除快照操作死亡列表的时候，
都需要扫描死亡列表中的块指针，根据指针中记录的 birth txg 做判断是否能直接释放或是需要保留到另一个快照的死亡列表。
于是🐆豹子算法的思路是，在死亡列表中记录块指针时，就把其中的块指针按 birth txg 分成子列表（sublist）。</p>
<p>比如上面🐰兔子算法中那4个死亡列表，可以这样拆成子列表：</p>
<img alt="ditaa diagram" class="img-responsive ditaa" src="//farseerfc.me/uml/34b39b01.png"/>
<p>这样拆成子列表之后，每次从死亡列表中释放数据块都能根据出生时间找到对应的子列表，
然后连续释放整个子列表。每次合并死亡列表时，也能直接用单链表穿起需要合并的子列表，不需要复制块指针。</p>
<p>死亡列表并不在跟踪快照的独占大小，而是在跟踪快照所需负责删除的数据块大小，
从这个数值可以推算出快照的独占大小之类的信息。
有了按出生时间排列的死亡列表子列表之后，事实上给任何一个出生时间到死亡时间的范围，
都可以找出对应的几个子列表，从而根据子列表的大小可以快速计算出每个快照范围的「独占」数据块、
「共享」数据块等大小，这不光在删除快照时很有用，也可以用来根据大小估算 zfs send
或者别的基于快照操作时需要的时间。</p>
<p>从直觉上理解，虽然 ZFS 没有直接记录每个数据块属于哪个数据集，但是 ZFS
跟踪记录了每个数据块的归属信息，也就是说由哪个数据集负责释放这个数据块。
在文件系统中删除数据块或者快照时，这个归属信息跟着共享数据块转移到别的快照中，直到最终被释放掉。</p>
</div>
<div class="section" id="id28">
<h4><a class="toc-backref" href="#id53">生存日志：ZFS 如何管理克隆的空间占用</a></h4>
<div class="panel panel-default">
<div class="panel-heading">
Fast Clone Deletion by Sara Hartse</div>
<div class="panel-body">
<div align="left" class="youtube embed-responsive embed-responsive-16by9"><iframe allow="fullscreen" class="embed-responsive-item" frameborder="0" src="https://www.youtube.com/embed/GLABJRWwGMk"></iframe></div></div>
</div>
<p>以上三种算法负责在 ZFS 中跟踪快照的空间占用，它们都基于数据块的诞生时间，所以都假设 ZFS
中对数据块的分配是位于连续的快照时间轴上。但是明显 ZFS 除了快照和文件系统，
还有另一种数据集可能分配数据块，那就是 <a class="reference internal" href="#id11">克隆</a>
，于是还需要在克隆中使用不同的算法单独管理因克隆而分配的数据块。
OpenZFS Summit 2017 有个演讲 <a class="reference external" href="https://www.youtube.com/watch?v=GLABJRWwGMk">Fast Clone Deletion by Sara Hartse</a>
解释了其中的细节。</p>
<p>首先克隆的存在本身会锁住克隆引用到的快照，不能删除这些被依赖的快照，
所以克隆无须担心靠快照共享的数据块的管理问题。因此克隆需要管理的，是从快照分离之后，
新创建的数据块。</p>
<p>和🐢乌龟算法一样，原理上删除克隆的时候可以遍历克隆引用的整个 DMU
对象集，找出其中晚于快照的诞生时间的数据块，然后释放它们。也和🐢乌龟算法一样，
这样扫描整个对象集的开销很大，所以使用一个列表来记录数据块指针。
克隆管理新数据块的思路和快照的🐰兔子算法维持死亡列表的思路相反，
记录所有新诞生的数据块，这个列表叫做「生存日志（livelist）」。</p>
<p>克隆不光要记录新数据块的诞生，还要记录新数据块可能的死亡，所以磁盘上保存的生存日志虽然叫 livelist
，但不像死亡列表那样是列表的形式，而是日志的形式，而内存中保存的生存日志则组织成了棵
<a class="reference external" href="https://zh.wikipedia.org/wiki/AVL%E6%A0%91">自平衡树（AVLTree）</a> 来加速查找。</p>
<img alt="ditaa diagram" class="img-responsive ditaa" src="//farseerfc.me/uml/7f244754.png"/>
<p>磁盘上存储的生存日志如上图，每个表项记录它是分配（A）或者删除（F）一个数据块，同时记录数据块的地址。
这些记录在一般情况下直接记录在日志末尾，随着对克隆的写入操作而不断增长，长到一定程度则从内存中的
AVL Tree 直接输出一个新的生存日志替代掉旧的，合并其中对应的分配和删除操作。</p>
<p>生存日志可以无限增长，从而要将整个生存列表载入内存也有不小的开销，这里的解决方案有点像快照管理中用
🐆豹子算法改进🐰兔子算法的思路，把一个克隆的整个生存日志也按照数据块的诞生时间拆分成子列表。
Sara Hartse 的演讲 Fast Clone Deletion 中继续解释了其中的细节和优化方案，感兴趣的可以看看。</p>
</div>
</div>
<div class="section" id="id29">
<h3><a class="toc-backref" href="#id54">btrfs 的空间跟踪算法：反向引用</a></h3>
<p>理解了 ZFS 中根据 birth txg 管理快照和克隆的算法之后，可以发现它们基于的假设难以用于 WAFL
和 btrfs 。 ZFS 严格区分文件系统、快照、克隆，并且不存在 reflink ，从而可以用 birth txg
判断数据块是否需要保留，而 WAFL 和 btrfs 中不存在 ZFS 的那些数据集分工，又想支持 reflink
，可见单纯基于 birth txg 不足以管理 WAFL 和 btrfs 子卷。</p>
<p>让我们回到一开始日志结构文件系统中基于垃圾回收（GC）的思路上来，作为程序员来看，
当垃圾回收的性能不足时，很自然的思路是：引用计数（reference counting）。
编程语言中用引用计数作为内存管理策略的缺陷是：强引用不能成环，
这在文件系统中看起来不是很严重的问题，文件系统总体上看是个树状结构，
有很多指针类型也方便区分强弱引用。</p>
<p>btrfs 中就是用引用计数的方式跟踪和管理数据块的。引用计数本身不能保存在 FS_TREE
或者指向的数据块中，因为这个计数需要能够变化，对只读快照来说整个 FS_TREE 都是只读的。
计算机领域中的所有问题都可以靠增加一层抽象来解决， btrfs 中关于数据块的引用计数用一个单独的
CoW B树来记录，叫做 EXTENT_TREE ，保存于 ROOT_TREE 中的 2 号对象位置。
btrfs 中每个数据块都是按 extent 的形式分配的，extent 是一块连续的存储空间而非 zfs
中的固定大小，记录数据块的存储位置和长度，以及这里所说的引用计数。
所以本文最开始讲 <a class="reference internal" href="#btrfs">Btrfs 的子卷和快照</a> 中举例的那个平坦布局，如果画上 EXTENT_TREE
大概像是下图这样，其中每个粗箭头是一个数据块指针，指向磁盘中的逻辑地址，细箭头则是指向
EXTENT_TREE 中这块数据块的描述：</p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">

<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Flat_layout_extents_on_disk Pages: 1 -->
<svg class="svg-responsive" height="599pt" viewbox="0.00 0.00 1219.00 598.88" width="1219pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g class="graph" id="graph0" transform="scale(1 1) rotate(0) translate(4 594.8766)">
<title>Flat_layout_extents_on_disk</title>
<polygon fill="#ffffff" points="-4,4 -4,-594.8766 1215,-594.8766 1215,4 -4,4" stroke="transparent"></polygon>
<!-- superblock -->
<g class="node" id="node1">
<title>superblock</title>
<polygon fill="none" points="0,-315.5 0,-407.5 123,-407.5 123,-315.5 0,-315.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="61.5" y="-392.3">SUPERBLOCK</text>
<polyline fill="none" points="0,-384.5 123,-384.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="61.5" y="-369.3">...</text>
<polyline fill="none" points="0,-361.5 123,-361.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="61.5" y="-346.3">root_tree</text>
<polyline fill="none" points="0,-338.5 123,-338.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="61.5" y="-323.3">...</text>
</g>
<!-- roottree -->
<g class="node" id="node2">
<title>roottree</title>
<polygon fill="none" points="195,-62 195,-361 504,-361 504,-62 195,-62" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-345.8">ROOT_TREE</text>
<polyline fill="none" points="195,-338 504,-338 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-322.8">2: extent_tree</text>
<polyline fill="none" points="195,-315 504,-315 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-299.8">3: chunk_tree</text>
<polyline fill="none" points="195,-292 504,-292 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-276.8">4: dev_tree</text>
<polyline fill="none" points="195,-269 504,-269 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-253.8">5: fs_tree</text>
<polyline fill="none" points="195,-246 504,-246 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-230.8">6: root_dir "default" -&gt; ROOT_ITEM 256</text>
<polyline fill="none" points="195,-223 504,-223 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-207.8">10: free_space_tree</text>
<polyline fill="none" points="195,-200 504,-200 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-184.8">256: fs_tree "root"</text>
<polyline fill="none" points="195,-177 504,-177 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-161.8">257: fs_tree "home"</text>
<polyline fill="none" points="195,-154 504,-154 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-138.8">258: fs_tree "www"</text>
<polyline fill="none" points="195,-131 504,-131 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-115.8">259: fs_tree "postgres"</text>
<polyline fill="none" points="195,-108 504,-108 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-92.8">-7: tree_log_tree</text>
<polyline fill="none" points="195,-85 504,-85 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="349.5" y="-69.8">-5: orphan_root</text>
</g>
<!-- superblock&#45;&gt;roottree -->
<g class="edge" id="edge1">
<title>superblock:sn_root-&gt;roottree:label</title>
<path d="M123,-349.5C151.375,-349.5 160.8795,-349.5 184.9792,-349.5" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="185,-353.0001 195,-349.5 185,-346.0001 185,-353.0001" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- roottree&#45;&gt;roottree -->
<g class="edge" id="edge8">
<title>roottree:e-&gt;roottree:e</title>
<path d="M504.5,-234.5C552,-243.5 648,-243.5 648,-211.5 648,-181.625 564.3267,-179.6411 514.5622,-186.8328" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="513.7934,-183.4124 504.5,-188.5 514.9376,-190.3183 513.7934,-183.4124" stroke="#000000"></polygon>
</g>
<!-- toplevel -->
<g class="node" id="node3">
<title>toplevel</title>
<polygon fill="none" points="576,-195.5 576,-425.5 923,-425.5 923,-195.5 576,-195.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-410.3">FS_TREE "toplevel"</text>
<polyline fill="none" points="576,-402.5 923,-402.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-387.3"> </text>
<polyline fill="none" points="576,-379.5 923,-379.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-364.3">256: inode_item DIR</text>
<polyline fill="none" points="576,-356.5 923,-356.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-341.3">256: dir_item: "root" -&gt; ROOT_ITEM 256</text>
<polyline fill="none" points="576,-333.5 923,-333.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-318.3">256: dir_item: "home" -&gt; ROOT_ITEM 257</text>
<polyline fill="none" points="576,-310.5 923,-310.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-295.3">256: dir_item: "var" -&gt; INODE_ITEM 257</text>
<polyline fill="none" points="576,-287.5 923,-287.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-272.3">256: dir_item: "postgres" -&gt; ROOT_ITEM 259</text>
<polyline fill="none" points="576,-264.5 923,-264.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-249.3"> </text>
<polyline fill="none" points="576,-241.5 923,-241.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-226.3">257: inode_item DIR</text>
<polyline fill="none" points="576,-218.5 923,-218.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-203.3">257: dir_item: "www" -&gt; ROOT_ITEM 258</text>
</g>
<!-- roottree&#45;&gt;toplevel -->
<g class="edge" id="edge7">
<title>roottree:root_fs-&gt;toplevel:label</title>
<path d="M504,-257.5C577.0172,-257.5 506.8191,-399.5423 565.8504,-413.4136" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="565.6843,-416.9157 576,-414.5 566.4293,-409.9555 565.6843,-416.9157" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- root -->
<g class="node" id="node4">
<title>root</title>
<polygon fill="none" points="667.5,-444.5 667.5,-490.5 831.5,-490.5 831.5,-444.5 667.5,-444.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-475.3">FS_TREE "root"</text>
<polyline fill="none" points="667.5,-467.5 831.5,-467.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-452.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;root -->
<g class="edge" id="edge9">
<title>roottree:root_sub_root-&gt;root:label</title>
<path d="M504,-188.5C618.3467,-188.5 502.0649,-348.2718 576,-435.5 602.8973,-467.2333 619.6153,-477.8519 657.4163,-479.3174" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="657.4382,-482.8182 667.5,-479.5 657.5651,-475.8194 657.4382,-482.8182" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- home -->
<g class="node" id="node5">
<title>home</title>
<polygon fill="none" points="667.5,-130.5 667.5,-176.5 831.5,-176.5 831.5,-130.5 667.5,-130.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-161.3">FS_TREE "home"</text>
<polyline fill="none" points="667.5,-153.5 831.5,-153.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-138.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;home -->
<g class="edge" id="edge10">
<title>roottree:root_sub_home-&gt;home:label</title>
<path d="M504,-165.5C573.1185,-165.5 592.9293,-165.5 657.2326,-165.5" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="657.5,-169.0001 667.5,-165.5 657.5,-162.0001 657.5,-169.0001" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- www -->
<g class="node" id="node6">
<title>www</title>
<polygon fill="none" points="667.5,-65.5 667.5,-111.5 831.5,-111.5 831.5,-65.5 667.5,-65.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-96.3">FS_TREE "www"</text>
<polyline fill="none" points="667.5,-88.5 831.5,-88.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-73.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;www -->
<g class="edge" id="edge11">
<title>roottree:root_sub_www-&gt;www:label</title>
<path d="M504,-142.5C537.3333,-142.5 543.742,-129.8984 576,-121.5 612.9079,-111.8909 623.9319,-102.3027 657.4191,-100.7257" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="657.5809,-104.2231 667.5,-100.5 657.4241,-97.2248 657.5809,-104.2231" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- postgres -->
<g class="node" id="node7">
<title>postgres</title>
<polygon fill="none" points="667,-.5 667,-46.5 832,-46.5 832,-.5 667,-.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-31.3">FS_TREE "postgres"</text>
<polyline fill="none" points="667,-23.5 832,-23.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="749.5" y="-8.3">256: inode_item DIR</text>
</g>
<!-- roottree&#45;&gt;postgres -->
<g class="edge" id="edge12">
<title>roottree:root_sub_postgres-&gt;postgres:label</title>
<path d="M504,-119.5C546.5206,-119.5 538.1561,-75.8865 576,-56.5 609.5913,-39.292 622.8882,-35.9967 656.4598,-35.5574" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="656.5202,-39.0572 666.5,-35.5 656.4801,-32.0573 656.5202,-39.0572" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- extent_tree -->
<g class="node" id="node8">
<title>extent_tree</title>
<polygon fill="none" points="995,-338.5 995,-568.5 1211,-568.5 1211,-338.5 995,-338.5" stroke="#000000"></polygon>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="1103" y="-553.3">EXTENT_TREE</text>
<polyline fill="none" points="995,-545.5 1211,-545.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="1103" y="-530.3"> </text>
<polyline fill="none" points="995,-522.5 1211,-522.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="1103" y="-507.3">extent 0x10000: ref 1 gen 6</text>
<polyline fill="none" points="995,-499.5 1211,-499.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="1103" y="-484.3">extent 0x10100: ref 1 gen 6</text>
<polyline fill="none" points="995,-476.5 1211,-476.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="1103" y="-461.3">extent 0x10200: ref 1 gen 6</text>
<polyline fill="none" points="995,-453.5 1211,-453.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="1103" y="-438.3">extent 0x10300: ref 1 gen 6</text>
<polyline fill="none" points="995,-430.5 1211,-430.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="1103" y="-415.3">extent 0x10400: ref 1 gen 6</text>
<polyline fill="none" points="995,-407.5 1211,-407.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="1103" y="-392.3">extent 0x10500: ref 1 gen 6</text>
<polyline fill="none" points="995,-384.5 1211,-384.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="1103" y="-369.3">extent 0x10600: ref 1 gen 6</text>
<polyline fill="none" points="995,-361.5 1211,-361.5 " stroke="#000000"></polyline>
<text fill="#000000" font-family="Times,serif" font-size="14.00" text-anchor="middle" x="1103" y="-346.3">...</text>
</g>
<!-- roottree&#45;&gt;extent_tree -->
<g class="edge" id="edge13">
<title>roottree:root_extent-&gt;extent_tree:label</title>
<path d="M504,-326.5C601.4064,-326.5 498.2586,-474.812 576,-533.5 722.1806,-643.8537 805.4304,-560.628 984.9901,-557.5848" fill="none" stroke="#000000" stroke-width="2"></path>
<polygon fill="#000000" points="985.0301,-561.0847 995,-557.5 984.9707,-554.085 985.0301,-561.0847" stroke="#000000" stroke-width="2"></polygon>
</g>
<!-- roottree&#45;&gt;extent_tree -->
<g class="edge" id="edge14">
<title>roottree:label-&gt;extent_tree:extent_roottree</title>
<path d="M504,-349.5C578.3499,-349.5 513.6489,-460.0002 576,-500.5 651.4417,-549.5028 885.1193,-514.1107 984.9203,-511.6341" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="985.0475,-515.1328 995,-511.5 984.9543,-508.1334 985.0475,-515.1328" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge2">
<title>toplevel:toplevel_dir_root-&gt;roottree:root_sub_root</title>
<path d="M576,-345.5C502.9828,-345.5 573.1809,-203.4577 514.1496,-189.5864" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="514.3157,-186.0843 504,-188.5 513.5707,-193.0445 514.3157,-186.0843" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge3">
<title>toplevel:toplevel_dir_home-&gt;roottree:root_sub_home</title>
<path d="M576,-322.5C502.9828,-322.5 573.1809,-180.4577 514.1496,-166.5864" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="514.3157,-163.0843 504,-165.5 513.5707,-170.0445 514.3157,-163.0843" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge5">
<title>toplevel:toplevel_dir_postgres-&gt;roottree:root_sub_postgres</title>
<path d="M576,-275.5C503.3669,-275.5 572.8531,-134.3624 514.0988,-120.5795" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="514.3154,-117.0828 504,-119.5 513.5713,-124.0431 514.3154,-117.0828" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;roottree -->
<g class="edge" id="edge6">
<title>toplevel:toplevel_dir_www-&gt;roottree:root_sub_www</title>
<path d="M576,-206.5C537.0321,-206.5 544.8212,-153.4834 514.2549,-143.957" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="514.3929,-140.4415 504,-142.5 513.4082,-147.3719 514.3929,-140.4415" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;toplevel -->
<g class="edge" id="edge4">
<title>toplevel:e-&gt;toplevel:e</title>
<path d="M923.5,-298.5C981.6667,-307.5 1099,-307.5 1099,-264 1099,-222.8789 994.1491,-220.6301 933.545,-228.1098" fill="none" stroke="#000000" stroke-dasharray="5,2"></path>
<polygon fill="none" points="932.9258,-224.6621 923.5,-229.5 933.8854,-231.596 932.9258,-224.6621" stroke="#000000"></polygon>
</g>
<!-- toplevel&#45;&gt;extent_tree -->
<g class="edge" id="edge16">
<title>toplevel:label-&gt;extent_tree:extent_toplevel</title>
<path d="M923,-414.5C958.385,-414.5 956.6059,-456.0254 984.7322,-464.1359" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="984.6261,-467.6525 995,-465.5 985.5481,-460.7134 984.6261,-467.6525" stroke="#000000"></polygon>
</g>
<!-- root&#45;&gt;extent_tree -->
<g class="edge" id="edge17">
<title>root:label-&gt;extent_tree:extent_root</title>
<path d="M831.5,-479.5C902.6064,-479.5 918.924,-444.979 984.894,-441.7427" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="985.0869,-445.2391 995,-441.5 984.9188,-438.2412 985.0869,-445.2391" stroke="#000000"></polygon>
</g>
<!-- home&#45;&gt;extent_tree -->
<g class="edge" id="edge18">
<title>home:label-&gt;extent_tree:extent_home</title>
<path d="M831.5,-165.5C873.224,-165.5 892.4068,-158.1284 923,-186.5 999.5328,-257.4751 894.4682,-408.0627 984.9685,-417.9844" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="984.8335,-421.482 995,-418.5 985.1929,-414.4912 984.8335,-421.482" stroke="#000000"></polygon>
</g>
<!-- www&#45;&gt;extent_tree -->
<g class="edge" id="edge19">
<title>www:label-&gt;extent_tree:extent_www</title>
<path d="M831.5,-100.5C873.224,-100.5 893.0377,-92.463 923,-121.5 1010.8577,-206.6445 877.0747,-385.0229 984.9412,-395.058" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="984.856,-398.5576 995,-395.5 985.1633,-391.5643 984.856,-398.5576" stroke="#000000"></polygon>
</g>
<!-- postgres&#45;&gt;extent_tree -->
<g class="edge" id="edge20">
<title>postgres:label-&gt;extent_tree:extent_postgres</title>
<path d="M832.5,-35.5C873.7909,-35.5 893.8612,-27.2448 923,-56.5 1022.0703,-155.9659 859.5991,-361.7078 984.6327,-372.0916" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="984.8699,-375.6035 995,-372.5 985.1456,-368.609 984.8699,-375.6035" stroke="#000000"></polygon>
</g>
<!-- extent_tree&#45;&gt;extent_tree -->
<g class="edge" id="edge15">
<title>extent_tree:extent_extent-&gt;extent_tree:label</title>
<path d="M994.8132,-483.7521C908.2355,-483.7746 819,-493.1362 819,-523 819,-551.6972 901.4002,-561.4627 984.6607,-562.2018" fill="none" stroke="#000000"></path>
<polygon fill="#000000" points="984.7974,-565.7024 994.8132,-562.2479 984.8292,-558.7025 984.7974,-565.7024" stroke="#000000"></polygon>
</g>
</g>
</svg>
<p>包括 ROOT_TREE 和 EXTENT_TREE 在内，btrfs 中所有分配的数据块（extent）都在 EXTENT_TREE
中有对应的记录，按数据块的逻辑地址索引。从而给定一个数据块，能从 EXTENT_TREE 中找到 ref
字段描述这个数据块有多少引用。不过 ROOT_TREE 、 EXTENT_TREE 和别的一些数据结构本身不是写时拷贝的，
这些数据结构对应的 extent 的引用计数总是 1 ；从 FS_TREE 开始的所有树节点都可以写时复制，
这包括所有子卷的元数据和文件数据，这些数据块对应的 extent 的引用计数可以大于 1 表示有多处引用。</p>
<p>但是 btrfs 中通过引用计数管理子卷的一点困难之处在于，创建快照的操作中理论上要修改所有引用到的数据块的计数，
这显然很影响创建快照的性能。所以 btrfs 采取的策略是在快照创建时只增加快照的 FS_TREE 顶层元数据块的引用。
换句话说 EXTENT_TREE 中保存的 ref ，是物理记录中的引用计数，不是整个文件系统中引用到的数量，
要得知逻辑上的引用计数，需要反过来从数据块往回遍历到树根。
也就是说单有引用计数还不够，需要记录具体反向的从数据块往引用源头指的引用，这种结构在 btrfs
中叫做「反向引用（back reference，简称 backref）」。</p>
</div>
</div>
<script type='text/javascript'>if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    var location_protocol = (false) ? 'https' : document.location.protocol;
    if (location_protocol !== 'http' && location_protocol !== 'https') location_protocol = 'https:';
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = location_protocol + '//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
            </div>
            <div class="entry-content jumbotron" id="source-content" style="display: none">
                <!-- <pre><code id="source-code">
                </code></pre> -->
                <div id="source-code"></div>
            </div>
            <!-- /.entry-content -->

            <div class="row" id="prevnext">
                <div class="col-xs-12">
                </div>
                <div class="col-xs-12">
                </div>
            </div>

            <div class="panel panel-default" id="series">
                <div class="panel-heading">
                  <h4>
这篇文章是 "" 系列文章的第 <built-in method index of str object at 0x7fa2f211fed0> 篇：                  </h4>
                </div>
                <ul class="list-group">
                </ul>
            </div>

<section class="comments" id="comments">
    <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
      <div class="panel panel-primary">
        <div class="panel-heading" role="tab" id="disqus-heading">
          <h4 class="panel-title">
            <a data-toggle="collapse" data-parent="#accordion" href="#disqus-comments" aria-expanded="false" aria-controls="disqus-comments">
              <i class="fa fa-comments-o"></i> Disqus 留言            </a>
          </h4>
        </div>
        <div id="disqus-comments" class="panel-collapse collapse" role="tabpanel" aria-labelledby="disqus-heading">
          <div class="panel-body">
            <div class="tab-pane fade active in" id="disqus-comments">
                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'farseerfcgithub'; // required: replace example with your forum shortname

                            var disqus_identifier = 'btrfs-vs-zfs-difference-in-implementing-snapshots';
                        var disqus_url = 'http://farseerfc.me/zhs/drafts/btrfs-vs-zfs-difference-in-implementing-snapshots.html';

                    var disqus_config = function () {

                        this.language = "zh";
                    };

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function () {
                        var dsq = document.createElement('script');
                        dsq.type = 'text/javascript';
                        dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
                    Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
          </div>
        </div>
      </div>
    </div>
</section>        </article>
    </section>


            </div>
<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <a data-dismiss="modal" href="javascript:void(0);">
            <img id="mimg" src="" style="width:100%;height:auto">
          </a>
        </div>
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
        </div>
        <div class="col-xl-3 col-lg-4 col-md-6" id="sidebar">
            <aside>

<section>
    <div class="sidebar-container">
<div class="sidebar-item ">
<div class="panel panel-default">
	<div class="panel-heading">
        <h4>
<i class="fa fa-user fa-lg"></i>
<a href="//farseerfc.me/zhs/pages/about.html">
关于 farseerfc</a>
        </h4>
    </div>
<div class="panel-body" id="aboutme">
        <a href="//farseerfc.me/zhs/pages/about.html"><img width="100%" src="//farseerfc.me/zhs/../images/avatar.jpg"/></a>
    <h3 style="text-align:center">
<a href="https://sak.uy/"                  target="_blank">
<i class="fa fa-music" style="text-align:center"></i></a>
<a href="https://twitter.com/farseerfc"                  target="_blank">
<i class="fa fa-twitter" style="text-align:center"></i></a>
<a href="https://github.com/farseerfc"                   target="_blank">
<i class="fa fa-github" style="text-align:center"></i></a>
<a href="http://www.facebook.com/farseerfc"              target="_blank">
<i class="fa fa-facebook" style="text-align:center"></i></a>
<a href="https://plus.google.com/u/0/+JiachenYang/posts" target="_blank">
<i class="fa fa-google-plus" style="text-align:center"></i></a>
<a href="mailto:farseerfc@gmail.com" target="_blank">
<i class="mdi-communication-email" style="text-align:center"></i></a>
</h3>

</div>
</div>
</div>





<div class="sidebar-item hidden-xs">
<div class="panel panel-default">
	<div class="panel-heading">
        <h4>
<a href="//farseerfc.me/zhs/tags.html"><i class="fa fa-tags fa-lg"></i><span class="icon-label">标签云</span></a>
        </h4>
    </div>
<div class="panel-body">
    <ul class="list-group list-inline tagcloud" id="tags">
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/zfs.html">
                    zfs <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/layered.html">
                    layered <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/architecture.html">
                    architecture <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/spa.html">
                    SPA <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/dmu.html">
                    DMU <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/zpl.html">
                    ZPL <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/zio.html">
                    ZIO <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/vdev.html">
                    VDEV <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/arc.html">
                    ARC <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/zap.html">
                    ZAP <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/dsl.html">
                    DSL <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/zil.html">
                    ZIL <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/zvol.html">
                    ZVOL <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/friend.html">
                    friend <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/horo.html">
                    horo <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/life.html">
                    life <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-1">
                <a href="//farseerfc.me/zhs/tag/linux.html">
                    linux <sup> 9</sup>
                </a>
            </li>
            <li class="list-group-item tag-3">
                <a href="//farseerfc.me/zhs/tag/archlinux.html">
                    archlinux <sup> 2</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/raspberrypi.html">
                    raspberrypi <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/usbip.html">
                    usbip <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/usb.html">
                    usb <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/forward.html">
                    forward <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/translate.html">
                    translate <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/chouyaku.html">
                    chouyaku <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/kimi.html">
                    kimi <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/sae.html">
                    sae <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/inakerya.html">
                    inakerya <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/ting-yi.html">
                    听译 <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/dotfiles.html">
                    dotfiles <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/stow.html">
                    stow <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-3">
                <a href="//farseerfc.me/zhs/tag/zhihu.html">
                    zhihu <sup> 2</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/gplv3.html">
                    GPLv3 <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/licenses.html">
                    licenses <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/linus-torvalds.html">
                    Linus Torvalds <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/gpl.html">
                    GPL <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/fsf.html">
                    FSF <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/eff.html">
                    EFF <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-1">
                <a href="//farseerfc.me/zhs/tag/c.html">
                    C <sup> 15</sup>
                </a>
            </li>
            <li class="list-group-item tag-2">
                <a href="//farseerfc.me/zhs/tag/pelican.html">
                    pelican <sup> 5</sup>
                </a>
            </li>
            <li class="list-group-item tag-2">
                <a href="//farseerfc.me/zhs/tag/github.html">
                    github <sup> 3</sup>
                </a>
            </li>
            <li class="list-group-item tag-3">
                <a href="//farseerfc.me/zhs/tag/pages.html">
                    pages <sup> 2</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/issues.html">
                    issues <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-2">
                <a href="//farseerfc.me/zhs/tag/python.html">
                    python <sup> 5</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/pacvis.html">
                    pacvis <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/pacman.html">
                    pacman <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-3">
                <a href="//farseerfc.me/zhs/tag/arch.html">
                    arch <sup> 2</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/pacgraph.html">
                    pacgraph <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/wayland.html">
                    wayland <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/xorg.html">
                    xorg <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-3">
                <a href="//farseerfc.me/zhs/tag/compositor.html">
                    compositor <sup> 2</sup>
                </a>
            </li>
            <li class="list-group-item tag-3">
                <a href="//farseerfc.me/zhs/tag/desktop.html">
                    desktop <sup> 2</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/macosx.html">
                    macosx <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/windows.html">
                    windows <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/window.html">
                    window <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/manager.html">
                    manager <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/blog.html">
                    blog <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/writing.html">
                    writing <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/travis.html">
                    travis <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/travis-ci.html">
                    travis-ci <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/ubuntu.html">
                    ubuntu <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/japan.html">
                    japan <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/academic.html">
                    academic <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/chrome.html">
                    chrome <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/remote.html">
                    remote <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/domain.html">
                    domain <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/cloudflare.html">
                    cloudflare <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/bootstrap.html">
                    bootstrap <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-3">
                <a href="//farseerfc.me/zhs/tag/material.html">
                    material <sup> 2</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/subsite.html">
                    subsite <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/css.html">
                    css <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/paper.html">
                    paper <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/stdio.html">
                    stdio <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/tty.html">
                    tty <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/unix.html">
                    unix <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/ugh.html">
                    ugh <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/ncurses.html">
                    ncurses <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/termcap.html">
                    termcap <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/terminfo.html">
                    terminfo <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/kde5.html">
                    kde5 <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/plasma.html">
                    plasma <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/gnome3.html">
                    gnome3 <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/will.html">
                    will <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/you.html">
                    you <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/marry.html">
                    marry <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/me.html">
                    me <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-3">
                <a href="//farseerfc.me/zhs/tag/icse.html">
                    icse <sup> 2</sup>
                </a>
            </li>
            <li class="list-group-item tag-3">
                <a href="//farseerfc.me/zhs/tag/software.html">
                    software <sup> 2</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/msr.html">
                    msr <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/mining.html">
                    mining <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/repository.html">
                    repository <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/sjtu.html">
                    sjtu <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/yssy.html">
                    yssy <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/ruby.html">
                    ruby <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/template.html">
                    template <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-3">
                <a href="//farseerfc.me/zhs/tag/microsoft.html">
                    microsoft <sup> 2</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/acpi.html">
                    acpi <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/zz.html">
                    zz <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-3">
                <a href="//farseerfc.me/zhs/tag/java.html">
                    java <sup> 2</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/creationism.html">
                    creationism <sup> 1</sup>
                </a>
            </li>
            <li class="list-group-item tag-4">
                <a href="//farseerfc.me/zhs/tag/oop.html">
                    oop <sup> 1</sup>
                </a>
            </li>
    </ul>
</div>
</div>
</div>

<div class="sidebar-item hidden-xs">
<div class="panel panel-default">
	<div class="panel-heading">
        <h4>
<i class="fa fa-github fa-lg"></i><span class="icon-label">GitHub仓库</span>
        </h4>
    </div>
    <div class="panel-body">
        <div id="gh_repos">
            <p class="list-group-item">Status updating...</p>
        </div>
            <a href="https://github.com/farseerfc">@farseerfc</a> on GitHub<br>
    </div>
</div>
</div>
<div class="sidebar-item hidden-xs">
<div class="panel panel-default">
	<div class="panel-heading">
        <h4>
<a href="https://sak.uy/">
<i class="fa fa-home fa-lg"></i><span class="icon-label">Sakuya的音樂盒</span>
</a>
        </h4>
    </div>
    <div class="panel-body">
        <div id="other_blog_posts">
            <p class="list-group-item">Status updating...</p>
        </div>
    </div>
</div>
</div>

    </div>
</section>
        <div class="panel panel-default hidden-xs hidden-sm" id="affix-toc">
            <div class="panel-heading"><h4>
目录</h4>
            </div>
            <div class="panel-boy">
            <div class="toc" id="">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#btrfs" id="id30">Btrfs 的子卷和快照</a><ul>
<li><a class="reference internal" href="#id3" id="id31">子卷和快照的术语</a></li>
<li><a class="reference internal" href="#id4" id="id32">于是子卷在存储介质中是如何记录的呢？</a></li>
<li><a class="reference internal" href="#id6" id="id33">那么快照又是如何记录的呢？</a></li>
</ul>
</li>
<li><a class="reference internal" href="#zfs" id="id34">ZFS 的文件系统、快照、克隆及其它</a><ul>
<li><a class="reference internal" href="#id7" id="id35">ZFS 设计中和快照相关的一些术语和概念</a><ul>
<li><a class="reference internal" href="#id8" id="id36">数据集</a></li>
<li><a class="reference internal" href="#id9" id="id37">文件系统</a></li>
<li><a class="reference internal" href="#id10" id="id38">快照</a></li>
<li><a class="reference internal" href="#id11" id="id39">克隆</a></li>
<li><a class="reference internal" href="#id12" id="id40">书签</a></li>
<li><a class="reference internal" href="#id13" id="id41">检查点</a></li>
</ul>
</li>
<li><a class="reference internal" href="#zfs-btrfs" id="id42">ZFS 的概念与 btrfs 概念的对比</a></li>
<li><a class="reference internal" href="#id14" id="id43">ZFS 中是如何存储这些数据集的呢</a><ul>
<li><a class="reference internal" href="#id17" id="id44">ZFS 的块指针</a></li>
<li><a class="reference internal" href="#id18" id="id45">ZPL 的元对象集</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id19" id="id46">创建快照这么简单么？那么删除快照呢？</a><ul>
<li><a class="reference internal" href="#id20" id="id47">日志结构文件系统中用的垃圾回收算法</a></li>
<li><a class="reference internal" href="#wafl" id="id48">WAFL 早期使用的可用空间位图数组</a></li>
<li><a class="reference internal" href="#id23" id="id49">ZFS 中关于快照和克隆的空间跟踪算法</a><ul>
<li><a class="reference internal" href="#id25" id="id50">🐢乌龟算法：概念上 ZFS 如何删快照</a></li>
<li><a class="reference internal" href="#id26" id="id51">🐰兔子算法：死亡列表算法（ZFS早期）</a></li>
<li><a class="reference internal" href="#id27" id="id52">🐆豹子算法：死亡列表的子列表</a></li>
<li><a class="reference internal" href="#id28" id="id53">生存日志：ZFS 如何管理克隆的空间占用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id29" id="id54">btrfs 的空间跟踪算法：反向引用</a></li>
</ul>
</li>
</ul>
</div>
            </div>
        </div>
            </aside>
        </div>
    </div>
</div>


<footer id="fcfooter">
   <hr/>
   <div class="container">
      <div class="row">
         <div class="col-md-24">
         <p><small>
            &copy; 2020 farseerfc
            &middot; 通过            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a> 生成                <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a>
    <!-- Content -->
  <!-- licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution 4.0 International License</a>, except where indicated otherwise. -->

         </small></p>
         </div>
      </div>
   </div>
   <a href="#" class="btn btn-primary btn-fab btn-raised mdi-editor-vertical-align-top withripple" style="position:fixed;bottom:30px;right:30px;z-index:1000"></a>
</footer>
<script src="//farseerfc.me/zhs/../theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="//farseerfc.me/zhs/../theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="//farseerfc.me/zhs/../theme/js/respond.min.js"></script>

    <!-- GitHub JS -->
    <script type="text/javascript">
        $(document).ready(function () {
            if (!window.jXHR) {
                var jxhr = document.createElement('script');
                jxhr.type = 'text/javascript';
                jxhr.src = '//farseerfc.me/zhs/../theme/js/jXHR.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(jxhr, s);
            }

            github.showRepos({
                user: 'farseerfc',
                count: 5,
                skip_forks: false,
                target: '#gh_repos'
            });
        });
    </script>
    <script src="//farseerfc.me/zhs/../theme/js/github.js" type="text/javascript"></script>
    <!-- End GitHub JS Code -->
<!-- Other Blog JS -->
<script type="text/javascript">
    $(document).ready(function () {
        if (!window.jXHR) {
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '//farseerfc.me/zhs/../theme/js/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }
        other_blog.showRepos({
            url: 'https://sak.uy/',
            target: '#other_blog_posts'
        });
    });
</script>
<script src="//farseerfc.me/zhs/../theme/js/other_blog.js" type="text/javascript"></script>
<!-- End Other Blog JS Code -->
    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'farseerfcgithub'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-29540705-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->

<script src="//farseerfc.me/zhs/../theme/js/ripples.min.js"></script>
<script src="//farseerfc.me/zhs/../theme/js/material.min.js"></script>
<script src="//farseerfc.me/zhs/../theme/js/jquery.bootstrap-autohidingnavbar.min.js"></script>
<script>
    $(document).ready(function() {
        $.material.init();
        $("div.navbar").autoHidingNavbar();
        $(".img-responsive").css("cursor","pointer").on('click',function(){
            var sr=$(this).attr('src');
            $('#mimg').attr('src',sr);
            $('#myModal').modal('show');
        });
        $('#affix-toc').affix({
          offset: {
            top: function(){
                if($('#affix-toc').hasClass("affix"))
                    return $('#sidebar').height();
                return $('#sidebar').height() - $('#affix-toc').height();
            },
            bottom: function (){
                return $("#fcfooter").offset().top -
                    $("#article-content").offset().top -
                    $("#article-content").height() + 20;
            }
          }
        });
        $('#affix-toc').width($('#sidebar').width());
    });
    $(window).resize(function () {
       $('#affix-toc').width($('#sidebar').width());
    });
</script>

</body>
</html>